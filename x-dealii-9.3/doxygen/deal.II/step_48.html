<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="canonical" href="https://www.dealii.org/current/doxygen/deal.II/step_48.html" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The step-48 tutorial program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2021 by the deal.II authors"></meta>
<meta name="deal.II-version" content="9.3.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 9.3.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--Extra macros for MathJax:-->
<div style="display:none">
\(\newcommand{\dealvcentcolon}{\mathrel{\mathop{:}}}\)
\(\newcommand{\dealcoloneq}{\dealvcentcolon\mathrel{\mkern-1.2mu}=}\)
\(\newcommand{\jump}[1]{\left[\!\left[ #1 \right]\!\right]}\)
\(\newcommand{\average}[1]{\left\{\!\left\{ #1 \right\}\!\right\}}\)
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The step-48 tutorial program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial depends on <a class="el" href="step_25.html">step-25</a>, <a class="el" href="step_37.html">step-37</a>.</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Problemstatementanddiscretization"> Problem statement and discretization </a>
        <li><a href="#Implementationofconstraints">Implementation of constraints</a>
        <li><a href="#Parallelization"> Parallelization </a>
        <li><a href="#Thetestcase"> The test case </a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#SineGordonOperation">SineGordonOperation</a>
      <ul>
        <li><a href="#SineGordonOperationSineGordonOperation">SineGordonOperation::SineGordonOperation</a>
        <li><a href="#SineGordonOperationlocal_apply">SineGordonOperation::local_apply</a>
        <li><a href="#SineGordonOperationapply">SineGordonOperation::apply</a>
      </ul>
        <li><a href="#Equationdata">Equation data</a>
        <li><a href="#SineGordonProblemclass">SineGordonProblem class</a>
      <ul>
        <li><a href="#SineGordonProblemSineGordonProblem">SineGordonProblem::SineGordonProblem</a>
        <li><a href="#SineGordonProblemmake_grid_and_dofs">SineGordonProblem::make_grid_and_dofs</a>
        <li><a href="#SineGordonProblemoutput_results">SineGordonProblem::output_results</a>
        <li><a href="#SineGordonProblemrun">SineGordonProblem::run</a>
      </ul>
        <li><a href="#Thecodemaincodefunction">The <code>main</code> function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Comparisonwithasparsematrix">Comparison with a sparse matrix</a>
        <li><a href="#Parallelrunin2Dand3D">Parallel run in 2D and 3D</a>
        <li><a href="#Possibilitiesforextensions">Possibilities for extensions</a>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
</p>
<p><em> This program was contributed by Katharina Kormann and Martin Kronbichler.</em></p>
<p><em>The algorithm for the matrix-vector product is based on the article <a href="http://dx.doi.org/10.1016/j.compfluid.2012.04.012">A generic interface for parallel cell-based finite element operator application</a> by Martin Kronbichler and Katharina Kormann, Computers and Fluids 63:135&ndash;147, 2012, and the paper &quot;Parallel finite element operator application: Graph partitioning and coloring&quot; by Katharina Kormann and Martin Kronbichler in: Proceedings of the 7th IEEE International Conference on e-Science, 2011. </em></p>
<p><a class="anchor" id="Intro"></a> <a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>This program demonstrates how to use the cell-based implementation of finite element operators with the <a class="el" href="classMatrixFree.html">MatrixFree</a> class, first introduced in <a class="el" href="step_37.html">step-37</a>, to solve nonlinear partial differential equations. Moreover, we have another look at the handling of constraints within the matrix-free framework. Finally, we will use an explicit time-stepping method to solve the problem and introduce Gauss-Lobatto finite elements that are very convenient in this case since their mass matrix can be accurately approximated by a diagonal, and thus trivially invertible, matrix. The two ingredients to this property are firstly a distribution of the nodal points of Lagrange polynomials according to the point distribution of the Gauss-Lobatto quadrature rule. Secondly, the quadrature is done with the same Gauss-Lobatto quadrature rule. In this formula, the integrals \(\int_K \varphi_i \varphi_j dx\approx \sum_q \varphi_i \varphi_j \mathrm{det}(J) \big |_{x_q}\) become zero whenever \(i\neq j\), because exactly one function \(\varphi_j\) is one and all others zero in the points defining the Lagrange polynomials. Moreover, the Gauss-Lobatto distribution of nodes of Lagrange polynomials clusters the nodes towards the element boundaries. This results in a well-conditioned polynomial basis for high-order discretization methods. Indeed, the condition number of an <a class="el" href="classFE__Q.html">FE_Q</a> elements with equidistant nodes grows exponentially with the degree, which destroys any benefit for orders of about five and higher. For this reason, Gauss-Lobatto points are the default distribution for the <a class="el" href="classFE__Q.html">FE_Q</a> element (but at degrees one and two, those are equivalent to the equidistant points).</p>
<p><a class="anchor" id="Problemstatementanddiscretization"></a></p><h3>Problem statement and discretization </h3>
<p>As an example, we choose to solve the sine-Gordon soliton equation </p><p class="formulaDsp">
\begin{eqnarray*} u_{tt} &amp;=&amp; \Delta u -\sin(u) \quad\mbox{for}\quad (x,t) \in \Omega \times (t_0,t_f],\\ {\mathbf n} \cdot \nabla u &amp;=&amp; 0 \quad\mbox{for}\quad (x,t) \in \partial\Omega \times (t_0,t_f],\\ u(x,t_0) &amp;=&amp; u_0(x). \end{eqnarray*}
</p>
<p>that was already introduced in <a class="el" href="step_25.html">step-25</a>. As a simple explicit time integration method, we choose leap frog scheme using the second-order formulation of the equation. With this time stepping, the scheme reads in weak form</p>
<p class="formulaDsp">
\begin{eqnarray*} (v,u^{n+1}) = (v,2 u^n-u^{n-1} - (\Delta t)^2 \sin(u^n)) - (\nabla v, (\Delta t)^2 \nabla u^n), \end{eqnarray*}
</p>
<p> where <em> v</em> denotes a test function and the index <em>n</em> stands for the time step number.</p>
<p>For the spatial discretization, we choose <a class="el" href="classFE__Q.html">FE_Q</a> elements with basis functions defined to interpolate the support points of the Gauss-Lobatto quadrature rule. Moreover, when we compute the integrals over the basis functions to form the mass matrix and the operator on the right hand side of the equation above, we use the Gauss-Lobatto quadrature rule with the same support points as the node points of the finite element to evaluate the integrals. Since the finite element is Lagrangian, this will yield a diagonal mass matrix on the left hand side of the equation, making the solution of the linear system in each time step trivial.</p>
<p>Using this quadrature rule, for a <em>p</em>th order finite element, we use a <em>(2p-1)</em>th order accurate formula to evaluate the integrals. Since the product of two <em>p</em>th order basis functions when computing a mass matrix gives a function with polynomial degree <em>2p</em> in each direction, the integrals are not computed exactly. However, the overall convergence properties are not disturbed by the quadrature error on meshes with affine element shapes with L2 errors proportional to <em>h<sup>p+1</sup></em>. Note however that order reduction with sub-optimal convergence rates of the L2 error of <em>O(h<sup>p</sup>)</em> or even <em>O(h<sup>p-1</sup>)</em> for some 3D setups has been reported <a href="https://dx.doi.org/10.1002/num.20353">in literature</a> on deformed (non-affine) element shapes for wave equations when the integrand is not a polynomial any more.</p>
<p>Apart from the fact that we avoid solving linear systems with this type of elements when using explicit time-stepping, they come with two other advantages. When we are using the sum-factorization approach to evaluate the finite element operator (cf. <a class="el" href="step_37.html">step-37</a>), we have to evaluate the function at the quadrature points. In the case of Gauss-Lobatto elements, where quadrature points and node points of the finite element coincide, this operation is trivial since the value of the function at the quadrature points is given by its one-dimensional coefficients. In this way, the arithmetic work for the finite element operator evaluation is reduced by approximately a factor of two compared to the generic Gaussian quadrature.</p>
<p>To sum up the discussion, by using the right finite element and quadrature rule combination, we end up with a scheme where we only need to compute the right hand side vector corresponding to the formulation above and then multiply it by the inverse of the diagonal mass matrix in each time step. In practice, of course, we extract the diagonal elements and invert them only once at the beginning of the program.</p>
<p><a class="anchor" id="Implementationofconstraints"></a></p><h3>Implementation of constraints</h3>
<p>The usual way to handle constraints in <code>deal.II</code> is to use the <a class="el" href="classAffineConstraints.html">AffineConstraints</a> class that builds a sparse matrix storing information about which degrees of freedom (DoF) are constrained and how they are constrained. This format uses an unnecessarily large amount of memory since there are not so many different types of constraints: for example, in the case of hanging nodes when using linear finite element on every cell, most constraints have the form \(x_k = \frac 12 x_i + \frac 12 x_j\) where the coefficients \(\frac 12\) are always the same and only \(i,j,k\) are different. While storing this redundant information is not a problem in general because it is only needed once during matrix and right hand side assembly, it becomes a bottleneck in the matrix-free approach since there this information has to be accessed every time we apply the operator, and the remaining components of the operator evaluation are so fast. Thus, instead of an <a class="el" href="classAffineConstraints.html">AffineConstraints</a> object, <a class="el" href="classMatrixFree.html">MatrixFree</a> uses a variable that we call <code>constraint_pool</code> that collects the weights of the different constraints. Then, only an identifier of each constraint in the mesh instead of all the weights have to be stored. Moreover, the constraints are not applied in a pre- and postprocessing step but rather as we evaluate the finite element operator. Therefore, the constraint information is embedded into the variable <code>indices_local_to_global</code> that is used to extract the cell information from the global vector. If a DoF is constrained, the <code>indices_local_to_global</code> variable contains the global indices of the DoFs that it is constrained to. Then, we have another variable <code>constraint_indicator</code> at hand that holds, for each cell, the local indices of DoFs that are constrained as well as the identifier of the type of constraint. Fortunately, you will not see these data structures in the example program since the class <code><a class="el" href="classFEEvaluation.html">FEEvaluation</a></code> takes care of the constraints without user interaction.</p>
<p>In the presence of hanging nodes, the diagonal mass matrix obtained on the element level via the Gauss-Lobatto quadrature/node point procedure does not directly translate to a diagonal global mass matrix, as following the constraints on rows and columns would also add off-diagonal entries. As explained in <a href="https://dx.doi.org/10.4208/cicp.101214.021015a">Kormann (2016)</a>, interpolating constraints on a vector, which maintains the diagonal shape of the mass matrix, is consistent with the equations up to an error of the same magnitude as the quadrature error. In the program below, we will simply assemble the diagonal of the mass matrix as if it were a vector to enable this approximation.</p>
<p><a class="anchor" id="Parallelization"></a></p><h3>Parallelization </h3>
<p>The <a class="el" href="classMatrixFree.html">MatrixFree</a> class comes with the option to be parallelized on three levels: MPI parallelization on clusters of distributed nodes, thread parallelization scheduled by the Threading Building Blocks library, and finally with a vectorization by working on a batch of two (or more) cells via SIMD data type (sometimes called cross-element or external vectorization). As we have already discussed in <a class="el" href="step_37.html">step-37</a>, you will get best performance by using an instruction set specific to your system, e.g. with the cmake variable <code>-DCMAKE_CXX_FLAGS="-march=native"</code>. The MPI parallelization was already exploited in <a class="el" href="step_37.html">step-37</a>. Here, we additionally consider thread parallelization with TBB. This is fairly simple, as all we need to do is to tell the initialization of the <a class="el" href="classMatrixFree.html">MatrixFree</a> object about the fact that we want to use a thread parallel scheme through the variable MatrixFree::AdditionalData::thread_parallel_scheme. During setup, a dependency graph is set up similar to the one described in the <a class="el" href="DEALGlossary.html#workstream_paper">workstream_paper</a> , which allows to schedule the work of the <code>local_apply</code> function on chunks of cells without several threads accessing the same vector indices. As opposed to the <a class="el" href="namespaceWorkStream.html">WorkStream</a> loops, some additional clever tricks to avoid global synchronizations as described in <a href="https://dx.doi.org/10.1109/eScience.2011.53">Kormann and Kronbichler (2011)</a> are also applied.</p>
<p>Note that this program is designed to be run with a distributed triangulation (<a class="el" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation</a>), which requires deal.II to be configured with <a href="http://www.p4est.org/">p4est</a> as described in the <a href="../../readme.html">deal.II ReadMe</a> file. However, a non-distributed triangulation is also supported, in which case the computation will be run in serial.</p>
<p><a class="anchor" id="Thetestcase"></a></p><h3>The test case </h3>
<p>In our example, we choose the initial value to be </p><p class="formulaDsp">
\begin{eqnarray*} u(x,t) = \prod_{i=1}^{d} -4 \arctan \left( \frac{m}{\sqrt{1-m^2}}\frac{\sin\left(\sqrt{1-m^2} t +c_2\right)}{\cosh(mx_i+c_1)}\right) \end{eqnarray*}
</p>
<p> and solve the equation over the time interval [-10,10]. The constants are chosen to be \(c_1=c_1=0\) and <em> m=0.5</em>. As mentioned in <a class="el" href="step_25.html">step-25</a>, in one dimension <em>u</em> as a function of <em>t</em> is the exact solution of the sine-Gordon equation. For higher dimension, this is however not the case.</p>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p>The necessary files from the deal.II library.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="conditional__ostream_8h.html">deal.II/base/conditional_ostream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="timer_8h.html">deal.II/base/timer.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2tria_8h.html">deal.II/distributed/tria.h</a>&gt;</span></div>
<div class="ttc" id="aaffine__constraints_8h_html"><div class="ttname"><a href="affine__constraints_8h.html">affine_constraints.h</a></div></div>
<div class="ttc" id="aconditional__ostream_8h_html"><div class="ttname"><a href="conditional__ostream_8h.html">conditional_ostream.h</a></div></div>
<div class="ttc" id="adistributed_2tria_8h_html"><div class="ttname"><a href="distributed_2tria_8h.html">tria.h</a></div></div>
<div class="ttc" id="adof__tools_8h_html"><div class="ttname"><a href="dof__tools_8h.html">dof_tools.h</a></div></div>
<div class="ttc" id="adofs_2dof__handler_8h_html"><div class="ttname"><a href="dofs_2dof__handler_8h.html">dof_handler.h</a></div></div>
<div class="ttc" id="afe_2fe__values_8h_html"><div class="ttname"><a href="fe_2fe__values_8h.html">fe_values.h</a></div></div>
<div class="ttc" id="afe__q_8h_html"><div class="ttname"><a href="fe__q_8h.html">fe_q.h</a></div></div>
<div class="ttc" id="afunction_8h_html"><div class="ttname"><a href="function_8h.html">function.h</a></div></div>
<div class="ttc" id="agrid_2tria_8h_html"><div class="ttname"><a href="grid_2tria_8h.html">tria.h</a></div></div>
<div class="ttc" id="agrid__generator_8h_html"><div class="ttname"><a href="grid__generator_8h.html">grid_generator.h</a></div></div>
<div class="ttc" id="ainclude_2deal_8II_2base_2utilities_8h_html"><div class="ttname"><a href="include_2deal_8II_2base_2utilities_8h.html">utilities.h</a></div></div>
<div class="ttc" id="alogstream_8h_html"><div class="ttname"><a href="logstream_8h.html">logstream.h</a></div></div>
<div class="ttc" id="anumerics_2data__out_8h_html"><div class="ttname"><a href="numerics_2data__out_8h.html">data_out.h</a></div></div>
<div class="ttc" id="atimer_8h_html"><div class="ttname"><a href="timer_8h.html">timer.h</a></div></div>
<div class="ttc" id="avector_8h_html"><div class="ttname"><a href="vector_8h.html">vector.h</a></div></div>
<div class="ttc" id="avector__tools_8h_html"><div class="ttname"><a href="vector__tools_8h.html">vector_tools.h</a></div></div>
</div><!-- fragment --><p>This includes the data structures for the efficient implementation of matrix-free methods.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="la__parallel__vector_8h.html">deal.II/lac/la_parallel_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="matrix__free_8h.html">deal.II/matrix_free/matrix_free.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__evaluation_8h.html">deal.II/matrix_free/fe_evaluation.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iomanip&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>Step48</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="ttc" id="afe__evaluation_8h_html"><div class="ttname"><a href="fe__evaluation_8h.html">fe_evaluation.h</a></div></div>
<div class="ttc" id="ala__parallel__vector_8h_html"><div class="ttname"><a href="la__parallel__vector_8h.html">la_parallel_vector.h</a></div></div>
<div class="ttc" id="amatrix__free_8h_html"><div class="ttname"><a href="matrix__free_8h.html">matrix_free.h</a></div></div>
<div class="ttc" id="anamespacedealii_html"><div class="ttname"><a href="namespacedealii.html">dealii</a></div><div class="ttdef"><b>Definition:</b> <a href="namespace__dealii_8h_source.html#l00025">namespace_dealii.h:26</a></div></div>
</div><!-- fragment --><p>We start by defining two global variables to collect all parameters subject to changes at one place: One for the dimension and one for the finite element degree. The dimension is used in the main function as a template argument for the actual classes (like in all other deal.II programs), whereas the degree of the finite element is more crucial, as it is passed as a template argument to the implementation of the Sine-Gordon operator. Therefore, it needs to be a compile-time constant.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dimension = 2;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fe_degree = 4;</div>
</div><!-- fragment --><p><a class="anchor" id="SineGordonOperation"></a> </p><h3>SineGordonOperation</h3>
<p>The <code>SineGordonOperation</code> class implements the cell-based operation that is needed in each time step. This nonlinear operation can be implemented straight-forwardly based on the <code><a class="el" href="classMatrixFree.html">MatrixFree</a></code> class, in the same way as a linear operation would be treated by this implementation of the finite element operator application. We apply two template arguments to the class, one for the dimension and one for the degree of the finite element. This is a difference to other functions in deal.II where only the dimension is a template argument. This is necessary to provide the inner loops in <code><a class="el" href="classFEEvaluation.html">FEEvaluation</a></code> with information about loop lengths etc., which is essential for efficiency. On the other hand, it makes it more challenging to implement the degree as a run-time parameter.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line"><span class="keyword">class </span>SineGordonOperation</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  SineGordonOperation(<span class="keyword">const</span> <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim, double&gt;</a> &amp;data_in,</div>
<div class="line">                      <span class="keyword">const</span> <span class="keywordtype">double</span>                   time_step);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespacestd__cxx17.html#aa2fc1031c06af4aea4de90c5a1905473">apply</a>(<a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> &amp;dst,</div>
<div class="line">             <span class="keyword">const</span> std::vector&lt;<a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> *&gt;</div>
<div class="line">               &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim, double&gt;</a> &amp;            data;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;double&gt;</a>              delta_t_sqr;</div>
<div class="line">  <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> inv_mass_matrix;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> local_apply(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim, double&gt;</a> &amp;                                  data,</div>
<div class="line">    <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> &amp;                     dst,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;<a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> *&gt; &amp;src,</div>
<div class="line">    <span class="keyword">const</span> std::pair&lt;unsigned int, unsigned int&gt; &amp;cell_range) <span class="keyword">const</span>;</div>
<div class="line">};</div>
<div class="ttc" id="aclassLinearAlgebra_1_1distributed_1_1Vector_html"><div class="ttname"><a href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="la__parallel__vector_8h_source.html#l00248">la_parallel_vector.h:250</a></div></div>
<div class="ttc" id="aclassMatrixFree_html"><div class="ttname"><a href="classMatrixFree.html">MatrixFree</a></div><div class="ttdef"><b>Definition:</b> <a href="matrix__free_8h_source.html#l00116">matrix_free.h:117</a></div></div>
<div class="ttc" id="aclassVectorizedArray_html"><div class="ttname"><a href="classVectorizedArray.html">VectorizedArray</a></div><div class="ttdef"><b>Definition:</b> <a href="vectorization_8h_source.html#l00389">vectorization.h:391</a></div></div>
<div class="ttc" id="anamespacestd__cxx17_html_aa2fc1031c06af4aea4de90c5a1905473"><div class="ttname"><a href="namespacestd__cxx17.html#aa2fc1031c06af4aea4de90c5a1905473">std_cxx17::apply</a></div><div class="ttdeci">auto apply(F &amp;&amp;fn, Tuple &amp;&amp;t) -&gt; decltype(apply_impl(std::forward&lt; F &gt;(fn), std::forward&lt; Tuple &gt;(t), std::make_index_sequence&lt; std::tuple_size&lt; typename std::remove_reference&lt; Tuple &gt;::type &gt;::value &gt;()))</div><div class="ttdef"><b>Definition:</b> <a href="tuple_8h_source.html#l00036">tuple.h:36</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="SineGordonOperationSineGordonOperation"></a> </p><h4>SineGordonOperation::SineGordonOperation</h4>
<p>This is the constructor of the SineGordonOperation class. It receives a reference to the <a class="el" href="classMatrixFree.html">MatrixFree</a> holding the problem information and the time step size as input parameters. The initialization routine sets up the mass matrix. Since we use Gauss-Lobatto elements, the mass matrix is a diagonal matrix and can be stored as a vector. The computation of the mass matrix diagonal is simple to achieve with the data structures provided by <a class="el" href="classFEEvaluation.html">FEEvaluation</a>: Just loop over all cell batches, i.e., collections of cells due to SIMD vectorization, and integrate over the function that is constant one on all quadrature points by using the <code>integrate</code> function with <code>true</code> argument at the slot for values. Finally, we invert the diagonal entries to have the inverse mass matrix directly available in each time step.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line">SineGordonOperation&lt;dim, fe_degree&gt;::SineGordonOperation(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim, double&gt;</a> &amp;data_in,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>                   time_step)</div>
<div class="line">  : data(data_in)</div>
<div class="line">  , delta_t_sqr(<a class="code" href="classVectorizedArray.html#ad7d7e08942faeecf438c75a254e06cbe">make_vectorized_array</a>(time_step * time_step))</div>
<div class="line">{</div>
<div class="line">  data.initialize_dof_vector(inv_mass_matrix);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEEvaluation.html">FEEvaluation&lt;dim, fe_degree&gt;</a> fe_eval(data);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>           n_q_points = fe_eval.n_q_points;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cell = 0; cell &lt; data.n_cell_batches(); ++cell)</div>
<div class="line">    {</div>
<div class="line">      fe_eval.reinit(cell);</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_q_points; ++q)</div>
<div class="line">        fe_eval.submit_value(<a class="code" href="classVectorizedArray.html#ad7d7e08942faeecf438c75a254e06cbe">make_vectorized_array</a>(1.), q);</div>
<div class="line">      fe_eval.integrate(<a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">EvaluationFlags::values</a>);</div>
<div class="line">      fe_eval.distribute_local_to_global(inv_mass_matrix);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  inv_mass_matrix.compress(<a class="code" href="group__Vectors.html#gga40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; inv_mass_matrix.locally_owned_size(); ++k)</div>
<div class="line">    <span class="keywordflow">if</span> (inv_mass_matrix.local_element(k) &gt; 1<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">e</a>-15)</div>
<div class="line">      inv_mass_matrix.local_element(k) =</div>
<div class="line">        1. / inv_mass_matrix.local_element(k);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      inv_mass_matrix.local_element(k) = 1;</div>
<div class="line">}</div>
<div class="ttc" id="aclassFEEvaluation_html"><div class="ttname"><a href="classFEEvaluation.html">FEEvaluation</a></div><div class="ttdef"><b>Definition:</b> <a href="fe__evaluation_8h_source.html#l02511">fe_evaluation.h:2516</a></div></div>
<div class="ttc" id="aclassVectorizedArray_html_ad7d7e08942faeecf438c75a254e06cbe"><div class="ttname"><a href="classVectorizedArray.html#ad7d7e08942faeecf438c75a254e06cbe">VectorizedArray::make_vectorized_array</a></div><div class="ttdeci">VectorizedArray&lt; Number, width &gt; make_vectorized_array(const Number &amp;u)</div><div class="ttdef"><b>Definition:</b> <a href="vectorization_8h_source.html#l00721">vectorization.h:721</a></div></div>
<div class="ttc" id="agroup__Vectors_html_gga40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708"><div class="ttname"><a href="group__Vectors.html#gga40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a></div><div class="ttdeci">@ add</div><div class="ttdef"><b>Definition:</b> <a href="vector__operation_8h_source.html#l00053">vector_operation.h:53</a></div></div>
<div class="ttc" id="anamespaceEvaluationFlags_html_a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58"><div class="ttname"><a href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">EvaluationFlags::values</a></div><div class="ttdeci">@ values</div><div class="ttdef"><b>Definition:</b> <a href="evaluation__flags_8h_source.html#l00051">evaluation_flags.h:51</a></div></div>
<div class="ttc" id="anamespacePhysics_1_1Elasticity_1_1Kinematics_html_a9587d5229555daa5b1fa1ba2f8a40adb"><div class="ttname"><a href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">Physics::Elasticity::Kinematics::e</a></div><div class="ttdeci">SymmetricTensor&lt; 2, dim, Number &gt; e(const Tensor&lt; 2, dim, Number &gt; &amp;F)</div></div>
</div><!-- fragment --><p><a class="anchor" id="SineGordonOperationlocal_apply"></a> </p><h4>SineGordonOperation::local_apply</h4>
<p>This operator implements the core operation of the program, the integration over a range of cells for the nonlinear operator of the Sine-Gordon problem. The implementation is based on the <a class="el" href="classFEEvaluation.html">FEEvaluation</a> class as in <a class="el" href="step_37.html">step-37</a>. Due to the special structure in Gauss-Lobatto elements, certain operations become simpler, in particular the evaluation of shape function values on quadrature points which is simply the injection of the values of cell degrees of freedom. The <a class="el" href="classMatrixFree.html">MatrixFree</a> class detects possible structure of the finite element at quadrature points when initializing, which is then automatically used by <a class="el" href="classFEEvaluation.html">FEEvaluation</a> for selecting the most appropriate numerical kernel.</p>
<p>The nonlinear function that we have to evaluate for the time stepping routine includes the value of the function at the present time <code>current</code> as well as the value at the previous time step <code>old</code>. Both values are passed to the operator in the collection of source vectors <code>src</code>, which is simply a <code>std::vector</code> of pointers to the actual solution vectors. This construct of collecting several source vectors into one is necessary as the cell loop in <code><a class="el" href="classMatrixFree.html">MatrixFree</a></code> takes exactly one source and one destination vector, even if we happen to use many vectors like the two in this case. Note that the cell loop accepts any valid class for input and output, which does not only include vectors but general data types. However, only in case it encounters a LinearAlgebra::distributed::Vector&lt;Number&gt; or a <code>std::vector</code> collecting these vectors, it calls functions that exchange ghost data due to MPI at the beginning and the end of the loop. In the loop over the cells, we first have to read in the values in the vectors related to the local values. Then, we evaluate the value and the gradient of the current solution vector and the values of the old vector at the quadrature points. Next, we combine the terms in the scheme in the loop over the quadrature points. Finally, we integrate the result against the test function and accumulate the result to the global solution vector <code>dst</code>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line"><span class="keywordtype">void</span> SineGordonOperation&lt;dim, fe_degree&gt;::local_apply(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim&gt;</a> &amp;                                          data,</div>
<div class="line">  <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> &amp;                     dst,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;<a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> *&gt; &amp;src,</div>
<div class="line">  <span class="keyword">const</span> std::pair&lt;unsigned int, unsigned int&gt; &amp;cell_range)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(src.size(), 2);</div>
<div class="line">  <a class="code" href="classFEEvaluation.html">FEEvaluation&lt;dim, fe_degree&gt;</a> current(data), old(data);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cell = cell_range.first; cell &lt; cell_range.second; ++cell)</div>
<div class="line">    {</div>
<div class="line">      current.reinit(cell);</div>
<div class="line">      old.reinit(cell);</div>
<div class="line"> </div>
<div class="line">      current.read_dof_values(*src[0]);</div>
<div class="line">      old.read_dof_values(*src[1]);</div>
<div class="line"> </div>
<div class="line">      current.evaluate(<a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">EvaluationFlags::values</a> | <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aea91b5f00e4be473005cc331b8644ab2f1">EvaluationFlags::gradients</a>);</div>
<div class="line">      old.evaluate(<a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">EvaluationFlags::values</a>);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; current.n_q_points; ++q)</div>
<div class="line">        {</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;double&gt;</a> current_value = current.get_value(q);</div>
<div class="line">          <span class="keyword">const</span> <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;double&gt;</a> old_value     = old.get_value(q);</div>
<div class="line"> </div>
<div class="line">          current.submit_value(2. * current_value - old_value -</div>
<div class="line">                                 delta_t_sqr * std::sin(current_value),</div>
<div class="line">                               q);</div>
<div class="line">          current.submit_gradient(-delta_t_sqr * current.get_gradient(q), q);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">      current.integrate(<a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">EvaluationFlags::values</a> | <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aea91b5f00e4be473005cc331b8644ab2f1">EvaluationFlags::gradients</a>);</div>
<div class="line">      current.distribute_local_to_global(dst);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="agroup__Exceptions_html_ga9442b63275c9ef3fab29bc222831c49c"><div class="ttname"><a href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a></div><div class="ttdeci">#define AssertDimension(dim1, dim2)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01630">exceptions.h:1630</a></div></div>
<div class="ttc" id="anamespaceEvaluationFlags_html_a9b7c6d689cb76386839d0d13640f59aea91b5f00e4be473005cc331b8644ab2f1"><div class="ttname"><a href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aea91b5f00e4be473005cc331b8644ab2f1">EvaluationFlags::gradients</a></div><div class="ttdeci">@ gradients</div><div class="ttdef"><b>Definition:</b> <a href="evaluation__flags_8h_source.html#l00055">evaluation_flags.h:55</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="SineGordonOperationapply"></a> </p><h4>SineGordonOperation::apply</h4>
<p>This function performs the time stepping routine based on the cell-local strategy. Note that we need to set the destination vector to zero before we add the integral contributions of the current time step (via the <a class="el" href="classFEEvaluationBase.html#a13c9d8eac4ca7b3f7d45eda97ea8e2fb">FEEvaluation::distribute_local_to_global()</a> call). In this tutorial, we let the cell-loop do the zero operation via the fifth <code>true</code> argument passed to <a class="el" href="classMatrixFree.html#abc204ec41ead1b5060f47ef3a5a066d7">MatrixFree::cell_loop</a>. The loop can schedule the zero operation closer to the operations on vector entries for supported vector entries, thereby possibly increasing data locality (the vector entries that first get zeroed are later re-used in the <code>distribute_local_to_global()</code> call). The structure of the cell loop is implemented in the cell finite element operator class. On each cell it applies the routine defined as the <code>local_apply()</code> method of the class <code>SineGordonOperation</code>, i.e., <code>this</code>. One could also provide a function with the same signature that is not part of a class. Finally, the result of the integration is multiplied by the inverse mass matrix.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="namespacestd__cxx17.html#aa2fc1031c06af4aea4de90c5a1905473">SineGordonOperation&lt;dim, fe_degree&gt;::apply</a>(</div>
<div class="line">  <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> &amp;                     dst,</div>
<div class="line">  <span class="keyword">const</span> std::vector&lt;<a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> *&gt; &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  data.<a class="code" href="classMatrixFree.html#abc204ec41ead1b5060f47ef3a5a066d7">cell_loop</a>(</div>
<div class="line">    &amp;SineGordonOperation&lt;dim, fe_degree&gt;::local_apply, <span class="keyword">this</span>, dst, src, <span class="keyword">true</span>);</div>
<div class="line">  dst.<a class="code" href="group__Vectors.html#gaacdf6bfd4533c47587ba0debe177710e">scale</a>(inv_mass_matrix);</div>
<div class="line">}</div>
<div class="ttc" id="aclassMatrixFree_html_abc204ec41ead1b5060f47ef3a5a066d7"><div class="ttname"><a href="classMatrixFree.html#abc204ec41ead1b5060f47ef3a5a066d7">MatrixFree::cell_loop</a></div><div class="ttdeci">void cell_loop(const std::function&lt; void(const MatrixFree&lt; dim, Number, VectorizedArrayType &gt; &amp;, OutVector &amp;, const InVector &amp;, const std::pair&lt; unsigned int, unsigned int &gt; &amp;)&gt; &amp;cell_operation, OutVector &amp;dst, const InVector &amp;src, const bool zero_dst_vector=false) const</div></div>
<div class="ttc" id="agroup__Vectors_html_gaacdf6bfd4533c47587ba0debe177710e"><div class="ttname"><a href="group__Vectors.html#gaacdf6bfd4533c47587ba0debe177710e">LinearAlgebra::distributed::Vector::scale</a></div><div class="ttdeci">virtual void scale(const VectorSpaceVector&lt; Number &gt; &amp;scaling_factors) override</div></div>
</div><!-- fragment --><p><a class="anchor" id="Equationdata"></a> </p><h3>Equation data</h3>
<p>We define a time-dependent function that is used as initial value. Different solutions can be obtained by varying the starting time. This function, taken from <a class="el" href="step_25.html">step-25</a>, would represent an analytic solution in 1D for all times, but is merely used for setting some starting solution of interest here. More elaborate choices that could test the convergence of this program are given in <a class="el" href="step_25.html">step-25</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>InitialCondition : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  InitialCondition(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_components = 1,</div>
<div class="line">                   <span class="keyword">const</span> <span class="keywordtype">double</span>       time         = 0.)</div>
<div class="line">    : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(n_components, time)</div>
<div class="line">  {}</div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div>
<div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordtype">double</span> t = this-&gt;<a class="code" href="classFunctionTime.html#ae7d37ddb04314b38cf67c6cba22923f6">get_time</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> m  = 0.5;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> c1 = 0.;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> c2 = 0.;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> factor =</div>
<div class="line">      (m / <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">std::sqrt</a>(1. - m * m) * <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">std::sin</a>(std::sqrt(1. - m * m) * t + c2));</div>
<div class="line">    <span class="keywordtype">double</span> result = 1.;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> &lt; dim; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div>
<div class="line">      result *= -4. * <a class="code" href="namespaceDifferentiation_1_1SD.html#a803fcea270d7a523a91e3b7c173059f9">std::atan</a>(factor / <a class="code" href="namespaceDifferentiation_1_1SD.html#a26c1f7a69dc8ac2e16144493d3b3b896">std::cosh</a>(m * p[<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] + c1));</div>
<div class="line">    <span class="keywordflow">return</span> result;</div>
<div class="line">  }</div>
<div class="line">};</div>
<div class="ttc" id="aclassFunctionTime_html_ae7d37ddb04314b38cf67c6cba22923f6"><div class="ttname"><a href="classFunctionTime.html#ae7d37ddb04314b38cf67c6cba22923f6">FunctionTime&lt; numbers::NumberTraits&lt; double &gt;::real_type &gt;::get_time</a></div><div class="ttdeci">numbers::NumberTraits&lt; double &gt;::real_type get_time() const</div></div>
<div class="ttc" id="aclassFunction_html"><div class="ttname"><a href="classFunction.html">Function</a></div><div class="ttdef"><b>Definition:</b> <a href="function_8h_source.html#l00150">function.h:153</a></div></div>
<div class="ttc" id="aclassFunction_html_acbfcab66b2fc63bfea59268f40772bb4"><div class="ttname"><a href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">Function::value</a></div><div class="ttdeci">virtual RangeNumberType value(const Point&lt; dim &gt; &amp;p, const unsigned int component=0) const</div></div>
<div class="ttc" id="aclassPoint_html"><div class="ttname"><a href="classPoint.html">Point</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2point_8h_source.html#l00110">point.h:111</a></div></div>
<div class="ttc" id="anamespaceDifferentiation_1_1SD_html_a26c1f7a69dc8ac2e16144493d3b3b896"><div class="ttname"><a href="namespaceDifferentiation_1_1SD.html#a26c1f7a69dc8ac2e16144493d3b3b896">Differentiation::SD::cosh</a></div><div class="ttdeci">Expression cosh(const Expression &amp;x)</div><div class="ttdef"><b>Definition:</b> <a href="symengine__math_8cc_source.html#l00189">symengine_math.cc:189</a></div></div>
<div class="ttc" id="anamespaceDifferentiation_1_1SD_html_a803fcea270d7a523a91e3b7c173059f9"><div class="ttname"><a href="namespaceDifferentiation_1_1SD.html#a803fcea270d7a523a91e3b7c173059f9">Differentiation::SD::atan</a></div><div class="ttdeci">Expression atan(const Expression &amp;x)</div><div class="ttdef"><b>Definition:</b> <a href="symengine__math_8cc_source.html#l00147">symengine_math.cc:147</a></div></div>
<div class="ttc" id="anamespacePhysics_1_1Elasticity_1_1Kinematics_html_a15728437b942dab0b0042eb06a407d2c"><div class="ttname"><a href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">Physics::Elasticity::Kinematics::d</a></div><div class="ttdeci">SymmetricTensor&lt; 2, dim, Number &gt; d(const Tensor&lt; 2, dim, Number &gt; &amp;F, const Tensor&lt; 2, dim, Number &gt; &amp;dF_dt)</div></div>
<div class="ttc" id="anumbers_8h_html_a27989bdc7b4b828564982787d126bd91"><div class="ttname"><a href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">std::sin</a></div><div class="ttdeci">::VectorizedArray&lt; Number, width &gt; sin(const ::VectorizedArray&lt; Number, width &gt; &amp;)</div><div class="ttdef"><b>Definition:</b> <a href="vectorization_8h_source.html#l05291">vectorization.h:5291</a></div></div>
<div class="ttc" id="anumbers_8h_html_ac4a2ed1890a931d0b6a55933310eadca"><div class="ttname"><a href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">std::sqrt</a></div><div class="ttdeci">::VectorizedArray&lt; Number, width &gt; sqrt(const ::VectorizedArray&lt; Number, width &gt; &amp;)</div><div class="ttdef"><b>Definition:</b> <a href="vectorization_8h_source.html#l05406">vectorization.h:5406</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="SineGordonProblemclass"></a> </p><h3>SineGordonProblem class</h3>
<p>This is the main class that builds on the class in <a class="el" href="step_25.html">step-25</a>. However, we replaced the <a class="el" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> class by the <a class="el" href="classMatrixFree.html">MatrixFree</a> class to store the geometry data. Also, we use a distributed triangulation in this example.</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>SineGordonProblem</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    SineGordonProblem();</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <a class="code" href="classConditionalOStream.html">ConditionalOStream</a> pcout;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> make_grid_and_dofs();</div>
<div class="line">    <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef DEAL_II_WITH_P4EST</span></div>
<div class="line">    <a class="code" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>       fe;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a> dof_handler;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classMappingQ1.html">MappingQ1&lt;dim&gt;</a> mapping;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div>
<div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a>                  locally_relevant_dofs;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim, double&gt;</a> matrix_free_data;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> solution, old_solution,</div>
<div class="line">      old_old_solution;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_global_refinements;</div>
<div class="line">    <span class="keywordtype">double</span>             time, time_step;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>       final_time;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>       cfl_number;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> output_timestep_skip;</div>
<div class="line">  };</div>
<div class="ttc" id="aclassAffineConstraints_html"><div class="ttname"><a href="classAffineConstraints.html">AffineConstraints&lt; double &gt;</a></div></div>
<div class="ttc" id="aclassConditionalOStream_html"><div class="ttname"><a href="classConditionalOStream.html">ConditionalOStream</a></div><div class="ttdef"><b>Definition:</b> <a href="conditional__ostream_8h_source.html#l00080">conditional_ostream.h:81</a></div></div>
<div class="ttc" id="aclassDoFHandler_html"><div class="ttname"><a href="classDoFHandler.html">DoFHandler</a></div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__handler_8h_source.html#l00314">dof_handler.h:315</a></div></div>
<div class="ttc" id="aclassFE__Q_html"><div class="ttname"><a href="classFE__Q.html">FE_Q</a></div><div class="ttdef"><b>Definition:</b> <a href="fe__q_8h_source.html#l00548">fe_q.h:549</a></div></div>
<div class="ttc" id="aclassIndexSet_html"><div class="ttname"><a href="classIndexSet.html">IndexSet</a></div><div class="ttdef"><b>Definition:</b> <a href="index__set_8h_source.html#l00072">index_set.h:73</a></div></div>
<div class="ttc" id="aclassMappingQ1_html"><div class="ttname"><a href="classMappingQ1.html">MappingQ1</a></div><div class="ttdef"><b>Definition:</b> <a href="mapping__q1_8h_source.html#l00054">mapping_q1.h:55</a></div></div>
<div class="ttc" id="aclassTriangulation_html"><div class="ttname"><a href="classTriangulation.html">Triangulation</a></div><div class="ttdef"><b>Definition:</b> <a href="grid_2tria_8h_source.html#l01127">tria.h:1128</a></div></div>
<div class="ttc" id="aclassparallel_1_1distributed_1_1Triangulation_html"><div class="ttname"><a href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation</a></div><div class="ttdef"><b>Definition:</b> <a href="distributed_2tria_8h_source.html#l00252">tria.h:254</a></div></div>
<div class="ttc" id="anamespaceWorkStream_1_1internal_1_1tbb__no__coloring_html_a8673698a405bf47aa24002aeb6d76d70"><div class="ttname"><a href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">WorkStream::internal::tbb_no_coloring::run</a></div><div class="ttdeci">void run(const Iterator &amp;begin, const typename identity&lt; Iterator &gt;::type &amp;end, Worker worker, Copier copier, const ScratchData &amp;sample_scratch_data, const CopyData &amp;sample_copy_data, const unsigned int queue_length, const unsigned int chunk_size)</div><div class="ttdef"><b>Definition:</b> <a href="work__stream_8h_source.html#l00691">work_stream.h:691</a></div></div>
<div class="ttc" id="ap4est__wrappers_8cc_html_ace00f2f80d9780ef9aa1007e1c22c6a4"><div class="ttname"><a href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a></div><div class="ttdeci">const ::parallel::distributed::Triangulation&lt; dim, spacedim &gt; * triangulation</div><div class="ttdef"><b>Definition:</b> <a href="p4est__wrappers_8cc_source.html#l00069">p4est_wrappers.cc:69</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="SineGordonProblemSineGordonProblem"></a> </p><h4>SineGordonProblem::SineGordonProblem</h4>
<p>This is the constructor of the SineGordonProblem class. The time interval and time step size are defined here. Moreover, we use the degree of the finite element that we defined at the top of the program to initialize a <a class="el" href="classFE__Q.html">FE_Q</a> finite element based on Gauss-Lobatto support points. These points are convenient because in conjunction with a <a class="el" href="classQGaussLobatto.html">QGaussLobatto</a> quadrature rule of the same order they give a diagonal mass matrix without compromising accuracy too much (note that the integration is inexact, though), see also the discussion in the introduction. Note that <a class="el" href="classFE__Q.html">FE_Q</a> selects the Gauss-Lobatto nodal points by default due to their improved conditioning versus equidistant points. To make things more explicit, we state the selection of the nodal points nonetheless.</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  SineGordonProblem&lt;dim&gt;::SineGordonProblem()</div>
<div class="line">    : pcout(std::cout, <a class="code" href="namespaceUtilities.html">Utilities</a>::MPI::<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">this_mpi_process</a>(MPI_COMM_WORLD) == 0)</div>
<div class="line">    ,</div>
<div class="line">#ifdef DEAL_II_WITH_P4EST</div>
<div class="line">    <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>(MPI_COMM_WORLD)</div>
<div class="line">    ,</div>
<div class="line">#endif</div>
<div class="line">    fe(<a class="code" href="classQGaussLobatto.html">QGaussLobatto</a>&lt;1&gt;(fe_degree + 1))</div>
<div class="line">    , dof_handler(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>)</div>
<div class="line">    , n_global_refinements(10 - 2 * dim)</div>
<div class="line">    , time(-10)</div>
<div class="line">    , time_step(10.)</div>
<div class="line">    , final_time(10.)</div>
<div class="line">    , cfl_number(.1 / fe_degree)</div>
<div class="line">    , output_timestep_skip(200)</div>
<div class="line">  {}</div>
<div class="ttc" id="aclassQGaussLobatto_html"><div class="ttname"><a href="classQGaussLobatto.html">QGaussLobatto</a></div><div class="ttdef"><b>Definition:</b> <a href="quadrature__lib_8h_source.html#l00072">quadrature_lib.h:73</a></div></div>
<div class="ttc" id="anamespaceUtilities_1_1MPI_html_a895dcd8223a0ee6f0e6a80b80e2d5982"><div class="ttname"><a href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a></div><div class="ttdeci">unsigned int this_mpi_process(const MPI_Comm &amp;mpi_communicator)</div><div class="ttdef"><b>Definition:</b> <a href="mpi_8cc_source.html#l00128">mpi.cc:128</a></div></div>
<div class="ttc" id="anamespaceUtilities_html"><div class="ttname"><a href="namespaceUtilities.html">Utilities</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2communication__pattern__base_8h_source.html#l00030">communication_pattern_base.h:31</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="SineGordonProblemmake_grid_and_dofs"></a> </p><h4>SineGordonProblem::make_grid_and_dofs</h4>
<p>As in <a class="el" href="step_25.html">step-25</a> this functions sets up a cube grid in <code>dim</code> dimensions of extent \([-15,15]\). We refine the mesh more in the center of the domain since the solution is concentrated there. We first refine all cells whose center is within a radius of 11, and then refine once more for a radius 6. This simple ad hoc refinement could be done better by adapting the mesh to the solution using error estimators during the time stepping as done in other example programs, and using <a class="el" href="classparallel_1_1distributed_1_1SolutionTransfer.html">parallel::distributed::SolutionTransfer</a> to transfer the solution to the new mesh.</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> SineGordonProblem&lt;dim&gt;::make_grid_and_dofs()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>, -15, 15);</div>
<div class="line">    <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.refine_global(n_global_refinements);</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">typename</span> <a class="code" href="classTriaActiveIterator.html">Triangulation&lt;dim&gt;::active_cell_iterator</a></div>
<div class="line">        cell     = <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.begin_active(),</div>
<div class="line">        end_cell = <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.end();</div>
<div class="line">      <span class="keywordflow">for</span> (; cell != end_cell; ++cell)</div>
<div class="line">        <span class="keywordflow">if</span> (cell-&gt;is_locally_owned())</div>
<div class="line">          <span class="keywordflow">if</span> (cell-&gt;center().norm() &lt; 11)</div>
<div class="line">            cell-&gt;set_refine_flag();</div>
<div class="line">      <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line"> </div>
<div class="line">      cell     = <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.begin_active();</div>
<div class="line">      end_cell = <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.end();</div>
<div class="line">      <span class="keywordflow">for</span> (; cell != end_cell; ++cell)</div>
<div class="line">        <span class="keywordflow">if</span> (cell-&gt;is_locally_owned())</div>
<div class="line">          <span class="keywordflow">if</span> (cell-&gt;center().norm() &lt; 6)</div>
<div class="line">            cell-&gt;set_refine_flag();</div>
<div class="line">      <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Number of global active cells: &quot;</span></div>
<div class="line"><span class="preprocessor">#ifdef DEAL_II_WITH_P4EST</span></div>
<div class="line">          &lt;&lt; <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_global_active_cells()</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">          &lt;&lt; <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells()</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">          &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    dof_handler.distribute_dofs(fe);</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.n_dofs()</div>
<div class="line">          &lt;&lt; std::endl;</div>
<div class="ttc" id="aclassTriaActiveIterator_html"><div class="ttname"><a href="classTriaActiveIterator.html">TriaActiveIterator</a></div><div class="ttdef"><b>Definition:</b> <a href="tria__iterator_8h_source.html#l00758">tria_iterator.h:759</a></div></div>
<div class="ttc" id="anamespaceGridGenerator_html_acea0cbcd68e52ce8113d1134b87de403"><div class="ttname"><a href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a></div><div class="ttdeci">void hyper_cube(Triangulation&lt; dim, spacedim &gt; &amp;tria, const double left=0., const double right=1., const bool colorize=false)</div></div>
</div><!-- fragment --><p>We generate hanging node constraints for ensuring continuity of the solution. As in <a class="el" href="step_40.html">step-40</a>, we need to equip the constraint matrix with the <a class="el" href="classIndexSet.html">IndexSet</a> of locally relevant degrees of freedom to avoid it to consume too much memory for big problems. Next, the <code> <a class="el" href="classMatrixFree.html">MatrixFree</a> </code> object for the problem is set up. Note that we specify a particular scheme for shared-memory parallelization (hence one would use multithreading for intra-node parallelism and not MPI; we here choose the standard option &mdash; if we wanted to disable shared memory parallelization even in case where there is more than one TBB thread available in the program, we would choose MatrixFree::AdditionalData::TasksParallelScheme::none). Also note that, instead of using the default <a class="el" href="classQGauss.html">QGauss</a> quadrature argument, we supply a <a class="el" href="classQGaussLobatto.html">QGaussLobatto</a> quadrature formula to enable the desired behavior. Finally, three solution vectors are initialized. <a class="el" href="classMatrixFree.html">MatrixFree</a> expects a particular layout of ghost indices (as it handles index access in MPI-local numbers that need to match between the vector and <a class="el" href="classMatrixFree.html">MatrixFree</a>), so we just ask it to initialize the vectors to be sure the ghost exchange is properly handled.</p>
<div class="fragment"><div class="line">  <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(dof_handler, locally_relevant_dofs);</div>
<div class="line">  constraints.clear();</div>
<div class="line">  constraints.reinit(locally_relevant_dofs);</div>
<div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div>
<div class="line">  constraints.close();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">typename</span> <a class="code" href="structMatrixFree_1_1AdditionalData.html">MatrixFree&lt;dim&gt;::AdditionalData</a> additional_data;</div>
<div class="line">  additional_data.<a class="code" href="structMatrixFree_1_1AdditionalData.html#a0bcce2facca91b925d3e1a5a00c7704b">tasks_parallel_scheme</a> =</div>
<div class="line">    <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim&gt;::AdditionalData::TasksParallelScheme::partition_partition</a>;</div>
<div class="line"> </div>
<div class="line">  matrix_free_data.<a class="code" href="classMatrixFree.html#adb324d469b296f2a6921b41208732ddf">reinit</a>(mapping,</div>
<div class="line">                          dof_handler,</div>
<div class="line">                          constraints,</div>
<div class="line">                          <a class="code" href="classQGaussLobatto.html">QGaussLobatto&lt;1&gt;</a>(fe_degree + 1),</div>
<div class="line">                          additional_data);</div>
<div class="line"> </div>
<div class="line">  matrix_free_data.initialize_dof_vector(solution);</div>
<div class="line">  old_solution.reinit(solution);</div>
<div class="line">  old_old_solution.reinit(solution);</div>
<div class="line">}</div>
<div class="ttc" id="aclassMatrixFree_html_adb324d469b296f2a6921b41208732ddf"><div class="ttname"><a href="classMatrixFree.html#adb324d469b296f2a6921b41208732ddf">MatrixFree::reinit</a></div><div class="ttdeci">void reinit(const MappingType &amp;mapping, const DoFHandler&lt; dim &gt; &amp;dof_handler, const AffineConstraints&lt; number2 &gt; &amp;constraint, const QuadratureType &amp;quad, const AdditionalData &amp;additional_data=AdditionalData())</div></div>
<div class="ttc" id="agroup__constraints_html_ga3b4ea7dfd313e388d868c4e4aa685799"><div class="ttname"><a href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a></div><div class="ttdeci">void make_hanging_node_constraints(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, AffineConstraints&lt; number &gt; &amp;constraints)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__constraints_8cc_source.html#l01787">dof_tools_constraints.cc:1787</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_acad7e0841b9046eaafddc4c617ab1d9d"><div class="ttname"><a href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a></div><div class="ttdeci">void extract_locally_relevant_dofs(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, IndexSet &amp;dof_set)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools_8cc_source.html#l01210">dof_tools.cc:1210</a></div></div>
<div class="ttc" id="astructMatrixFree_1_1AdditionalData_html"><div class="ttname"><a href="structMatrixFree_1_1AdditionalData.html">MatrixFree::AdditionalData</a></div><div class="ttdef"><b>Definition:</b> <a href="matrix__free_8h_source.html#l00181">matrix_free.h:182</a></div></div>
<div class="ttc" id="astructMatrixFree_1_1AdditionalData_html_a0bcce2facca91b925d3e1a5a00c7704b"><div class="ttname"><a href="structMatrixFree_1_1AdditionalData.html#a0bcce2facca91b925d3e1a5a00c7704b">MatrixFree::AdditionalData::tasks_parallel_scheme</a></div><div class="ttdeci">TasksParallelScheme tasks_parallel_scheme</div><div class="ttdef"><b>Definition:</b> <a href="matrix__free_8h_source.html#l00344">matrix_free.h:344</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="SineGordonProblemoutput_results"></a> </p><h4>SineGordonProblem::output_results</h4>
<p>This function prints the norm of the solution and writes the solution vector to a file. The norm is standard (except for the fact that we need to accumulate the norms over all processors for the parallel grid which we do via the <a class="el" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error()</a> function), and the second is similar to what we did in <a class="el" href="step_40.html">step-40</a> or <a class="el" href="step_37.html">step-37</a>. Note that we can use the same vector for output as the one used during computations: The vectors in the matrix-free framework always provide full information on all locally owned cells (this is what is needed in the local evaluations, too), including ghost vector entries on these cells. This is the only data that is needed in the <a class="el" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference()</a> function as well as in <a class="el" href="classDataOut.html">DataOut</a>. The only action to take at this point is to make sure that the vector updates its ghost values before we read from them, and to reset ghost values once done. This is a feature present only in the <a class="el" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector</a> class. Distributed vectors with PETSc and Trilinos, on the other hand, need to be copied to special vectors including ghost values (see the relevant section in <a class="el" href="step_40.html">step-40</a>). If we also wanted to access all degrees of freedom on ghost cells (e.g. when computing error estimators that use the jump of solution over cell boundaries), we would need more information and create a vector initialized with locally relevant dofs just as in <a class="el" href="step_40.html">step-40</a>. Observe also that we need to distribute constraints for output - they are not filled during computations (rather, they are interpolated on the fly in the matrix-free method <a class="el" href="classFEEvaluationBase.html#a5c3bf28ebceb0271addfba5b92f475ce">FEEvaluation::read_dof_values()</a>).</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">SineGordonProblem&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number)</div>
<div class="line">{</div>
<div class="line">  constraints.distribute(solution);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> norm_per_cell(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells());</div>
<div class="line">  solution.update_ghost_values();</div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(mapping,</div>
<div class="line">                                    dof_handler,</div>
<div class="line">                                    solution,</div>
<div class="line">                                    <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a>(),</div>
<div class="line">                                    norm_per_cell,</div>
<div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe_degree + 1),</div>
<div class="line">                                    <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> solution_norm =</div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>,</div>
<div class="line">                                      norm_per_cell,</div>
<div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div>
<div class="line"> </div>
<div class="line">  pcout &lt;&lt; <span class="stringliteral">&quot;   Time:&quot;</span> &lt;&lt; std::setw(8) &lt;&lt; std::setprecision(3) &lt;&lt; time</div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;, solution norm: &quot;</span> &lt;&lt; std::setprecision(5) &lt;&lt; std::setw(7)</div>
<div class="line">        &lt;&lt; solution_norm &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line"> </div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#ac1eb26168177faa30ffbcf9cbb9c3cd5">attach_dof_handler</a>(dof_handler);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">add_data_vector</a>(solution, <span class="stringliteral">&quot;solution&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#a5eb51872b8736849bb7e8d2007fae086">build_patches</a>(mapping);</div>
<div class="line"> </div>
<div class="line">  data_out.<a class="code" href="group__Exceptions.html#ga0864e51eb173c87e2a3edc9391ea8009">write_vtu_with_pvtu_record</a>(</div>
<div class="line">    <span class="stringliteral">&quot;./&quot;</span>, <span class="stringliteral">&quot;solution&quot;</span>, timestep_number, MPI_COMM_WORLD, 3);</div>
<div class="line"> </div>
<div class="line">  solution.zero_out_ghost_values();</div>
<div class="line">}</div>
<div class="ttc" id="aclassDataOut__DoFData_html_ac1eb26168177faa30ffbcf9cbb9c3cd5"><div class="ttname"><a href="classDataOut__DoFData.html#ac1eb26168177faa30ffbcf9cbb9c3cd5">DataOut_DoFData::attach_dof_handler</a></div><div class="ttdeci">void attach_dof_handler(const DoFHandlerType &amp;)</div></div>
<div class="ttc" id="aclassDataOut__DoFData_html_ace4b76e565ba0701c4d32c26075ed3b9"><div class="ttname"><a href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">DataOut_DoFData::add_data_vector</a></div><div class="ttdeci">void add_data_vector(const VectorType &amp;data, const std::vector&lt; std::string &gt; &amp;names, const DataVectorType type=type_automatic, const std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt; &amp;data_component_interpretation=std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="data__out__dof__data_8h_source.html#l01087">data_out_dof_data.h:1087</a></div></div>
<div class="ttc" id="aclassDataOut_html"><div class="ttname"><a href="classDataOut.html">DataOut</a></div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out_8h_source.html#l00147">data_out.h:150</a></div></div>
<div class="ttc" id="aclassDataOut_html_a5eb51872b8736849bb7e8d2007fae086"><div class="ttname"><a href="classDataOut.html#a5eb51872b8736849bb7e8d2007fae086">DataOut::build_patches</a></div><div class="ttdeci">virtual void build_patches(const unsigned int n_subdivisions=0)</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out_8cc_source.html#l01085">data_out.cc:1085</a></div></div>
<div class="ttc" id="aclassFunctions_1_1ZeroFunction_html"><div class="ttname"><a href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction</a></div><div class="ttdef"><b>Definition:</b> <a href="function_8h_source.html#l00510">function.h:511</a></div></div>
<div class="ttc" id="aclassQGauss_html"><div class="ttname"><a href="classQGauss.html">QGauss</a></div><div class="ttdef"><b>Definition:</b> <a href="quadrature__lib_8h_source.html#l00038">quadrature_lib.h:39</a></div></div>
<div class="ttc" id="aclassVector_html"><div class="ttname"><a href="classVector.html">Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="vector_8h_source.html#l00109">vector.h:110</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga0864e51eb173c87e2a3edc9391ea8009"><div class="ttname"><a href="group__Exceptions.html#ga0864e51eb173c87e2a3edc9391ea8009">DataOutInterface::write_vtu_with_pvtu_record</a></div><div class="ttdeci">std::string write_vtu_with_pvtu_record(const std::string &amp;directory, const std::string &amp;filename_without_extension, const unsigned int counter, const MPI_Comm &amp;mpi_communicator, const unsigned int n_digits_for_counter=numbers::invalid_unsigned_int, const unsigned int n_groups=0) const</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8cc_source.html#l07326">data_out_base.cc:7326</a></div></div>
<div class="ttc" id="anamespaceVectorTools_html_a21eb62d70953182dcc2b15c4e14dd533"><div class="ttname"><a href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a></div><div class="ttdeci">double compute_global_error(const Triangulation&lt; dim, spacedim &gt; &amp;tria, const InVector &amp;cellwise_error, const NormType &amp;norm, const double exponent=2.)</div></div>
<div class="ttc" id="anamespaceVectorTools_html_a676190d2c897ac5da68a9c460fa95832"><div class="ttname"><a href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a></div><div class="ttdeci">void integrate_difference(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const InVector &amp;fe_function, const Function&lt; spacedim, typename InVector::value_type &gt; &amp;exact_solution, OutVector &amp;difference, const Quadrature&lt; dim &gt; &amp;q, const NormType &amp;norm, const Function&lt; spacedim, double &gt; *weight=nullptr, const double exponent=2.)</div></div>
<div class="ttc" id="anamespaceVectorTools_html_a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e"><div class="ttname"><a href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a></div><div class="ttdeci">@ L2_norm</div><div class="ttdef"><b>Definition:</b> <a href="vector__tools__common_8h_source.html#l00113">vector_tools_common.h:113</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="SineGordonProblemrun"></a> </p><h4>SineGordonProblem::run</h4>
<p>This function is called by the main function and steps into the subroutines of the class.</p>
<p>After printing some information about the parallel setup, the first action is to set up the grid and the cell operator. Then, the time step is computed from the CFL number given in the constructor and the finest mesh size. The finest mesh size is computed as the diameter of the last cell in the triangulation, which is the last cell on the finest level of the mesh. This is only possible for meshes where all elements on a level have the same size, otherwise, one needs to loop over all cells. Note that we need to query all the processors for their finest cell since not all processors might hold a region where the mesh is at the finest level. Then, we readjust the time step a little to hit the final time exactly.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">SineGordonProblem&lt;dim&gt;::run</a>()</div>
<div class="line">{</div>
<div class="line">  {</div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;Number of MPI ranks:            &quot;</span></div>
<div class="line">          &lt;&lt; <a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(MPI_COMM_WORLD) &lt;&lt; std::endl;</div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;Number of threads on each rank: &quot;</span></div>
<div class="line">          &lt;&lt; <a class="code" href="classMultithreadInfo.html#ad0b84ae105b385b88bdd4bfc0c530995">MultithreadInfo::n_threads</a>() &lt;&lt; std::endl;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_vect_doubles = <a class="code" href="classVectorizedArrayBase.html#acb35404acc1693aee6e990228924cc09">VectorizedArray&lt;double&gt;::size</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_vect_bits    = 8 * <span class="keyword">sizeof</span>(<a class="code" href="classdouble.html">double</a>) * n_vect_doubles;</div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;Vectorization over &quot;</span> &lt;&lt; n_vect_doubles</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot; doubles = &quot;</span> &lt;&lt; n_vect_bits &lt;&lt; <span class="stringliteral">&quot; bits (&quot;</span></div>
<div class="line">          &lt;&lt; <a class="code" href="namespaceUtilities_1_1System.html#ade631a789101336840371e3b2e2851e0">Utilities::System::get_current_vectorization_level</a>() &lt;&lt; <span class="stringliteral">&quot;)&quot;</span></div>
<div class="line">          &lt;&lt; std::endl</div>
<div class="line">          &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line">  make_grid_and_dofs();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> local_min_cell_diameter =</div>
<div class="line">    <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.last()-&gt;diameter() / <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">std::sqrt</a>(dim);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> global_min_cell_diameter =</div>
<div class="line">    -<a class="code" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a>(-local_min_cell_diameter, MPI_COMM_WORLD);</div>
<div class="line">  time_step = cfl_number * global_min_cell_diameter;</div>
<div class="line">  time_step = (final_time - time) / (<span class="keywordtype">int</span>((final_time - time) / time_step));</div>
<div class="line">  pcout &lt;&lt; <span class="stringliteral">&quot;   Time step size: &quot;</span> &lt;&lt; time_step</div>
<div class="line">        &lt;&lt; <span class="stringliteral">&quot;, finest cell: &quot;</span> &lt;&lt; global_min_cell_diameter &lt;&lt; std::endl</div>
<div class="line">        &lt;&lt; std::endl;</div>
<div class="ttc" id="aclassMultithreadInfo_html_ad0b84ae105b385b88bdd4bfc0c530995"><div class="ttname"><a href="classMultithreadInfo.html#ad0b84ae105b385b88bdd4bfc0c530995">MultithreadInfo::n_threads</a></div><div class="ttdeci">static unsigned int n_threads()</div><div class="ttdef"><b>Definition:</b> <a href="multithread__info_8cc_source.html#l00110">multithread_info.cc:110</a></div></div>
<div class="ttc" id="aclassVectorizedArrayBase_html_acb35404acc1693aee6e990228924cc09"><div class="ttname"><a href="classVectorizedArrayBase.html#acb35404acc1693aee6e990228924cc09">VectorizedArrayBase&lt; VectorizedArray&lt; Number, width &gt;, 1 &gt;::size</a></div><div class="ttdeci">static constexpr std::size_t size()</div><div class="ttdef"><b>Definition:</b> <a href="vectorization_8h_source.html#l00257">vectorization.h:257</a></div></div>
<div class="ttc" id="aclassdouble_html"><div class="ttname"><a href="classdouble.html">double</a></div></div>
<div class="ttc" id="anamespaceUtilities_1_1MPI_html_ac26de0c059200523177bb1d92cc25d00"><div class="ttname"><a href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a></div><div class="ttdeci">unsigned int n_mpi_processes(const MPI_Comm &amp;mpi_communicator)</div><div class="ttdef"><b>Definition:</b> <a href="mpi_8cc_source.html#l00117">mpi.cc:117</a></div></div>
<div class="ttc" id="anamespaceUtilities_1_1MPI_html_ad2f716b789abe53715d6659f38aa7815"><div class="ttname"><a href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a></div><div class="ttdeci">T max(const T &amp;t, const MPI_Comm &amp;mpi_communicator)</div></div>
<div class="ttc" id="anamespaceUtilities_1_1System_html_ade631a789101336840371e3b2e2851e0"><div class="ttname"><a href="namespaceUtilities_1_1System.html#ade631a789101336840371e3b2e2851e0">Utilities::System::get_current_vectorization_level</a></div><div class="ttdeci">const std::string get_current_vectorization_level()</div><div class="ttdef"><b>Definition:</b> <a href="base_2utilities_8cc_source.html#l00944">utilities.cc:944</a></div></div>
</div><!-- fragment --><p>Next the initial value is set. Since we have a two-step time stepping method, we also need a value of the solution at time-time_step. For accurate results, one would need to compute this from the time derivative of the solution at initial time, but here we ignore this difficulty and just set it to the initial value function at that artificial time.</p>
<p>We then go on by writing the initial state to file and collecting the two starting solutions in a <code>std::vector</code> of pointers that get later consumed by the <a class="el" href="namespacestd__cxx17.html#aa2fc1031c06af4aea4de90c5a1905473">SineGordonOperation::apply()</a> function. Next, an instance of the <code> SineGordonOperation class </code> based on the finite element degree specified at the top of this file is set up.</p>
<div class="fragment"><div class="line"><a class="code" href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a>(mapping,</div>
<div class="line">                         dof_handler,</div>
<div class="line">                         InitialCondition&lt;dim&gt;(1, time),</div>
<div class="line">                         solution);</div>
<div class="line"><a class="code" href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a>(mapping,</div>
<div class="line">                         dof_handler,</div>
<div class="line">                         InitialCondition&lt;dim&gt;(1, time - time_step),</div>
<div class="line">                         old_solution);</div>
<div class="line">output_results(0);</div>
<div class="line"> </div>
<div class="line">std::vector&lt;LinearAlgebra::distributed::Vector&lt;double&gt; *&gt;</div>
<div class="line">  previous_solutions({&amp;old_solution, &amp;old_old_solution});</div>
<div class="line"> </div>
<div class="line">SineGordonOperation&lt;dim, fe_degree&gt; sine_gordon_op(matrix_free_data,</div>
<div class="line">                                                   time_step);</div>
<div class="ttc" id="anamespaceVectorTools_html_a761f008bdeb7d94a69205ae824deefad"><div class="ttname"><a href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a></div><div class="ttdeci">void interpolate(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const Function&lt; spacedim, typename VectorType::value_type &gt; &amp;function, VectorType &amp;vec, const ComponentMask &amp;component_mask=ComponentMask())</div></div>
</div><!-- fragment --><p>Now loop over the time steps. In each iteration, we shift the solution vectors by one and call the <code>apply</code> function of the <code>SineGordonOperator</code> class. Then, we write the solution to a file. We clock the wall times for the computational time needed as wall as the time needed to create the output and report the numbers when the time stepping is finished.</p>
<p>Note how this shift is implemented: We simply call the swap method on the two vectors which swaps only some pointers without the need to copy data around, a relatively expensive operation within an explicit time stepping method. Let us see what happens in more detail: First, we exchange <code>old_solution</code> with <code>old_old_solution</code>, which means that <code>old_old_solution</code> gets <code>old_solution</code>, which is what we expect. Similarly, <code>old_solution</code> gets the content from <code>solution</code> in the next step. After this, <code>solution</code> holds <code>old_old_solution</code>, but that will be overwritten during this step.</p>
<div class="fragment"><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number = 1;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTimer.html">Timer</a>  timer;</div>
<div class="line">    <span class="keywordtype">double</span> wtime       = 0;</div>
<div class="line">    <span class="keywordtype">double</span> output_time = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (time += time_step; time &lt;= final_time;</div>
<div class="line">         time += time_step, ++timestep_number)</div>
<div class="line">      {</div>
<div class="line">        timer.<a class="code" href="classTimer.html#aa3f7871196bb56202af2bc982bfbfff6">restart</a>();</div>
<div class="line">        old_old_solution.swap(old_solution);</div>
<div class="line">        old_solution.swap(solution);</div>
<div class="line">        sine_gordon_op.apply(solution, previous_solutions);</div>
<div class="line">        wtime += timer.<a class="code" href="classTimer.html#a6f3e76707411b51e7d7e7bfa5755cf02">wall_time</a>();</div>
<div class="line"> </div>
<div class="line">        timer.<a class="code" href="classTimer.html#aa3f7871196bb56202af2bc982bfbfff6">restart</a>();</div>
<div class="line">        <span class="keywordflow">if</span> (timestep_number % output_timestep_skip == 0)</div>
<div class="line">          output_results(timestep_number / output_timestep_skip);</div>
<div class="line"> </div>
<div class="line">        output_time += timer.<a class="code" href="classTimer.html#a6f3e76707411b51e7d7e7bfa5755cf02">wall_time</a>();</div>
<div class="line">      }</div>
<div class="line">    timer.<a class="code" href="classTimer.html#aa3f7871196bb56202af2bc982bfbfff6">restart</a>();</div>
<div class="line">    output_results(timestep_number / output_timestep_skip + 1);</div>
<div class="line">    output_time += timer.<a class="code" href="classTimer.html#a6f3e76707411b51e7d7e7bfa5755cf02">wall_time</a>();</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; std::endl</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;   Performed &quot;</span> &lt;&lt; timestep_number &lt;&lt; <span class="stringliteral">&quot; time steps.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Average wallclock time per time step: &quot;</span></div>
<div class="line">          &lt;&lt; wtime / timestep_number &lt;&lt; <span class="stringliteral">&quot;s&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Spent &quot;</span> &lt;&lt; output_time &lt;&lt; <span class="stringliteral">&quot;s on output and &quot;</span> &lt;&lt; wtime</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;s on computations.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step48</span></div>
<div class="ttc" id="aclassTimer_html"><div class="ttname"><a href="classTimer.html">Timer</a></div><div class="ttdef"><b>Definition:</b> <a href="timer_8h_source.html#l00118">timer.h:119</a></div></div>
<div class="ttc" id="aclassTimer_html_a6f3e76707411b51e7d7e7bfa5755cf02"><div class="ttname"><a href="classTimer.html#a6f3e76707411b51e7d7e7bfa5755cf02">Timer::wall_time</a></div><div class="ttdeci">double wall_time() const</div><div class="ttdef"><b>Definition:</b> <a href="timer_8cc_source.html#l00264">timer.cc:264</a></div></div>
<div class="ttc" id="aclassTimer_html_aa3f7871196bb56202af2bc982bfbfff6"><div class="ttname"><a href="classTimer.html#aa3f7871196bb56202af2bc982bfbfff6">Timer::restart</a></div><div class="ttdeci">void restart()</div><div class="ttdef"><b>Definition:</b> <a href="timer_8h_source.html#l00908">timer.h:908</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="Thecodemaincodefunction"></a> </p><h3>The <code>main</code> function</h3>
<p>As in <a class="el" href="step_40.html">step-40</a>, we initialize MPI at the start of the program. Since we will in general mix MPI parallelization with threads, we also set the third argument in MPI_InitFinalize that controls the number of threads to an invalid number, which means that the TBB library chooses the number of threads automatically, typically to the number of available cores in the system. As an alternative, you can also set this number manually if you want to set a specific number of threads (e.g. when MPI-only is required).</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span>Step48;</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(</div>
<div class="line">    argc, argv, <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      SineGordonProblem&lt;dimension&gt; sg_problem;</div>
<div class="line">      sg_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aclassUtilities_1_1MPI_1_1MPI__InitFinalize_html"><div class="ttname"><a href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a></div><div class="ttdef"><b>Definition:</b> <a href="mpi_8h_source.html#l00902">mpi.h:903</a></div></div>
<div class="ttc" id="anamespacenumbers_html_a8ae36952c7e0cc778b47b5371b3aeff1"><div class="ttname"><a href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a></div><div class="ttdeci">static const unsigned int invalid_unsigned_int</div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00196">types.h:196</a></div></div>
</div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p><a class="anchor" id="Comparisonwithasparsematrix"></a></p><h3>Comparison with a sparse matrix</h3>
<p>In order to demonstrate the gain in using the <a class="el" href="classMatrixFree.html">MatrixFree</a> class instead of the standard <code>deal.II</code> assembly routines for evaluating the information from old time steps, we study a simple serial run of the code on a nonadaptive mesh. Since much time is spent on evaluating the sine function, we do not only show the numbers of the full sine-Gordon equation but also for the wave equation (the sine-term skipped from the sine-Gordon equation). We use both second and fourth order elements. The results are summarized in the following table.</p>
<table align="center" class="doxtable">
<tr>
<th>&#160; </th><th colspan="3">wave equation </th><th colspan="2">sine-Gordon  </th></tr>
<tr>
<th>&#160; </th><th>MF </th><th>SpMV </th><th>dealii </th><th>MF </th><th>dealii  </th></tr>
<tr>
<td>2D, \(\mathcal{Q}_2\) </td><td align="right">0.0106 </td><td align="right">0.00971 </td><td align="right">0.109 </td><td align="right">0.0243 </td><td align="right">0.124  </td></tr>
<tr>
<td>2D, \(\mathcal{Q}_4\) </td><td align="right">0.0328 </td><td align="right">0.0706 </td><td align="right">0.528 </td><td align="right">0.0714 </td><td align="right">0.502  </td></tr>
<tr>
<td>3D, \(\mathcal{Q}_2\) </td><td align="right">0.0151 </td><td align="right">0.0320 </td><td align="right">0.331 </td><td align="right">0.0376 </td><td align="right">0.364  </td></tr>
<tr>
<td>3D, \(\mathcal{Q}_4\) </td><td align="right">0.0918 </td><td align="right">0.844 </td><td align="right">6.83 </td><td align="right">0.194 </td><td align="right">6.95  </td></tr>
</table>
<p>It is apparent that the matrix-free code outperforms the standard assembly routines in deal.II by far. In 3D and for fourth order elements, one operator evaluation is also almost ten times as fast as a sparse matrix-vector product.</p>
<p><a class="anchor" id="Parallelrunin2Dand3D"></a></p><h3>Parallel run in 2D and 3D</h3>
<p>We start with the program output obtained on a workstation with 12 cores / 24 threads (one Intel Xeon E5-2687W v4 CPU running at 3.2 GHz, hyperthreading enabled), running the program in release mode: </p><div class="fragment"><div class="line">$ make <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a></div>
<div class="line">Number of MPI ranks:            1</div>
<div class="line">Number of threads on each rank: 24</div>
<div class="line">Vectorization over 4 doubles = 256 bits (AVX)</div>
<div class="line"> </div>
<div class="line">   Number of global active cells: 15412</div>
<div class="line">   Number of degrees of freedom: 249065</div>
<div class="line">   Time step size: 0.00292997, finest cell: 0.117188</div>
<div class="line"> </div>
<div class="line">   Time:     -10, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  9.5599</div>
<div class="line">   Time:   -9.41, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  17.678</div>
<div class="line">   Time:   -8.83, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  23.504</div>
<div class="line">   Time:   -8.24, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:    27.5</div>
<div class="line">   Time:   -7.66, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  29.513</div>
<div class="line">   Time:   -7.07, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  29.364</div>
<div class="line">   Time:   -6.48, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:   27.23</div>
<div class="line">   Time:    -5.9, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  23.527</div>
<div class="line">   Time:   -5.31, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  18.439</div>
<div class="line">   Time:   -4.73, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  11.935</div>
<div class="line">   Time:   -4.14, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  5.5284</div>
<div class="line">   Time:   -3.55, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  8.0354</div>
<div class="line">   Time:   -2.97, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  14.707</div>
<div class="line">   Time:   -2.38, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:      20</div>
<div class="line">   Time:    -1.8, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  22.834</div>
<div class="line">   Time:   -1.21, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  22.771</div>
<div class="line">   Time:  -0.624, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  20.488</div>
<div class="line">   Time: -0.0381, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  16.697</div>
<div class="line">   Time:   0.548, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  11.221</div>
<div class="line">   Time:    1.13, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  5.3912</div>
<div class="line">   Time:    1.72, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  8.4528</div>
<div class="line">   Time:    2.31, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  14.335</div>
<div class="line">   Time:    2.89, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  18.555</div>
<div class="line">   Time:    3.48, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  20.894</div>
<div class="line">   Time:    4.06, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  21.305</div>
<div class="line">   Time:    4.65, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  19.903</div>
<div class="line">   Time:    5.24, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  16.864</div>
<div class="line">   Time:    5.82, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  12.223</div>
<div class="line">   Time:    6.41, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:   6.758</div>
<div class="line">   Time:    6.99, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  7.2423</div>
<div class="line">   Time:    7.58, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  12.888</div>
<div class="line">   Time:    8.17, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  17.273</div>
<div class="line">   Time:    8.75, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  19.654</div>
<div class="line">   Time:    9.34, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  19.838</div>
<div class="line">   Time:    9.92, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  17.964</div>
<div class="line">   Time:      10, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  17.595</div>
<div class="line"> </div>
<div class="line">   Performed 6826 time steps.</div>
<div class="line">   Average wallclock time per time step: 0.0013453s</div>
<div class="line">   Spent 14.976s on output and 9.1831s on computations.</div>
<div class="ttc" id="anamespaceLocalIntegrators_1_1Divergence_html_a8bcfc37d2a2be8faa18628a601ecf112"><div class="ttname"><a href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">LocalIntegrators::Divergence::norm</a></div><div class="ttdeci">double norm(const FEValuesBase&lt; dim &gt; &amp;fe, const ArrayView&lt; const std::vector&lt; Tensor&lt; 1, dim &gt;&gt;&gt; &amp;Du)</div><div class="ttdef"><b>Definition:</b> <a href="divergence_8h_source.html#l00472">divergence.h:472</a></div></div>
</div><!-- fragment --><p>In 3D, the respective output looks like </p><div class="fragment"><div class="line">$ make <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a></div>
<div class="line">Number of MPI ranks:            1</div>
<div class="line">Number of threads on each rank: 24</div>
<div class="line">Vectorization over 4 doubles = 256 bits (AVX)</div>
<div class="line"> </div>
<div class="line">   Number of global active cells: 17592</div>
<div class="line">   Number of degrees of freedom: 1193881</div>
<div class="line">   Time step size: 0.0117233, finest cell: 0.46875</div>
<div class="line"> </div>
<div class="line">   Time:     -10, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  29.558</div>
<div class="line">   Time:   -7.66, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  129.13</div>
<div class="line">   Time:   -5.31, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  67.753</div>
<div class="line">   Time:   -2.97, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  79.245</div>
<div class="line">   Time:  -0.621, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  123.52</div>
<div class="line">   Time:    1.72, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  43.525</div>
<div class="line">   Time:    4.07, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  93.285</div>
<div class="line">   Time:    6.41, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  97.722</div>
<div class="line">   Time:    8.76, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  36.734</div>
<div class="line">   Time:      10, solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>:  94.115</div>
<div class="line"> </div>
<div class="line">   Performed 1706 time steps.</div>
<div class="line">   Average wallclock time per time step: 0.0084542s</div>
<div class="line">   Spent 16.766s on output and 14.423s on computations.</div>
</div><!-- fragment --><p>It takes 0.008 seconds for one time step with more than a million degrees of freedom (note that we would need many processors to reach such numbers when solving linear systems).</p>
<p>If we replace the thread-parallelization by a pure MPI parallelization, the timings change into: </p><div class="fragment"><div class="line">$ mpirun -n 24 ./step-48</div>
<div class="line">Number of MPI ranks:            24</div>
<div class="line">Number of threads on each rank: 1</div>
<div class="line">Vectorization over 4 doubles = 256 bits (AVX)</div>
<div class="line">...</div>
<div class="line">   Performed 1706 time steps.</div>
<div class="line">   Average wallclock time per time step: 0.0051747s</div>
<div class="line">   Spent 2.0535s on output and 8.828s on computations.</div>
</div><!-- fragment --><p>We observe a dramatic speedup for the output (which makes sense, given that most code of the output is not parallelized via threads, whereas it is for MPI), but less than the theoretical factor of 12 we would expect from the parallelism. More interestingly, the computations also get faster when switching from the threads-only variant to the MPI-only variant. This is a general observation for the <a class="el" href="classMatrixFree.html">MatrixFree</a> framework (as of updating this data in 2019). The main reason is that the decisions regarding work on conflicting cell batches made to enable execution in parallel are overly pessimistic: While they ensure that no work on neighboring cells is done on different threads at the same time, this conservative setting implies that data from neighboring cells is also evicted from caches by the time neighbors get touched. Furthermore, the current scheme is not able to provide a constant load for all 24 threads for the given mesh with 17,592 cells.</p>
<p>The current program allows to also mix MPI parallelization with thread parallelization. This is most beneficial when running programs on clusters with multiple nodes, using MPI for the inter-node parallelization and threads for the intra-node parallelization. On the workstation used above, we can run threads in the hyperthreading region (i.e., using 2 threads for each of the 12 MPI ranks). An important setting for mixing MPI with threads is to ensure proper binning of tasks to CPUs. On many clusters the placing is either automatically via the <code>mpirun/mpiexec</code> environment, or there can be manual settings. Here, we simply report the run times the plain version of the program (noting that things could be improved towards the timings of the MPI-only program when proper pinning is done): </p><div class="fragment"><div class="line">$ mpirun -n 12 ./step-48</div>
<div class="line">Number of MPI ranks:            12</div>
<div class="line">Number of threads on each rank: 2</div>
<div class="line">Vectorization over 4 doubles = 256 bits (AVX)</div>
<div class="line">...</div>
<div class="line">   Performed 1706 time steps.</div>
<div class="line">   Average wallclock time per time step: 0.0056651s</div>
<div class="line">   Spent 2.5175s on output and 9.6646s on computations.</div>
</div><!-- fragment --><p><a class="anchor" id="Possibilitiesforextensions"></a></p><h3>Possibilities for extensions</h3>
<p>There are several things in this program that could be improved to make it even more efficient (besides improved boundary conditions and physical stuff as discussed in <a class="el" href="step_25.html">step-25</a>):</p>
<ul>
<li>
<p class="startli"><b>Faster evaluation of sine terms:</b> As becomes obvious from the comparison of the plain wave equation and the sine-Gordon equation above, the evaluation of the sine terms dominates the total time for the finite element operator application. There are a few reasons for this: Firstly, the deal.II sine computation of a <a class="el" href="classVectorizedArray.html">VectorizedArray</a> field is not vectorized (as opposed to the rest of the operator application). This could be cured by handing the sine computation to a library with vectorized sine computations like Intel's math kernel library (MKL). By using the function <code>vdSin</code> in MKL, the program uses half the computing time in 2D and 40 percent less time in 3D. On the other hand, the sine computation is structurally much more complicated than the simple arithmetic operations like additions and multiplications in the rest of the local operation.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><b>Higher order time stepping:</b> While the implementation allows for arbitrary order in the spatial part (by adjusting the degree of the finite element), the time stepping scheme is a standard second-order leap-frog scheme. Since solutions in wave propagation problems are usually very smooth, the error is likely dominated by the time stepping part. Of course, this could be cured by using smaller time steps (at a fixed spatial resolution), but it would be more efficient to use higher order time stepping as well. While it would be straight-forward to do so for a first-order system (use some Runge&ndash;Kutta scheme of higher order, probably combined with adaptive time step selection like the <a href="http://en.wikipedia.org/wiki/Dormand%E2%80%93Prince_method">Dormand&ndash;Prince method</a>), it is more challenging for the second-order formulation. At least in the finite difference community, people usually use the PDE to find spatial correction terms that improve the temporal error.</p>
<p class="endli"></p>
</li>
</ul>
<p><a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2011 - 2020 by the deal.II authors</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div>
<div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div>
<div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div>
<div class="line"><span class="comment"> * the top level directory of deal.II.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Author: Katharina Kormann, Martin Kronbichler, Uppsala University, 2011-2012</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="conditional__ostream_8h.html">deal.II/base/conditional_ostream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="timer_8h.html">deal.II/base/timer.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="distributed_2tria_8h.html">deal.II/distributed/tria.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="la__parallel__vector_8h.html">deal.II/lac/la_parallel_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="matrix__free_8h.html">deal.II/matrix_free/matrix_free.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__evaluation_8h.html">deal.II/matrix_free/fe_evaluation.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iomanip&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>Step48</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dimension = 2;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fe_degree = 4;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line">  <span class="keyword">class </span>SineGordonOperation</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    SineGordonOperation(<span class="keyword">const</span> <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim, double&gt;</a> &amp;data_in,</div>
<div class="line">                        <span class="keyword">const</span> <span class="keywordtype">double</span>                   time_step);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="namespacestd__cxx17.html#aa2fc1031c06af4aea4de90c5a1905473">apply</a>(<a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> &amp;dst,</div>
<div class="line">               <span class="keyword">const</span> std::vector&lt;<a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> *&gt;</div>
<div class="line">                 &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim, double&gt;</a> &amp;            data;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;double&gt;</a>              delta_t_sqr;</div>
<div class="line">    <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> inv_mass_matrix;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> local_apply(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim, double&gt;</a> &amp;                                  data,</div>
<div class="line">      <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> &amp;                     dst,</div>
<div class="line">      <span class="keyword">const</span> std::vector&lt;<a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> *&gt; &amp;src,</div>
<div class="line">      <span class="keyword">const</span> std::pair&lt;unsigned int, unsigned int&gt; &amp;cell_range) <span class="keyword">const</span>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line">  SineGordonOperation&lt;dim, fe_degree&gt;::SineGordonOperation(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim, double&gt;</a> &amp;data_in,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>                   time_step)</div>
<div class="line">    : data(data_in)</div>
<div class="line">    , delta_t_sqr(<a class="code" href="vectorization_8h.html#ad7d7e08942faeecf438c75a254e06cbe">make_vectorized_array</a>(time_step * time_step))</div>
<div class="line">  {</div>
<div class="line">    data.initialize_dof_vector(inv_mass_matrix);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEEvaluation.html">FEEvaluation&lt;dim, fe_degree&gt;</a> fe_eval(data);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>           n_q_points = fe_eval.n_q_points;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cell = 0; cell &lt; data.n_cell_batches(); ++cell)</div>
<div class="line">      {</div>
<div class="line">        fe_eval.reinit(cell);</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_q_points; ++q)</div>
<div class="line">          fe_eval.submit_value(<a class="code" href="classVectorizedArray.html#ad7d7e08942faeecf438c75a254e06cbe">make_vectorized_array</a>(1.), q);</div>
<div class="line">        fe_eval.integrate(<a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">EvaluationFlags::values</a>);</div>
<div class="line">        fe_eval.distribute_local_to_global(inv_mass_matrix);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    inv_mass_matrix.compress(<a class="code" href="group__Vectors.html#gga40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; inv_mass_matrix.locally_owned_size(); ++k)</div>
<div class="line">      <span class="keywordflow">if</span> (inv_mass_matrix.local_element(k) &gt; 1<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">e</a>-15)</div>
<div class="line">        inv_mass_matrix.local_element(k) =</div>
<div class="line">          1. / inv_mass_matrix.local_element(k);</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        inv_mass_matrix.local_element(k) = 1;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line">  <span class="keywordtype">void</span> SineGordonOperation&lt;dim, fe_degree&gt;::local_apply(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim&gt;</a> &amp;                                          data,</div>
<div class="line">    <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> &amp;                     dst,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;<a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> *&gt; &amp;src,</div>
<div class="line">    <span class="keyword">const</span> std::pair&lt;unsigned int, unsigned int&gt; &amp;cell_range)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga9442b63275c9ef3fab29bc222831c49c">AssertDimension</a>(src.size(), 2);</div>
<div class="line">    <a class="code" href="classFEEvaluation.html">FEEvaluation&lt;dim, fe_degree&gt;</a> current(data), old(data);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cell = cell_range.first; cell &lt; cell_range.second; ++cell)</div>
<div class="line">      {</div>
<div class="line">        current.reinit(cell);</div>
<div class="line">        old.reinit(cell);</div>
<div class="line"> </div>
<div class="line">        current.read_dof_values(*src[0]);</div>
<div class="line">        old.read_dof_values(*src[1]);</div>
<div class="line"> </div>
<div class="line">        current.evaluate(<a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">EvaluationFlags::values</a> | <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aea91b5f00e4be473005cc331b8644ab2f1">EvaluationFlags::gradients</a>);</div>
<div class="line">        old.evaluate(<a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">EvaluationFlags::values</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; current.n_q_points; ++q)</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;double&gt;</a> current_value = current.get_value(q);</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classVectorizedArray.html">VectorizedArray&lt;double&gt;</a> old_value     = old.get_value(q);</div>
<div class="line"> </div>
<div class="line">            current.submit_value(2. * current_value - old_value -</div>
<div class="line">                                   delta_t_sqr * std::sin(current_value),</div>
<div class="line">                                 q);</div>
<div class="line">            current.submit_gradient(-delta_t_sqr * current.get_gradient(q), q);</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        current.integrate(<a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">EvaluationFlags::values</a> | <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aea91b5f00e4be473005cc331b8644ab2f1">EvaluationFlags::gradients</a>);</div>
<div class="line">        current.distribute_local_to_global(dst);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespacestd__cxx17.html#aa2fc1031c06af4aea4de90c5a1905473">SineGordonOperation&lt;dim, fe_degree&gt;::apply</a>(</div>
<div class="line">    <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> &amp;                     dst,</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;<a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> *&gt; &amp;src)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    data.<a class="code" href="classMatrixFree.html#abc204ec41ead1b5060f47ef3a5a066d7">cell_loop</a>(</div>
<div class="line">      &amp;SineGordonOperation&lt;dim, fe_degree&gt;::local_apply, <span class="keyword">this</span>, dst, src, <span class="keyword">true</span>);</div>
<div class="line">    dst.<a class="code" href="group__Vectors.html#gaacdf6bfd4533c47587ba0debe177710e">scale</a>(inv_mass_matrix);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>InitialCondition : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    InitialCondition(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_components = 1,</div>
<div class="line">                     <span class="keyword">const</span> <span class="keywordtype">double</span>       time         = 0.)</div>
<div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(n_components, time)</div>
<div class="line">    {}</div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*component*/</span>)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">      <span class="keywordtype">double</span> t = this-&gt;<a class="code" href="classFunctionTime.html#ae7d37ddb04314b38cf67c6cba22923f6">get_time</a>();</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> m  = 0.5;</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> c1 = 0.;</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> c2 = 0.;</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> factor =</div>
<div class="line">        (m / <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">std::sqrt</a>(1. - m * m) * <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">std::sin</a>(std::sqrt(1. - m * m) * t + c2));</div>
<div class="line">      <span class="keywordtype">double</span> result = 1.;</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> &lt; dim; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div>
<div class="line">        result *= -4. * <a class="code" href="namespaceDifferentiation_1_1SD.html#a803fcea270d7a523a91e3b7c173059f9">std::atan</a>(factor / <a class="code" href="namespaceDifferentiation_1_1SD.html#a26c1f7a69dc8ac2e16144493d3b3b896">std::cosh</a>(m * p[<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] + c1));</div>
<div class="line">      <span class="keywordflow">return</span> result;</div>
<div class="line">    }</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>SineGordonProblem</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    SineGordonProblem();</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <a class="code" href="classConditionalOStream.html">ConditionalOStream</a> pcout;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> make_grid_and_dofs();</div>
<div class="line">    <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef DEAL_II_WITH_P4EST</span></div>
<div class="line">    <a class="code" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>       fe;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a> dof_handler;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classMappingQ1.html">MappingQ1&lt;dim&gt;</a> mapping;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div>
<div class="line">    <a class="code" href="classIndexSet.html">IndexSet</a>                  locally_relevant_dofs;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim, double&gt;</a> matrix_free_data;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double&gt;</a> solution, old_solution,</div>
<div class="line">      old_old_solution;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_global_refinements;</div>
<div class="line">    <span class="keywordtype">double</span>             time, time_step;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>       final_time;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>       cfl_number;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> output_timestep_skip;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  SineGordonProblem&lt;dim&gt;::SineGordonProblem()</div>
<div class="line">    : pcout(std::cout, <a class="code" href="namespaceUtilities.html">Utilities</a>::MPI::<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">this_mpi_process</a>(MPI_COMM_WORLD) == 0)</div>
<div class="line">    ,</div>
<div class="line">#ifdef DEAL_II_WITH_P4EST</div>
<div class="line">    <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>(MPI_COMM_WORLD)</div>
<div class="line">    ,</div>
<div class="line">#endif</div>
<div class="line">    fe(<a class="code" href="classQGaussLobatto.html">QGaussLobatto</a>&lt;1&gt;(fe_degree + 1))</div>
<div class="line">    , dof_handler(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>)</div>
<div class="line">    , n_global_refinements(10 - 2 * dim)</div>
<div class="line">    , time(-10)</div>
<div class="line">    , time_step(10.)</div>
<div class="line">    , final_time(10.)</div>
<div class="line">    , cfl_number(.1 / fe_degree)</div>
<div class="line">    , output_timestep_skip(200)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> SineGordonProblem&lt;dim&gt;::make_grid_and_dofs()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>, -15, 15);</div>
<div class="line">    <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.refine_global(n_global_refinements);</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">typename</span> <a class="code" href="classTriaActiveIterator.html">Triangulation&lt;dim&gt;::active_cell_iterator</a></div>
<div class="line">        cell     = <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.begin_active(),</div>
<div class="line">        end_cell = <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.end();</div>
<div class="line">      <span class="keywordflow">for</span> (; cell != end_cell; ++cell)</div>
<div class="line">        <span class="keywordflow">if</span> (cell-&gt;is_locally_owned())</div>
<div class="line">          <span class="keywordflow">if</span> (cell-&gt;center().norm() &lt; 11)</div>
<div class="line">            cell-&gt;set_refine_flag();</div>
<div class="line">      <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line"> </div>
<div class="line">      cell     = <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.begin_active();</div>
<div class="line">      end_cell = <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.end();</div>
<div class="line">      <span class="keywordflow">for</span> (; cell != end_cell; ++cell)</div>
<div class="line">        <span class="keywordflow">if</span> (cell-&gt;is_locally_owned())</div>
<div class="line">          <span class="keywordflow">if</span> (cell-&gt;center().norm() &lt; 6)</div>
<div class="line">            cell-&gt;set_refine_flag();</div>
<div class="line">      <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Number of global active cells: &quot;</span></div>
<div class="line"><span class="preprocessor">#ifdef DEAL_II_WITH_P4EST</span></div>
<div class="line">          &lt;&lt; <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_global_active_cells()</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">          &lt;&lt; <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells()</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">          &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    dof_handler.distribute_dofs(fe);</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.n_dofs()</div>
<div class="line">          &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(dof_handler, locally_relevant_dofs);</div>
<div class="line">    constraints.clear();</div>
<div class="line">    constraints.reinit(locally_relevant_dofs);</div>
<div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div>
<div class="line">    constraints.close();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">typename</span> <a class="code" href="structMatrixFree_1_1AdditionalData.html">MatrixFree&lt;dim&gt;::AdditionalData</a> additional_data;</div>
<div class="line">    additional_data.<a class="code" href="structMatrixFree_1_1AdditionalData.html#a0bcce2facca91b925d3e1a5a00c7704b">tasks_parallel_scheme</a> =</div>
<div class="line">      <a class="code" href="classMatrixFree.html">MatrixFree&lt;dim&gt;::AdditionalData::TasksParallelScheme::partition_partition</a>;</div>
<div class="line"> </div>
<div class="line">    matrix_free_data.<a class="code" href="classMatrixFree.html#adb324d469b296f2a6921b41208732ddf">reinit</a>(mapping,</div>
<div class="line">                            dof_handler,</div>
<div class="line">                            constraints,</div>
<div class="line">                            <a class="code" href="classQGaussLobatto.html">QGaussLobatto&lt;1&gt;</a>(fe_degree + 1),</div>
<div class="line">                            additional_data);</div>
<div class="line"> </div>
<div class="line">    matrix_free_data.initialize_dof_vector(solution);</div>
<div class="line">    old_solution.reinit(solution);</div>
<div class="line">    old_old_solution.reinit(solution);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span></div>
<div class="line">  SineGordonProblem&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number)</div>
<div class="line">  {</div>
<div class="line">    constraints.distribute(solution);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;float&gt;</a> norm_per_cell(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells());</div>
<div class="line">    solution.update_ghost_values();</div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(mapping,</div>
<div class="line">                                      dof_handler,</div>
<div class="line">                                      solution,</div>
<div class="line">                                      <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a>(),</div>
<div class="line">                                      norm_per_cell,</div>
<div class="line">                                      <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe_degree + 1),</div>
<div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> solution_norm =</div>
<div class="line">      <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>,</div>
<div class="line">                                        norm_per_cell,</div>
<div class="line">                                        <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Time:&quot;</span> &lt;&lt; std::setw(8) &lt;&lt; std::setprecision(3) &lt;&lt; time</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;, solution norm: &quot;</span> &lt;&lt; std::setprecision(5) &lt;&lt; std::setw(7)</div>
<div class="line">          &lt;&lt; solution_norm &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line"> </div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#ac1eb26168177faa30ffbcf9cbb9c3cd5">attach_dof_handler</a>(dof_handler);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">add_data_vector</a>(solution, <span class="stringliteral">&quot;solution&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOut.html#a5eb51872b8736849bb7e8d2007fae086">build_patches</a>(mapping);</div>
<div class="line"> </div>
<div class="line">    data_out.<a class="code" href="group__Exceptions.html#ga0864e51eb173c87e2a3edc9391ea8009">write_vtu_with_pvtu_record</a>(</div>
<div class="line">      <span class="stringliteral">&quot;./&quot;</span>, <span class="stringliteral">&quot;solution&quot;</span>, timestep_number, MPI_COMM_WORLD, 3);</div>
<div class="line"> </div>
<div class="line">    solution.zero_out_ghost_values();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">SineGordonProblem&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    {</div>
<div class="line">      pcout &lt;&lt; <span class="stringliteral">&quot;Number of MPI ranks:            &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="namespaceUtilities_1_1MPI.html#ac26de0c059200523177bb1d92cc25d00">Utilities::MPI::n_mpi_processes</a>(MPI_COMM_WORLD) &lt;&lt; std::endl;</div>
<div class="line">      pcout &lt;&lt; <span class="stringliteral">&quot;Number of threads on each rank: &quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="classMultithreadInfo.html#ad0b84ae105b385b88bdd4bfc0c530995">MultithreadInfo::n_threads</a>() &lt;&lt; std::endl;</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_vect_doubles = <a class="code" href="classVectorizedArrayBase.html#acb35404acc1693aee6e990228924cc09">VectorizedArray&lt;double&gt;::size</a>();</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_vect_bits    = 8 * <span class="keyword">sizeof</span>(<a class="code" href="classdouble.html">double</a>) * n_vect_doubles;</div>
<div class="line">      pcout &lt;&lt; <span class="stringliteral">&quot;Vectorization over &quot;</span> &lt;&lt; n_vect_doubles</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot; doubles = &quot;</span> &lt;&lt; n_vect_bits &lt;&lt; <span class="stringliteral">&quot; bits (&quot;</span></div>
<div class="line">            &lt;&lt; <a class="code" href="namespaceUtilities_1_1System.html#ade631a789101336840371e3b2e2851e0">Utilities::System::get_current_vectorization_level</a>() &lt;&lt; <span class="stringliteral">&quot;)&quot;</span></div>
<div class="line">            &lt;&lt; std::endl</div>
<div class="line">            &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">    make_grid_and_dofs();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> local_min_cell_diameter =</div>
<div class="line">      <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.last()-&gt;diameter() / <a class="code" href="numbers_8h.html#ac4a2ed1890a931d0b6a55933310eadca">std::sqrt</a>(dim);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> global_min_cell_diameter =</div>
<div class="line">      -<a class="code" href="namespaceUtilities_1_1MPI.html#ad2f716b789abe53715d6659f38aa7815">Utilities::MPI::max</a>(-local_min_cell_diameter, MPI_COMM_WORLD);</div>
<div class="line">    time_step = cfl_number * global_min_cell_diameter;</div>
<div class="line">    time_step = (final_time - time) / (<span class="keywordtype">int</span>((final_time - time) / time_step));</div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Time step size: &quot;</span> &lt;&lt; time_step</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;, finest cell: &quot;</span> &lt;&lt; global_min_cell_diameter &lt;&lt; std::endl</div>
<div class="line">          &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a>(mapping,</div>
<div class="line">                             dof_handler,</div>
<div class="line">                             InitialCondition&lt;dim&gt;(1, time),</div>
<div class="line">                             solution);</div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a>(mapping,</div>
<div class="line">                             dof_handler,</div>
<div class="line">                             InitialCondition&lt;dim&gt;(1, time - time_step),</div>
<div class="line">                             old_solution);</div>
<div class="line">    output_results(0);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;LinearAlgebra::distributed::Vector&lt;double&gt; *&gt;</div>
<div class="line">      previous_solutions({&amp;old_solution, &amp;old_old_solution});</div>
<div class="line"> </div>
<div class="line">    SineGordonOperation&lt;dim, fe_degree&gt; sine_gordon_op(matrix_free_data,</div>
<div class="line">                                                       time_step);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number = 1;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTimer.html">Timer</a>  timer;</div>
<div class="line">    <span class="keywordtype">double</span> wtime       = 0;</div>
<div class="line">    <span class="keywordtype">double</span> output_time = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (time += time_step; time &lt;= final_time;</div>
<div class="line">         time += time_step, ++timestep_number)</div>
<div class="line">      {</div>
<div class="line">        timer.<a class="code" href="classTimer.html#aa3f7871196bb56202af2bc982bfbfff6">restart</a>();</div>
<div class="line">        old_old_solution.swap(old_solution);</div>
<div class="line">        old_solution.swap(solution);</div>
<div class="line">        sine_gordon_op.apply(solution, previous_solutions);</div>
<div class="line">        wtime += timer.<a class="code" href="classTimer.html#a6f3e76707411b51e7d7e7bfa5755cf02">wall_time</a>();</div>
<div class="line"> </div>
<div class="line">        timer.<a class="code" href="classTimer.html#aa3f7871196bb56202af2bc982bfbfff6">restart</a>();</div>
<div class="line">        <span class="keywordflow">if</span> (timestep_number % output_timestep_skip == 0)</div>
<div class="line">          output_results(timestep_number / output_timestep_skip);</div>
<div class="line"> </div>
<div class="line">        output_time += timer.<a class="code" href="classTimer.html#a6f3e76707411b51e7d7e7bfa5755cf02">wall_time</a>();</div>
<div class="line">      }</div>
<div class="line">    timer.<a class="code" href="classTimer.html#aa3f7871196bb56202af2bc982bfbfff6">restart</a>();</div>
<div class="line">    output_results(timestep_number / output_timestep_skip + 1);</div>
<div class="line">    output_time += timer.<a class="code" href="classTimer.html#a6f3e76707411b51e7d7e7bfa5755cf02">wall_time</a>();</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; std::endl</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;   Performed &quot;</span> &lt;&lt; timestep_number &lt;&lt; <span class="stringliteral">&quot; time steps.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Average wallclock time per time step: &quot;</span></div>
<div class="line">          &lt;&lt; wtime / timestep_number &lt;&lt; <span class="stringliteral">&quot;s&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; <span class="stringliteral">&quot;   Spent &quot;</span> &lt;&lt; output_time &lt;&lt; <span class="stringliteral">&quot;s on output and &quot;</span> &lt;&lt; wtime</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;s on computations.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step48</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span>Step48;</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_initialization(</div>
<div class="line">    argc, argv, <a class="code" href="namespacenumbers.html#a8ae36952c7e0cc778b47b5371b3aeff1">numbers::invalid_unsigned_int</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      SineGordonProblem&lt;dimension&gt; sg_problem;</div>
<div class="line">      sg_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="avectorization_8h_html_ad7d7e08942faeecf438c75a254e06cbe"><div class="ttname"><a href="vectorization_8h.html#ad7d7e08942faeecf438c75a254e06cbe">make_vectorized_array</a></div><div class="ttdeci">VectorizedArray&lt; Number, width &gt; make_vectorized_array(const Number &amp;u)</div><div class="ttdef"><b>Definition:</b> <a href="vectorization_8h_source.html#l00721">vectorization.h:721</a></div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
