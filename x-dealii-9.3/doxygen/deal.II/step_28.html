<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="canonical" href="https://www.dealii.org/current/doxygen/deal.II/step_28.html" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The step-28 tutorial program  。</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2021 by the deal.II authors"></meta>
<meta name="deal.II-version" content="9.3.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 9.3.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--Extra macros for MathJax:-->
<div style="display:none">
\(\newcommand{\dealvcentcolon}{\mathrel{\mathop{:}}}\)
\(\newcommand{\dealcoloneq}{\dealvcentcolon\mathrel{\mkern-1.2mu}=}\)
\(\newcommand{\jump}[1]{\left[\!\left[ #1 \right]\!\right]}\)
\(\newcommand{\average}[1]{\left\{\!\left\{ #1 \right\}\!\right\}}\)
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The step-28 tutorial program 。 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>本教程取决于 <a class="el" href="step_6.html">step-6</a> 。</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a><a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Theeigenvalueproblem">The eigenvalue problem</a><a href="#Theeigenvalueproblem">The eigenvalue problem</a>
        <li><a href="#Meshesandmeshrefinement">Meshes and mesh refinement</a><a href="#Meshesandmeshrefinement">Meshes and mesh refinement</a>
      <ul>
        <li><a href="#Meshrefinement">Mesh refinement</a><a href="#Meshrefinement">Mesh refinement</a>
        <li><a href="#Assemblingtermsondifferentmeshes">Assembling terms on different meshes</a><a href="#Assemblingtermsondifferentmeshes">Assembling terms on different meshes</a>
      </ul>
        <li><a href="#Descriptionofthetestcase">Description of the test case</a><a href="#Descriptionofthetestcase">Description of the test case</a>
        <li><a href="#Whattheprogramdoesandhowitdoesthat">What the program does (and how it does that)</a><a href="#Whattheprogramdoesandhowitdoesthat">What the program does (and how it does that)</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a><a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a><a href="#Includefiles">Include files</a>
        <li><a href="#Materialdata">Material data</a><a href="#Materialdata">Material data</a>
        <li><a href="#ThecodeEnergyGroupcodeclass">The <code>EnergyGroup</code> class</a><a href="#ThecodeEnergyGroupcodeclass">The <code>EnergyGroup</code> class</a>
      <ul>
      <ul>
        <li><a href="#codeEnergyGroupcodepublicmemberfunctions"><code>EnergyGroup</code> public member functions</a><a href="#codeEnergyGroupcodepublicmemberfunctions"><code>EnergyGroup</code> public member functions</a>
        <li><a href="#codeEnergyGroupcodepublicdatamembers"><code>EnergyGroup</code> public data members</a><a href="#codeEnergyGroupcodepublicdatamembers"><code>EnergyGroup</code> public data members</a>
        <li><a href="#codeEnergyGroupcodeprivatedatamembers"><code>EnergyGroup</code> private data members</a><a href="#codeEnergyGroupcodeprivatedatamembers"><code>EnergyGroup</code> private data members</a>
        <li><a href="#codeEnergyGroupcodeprivatememberfunctions"><code>EnergyGroup</code> private member functions</a><a href="#codeEnergyGroupcodeprivatememberfunctions"><code>EnergyGroup</code> private member functions</a>
      </ul>
        <li><a href="#ImplementationofthecodeEnergyGroupcodeclass">Implementation of the <code>EnergyGroup</code> class</a><a href="#ImplementationofthecodeEnergyGroupcodeclass">Implementation of the <code>EnergyGroup</code> class</a>
      <ul>
        <li><a href="#codeEnergyGroupsetup_linear_systemcode"><code>EnergyGroup::setup_linear_system</code></a><a href="#codeEnergyGroupsetup_linear_systemcode"><code>EnergyGroup::setup_linear_system</code></a>
        <li><a href="#codeEnergyGroupassemble_system_matrixcode"><code>EnergyGroup::assemble_system_matrix</code></a><a href="#codeEnergyGroupassemble_system_matrixcode"><code>EnergyGroup::assemble_system_matrix</code></a>
        <li><a href="#codeEnergyGroupassemble_ingroup_rhscode"><code>EnergyGroup::assemble_ingroup_rhs</code></a><a href="#codeEnergyGroupassemble_ingroup_rhscode"><code>EnergyGroup::assemble_ingroup_rhs</code></a>
        <li><a href="#codeEnergyGroupassemble_cross_group_rhscode"><code>EnergyGroup::assemble_cross_group_rhs</code></a> ]<a href="#codeEnergyGroupassemble_cross_group_rhscode"><code>EnergyGroup::assemble_cross_group_rhs</code></a>
        <li><a href="#codeEnergyGroupassemble_cross_group_rhs_recursivecode"><code>EnergyGroup::assemble_cross_group_rhs_recursive</code></a><a href="#codeEnergyGroupassemble_cross_group_rhs_recursivecode"><code>EnergyGroup::assemble_cross_group_rhs_recursive</code></a>
        <li><a href="#codeEnergyGroupget_fission_sourcecode"><code>EnergyGroup::get_fission_source</code></a><a href="#codeEnergyGroupget_fission_sourcecode"><code>EnergyGroup::get_fission_source</code></a>
        <li><a href="#codeEnergyGroupsolvecode"><code>EnergyGroup::solve</code></a><a href="#codeEnergyGroupsolvecode"><code>EnergyGroup::solve</code></a>
        <li><a href="#codeEnergyGroupestimate_errorscode"><code>EnergyGroup::estimate_errors</code></a><a href="#codeEnergyGroupestimate_errorscode"><code>EnergyGroup::estimate_errors</code></a>
        <li><a href="#codeEnergyGrouprefine_gridcode"><code>EnergyGroup::refine_grid</code></a><a href="#codeEnergyGrouprefine_gridcode"><code>EnergyGroup::refine_grid</code></a>
        <li><a href="#codeEnergyGroupoutput_resultscode"><code>EnergyGroup::output_results</code></a><a href="#codeEnergyGroupoutput_resultscode"><code>EnergyGroup::output_results</code></a>
      </ul>
      </ul>
        <li><a href="#ThecodeNeutronDiffusionProblemcodeclasstemplate">The <code>NeutronDiffusionProblem</code> class template</a><a href="#ThecodeNeutronDiffusionProblemcodeclasstemplate">The <code>NeutronDiffusionProblem</code> class template</a>
      <ul>
      <ul>
        <li><a href="#codeNeutronDiffusionProblemcodeprivatememberfunctions"><code>NeutronDiffusionProblem</code> private member functions</a><a href="#codeNeutronDiffusionProblemcodeprivatememberfunctions"><code>NeutronDiffusionProblem</code> private member functions</a>
        <li><a href="#codeNeutronDiffusionProblemcodeprivatemembervariables"><code>NeutronDiffusionProblem</code> private member variables</a><a href="#codeNeutronDiffusionProblemcodeprivatemembervariables"><code>NeutronDiffusionProblem</code> private member variables</a>
      </ul>
        <li><a href="#ImplementationofthecodeParameterscodeclass">Implementation of the <code>Parameters</code> class</a><a href="#ImplementationofthecodeParameterscodeclass">Implementation of the <code>Parameters</code> class</a>
        <li><a href="#ImplementationofthecodeNeutronDiffusionProblemcodeclass">Implementation of the <code>NeutronDiffusionProblem</code> class</a><a href="#ImplementationofthecodeNeutronDiffusionProblemcodeclass">Implementation of the <code>NeutronDiffusionProblem</code> class</a>
      <ul>
        <li><a href="#codeNeutronDiffusionProbleminitialize_problemcode"><code>NeutronDiffusionProblem::initialize_problem</code></a><a href="#codeNeutronDiffusionProbleminitialize_problemcode"><code>NeutronDiffusionProblem::initialize_problem</code></a>
        <li><a href="#codeNeutronDiffusionProblemget_total_fission_sourcecode"><code>NeutronDiffusionProblem::get_total_fission_source</code></a><a href="#codeNeutronDiffusionProblemget_total_fission_sourcecode"><code>NeutronDiffusionProblem::get_total_fission_source</code></a>
        <li><a href="#codeNeutronDiffusionProblemrefine_gridcode"><code>NeutronDiffusionProblem::refine_grid</code></a><a href="#codeNeutronDiffusionProblemrefine_gridcode"><code>NeutronDiffusionProblem::refine_grid</code></a>
        <li><a href="#codeNeutronDiffusionProblemruncode"><code>NeutronDiffusionProblem::run</code></a><a href="#codeNeutronDiffusionProblemruncode"><code>NeutronDiffusionProblem::run</code></a>
      </ul>
      </ul>
        <li><a href="#Thecodemaincodefunction">The <code>main()</code> function</a><a href="#Thecodemaincodefunction">The <code>main()</code> function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a><a href="#Results" class=bold>Results</a>
    <ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a><a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
</p>
<p><br  />
 <br  />
</p>
<p><em>This program was contributed by Yaqi Wang and Wolfgang Bangerth. Results from this program are used and discussed in the publication "Three-dimensional h-adaptivity for the multigroup neutron diffusion
equations" by Yaqi Wang, Wolfgang Bangerth and Jean Ragusa. The paper's full bibliographic details are as follows:</em></p>
<p><em></p><div class="fragment"><div class="line">@Article{WBR09,</div>
<div class="line">  author  = {Yaqi Wang and Wolfgang Bangerth and Jean Ragusa},</div>
<div class="line">  title   = {Three-dimensional h-adaptivity <span class="keywordflow">for</span> the multigroup</div>
<div class="line">             neutron diffusion equations},</div>
<div class="line">  journal = {Progr. Nucl. Energy},</div>
<div class="line">  year    = 2009,</div>
<div class="line">  <a class="code" href="namespaceGridTools.html#a9e8169dc4981e90ba5d2386a87efa042">volume</a>  = 51,</div>
<div class="line">  pages   = {543--555}</div>
<div class="line">}</div>
<div class="ttc" id="anamespaceGridTools_html_a9e8169dc4981e90ba5d2386a87efa042"><div class="ttname"><a href="namespaceGridTools.html#a9e8169dc4981e90ba5d2386a87efa042">GridTools::volume</a></div><div class="ttdeci">double volume(const Triangulation&lt; dim, spacedim &gt; &amp;tria, const Mapping&lt; dim, spacedim &gt; &amp;mapping=(ReferenceCells::get_hypercube&lt; dim &gt;() .template get_default_linear_mapping&lt; dim, spacedim &gt;()))</div><div class="ttdef"><b>Definition:</b> <a href="grid__tools_8cc_source.html#l00137">grid_tools.cc:137</a></div></div>
</div><!-- fragment --><div class="fragment"><div class="line">@Article{WBR09,</div>
<div class="line">  author  = {Yaqi Wang and Wolfgang Bangerth and Jean Ragusa},</div>
<div class="line">  title   = {Three-dimensional h-adaptivity <span class="keywordflow">for</span> the multigroup</div>
<div class="line">             neutron diffusion equations},</div>
<div class="line">  journal = {Progr. Nucl. Energy},</div>
<div class="line">  year    = 2009,</div>
<div class="line">  <a class="code" href="namespaceGridTools.html#a9e8169dc4981e90ba5d2386a87efa042">volume</a>  = 51,</div>
<div class="line">  pages   = {543--555}</div>
<div class="line">}</div>
</div><!-- fragment --><p></em></p>
<p><em>The paper is available <a href="https://www.semanticscholar.org/paper/Three-dimensional-h-adaptivity-for-the-multigroup-Wang-Bangerth/900592e8e891d9b888d59a69ec58bf2bbda56b4b" target="_top">here</a><a href="https://www.semanticscholar.org/paper/Three-dimensional-h-adaptivity-for-the-multigroup-Wang-Bangerth/900592e8e891d9b888d59a69ec58bf2bbda56b4b" target="_top">here</a>. </em></p>
<p><br  />
 <br  />
</p>
<p><a class="anchor" id="Introduction"></a><a class="anchor" id="Intro"></a></p><h1>Introduction</h1>
<p>在这个例子中，我们打算解决中子传输方程的多组扩散近似。本质上，看待这个问题的方式如下。在核反应堆中，中子以不同的能量飞驰，被吸收或散射，或开始一个新的裂变事件。如果从足够长的长度尺度来看，中子的运动可以被视为一个扩散过程。</p>
<p>对此的数学描述将把中子归入能量仓，并考虑这些仓或能量组中每个仓的中子通量的平衡方程。然后，散射、吸收和裂变事件将成为描述中子通量的扩散方程中的运算符。假设我们有能量组 \(g=1,\ldots,G\) ，按照惯例，我们假设能量最高的中子在1组，能量最低的中子在 \(G\) 组。那么每组的中子通量满足以下公式。 </p><p class="formulaDsp">
\begin{eqnarray*} \frac 1{v_g}\frac{\partial \phi_g(x,t)}{\partial t} &amp;=&amp; \nabla \cdot(D_g(x) \nabla \phi_g(x,t)) - \Sigma_{r,g}(x)\phi_g(x,t) \\ &amp;&amp; \qquad + \chi_g\sum_{g&#39;=1}^G\nu\Sigma_{f,g&#39;}(x)\phi_{g&#39;}(x,t) + \sum_{g&#39;\ne g}\Sigma_{s,g&#39;\to g}(x)\phi_{g&#39;}(x,t) + s_{\mathrm{ext},g}(x,t) \end{eqnarray*}
</p>
<p>用适当的边界条件加以增强。这里， \(v_g\) 是组内中子的速度 \(g\) 。换句话说， \(g\) 组中的中子通量的时间变化受以下过程支配。 </p><ul>
<li>
扩散 \(\nabla \cdot(D_g(x) \nabla \phi_g(x,t))\) 。这里， \(D_g\) 是（空间上可变的）扩散系数。 </li>
<li>
吸收 \(\Sigma_{r,g}(x)\phi_g(x,t)\) （注意是负号）。系数 \(\Sigma_{r,g}\) 被称为<em>removal cross section</em>。 </li>
<li>
核裂变 \(\chi_g\sum_{g&#39;=1}^G\nu\Sigma_{f,g&#39;}(x)\phi_{g&#39;}(x,t)\) 。 能量的中子 \(g\) 的产生与能量的中子通量 \(g&#39;\) 乘以能量的中子 \(g&#39;\) 引起裂变事件的概率 \(\nu\) 乘以每个裂变事件中产生的中子数量乘以该事件中产生的中子具有能量的概率 \(g\) 。 \(\nu\Sigma_{f,g&#39;}\) 被称为<em>fission cross section</em>， \(\chi_g\) 被称为<em>fission spectrum</em>。我们将在程序中把 \(\chi_g\nu\Sigma_{f,g&#39;}\) 这个词表示为<em>fission distribution cross section</em>。 </li>
<li>
能量为 \(g&#39;\) 的中子的散射 \(\sum_{g&#39;\ne g}\Sigma_{s,g&#39;\to g}(x)\phi_{g&#39;}(x,t)\) 产生能量为 \(g\) 的中子 。 \(\Sigma_{s,g&#39;\to g}\) 被称为<em>scattering cross section</em>。弹性、群内散射 \(g&#39;=g\) 的情况也存在，但我们将其归入清除截面。 \(g&#39;&lt;g\) 的情况被称为向下散射，因为中子在这样的事件中失去了能量。另一方面， \(g&#39;&gt;g\) 对应于上散射：中子在散射事件中从其周围原子的热运动中获得能量；因此，上散射仅对动能已经与热动能相同的中子（即在 \(eV\) 以下范围）是一个重要过程。 </li>
<li>
一个外源 \(s_{\mathrm{ext},g}\) 。 </li>
</ul>
<p><br  />
</p>
<p>对于反应堆分析中的现实模拟，人们可能希望将中子能量的连续谱分成许多能量组，通常多达100个。然而，如果对某些类型的反应堆（例如压水反应堆，PWR）的中子能谱足够了解，那么只用2个能群就有可能获得满意的结果。</p>
<p>在本教程中显示的程序中，我们提供了一个结构，可以根据需要用许多能量组进行计算。然而，为了保持适度的计算时间，并避免表列数百个系数，我们只提供上述方程的系数，用于两组模拟，即 \(g=1,2\) 。然而，我们确实考虑了一个现实的情况，即假设系数不是恒定的，而是取决于以相当复杂的方式装配到反应堆燃料组件的材料（见下文）。</p>
<p><a class="anchor" id="Theeigenvalueproblem"></a></p><h3>The eigenvalue problem</h3>
<p>如果我们一次考虑所有的能量组，我们可以把上述方程写成以下算子形式。 </p><p class="formulaDsp">
\begin{eqnarray*} \frac 1v \frac{\partial \phi}{\partial t} = -L\phi + F\phi + X\phi + s_{\mathrm{ext}}, \end{eqnarray*}
</p>
<p>其中 \(L,F,X\) 分别是沉降、裂变和散射算子。 这里的 \(L\) 包括扩散和清除项。请注意， \(L\) 是对称的，而 \(F\) 和 \(X\) 不是。</p>
<p>众所周知，如果算子 \(-L+F+X\) 的所有特征值都是负的，这个方程就有一个稳定的解。这可以通过将方程乘以 \(\phi\) 并在域上进行积分而很容易看出，从而得出 </p><p class="formulaDsp">
\begin{eqnarray*} \frac 1{2v} \frac{\partial}{\partial t} \|\phi\|^2 = ((-L+F+X)\phi,\phi). \end{eqnarray*}
</p>
<p>稳定性意味着解决方案不会增长，也就是说，我们希望左手边的数值小于零，如果右边算子的特征值都是负的，就会出现这种情况。由于显而易见的原因，如果核反应堆产生的中子通量呈指数增长，这不是很理想，所以特征值分析是核工程师的面包和主食。因此，该程序的要点是考虑特征值问题 </p><p class="formulaDsp">
\begin{eqnarray*} (L-F-X) \phi = \lambda \phi, \end{eqnarray*}
</p>
<p>其中我们要确保所有的特征值都是正值。请注意， \(L\) ，作为扩散算子加上吸收（去除），是正定的；因此，所有特征值为正的条件意味着我们要确保裂变和组间散射足够弱，不会将光谱转移到负值。</p>
<p>在核工程中，人们通常会关注特征值问题的一个稍微不同的表述。为此，我们不只是与 \(\phi\) 相乘并进行积分，而是与 \(\phi(L-X)^{-1}\) 相乘。然后我们得到以下演化方程。 </p><p class="formulaDsp">
\begin{eqnarray*} \frac 1{2v} \frac{\partial}{\partial t} \|\phi\|^2_{(L-X)^{-1}} = ((L-X)^{-1}(-L+F+X)\phi,\phi). \end{eqnarray*}
</p>
<p>如果以下问题的特征值都是负的，那么稳定性就得到保证。 </p><p class="formulaDsp">
\begin{eqnarray*} (L-X)^{-1}(-L+F+X)\phi = \lambda_F \phi, \end{eqnarray*}
</p>
<p>这等同于特征值问题 </p><p class="formulaDsp">
\begin{eqnarray*} (L-X)\phi = \frac 1{\lambda_F+1} F \phi. \end{eqnarray*}
</p>
<p>核工程中的典型表述是将其写成 </p><p class="formulaDsp">
\begin{eqnarray*} (L-X) \phi = \frac 1{k_{\mathrm{eff}}} F \phi, \end{eqnarray*}
</p>
<p>其中 \(k_{\mathrm{eff}}=\frac 1{\lambda^F+1}\) 。直观地说， \(k_{\mathrm{eff}}\) 是类似于每个典型时间尺度的中子乘法系数，对于反应堆的稳定运行来说，它应该小于或等于1：如果它小于1，链式反应就会消亡，而核弹等的特征值 \(k\) 大于1。一个稳定的反应堆应该有 \(k_{\mathrm{eff}}=1\) 。</p>
<p>对于那些想知道如何在实践中实现这一点，而不在无意中得到略大于1的值并触发核弹的人来说：首先，裂变过程发生在不同的时间尺度上。虽然大多数中子在裂变事件后很快就被释放出来，但少量的中子只有在裂变开始后经过几次进一步的衰变后，才由子核释放出来，最长可达10-60秒。因此，如果人们稍稍超出 \(k_{\mathrm{eff}}=1\) ，就会有许多秒的反应时间，直到裂变中产生的所有中子重新进入裂变循环。然而，吸收中子的核反应堆中的控制棒&ndash;并因此减少 \(k_{\mathrm{eff}}\) &ndash;被设计成最多在2秒内全部进入反应堆。</p>
<p>因此，如果 \(k_{\mathrm{eff}}\) 在一段时间内大于1，正如不断增长的中子通量所表明的那样，人们有10-60秒的时间来调节核反应。调节可以通过持续监测中子通量来实现，必要时通过将吸收中子的控制棒移入或移出反应堆几毫米来增加或减少中子通量。在更大的范围内，冷却反应堆的水含有硼，一种良好的中子吸收剂。每隔几个小时，通过添加硼或稀释冷却剂来调整硼的浓度。</p>
<p>最后，一些吸收和散射反应有一些内置的稳定性；例如，较高的中子通量导致局部温度升高，这降低了水的密度，因此减少了散射体的数量，而这些散射体是在中子自己开始裂变事件之前将中子从高能量缓和到低能量所必需的。</p>
<p>在这个教程程序中，我们解决上述 \(k\) -两个能量组的特征值问题，我们正在寻找最大的乘法系数 \(k_{\mathrm{eff}}\) ，它与最小特征值的逆值加1成正比。为了解决特征值问题，我们一般使用<em>inverse power method</em>的修改版。该算法看起来像这样。</p>
<ol>
<li>
<p class="startli">用 \(\phi_g^{(0)}\) 和 \(k_{\mathrm{eff}}^{(0)}\) 初始化 \(\phi_g\) 和 \(k_{\mathrm{eff}}\) ，让 \(n=1\) 。</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">用 </p><p class="formulaDsp">
\begin{eqnarray*} s_f^{(n-1)}(x) = \frac{1}{k_{\mathrm{eff}}^{(n-1)}} \sum_{g&#39;=1}^G\nu\Sigma_{f,g&#39;}(x)\phi_{g&#39;}^{(n-1)}(x). \end{eqnarray*}
</p>
<p>定义所谓的<em>fission source</em>。</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">用 </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot D_g\nabla \phi_g^{(n)} + \Sigma_{r,g}\phi_g^{(n)} = \chi_g s_f^{(n-1)} + \sum_{g&#39;&lt; g} \Sigma_{s,g&#39;\to g} \phi_{g&#39;}^{(n)} + \sum_{g&#39;&gt; g}\Sigma_{s,g&#39;\to g}\phi_{g&#39;}^{(n-1)}. \end{eqnarray*}
</p>
<p>求解所有组通量 \(\phi_g,g=1,\ldots,G\) 。</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">更新 </p><p class="formulaDsp">
\begin{eqnarray*} k_{\mathrm{eff}}^{(n)} = \sum_{g&#39;=1}^G \int_{\Omega}\nu\Sigma_{f,g&#39;}(x) \phi_{g&#39;}^{(n)}(x)dx. \end{eqnarray*}
</p>
<p class="endli"></p>
</li>
<li>
比较 \(k_{\mathrm{eff}}^{(n)}\) 和 \(k_{\mathrm{eff}}^{(n-1)}\) 。 如果变化大于规定的公差，则设置 \(n=n+1\) 从步骤2开始重复迭代，否则结束迭代。 </li>
</ol>
<p><br  />
</p>
<p>请注意，在这个方案中，我们并不在每个功率迭代中准确地解决群通量，而是考虑以前只计算 \(\phi_{g&#39;}^{(n)}\) 下散射事件 \(g&#39;&lt;g\) 。上散射只通过使用旧的迭代器来处理 \(\phi_{g&#39;}^{(n-1)}\) ，实质上是假设散射算子是三角形的。这在物理上是有原因的，因为向上散射在中子散射中并不扮演太重要的角色。此外，实践表明，即使使用这种简化方法，反功率迭代也是稳定的。</p>
<p>还要注意的是，人们可以使用很多外推技术来加速上述的功率迭代。然而，这些都没有在这个例子中实现。</p>
<p><a class="anchor" id="Meshesandmeshrefinement"></a></p><h3>Meshes and mesh refinement</h3>
<p>人们可能会问，在同一网格上求解各个能量组方程的解是否合适。这个问题可以归结为： \(\phi_g\) 和 \(\phi_{g&#39;}\) 是否会有类似的平稳性特性？如果是这样的话，那么对两者使用相同的网格是合适的；一个典型的应用可能是化学燃烧，通常所有或大多数化学物种的浓度在火焰前沿快速变化。事实证明，通过观察本教程程序结果部分显示的图形就会发现，然而这里的情况并非如此：由于不同能量组的扩散系数不同，快中子（在小群数 \(g\) 的仓中）有一个非常平滑的通量函数，而慢中子（在大群数的仓中）受当地材料特性的影响更大，如果像我们这里计算的情况一样，系数是粗糙的，则有一个相应的粗糙解。因此，我们将希望使用不同的网格来计算每个能量组。</p>
<p>这有两个影响，我们将不得不考虑。首先，我们需要找到一种方法来单独细化这些网格。第二，为逆功率迭代组装源项，我们必须将定义在网格 \(g&#39;\) 上的解 \(\phi_{g&#39;}^{(n)}\) 与定义在网格 \(g\) 上的形状函数进行积分，这将成为一项更为复杂的任务。</p>
<p><a class="anchor" id="Meshrefinement"></a></p><h4>Mesh refinement</h4>
<p>我们使用通常的范式：在一个给定的网格上求解，然后为每个网格的每个单元评估一个误差指标。因为它非常方便，我们再次使用Kelly, Gago, Zienkiewicz和Babuska的后验误差估计器，它通过整合每个单元面的解的梯度跳跃来近似每个单元的误差。利用这一点，我们得到指标 </p><p class="formulaDsp">
\begin{eqnarray*} \eta_{g,K}, \qquad g=1,2,\ldots,G,\qquad K\in{\cal T}_g, \end{eqnarray*}
</p>
<p>其中 \({\cal T}_g\) 是用于解决 \(\phi_g\) 的三角结构。问题是该如何处理这个问题。其一，很明显，只提炼那些误差指标最高的单元可能会导致不好的结果。为了理解这一点，必须认识到 \(\eta_{g,K}\) 与 \(\phi_g\) 的二阶导数成比例。换句话说，如果我们有两个能量组 \(g=1,2\) ，它们的解同样平滑，但其中一个大了一万倍，例如，那么只有该网格的单元被细化，而小幅度的解的网格将保持粗糙。这可能不是人们想要的，因为我们可以认为解决方案的两个部分都同样重要。</p>
<p>因此，从本质上讲，我们必须用一个重要系数 \(z_g\) 来衡量 \(\eta_{g,K}\) ，即在任何特定精度下解决 \(\phi_g\) 的重要性。这样的重要系数可以用对偶性技术来计算（例如，见 <a class="el" href="step_14.html">step-14</a> 教程程序，以及那里引用的班格特和兰纳赫的书的参考资料）。然而，我们不会去那里，而只是假设所有的能量组都是同等重要的，因此将通过解 \(\phi_g\) 的最大值对 \(\eta_{g,K}\) 组的误差指标进行归一化。然后我们细化那些误差满足 </p><p class="formulaDsp">
\begin{eqnarray*} \frac{\eta_{g,K}}{\|\phi_g\|_\infty} &gt; \alpha_1 \displaystyle{\max_{\begin{matrix}1\le g\le G \\ K\in {\cal T}_g\end{matrix}} \frac{\eta_{g,K}}{\|\phi_g\|_\infty}} \end{eqnarray*}
</p>
<p>的单元。</p>
<p>并粗化满足 </p><p class="formulaDsp">
\begin{eqnarray*} \frac{\eta_{g,K}}{\|\phi_g\|_\infty} &lt; \alpha_2 \displaystyle{\max_{\begin{matrix}1\le g\le G \\ K\in {\cal T}_g\end{matrix}} \frac{\eta_{g,K}}{\|\phi_g\|_\infty}}. \end{eqnarray*}
</p>
<p>的单元格。</p>
<p>我们在代码中选择 \(\alpha_1=0.3\) 和 \(\alpha_2=0.01\) 。注意，这当然会导致不同能量组的网格不同。</p>
<p>上述策略本质上意味着以下几点。如果对于能量组 \(g\) 来说，有许多单元 \(K\in {\cal T}_g\) 的误差很大，例如因为解是全局非常粗糙的，那么许多单元将在阈值之上。另一方面，如果有几个单元的误差较大，而许多单元的误差较小，例如，因为除了少数地方外，解决方案总体上是相当平滑的，那么，只有少数有较大误差的单元将被精炼。因此，该策略允许网格很好地跟踪相应解的全局平滑特性。</p>
<p><a class="anchor" id="Assemblingtermsondifferentmeshes"></a></p><h4>Assembling terms on different meshes</h4>
<p>如上所述，多组细化策略导致不同解的网格不同 \(\phi_g\) 。那么问题出在哪里呢？实质上是这样的：在特征值迭代的第3步中，我们要像往常一样通过与定义在网格上的测试函数 \(\varphi_g^i\) 相乘来形成方程的弱形式，以计算 \(\phi_g^{(n)}\) ；在这个过程中，我们要计算包含以下形式的项的右手向量。 </p><p class="formulaDsp">
\begin{eqnarray*} F_i = \int_\Omega f(x) \varphi_g^i(x) \phi_{g&#39;}(x) \ dx, \end{eqnarray*}
</p>
<p>其中 \(f(x)\) 是用于特征值方程右侧的系数函数 \(\Sigma_{s,g&#39;\to g}\) 或 \(\nu\chi_g\Sigma_{f,g&#39;}\) 之一。现在的困难是 \(\phi_{g&#39;}\) 是定义在能量组 \(g&#39;\) 的网格上，即它可以扩展为 \(\phi_{g&#39;}(x)=\sum_j\phi_{g&#39;}^j \varphi_{g&#39;}^j(x)\) ，基函数 \(\varphi_{g&#39;}^j(x)\) 定义在网格 \(g&#39;\) 。因此，对右边的贡献可以写成 </p><p class="formulaDsp">
\begin{eqnarray*} F_i = \sum_j \left\{\int_\Omega f(x) \varphi_g^i(x) \varphi_{g&#39;}^j(x) \ dx \right\} \phi_{g&#39;}^j , \end{eqnarray*}
</p>
<p>另一方面，测试函数 \(\varphi_g^i(x)\) 被定义在网格 \(g\) 上。这意味着我们不能将积分 \(\Omega\) 分割成网格 \(g\) 或 \(g&#39;\) 上的积分，因为其他的基函数可能不在这些单元上定义。</p>
<p>这个问题的解决方案在于， \(g\) 和 \(g&#39;\) 的网格都是通过自适应细化从一个共同的粗网格中得到的。因此，我们总能找到一组满足以下条件的单元，我们用 \({\cal T}_g \cap {\cal T}_{g&#39;}\) 表示。 </p><ul>
<li>
这些单元的联合覆盖了整个域，并且 </li>
<li>
一个单元 \(K \in {\cal T}_g \cap {\cal T}_{g&#39;}\) 在两个网格中至少有一个是活动的。 </li>
</ul>
<p>构造这个集合的方法是，取粗网格的每个单元，做以下步骤。(i) 如果该单元在 \({\cal T}_g\) 或 \({\cal T}_{g&#39;}\) 上处于活动状态，则将该单元加入该集合；(ii) 否则，即如果该单元在两个网格上都有子节点，则对该单元的每个子节点做步骤(i)。事实上，deal.II有一个函数 <a class="el" href="namespaceGridTools.html#a32a5016c746ad756046ecff264dfa60d">GridTools::get_finest_common_cells</a> 可以准确地计算出在两个网格中至少有一个处于活动状态的单元的集合。</p>
<p>有了这个，我们可以将上述积分写成如下。 </p><p class="formulaDsp">
\begin{eqnarray*} F_i = \sum_{K \in {\cal T}_g \cap {\cal T}_{g&#39;}} \sum_j \left\{\int_K f(x) \varphi_g^i(x) \varphi_{g&#39;}^j(x) \ dx \right\} \phi_{g&#39;}^j. \end{eqnarray*}
</p>
<p>在代码中，我们在函数 <code>NeutronDiffusionProblem::assemble_rhs</code> 中计算右手边，其中（除其他外）我们在共同的最精炼单元的集合上循环，在这些单元的每一对上调用函数 <code>NeutronDiffusionProblem::assemble_common_cell</code> 。</p>
<p>根据结构，现在有三种情况需要考虑。 </p><ol>
<li>
单元 \(K\) 在两个网格上都是有效的，也就是说，基函数 \(\varphi_g^i\) 以及 \(\varphi_{g&#39;}^j\) 都是在 \(K\) 上定义。 </li>
<li>
单元 \(K\) 在网格 \(g\) 上有效，但在 \(g&#39;\) 上无效，即 \(\varphi_g^i\) 定义在 \(K\) 上，而 \(\varphi_{g&#39;}^j\) 则定义在 \(K\) 的子网格上。 </li>
<li>
单元 \(K\) 在网格 \(g&#39;\) 上是有效的，但在 \(g\) 上不是，其结论与(ii)中相反。 </li>
</ol>
<p><br  />
</p>
<p>为了计算上面的右手边，我们就需要对这三种情况有不同的代码，如下所示。 </p><ol>
<li>
<p class="startli">如果单元 \(K\) 在两个网格上都是活动的，那么我们可以直接评估积分。事实上，我们甚至不必理会基函数 \(\varphi_{g&#39;}\) ，因为我们所需要的只是 \(\phi_{g&#39;}\) 在正交点的值。我们可以使用 <a class="el" href="classFEValuesBase.html#a357b422e374f2f2207af3512093f3907">FEValues::get_function_values</a> 函数来完成这个任务。这可以直接在 <code>NeutronDiffusionProblem::assemble_common_cell</code> 函数中完成。</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">如果单元 \(K\) 在网格 \(g\) 上被激活，而不是 \(g&#39;\) ，那么基函数 \(\varphi_{g&#39;}^j\) 只定义在子单元 \(K_c,0\le c&lt;2^{\texttt{dim}}\) 上，或者如果单元 \(K\) 在网格 \(g&#39;\) 上被精炼了一次以上，则定义在这些子单元的子节点上。</p>
<p class="interli">让我们假设 \(K\) 在网格 \(g&#39;\) 上只比在网格 \(g\) 上多精炼一次。利用我们使用嵌入式有限元空间的事实，即一个网格上的每个基函数可以写成下一个细化网格上的基函数的线性组合，我们可以将 \(\phi_g^i\) 对子单元 \(K_c\) 的限制扩展为定义在该子单元上的基函数（即定义有基函数 \(\varphi_{g&#39;}^l\) 的单元）。 </p><p class="formulaDsp">
\begin{eqnarray*} \phi_g^i|_{K_c} = B_c^{il} \varphi_{g&#39;}^l|_{K_c}. \end{eqnarray*}
</p>
<p class="interli">在这里，以及在下文中，对出现两次的指数进行求和是隐含的。矩阵 \(B_c\) 是将数据从一个单元内插到其 \(c\) -个子单元的矩阵。</p>
<p class="interli">那么我们可以把单元格 \(K\) 对右侧分量 \(F_i\) 的贡献写成 </p><p class="formulaDsp">
\begin{eqnarray*} F_i|_K &amp;=&amp; \left\{ \int_K f(x) \varphi_g^i(x) \varphi_{g&#39;}^j(x) \ dx \right\} \phi_{g&#39;}^j \\ &amp;=&amp; \left\{ \sum_{0\le c&lt;2^{\texttt{dim}}} B_c^{il} \int_{K_c} f(x) \varphi_{g&#39;}^l(x) \varphi_{g&#39;}^j(x) \ dx \right\} \phi_{g&#39;}^j. \end{eqnarray*}
</p>
<p class="interli">在矩阵符号中，可以写成 </p><p class="formulaDsp">
\begin{eqnarray*} F_i|_K = \sum_{0\le c&lt;2^{\texttt{dim}}} F_i|_{K_c}, \qquad \qquad F_i|_{K_c} = B_c^{il} M_{K_c}^{lj} \phi_{g&#39;}^j = (B_c M_{K_c})^{ij} \phi_{g&#39;}^j, \end{eqnarray*}
</p>
<p class="interli">其中 \(M_{K_c}^{lj}=\int_{K_c} f(x) \varphi_{g&#39;}^l(x) \varphi_{g&#39;}^j(x)\) 是单元格 \(K\) 的子 \(c\) 上的加权质量矩阵。</p>
<p class="interli">接下来的问题是，如果 \(K\) 的子单元 \(K_c\) 不活动，会发生什么情况。然后，我们必须递归地应用这个过程，即我们必须将基函数 \(\varphi_g^i\) 插值到 \(K\) 的子单元 \(K_c\) 上，然后插值到该单元的子单元 \(K_{cc&#39;}\) 上，插值到该单元的子单元 \(K_{cc&#39;c&#39;&#39;}\) 上，等等，直到我们找到一个活动单元。然后，我们必须将单元格 \(K\) 的所有子代、孙代等的贡献相加，其贡献形式为 </p><p class="formulaDsp">
\begin{eqnarray*} F_i|_{K_{cc&#39;}} = (B_cB_{c&#39;} M_{K_{cc&#39;}})^{ij} \phi_{g&#39;}^j, \end{eqnarray*}
</p>
<p class="interli">或 </p><p class="formulaDsp">
\begin{eqnarray*} F_i|_{K_{cc&#39;c&#39;&#39;}} = (B_c B_{c&#39;} B_{c&#39;&#39;}M_{K_{cc&#39;c&#39;&#39;}})^{ij} \phi_{g&#39;}^j, \end{eqnarray*}
</p>
<p class="interli">等。我们递归地做这个过程，也就是说，如果我们坐在单元格 \(K\) 上，看到它在网格 \(g&#39;\) 上有子代，那么我们用一个身份矩阵调用一个函数 <code>assemble_case_2</code> ；该函数将从左边的参数与延长矩阵相乘；如果该单元格还有子代，它将用这个新矩阵调用自己，否则它将进行整合。</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">最后一种情况是， \(K\) 在网格 \(g&#39;\) 上是有效的，但在网格 \(g\) 上不是。在这种情况下，我们必须用定义在单元格 \(K\) 上的基函数来表达基函数 \(\varphi_{g&#39;}^j\) ，而不是像之前那样用 \(\varphi_g^i\) 来表达。这当然是以完全相同的方式进行的。如果 \(K\) 的子单元在网格 \(g\) 上是活动的，那么导致表达式 </p><p class="formulaDsp">
\begin{eqnarray*} F_i|_K &amp;=&amp; \left\{ \int_K f(x) \varphi_g^i(x) \varphi_{g&#39;}^j(x) \ dx \right\} \phi_{g&#39;}^j \\ &amp;=&amp; \left\{ \sum_{0\le c&lt;2^{\texttt{dim}}} \int_{K_c} f(x) \varphi_g^i(x) B_c^{jl} \varphi_{g}^l(x) \ dx \right\} \phi_{g&#39;}^j. \end{eqnarray*}
</p>
<p class="interli">用矩阵符号表示，这个表达式现在读作 </p><p class="formulaDsp">
\begin{eqnarray*} F_i|_K = \sum_{0\le c&lt;2^{\texttt{dim}}} F_i|_{K_c}, \qquad \qquad F_i|_{K_c} = M_{K_c}^{il} B_c^{jl} \phi_{g&#39;}^j = (M_{K_c} B_c^T)^{ij} \phi_{g&#39;}^j, \end{eqnarray*}
</p>
<p class="interli">相应地，当单元格 \(K\) 在网格 \(g\) 上被精炼一次以上时： </p><p class="formulaDsp">
\begin{eqnarray*} F_i|_{K_{cc&#39;}} = (M_{K_{cc&#39;}} B_{c&#39;}^T B_c^T)^{ij} \phi_{g&#39;}^j, \end{eqnarray*}
</p>
<p class="interli">或 </p><p class="formulaDsp">
\begin{eqnarray*} F_i|_{K_{cc&#39;c&#39;&#39;}} = (M_{K_{cc&#39;c&#39;&#39;}} B_{c&#39;&#39;}^T B_{c&#39;}^T B_c^T)^{ij} \phi_{g&#39;}^j, \end{eqnarray*}
</p>
<p class="endli">等等。换句话说，这个过程与之前的工作方式完全相同，只是我们必须采取延长矩阵的转置，并需要将其与另一侧的质量矩阵相乘。 </p>
</li>
</ol>
<p><br  />
</p>
<p>情况（二）和（三）的表达式可以理解为将标量积 \((f \varphi_g^i, \varphi_{g&#39;}^j)_K\) 中的左或右基函数反复插值到子单元上，然后在最后的单元上形成内积（质量矩阵）。为了使这些情况的对称性更加明显，我们可以这样写：对于情况（二），我们有 </p><p class="formulaDsp">
\begin{eqnarray*} F_i|_{K_{cc&#39;\cdots c^{(k)}}} = [B_c B_{c&#39;} \cdots B_{c^{(k)}} M_{K_{cc&#39;\cdots c^{(k)}}}]^{ij} \phi_{g&#39;}^j, \end{eqnarray*}
</p>
<p>而对于情况（三），我们得到 </p><p class="formulaDsp">
\begin{eqnarray*} F_i|_{K_{cc&#39;\cdots c^{(k)}}} = [(B_c B_{c&#39;} \cdots B_{c^{(k)}} M_{K_{cc&#39;\cdots c^{(k)}}})^T]^{ij} \phi_{g&#39;}^j, \end{eqnarray*}
</p>
<p><a class="anchor" id="Descriptionofthetestcase"></a></p><h3>Description of the test case</h3>
<p>核反应堆堆芯是由不同类型的组件组成的。一个组件基本上是可以在反应堆中移动的最小单元，通常是矩形或方形。然而，组件并不是固定的单位，因为它们是由不同的燃料棒、控制棒和仪器元件的复杂晶格组装而成的，这些元件通过永久连接在燃料棒上的间隔物来保持彼此的位置。使事情更加复杂的是，在反应堆中同时使用不同种类的组件，这些组件在它们所组成的棒的类型和排列上有所不同。</p>
<p>显然，组件的排列以及组件内棒的排列会影响反应堆内中子通量的分布（通过查看本程序结果部分中显示的解决方案，这一事实将很明显）。例如，燃料棒在铀235或钚239的富集程度上彼此不同。另一方面，控制棒具有零裂变，但散射和吸收截面不为零。</p>
<p>这整个安排将使描述或空间依赖的材料参数变得非常复杂。它不会变得更简单，但我们将做一个近似：我们将每个圆柱形棒和周围的水所居住的体积合并成二次截面的体积，变成所谓的 "夹子单元"，对于这些单元，用核数据库和中子光谱的知识获得同质化的材料数据。同质化使所有材料数据在有新燃料的反应堆的求解域上成为片状常数。然后，对一个点所在的二次元组合进行空间依赖性材料参数的查询，然后对该组合中的二次元销单元进行查询。</p>
<p>在这个教程程序中，我们模拟了一个由 \(4 \times 4\) 组件组成的反应堆的四分之一。我们使用对称性（诺伊曼）边界条件，将问题缩小到四分之一的领域，因此只模拟 \(2\times 2\) 组的装配。其中两个将是UO \({}_2\) 燃料，另外两个是MOX燃料。这些组件中的每一个都由不同成分的 \(17\times 17\) 棒组成。因此，我们总共创造了一个 \(34\times 34\) 棒子的网格。为了使以后的事情更简单，我们通过创建一个 \(34\times 34\) 单元的粗大网格来反映这一事实（尽管领域是一个正方形，我们通常会使用一个单元）。在deal.II中，每个单元都有一个 <code>material_id</code> ，可以用来将每个单元与一个特定的数字联系起来，识别这个单元的体积是由什么材料制成的；我们将使用这个材料ID来识别在这个测试案例中使用的8种不同的杆子中的哪一种组成了一个特定的单元。请注意，在网格细化后，单元格的子代会继承材料ID，这样即使在网格细化后也能简单地跟踪材料。</p>
<p>在结果部分显示的图片中，棒材的排列将清晰可见。材料和两个能量组的截面都取自OECD/NEA的基准问题。详细的配置和材料数据在代码中给出。</p>
<p><a class="anchor" id="Whattheprogramdoesandhowitdoesthat"></a></p><h3>What the program does (and how it does that)</h3>
<p>作为对程序具体工作的粗略概述，以下是基本布局：从每个能量组相同的粗网格开始，我们计算反特征值迭代，以计算给定网格集上的 \(k\) -特征值。当特征值的变化低于一定的容忍度时，我们停止这些迭代，然后写出每个能量组的网格和解，供图形程序检查。由于解决方案的网格是不同的，我们必须为每个能量组生成一个单独的输出文件，而不是能够将所有能量组的解决方案加入同一个文件。</p>
<p>在这之后，我们按照上面某一节的解释对每个网格的误差指标进行评估，并独立地对每个网格的单元进行细化和粗化。由于特征值迭代是相当昂贵的，我们不想在新的网格上重新开始；相反，我们使用SolutionTransfer类在网格细化时将前一个网格的解插到下一个网格。一个简单的实验会让你相信，这比我们省略这一步要省事得多。这样做之后，我们在下一组网格上继续进行特征值迭代。</p>
<p>该程序由一个参数文件控制，使用ParameterHandler类。我们将在本教程的结果部分展示一个参数文件。现在只需说它控制了所使用的有限元的多项式程度，能量组的数量（尽管目前实现的只是2组问题的系数），停止反特征值迭代的容忍度，以及我们要做的细化循环的数量。<a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>我们从一堆包含文件开始，这些文件已经在以前的教程程序中解释过了。一个新的文件是 <code><a class="el" href="timer_8h.html">timer.h</a></code> : 这是第一个使用Timer类的例子程序。Timer同时记录了经过的挂钟时间（即安装在墙上的时钟所测量的时间）和CPU时钟时间（当前进程在CPU上使用的时间）。我们将在下面使用一个Timer来测量每个网格细化周期需要多少CPU时间。</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="timer_8h.html">deal.II/base/timer.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="parameter__handler_8h.html">deal.II/base/parameter_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="thread__management_8h.html">deal.II/base/thread_management.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparsity__pattern_8h.html">deal.II/lac/sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparse__matrix_8h.html">deal.II/lac/sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__out_8h.html">deal.II/grid/grid_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="ttc" id="aaffine__constraints_8h_html"><div class="ttname"><a href="affine__constraints_8h.html">affine_constraints.h</a></div></div>
<div class="ttc" id="adof__tools_8h_html"><div class="ttname"><a href="dof__tools_8h.html">dof_tools.h</a></div></div>
<div class="ttc" id="adofs_2dof__handler_8h_html"><div class="ttname"><a href="dofs_2dof__handler_8h.html">dof_handler.h</a></div></div>
<div class="ttc" id="adynamic__sparsity__pattern_8h_html"><div class="ttname"><a href="dynamic__sparsity__pattern_8h.html">dynamic_sparsity_pattern.h</a></div></div>
<div class="ttc" id="aerror__estimator_8h_html"><div class="ttname"><a href="error__estimator_8h.html">error_estimator.h</a></div></div>
<div class="ttc" id="afe_2fe__values_8h_html"><div class="ttname"><a href="fe_2fe__values_8h.html">fe_values.h</a></div></div>
<div class="ttc" id="afe__q_8h_html"><div class="ttname"><a href="fe__q_8h.html">fe_q.h</a></div></div>
<div class="ttc" id="afull__matrix_8h_html"><div class="ttname"><a href="full__matrix_8h.html">full_matrix.h</a></div></div>
<div class="ttc" id="afunction_8h_html"><div class="ttname"><a href="function_8h.html">function.h</a></div></div>
<div class="ttc" id="agrid_2grid__refinement_8h_html"><div class="ttname"><a href="grid_2grid__refinement_8h.html">grid_refinement.h</a></div></div>
<div class="ttc" id="agrid_2tria_8h_html"><div class="ttname"><a href="grid_2tria_8h.html">tria.h</a></div></div>
<div class="ttc" id="agrid__generator_8h_html"><div class="ttname"><a href="grid__generator_8h.html">grid_generator.h</a></div></div>
<div class="ttc" id="agrid__out_8h_html"><div class="ttname"><a href="grid__out_8h.html">grid_out.h</a></div></div>
<div class="ttc" id="ainclude_2deal_8II_2base_2utilities_8h_html"><div class="ttname"><a href="include_2deal_8II_2base_2utilities_8h.html">utilities.h</a></div></div>
<div class="ttc" id="amatrix__tools_8h_html"><div class="ttname"><a href="matrix__tools_8h.html">matrix_tools.h</a></div></div>
<div class="ttc" id="anumerics_2data__out_8h_html"><div class="ttname"><a href="numerics_2data__out_8h.html">data_out.h</a></div></div>
<div class="ttc" id="aparameter__handler_8h_html"><div class="ttname"><a href="parameter__handler_8h.html">parameter_handler.h</a></div></div>
<div class="ttc" id="aprecondition_8h_html"><div class="ttname"><a href="precondition_8h.html">precondition.h</a></div></div>
<div class="ttc" id="aquadrature__lib_8h_html"><div class="ttname"><a href="quadrature__lib_8h.html">quadrature_lib.h</a></div></div>
<div class="ttc" id="asolver__cg_8h_html"><div class="ttname"><a href="solver__cg_8h.html">solver_cg.h</a></div></div>
<div class="ttc" id="asparse__matrix_8h_html"><div class="ttname"><a href="sparse__matrix_8h.html">sparse_matrix.h</a></div></div>
<div class="ttc" id="asparsity__pattern_8h_html"><div class="ttname"><a href="sparsity__pattern_8h.html">sparsity_pattern.h</a></div></div>
<div class="ttc" id="athread__management_8h_html"><div class="ttname"><a href="thread__management_8h.html">thread_management.h</a></div></div>
<div class="ttc" id="atimer_8h_html"><div class="ttname"><a href="timer_8h.html">timer.h</a></div></div>
<div class="ttc" id="avector_8h_html"><div class="ttname"><a href="vector_8h.html">vector.h</a></div></div>
<div class="ttc" id="avector__tools_8h_html"><div class="ttname"><a href="vector__tools_8h.html">vector_tools.h</a></div></div>
</div><!-- fragment --><p>我们使用下一个include文件来访问块向量，它为我们提供了一种方便的方式来管理所有能量组的解和右手向量。</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="block__vector_8h.html">deal.II/lac/block_vector.h</a>&gt;</span></div>
<div class="ttc" id="ablock__vector_8h_html"><div class="ttname"><a href="block__vector_8h.html">block_vector.h</a></div></div>
</div><!-- fragment --><p>这个包含文件是用来将解从一个网格转移到另一个不同的网格。我们在每次网格迭代后初始化解法时使用它。</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div>
<div class="ttc" id="anumerics_2solution__transfer_8h_html"><div class="ttname"><a href="numerics_2solution__transfer_8h.html">solution_transfer.h</a></div></div>
</div><!-- fragment --><p>当在一个网格上定义的函数与另一个网格上定义的形状函数进行积分时，我们需要一个函数 <code>get_finest_common_cells</code> (如在介绍中所讨论的)，它定义在以下头文件中。</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div>
<div class="ttc" id="agrid__tools_8h_html"><div class="ttname"><a href="grid__tools_8h.html">grid_tools.h</a></div></div>
</div><!-- fragment --><p>我们使用一个来自boost的小工具类来保存输出流的状态（见下面的 <code>run</code> 函数）。</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;boost/io/ios_state.hpp&gt;</span></div>
</div><!-- fragment --><p>这里还有两个C++标准头文件，我们用它来定义列表数据类型，以及微调我们生成的输出。</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;list&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iomanip&gt;</span></div>
</div><!-- fragment --><p>最后一步和以前所有的程序一样。</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>Step28</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="ttc" id="anamespacedealii_html"><div class="ttname"><a href="namespacedealii.html">dealii</a></div><div class="ttdef"><b>Definition:</b> <a href="namespace__dealii_8h_source.html#l00025">namespace_dealii.h:26</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="Materialdata"></a> </p><h3>Material data</h3>
<p>首先，我们需要定义一个类，为主类提供材料数据（包括扩散系数、清除截面、散射截面、裂变截面和裂变光谱）。 <br  />
</p>
<p>构造函数的参数决定了我们为多少个能量组设置了相关的表格。目前，这个程序只包括2个能量组的数据，但更复杂的程序可能也能初始化更多能量组的数据结构，这取决于在参数文件中选择了多少个能量组。 <br  />
</p>
<p>对于每一种不同的系数类型，都有一个函数来返回特定能量组（或能量组的组合，如分布截面 \(\chi_g\nu\Sigma_{f,g&#39;}\) 或散射截面 \(\Sigma_{s,g&#39;\to g}\) ）的这个系数的值。除了能量组之外，这些系数还取决于燃料或控制棒的类型，正如介绍中所解释的那样。因此，这些函数需要一个额外的参数，<code>material_id，以确定特定种类的棒。在这个程序中，我们使用</code> <code>n_materials=8</code> 不同种类的棒子。</p>
<p>除了散射截面，每个系数都可以表示为一个二维浮点数组中的一个条目，该数组由能量组编号以及材料ID索引。表类模板是存储此类数据的理想方式。最后，散射系数取决于两个能量组的索引，因此需要存储在一个三维数组中，为此我们再次使用表类，这时第一个模板参数（表示数组的维度）当然需要是三。</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>MaterialData</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  MaterialData(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_groups);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> get_diffusion_coefficient(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group,</div>
<div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>) <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">double</span> get_removal_XS(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group,</div>
<div class="line">                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>) <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">double</span> get_fission_XS(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group,</div>
<div class="line">                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>) <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">double</span> get_fission_dist_XS(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_1,</div>
<div class="line">                             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_2,</div>
<div class="line">                             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>) <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">double</span> get_scattering_XS(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_1,</div>
<div class="line">                           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_2,</div>
<div class="line">                           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>) <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">double</span> get_fission_spectrum(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group,</div>
<div class="line">                              <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_groups;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_materials;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTable.html">Table&lt;2, double&gt;</a> diffusion;</div>
<div class="line">  <a class="code" href="classTable.html">Table&lt;2, double&gt;</a> sigma_r;</div>
<div class="line">  <a class="code" href="classTable.html">Table&lt;2, double&gt;</a> nu_sigma_f;</div>
<div class="line">  <a class="code" href="classTable.html">Table&lt;3, double&gt;</a> sigma_s;</div>
<div class="line">  <a class="code" href="classTable.html">Table&lt;2, double&gt;</a> chi;</div>
<div class="line">};</div>
<div class="ttc" id="aclassTable_html"><div class="ttname"><a href="classTable.html">Table&lt; 2, double &gt;</a></div></div>
<div class="ttc" id="anamespacetypes_html_ae22a1b4da339109d8dc9cc2a112b1a69"><div class="ttname"><a href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">types::material_id</a></div><div class="ttdeci">unsigned int material_id</div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00152">types.h:152</a></div></div>
</div><!-- fragment --><p>该类的构造函数被用来初始化所有的材料数据数组。它需要能量组的数量作为参数（如果该值不等于2，就会抛出一个错误，因为目前只实现了两个能量组的数据；然而，利用这一点，该函数仍然是灵活的，可扩展到未来）。在开始的成员初始化部分，它也将数组的大小调整为正确的大小。 <br  />
</p>
<p>目前，材料数据被存储为8种不同类型的材料。这也可以在将来很容易地被扩展。</p>
<div class="fragment"><div class="line">MaterialData::MaterialData(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_groups)</div>
<div class="line">  : n_groups(n_groups)</div>
<div class="line">  , n_materials(8)</div>
<div class="line">  , diffusion(n_materials, n_groups)</div>
<div class="line">  , sigma_r(n_materials, n_groups)</div>
<div class="line">  , nu_sigma_f(n_materials, n_groups)</div>
<div class="line">  , sigma_s(n_materials, n_groups, n_groups)</div>
<div class="line">  , chi(n_materials, n_groups)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">switch</span> (this-&gt;n_groups)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">case</span> 2:</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> m = 0; m &lt; n_materials; ++m)</div>
<div class="line">            {</div>
<div class="line">              diffusion[m][0] = 1.2;</div>
<div class="line">              diffusion[m][1] = 0.4;</div>
<div class="line">              chi[m][0]       = 1.0;</div>
<div class="line">              chi[m][1]       = 0.0;</div>
<div class="line">              sigma_r[m][0]   = 0.03;</div>
<div class="line">              <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_1 = 0; group_1 &lt; n_groups; ++group_1)</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_2 = 0; group_2 &lt; n_groups; ++group_2)</div>
<div class="line">                  sigma_s[m][group_1][group_2] = 0.0;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">          diffusion[5][1] = 0.2;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">          sigma_r[4][0] = 0.026;</div>
<div class="line">          sigma_r[5][0] = 0.051;</div>
<div class="line">          sigma_r[6][0] = 0.026;</div>
<div class="line">          sigma_r[7][0] = 0.050;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">          sigma_r[0][1] = 0.100;</div>
<div class="line">          sigma_r[1][1] = 0.200;</div>
<div class="line">          sigma_r[2][1] = 0.250;</div>
<div class="line">          sigma_r[3][1] = 0.300;</div>
<div class="line">          sigma_r[4][1] = 0.020;</div>
<div class="line">          sigma_r[5][1] = 0.040;</div>
<div class="line">          sigma_r[6][1] = 0.020;</div>
<div class="line">          sigma_r[7][1] = 0.800;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">          nu_sigma_f[0][0] = 0.0050;</div>
<div class="line">          nu_sigma_f[1][0] = 0.0075;</div>
<div class="line">          nu_sigma_f[2][0] = 0.0075;</div>
<div class="line">          nu_sigma_f[3][0] = 0.0075;</div>
<div class="line">          nu_sigma_f[4][0] = 0.000;</div>
<div class="line">          nu_sigma_f[5][0] = 0.000;</div>
<div class="line">          nu_sigma_f[6][0] = 1<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">e</a>-7;</div>
<div class="line">          nu_sigma_f[7][0] = 0.00;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">          nu_sigma_f[0][1] = 0.125;</div>
<div class="line">          nu_sigma_f[1][1] = 0.300;</div>
<div class="line">          nu_sigma_f[2][1] = 0.375;</div>
<div class="line">          nu_sigma_f[3][1] = 0.450;</div>
<div class="line">          nu_sigma_f[4][1] = 0.000;</div>
<div class="line">          nu_sigma_f[5][1] = 0.000;</div>
<div class="line">          nu_sigma_f[6][1] = 3<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">e</a>-6;</div>
<div class="line">          nu_sigma_f[7][1] = 0.00;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">          sigma_s[0][0][1] = 0.020;</div>
<div class="line">          sigma_s[1][0][1] = 0.015;</div>
<div class="line">          sigma_s[2][0][1] = 0.015;</div>
<div class="line">          sigma_s[3][0][1] = 0.015;</div>
<div class="line">          sigma_s[4][0][1] = 0.025;</div>
<div class="line">          sigma_s[5][0][1] = 0.050;</div>
<div class="line">          sigma_s[6][0][1] = 0.025;</div>
<div class="line">          sigma_s[7][0][1] = 0.010;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">default</span>:</div>
<div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>,</div>
<div class="line">               <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(</div>
<div class="line">                 <span class="stringliteral">&quot;Presently, only data for 2 groups is implemented&quot;</span>));</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="agroup__Exceptions_html_ga70a0bb353656e704acf927945277bbc6"><div class="ttname"><a href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a></div><div class="ttdeci">#define Assert(cond, exc)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01473">exceptions.h:1473</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_gae9a45f517af1401c50811a11083f9114"><div class="ttname"><a href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">StandardExceptions::ExcMessage</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcMessage(std::string arg1)</div></div>
<div class="ttc" id="anamespacePhysics_1_1Elasticity_1_1Kinematics_html_a9587d5229555daa5b1fa1ba2f8a40adb"><div class="ttname"><a href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">Physics::Elasticity::Kinematics::e</a></div><div class="ttdeci">SymmetricTensor&lt; 2, dim, Number &gt; e(const Tensor&lt; 2, dim, Number &gt; &amp;F)</div></div>
</div><!-- fragment --><p>接下来是返回给定材料和能量组的系数值的函数。它们所做的只是确保给定的参数在允许的范围内，然后在相应的表格中查找相应的值。</p>
<div class="fragment"><div class="line"><span class="keywordtype">double</span></div>
<div class="line">MaterialData::get_diffusion_coefficient(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group,</div>
<div class="line">                                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(group &lt; n_groups, <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(group, 0, n_groups));</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a> &lt; n_materials,</div>
<div class="line">         <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>, 0, n_materials));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> diffusion[<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>][group];</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> MaterialData::get_removal_XS(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group,</div>
<div class="line">                                    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(group &lt; n_groups, <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(group, 0, n_groups));</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a> &lt; n_materials,</div>
<div class="line">         <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>, 0, n_materials));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> sigma_r[<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>][group];</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> MaterialData::get_fission_XS(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group,</div>
<div class="line">                                    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(group &lt; n_groups, <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(group, 0, n_groups));</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a> &lt; n_materials,</div>
<div class="line">         <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>, 0, n_materials));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> nu_sigma_f[<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>][group];</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> MaterialData::get_scattering_XS(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_1,</div>
<div class="line">                                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_2,</div>
<div class="line">                                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(group_1 &lt; n_groups, <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(group_1, 0, n_groups));</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(group_2 &lt; n_groups, <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(group_2, 0, n_groups));</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a> &lt; n_materials,</div>
<div class="line">         <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>, 0, n_materials));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> sigma_s[<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>][group_1][group_2];</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span></div>
<div class="line">MaterialData::get_fission_spectrum(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group,</div>
<div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(group &lt; n_groups, <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(group, 0, n_groups));</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a> &lt; n_materials,</div>
<div class="line">         <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>, 0, n_materials));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> chi[<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>][group];</div>
<div class="line">}</div>
<div class="ttc" id="agroup__Exceptions_html_ga0d685aad996180f9851183ae3e29019a"><div class="ttname"><a href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">StandardExceptions::ExcIndexRange</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcIndexRange(int arg1, int arg2, int arg3)</div></div>
</div><!-- fragment --><p>计算裂变分布截面的函数略有不同，因为它将其值计算为另外两个系数的乘积。我们不需要在这里检查参数，因为这在我们调用其他两个相关函数时已经发生了，尽管这样做可能也无妨。</p>
<div class="fragment"><div class="line"><span class="keywordtype">double</span> MaterialData::get_fission_dist_XS(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_1,</div>
<div class="line">                                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_2,</div>
<div class="line">                                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">return</span> (get_fission_spectrum(group_1, <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>) *</div>
<div class="line">          get_fission_XS(group_2, <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>));</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeEnergyGroupcodeclass"></a> </p><h3>The <code>EnergyGroup</code> class</h3>
<p>第一个有趣的类是包含所有特定于单一能量组的东西。为了将那些属于同一个对象的东西分组，我们声明了一个结构，该结构包含了用于单个能量组的网格的Triangulation和DoFHandler对象，以及一些其他对象和成员函数，我们将在下面的章节中讨论。 <br  />
</p>
<p>这个类的主要原因如下：对于正向问题（有指定的右手边）和特征值问题，人们通常解决一连串的问题，而不是完全耦合的问题，每个能量组。一旦意识到单一能量组的系统矩阵是对称和正定的（它只是一个扩散算子），而完全耦合问题的矩阵通常是非对称和非定值的，这就可以理解了。如果涉及几个以上的能量组，它也是非常大和相当完整的。 <br  />
</p>
<p>让我们首先看一下在外部右手边的情况下要解决的方程（对于时间无关的情况）。 </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot(D_g(x) \nabla \phi_g(x)) + \Sigma_{r,g}(x)\phi_g(x) = \chi_g\sum_{g&#39;=1}^G\nu\Sigma_{f,g&#39;}(x)\phi_{g&#39;}(x) + \sum_{g&#39;\ne g}\Sigma_{s,g&#39;\to g}(x)\phi_{g&#39;}(x) + s_{\mathrm{ext},g}(x) \end{eqnarray*}
</p>
<p>我们通常会通过将右手边的所有项与 \(g&#39;=g\) 移到左手边来解决这个方程，并求出 \(\phi_g\) 。当然，我们还不知道 \(\phi_{g&#39;}\) ，因为这些变量的方程包括涉及 \(\phi_g\) 的右侧项。在这种情况下，通常要做的是迭代：计算 </p><p class="formulaDsp">
\begin{eqnarray*} -\nabla \cdot(D_g(x) \nabla \phi^{(n)}_g(x)) &amp;+&amp; \Sigma_{r,g}(x)\phi^{(n)}_g(x) \\ &amp;=&amp; \chi_g\sum_{g&#39;=1}^{g-1}\nu\Sigma_{f,g&#39;}(x)\phi^{(n)}_{g&#39;}(x) + \chi_g\sum_{g&#39;=g}^G\nu\Sigma_{f,g&#39;}(x)\phi^{(n-1)}_{g&#39;}(x) + \sum_{g&#39;\ne g, g&#39;&lt;g}\Sigma_{s,g&#39;\to g}(x)\phi^{(n)}_{g&#39;}(x) + \sum_{g&#39;\ne g, g&#39;&gt;g}\Sigma_{s,g&#39;\to g}(x)\phi^{(n-1)}_{g&#39;}(x) + s_{\mathrm{ext},g}(x) \end{eqnarray*}
</p>
<p>换句话说，我们逐一解决方程，如果 \(g&#39;\ge g\) ，则使用前一次迭代中的 \(\phi_{g&#39;}\) 的值，如果 \(g&#39;&lt;g\) ，则使用本次迭代中已经计算的 \(\phi_{g&#39;}\) 的值。 <br  />
</p>
<p>当计算特征值时，我们做一个非常类似的迭代，只是我们没有外部的右手边，而且每次迭代后的解都会被缩放，这一点在介绍中已经解释过了。 <br  />
</p>
<p>在任何一种情况下，如果我们所做的只是让下面这一类人具备这些能力，那么这两种情况就可以共同处理。(i) 形成左手边的矩阵，(ii) 形成组内右手边的贡献，即涉及到不相干的来源，以及(iii) 形成源于组 \(g&#39;\) 的对右手边的贡献。这个类正是做这些工作（以及一些簿记工作，如网格细化、设置矩阵和向量等）。另一方面，这个类本身并不知道有多少个能量组，特别是它们是如何相互作用的，也就是说，外部迭代的样子（以及因此我们是解决一个特征值还是一个直接问题）的决定是留给本程序下面的NeutronDiffusionProblem类。 <br  />
</p>
<p>所以让我们来看看这个类和它的接口。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>EnergyGroup</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
</div><!-- fragment --><p><a class="anchor" id="codeEnergyGroupcodepublicmemberfunctions"></a> </p><h5><code>EnergyGroup</code> public member functions</h5>
<p><br  />
</p>
<p>该类有大量的公共成员函数，因为它的操作方式是由外部控制的，因此所有做重要事情的函数都需要从另一个类中调用。让我们从记账开始：该类显然需要知道它代表哪个能源组，使用哪种材料数据，以及从哪个粗略的网格开始。构造函数需要这些信息，并通过这些信息初始化相关的成员变量（见下文）。 <br  />
</p>
<p>然后，我们还需要设置线性系统的函数，即正确地确定矩阵的大小及其稀疏模式，等等，给定一个要使用的有限元对象。 <code>setup_linear_system</code> 函数就是这样做的。最后，对于这个初始块，有两个函数可以返回这个对象中使用的活动单元和自由度的数量&ndash;利用这一点，我们可以使三角形和DoF处理程序成员变量私有化，而不必授予外部使用，增强了封装性。</p>
<div class="fragment"><div class="line">EnergyGroup(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        group,</div>
<div class="line">            <span class="keyword">const</span> MaterialData &amp;      material_data,</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> &amp;coarse_grid,</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;fe);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> setup_linear_system();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceinternal_1_1TriangulationImplementation.html#a3344398031a9e10cb9eef0784f8da1be">n_active_cells</a>() <span class="keyword">const</span>;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_dofs() <span class="keyword">const</span>;</div>
<div class="ttc" id="aclassFiniteElement_html"><div class="ttname"><a href="classFiniteElement.html">FiniteElement</a></div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2fe_2fe_8h_source.html#l00645">fe.h:646</a></div></div>
<div class="ttc" id="aclassTriangulation_html"><div class="ttname"><a href="classTriangulation.html">Triangulation</a></div><div class="ttdef"><b>Definition:</b> <a href="grid_2tria_8h_source.html#l01127">tria.h:1128</a></div></div>
<div class="ttc" id="anamespaceinternal_1_1TriangulationImplementation_html_a3344398031a9e10cb9eef0784f8da1be"><div class="ttname"><a href="namespaceinternal_1_1TriangulationImplementation.html#a3344398031a9e10cb9eef0784f8da1be">internal::TriangulationImplementation::n_active_cells</a></div><div class="ttdeci">unsigned int n_active_cells(const internal::TriangulationImplementation::NumberCache&lt; 1 &gt; &amp;c)</div><div class="ttdef"><b>Definition:</b> <a href="grid_2tria_8cc_source.html#l12658">tria.cc:12658</a></div></div>
</div><!-- fragment --><p>然后是为每个迭代和现能组组装线性系统的函数。请注意，该矩阵与迭代次数无关，所以只需为每个细化周期计算一次。对于必须在每次逆功率迭代中更新的右手边来说，情况就有点复杂了，而且由于计算它可能涉及到几个不同的网格，正如介绍中所解释的那样，这就更复杂了。为了使事情在解决正向或特征值问题方面更加灵活，我们将右手边的计算分成一个函数，该函数集合了无关的源和组内贡献（我们将用零函数称为特征值问题的源项）和一个计算来自另一个能量组对右手边的贡献的函数。</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> assemble_system_matrix();</div>
<div class="line"><span class="keywordtype">void</span> assemble_ingroup_rhs(<span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> &amp;extraneous_source);</div>
<div class="line"><span class="keywordtype">void</span> assemble_cross_group_rhs(<span class="keyword">const</span> EnergyGroup&lt;dim&gt; &amp;g_prime);</div>
<div class="ttc" id="aclassFunction_html"><div class="ttname"><a href="classFunction.html">Function</a></div><div class="ttdef"><b>Definition:</b> <a href="function_8h_source.html#l00150">function.h:153</a></div></div>
</div><!-- fragment --><p>接下来我们需要一组函数来实际计算线性系统的解，并对其做一些处理（比如计算介绍中提到的裂变源贡献，将图形信息写入输出文件，计算误差指标，或者根据这些标准和阈值实际细化和粗化网格）。所有这些函数以后都可以从驱动类 <code>NeutronDiffusionProblem</code> 中调用，或者你想实现的任何其他类来解决涉及中子通量方程的问题。</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> solve();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> get_fission_source() <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> estimate_errors(<a class="code" href="classVector.html">Vector&lt;float&gt;</a> &amp;error_indicators) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> refine_grid(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;float&gt;</a> &amp;error_indicators,</div>
<div class="line">                 <span class="keyword">const</span> <span class="keywordtype">double</span>         refine_threshold,</div>
<div class="line">                 <span class="keyword">const</span> <span class="keywordtype">double</span>         coarsen_threshold);</div>
<div class="ttc" id="aclassVector_html"><div class="ttname"><a href="classVector.html">Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="vector_8h_source.html#l00109">vector.h:110</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="codeEnergyGroupcodepublicdatamembers"></a> </p><h5><code>EnergyGroup</code> public data members</h5>
<p><br  />
</p>
<p>作为面向对象编程的良好实践，我们通过将大多数数据成员变成私有的来隐藏它们。然而，我们必须允许驱动进程的类访问解向量以及上一次迭代的解，因为在幂迭代中，解向量在每次迭代中都被我们正在寻找的特征值的当前猜测所缩放。</p>
<div class="fragment"><div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> solution;</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> solution_old;</div>
</div><!-- fragment --><p><a class="anchor" id="codeEnergyGroupcodeprivatedatamembers"></a> </p><h5><code>EnergyGroup</code> private data members</h5>
<p><br  />
</p>
<p>其余的数据成员是私有的。与之前所有的教程程序相比，唯一的新数据成员是一个存储该对象所代表的能量组的整数，以及该对象的构造函数从驱动类中得到的对材料数据对象的引用。同样，构造函数也得到了对我们要使用的有限元对象的引用。 <br  />
</p>
<p>最后，我们必须在每次迭代中对线性系统应用边界值，即相当频繁。我们不是每次都插值，而是在每个新的网格上插值一次，然后和这个类的所有其他数据一起存储。</p>
<div class="fragment"><div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  group;</div>
<div class="line">  <span class="keyword">const</span> MaterialData &amp;material_data;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>        <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;fe;</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           dof_handler;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      sparsity_pattern;</div>
<div class="line">  <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> system_rhs;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  std::map&lt;types::global_dof_index, double&gt; boundary_values;</div>
<div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a>                 hanging_node_constraints;</div>
<div class="ttc" id="aclassAffineConstraints_html"><div class="ttname"><a href="classAffineConstraints.html">AffineConstraints&lt; double &gt;</a></div></div>
<div class="ttc" id="aclassDoFHandler_html"><div class="ttname"><a href="classDoFHandler.html">DoFHandler</a></div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__handler_8h_source.html#l00314">dof_handler.h:315</a></div></div>
<div class="ttc" id="aclassSparseMatrix_html"><div class="ttname"><a href="classSparseMatrix.html">SparseMatrix&lt; double &gt;</a></div></div>
<div class="ttc" id="aclassSparsityPattern_html"><div class="ttname"><a href="classSparsityPattern.html">SparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="sparsity__pattern_8h_source.html#l00868">sparsity_pattern.h:869</a></div></div>
<div class="ttc" id="ap4est__wrappers_8cc_html_ace00f2f80d9780ef9aa1007e1c22c6a4"><div class="ttname"><a href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a></div><div class="ttdeci">const ::parallel::distributed::Triangulation&lt; dim, spacedim &gt; * triangulation</div><div class="ttdef"><b>Definition:</b> <a href="p4est__wrappers_8cc_source.html#l00069">p4est_wrappers.cc:69</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="codeEnergyGroupcodeprivatememberfunctions"></a> </p><h5><code>EnergyGroup</code> private member functions</h5>
<p><br  />
</p>
<p>这个类中有一个私有成员函数。它递归地走过两个网格的单元，以计算跨组的右手边项。这方面的算法在本程序的介绍中有所解释。这个函数的参数是对一个对象的引用，该对象代表我们要整合的右手项的能量组，一个用于当前能量组的网格单元的迭代器，一个用于另一个网格的相应单元的迭代器，以及将自由度从两个单元中较粗的单元插值到较细的单元的矩阵。</p>
<div class="fragment"><div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span> assemble_cross_group_rhs_recursive(</div>
<div class="line">    <span class="keyword">const</span> EnergyGroup&lt;dim&gt; &amp;                       g_prime,</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler&lt;dim&gt;::cell_iterator</a> &amp;cell_g,</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler&lt;dim&gt;::cell_iterator</a> &amp;cell_g_prime,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> &amp;                     prolongation_matrix);</div>
<div class="line">};</div>
<div class="ttc" id="aclassFullMatrix_html"><div class="ttname"><a href="classFullMatrix.html">FullMatrix&lt; double &gt;</a></div></div>
<div class="ttc" id="agroup__Iterators_html_ga32b2a057d9abd2e1752bf8a3cb88e644"><div class="ttname"><a href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler::cell_iterator</a></div><div class="ttdeci">typename ActiveSelector::cell_iterator cell_iterator</div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__handler_8h_source.html#l00466">dof_handler.h:466</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="ImplementationofthecodeEnergyGroupcodeclass"></a></p><h4>Implementation of the <code>EnergyGroup</code> class</h4>
<p>这个类的前几个函数大多是不言自明的。构造函数只设置了几个数据成员，并创建了一个给定三角图的副本，作为该能量组使用的三角图的基础。接下来的两个函数只是返回私有数据成员的数据，从而使我们能够使这些数据成员私有化。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">EnergyGroup&lt;dim&gt;::EnergyGroup(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        group,</div>
<div class="line">                              <span class="keyword">const</span> MaterialData &amp;      material_data,</div>
<div class="line">                              <span class="keyword">const</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> &amp;coarse_grid,</div>
<div class="line">                              <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;fe)</div>
<div class="line">  : group(group)</div>
<div class="line">  , material_data(material_data)</div>
<div class="line">  , fe(fe)</div>
<div class="line">  , dof_handler(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.copy_triangulation(coarse_grid);</div>
<div class="line">  dof_handler.distribute_dofs(fe);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceinternal_1_1TriangulationImplementation.html#a3344398031a9e10cb9eef0784f8da1be">EnergyGroup&lt;dim&gt;::n_active_cells</a>()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> EnergyGroup&lt;dim&gt;::n_dofs()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">return</span> dof_handler.n_dofs();</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="codeEnergyGroupsetup_linear_systemcode"></a></p><h5><code>EnergyGroup::setup_linear_system</code></h5>
<p><br  />
</p>
<p>第一个 "真正的 "函数是在新的网格上或网格细化后设置网格、矩阵等。我们用这个函数来初始化稀疏系统矩阵，以及右手边的向量。如果求解向量之前从未被设置过（如用零大小表示），我们也会初始化它并将其设置为默认值。如果它已经有一个非零的大小，我们就不这么做了（也就是说，这个函数是在网格细化之后调用的），因为在这种情况下，我们希望在网格细化中保留解决方案（这一点我们在 <code>EnergyGroup::refine_grid</code> 函数中做过）。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> EnergyGroup&lt;dim&gt;::setup_linear_system()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_dofs = dof_handler.n_dofs();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  hanging_node_constraints.clear();</div>
<div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler,</div>
<div class="line">                                          hanging_node_constraints);</div>
<div class="line">  hanging_node_constraints.close();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  system_matrix.clear();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(n_dofs, n_dofs);</div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler, dsp);</div>
<div class="line">  hanging_node_constraints.condense(dsp);</div>
<div class="line">  sparsity_pattern.copy_from(dsp);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  system_matrix.reinit(sparsity_pattern);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  system_rhs.reinit(n_dofs);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (solution.size() == 0)</div>
<div class="line">    {</div>
<div class="line">      solution.reinit(n_dofs);</div>
<div class="line">      solution_old.reinit(n_dofs);</div>
<div class="line">      solution_old = 1.0;</div>
<div class="line">      solution     = solution_old;</div>
<div class="line">    }</div>
<div class="ttc" id="aclassDynamicSparsityPattern_html"><div class="ttname"><a href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="dynamic__sparsity__pattern_8h_source.html#l00318">dynamic_sparsity_pattern.h:319</a></div></div>
<div class="ttc" id="agroup__constraints_html_ga3b4ea7dfd313e388d868c4e4aa685799"><div class="ttname"><a href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a></div><div class="ttdeci">void make_hanging_node_constraints(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, AffineConstraints&lt; number &gt; &amp;constraints)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__constraints_8cc_source.html#l01787">dof_tools_constraints.cc:1787</a></div></div>
<div class="ttc" id="agroup__constraints_html_gaf78e864edbfba7e0a7477457bfb96b26"><div class="ttname"><a href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a></div><div class="ttdeci">void make_sparsity_pattern(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, SparsityPatternType &amp;sparsity_pattern, const AffineConstraints&lt; number &gt; &amp;constraints=AffineConstraints&lt; number &gt;(), const bool keep_constrained_dofs=true, const types::subdomain_id subdomain_id=numbers::invalid_subdomain_id)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__sparsity_8cc_source.html#l00064">dof_tools_sparsity.cc:64</a></div></div>
</div><!-- fragment --><p>在这个函数的最后，我们更新边界节点的列表和它们的值，首先清除这个列表和重新插值的边界值（记住，这个函数是在第一次设置网格后调用的，每次在网格细化后调用）。 <br  />
</p>
<p>为了理解这段代码，有必要认识到我们使用 <code><a class="el" href="namespaceGridGenerator.html#ac76417d7404b75cf53c732f456e6e971">GridGenerator::subdivided_hyper_rectangle</a></code> 函数创建网格（在 <code>NeutronDiffusionProblem::initialize_problem</code> 中），其中我们将最后一个参数设置为 <code>true</code> 。这意味着域的边界是 "彩色 "的，也就是说，域的四个（或六个，在3D中）边被赋予不同的边界指标。结果是，底部边界得到指标0，顶部的一个边界指标1，左右边界分别得到指标2和3。 <br  />
</p>
<p>在这个程序中，我们只模拟一个，即右上角的反应器的四分之一。也就是说，我们只想在顶部和右侧边界插值边界条件，而在底部和左侧边界不做任何事情（即施加自然的、无流量的诺伊曼边界条件）。这很容易被推广到任意维度，即我们想在指标为1、3、......的边界上进行插值，我们在下面的循环中这样做（注意，对 <code><a class="el" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a></code> 的调用是加法的，即它们不会首先清除边界值图）。</p>
<div class="fragment"><div class="line">  boundary_values.clear();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dim; ++i)</div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                             2 * i + 1,</div>
<div class="line">                                             <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a>(),</div>
<div class="line">                                             boundary_values);</div>
<div class="line">}</div>
<div class="ttc" id="aclassFunctions_1_1ZeroFunction_html"><div class="ttname"><a href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction</a></div><div class="ttdef"><b>Definition:</b> <a href="function_8h_source.html#l00510">function.h:511</a></div></div>
<div class="ttc" id="anamespaceVectorTools_html_ab2562d41bb26f362043f9719a8cd9b87"><div class="ttname"><a href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a></div><div class="ttdeci">void interpolate_boundary_values(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const std::map&lt; types::boundary_id, const Function&lt; spacedim, number &gt; * &gt; &amp;function_map, std::map&lt; types::global_dof_index, number &gt; &amp;boundary_values, const ComponentMask &amp;component_mask=ComponentMask())</div></div>
</div><!-- fragment --><p><a class="anchor" id="codeEnergyGroupassemble_system_matrixcode"></a> </p><h5><code>EnergyGroup::assemble_system_matrix</code></h5>
<p><br  />
</p>
<p>接下来我们需要函数来组装系统矩阵和右手边。考虑到介绍中列出的方程以及我们在以前的例子程序中看到的内容，组装矩阵是很简单的。注意使用 <code>cell-&gt;<a class="el" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id()</a></code> 来获取一个单元的材料种类。还要注意我们如何设置正交公式的顺序，以便它总是适合于使用中的有限元。 <br  />
</p>
<p>最后，请注意，由于我们在这里只组装了系统矩阵，所以我们还不能消除边界值（我们需要右手边的向量来实现）。我们将此推迟到 <code>EnergyGroup::solve</code> 函数中，此时所有的信息都可以得到。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> EnergyGroup&lt;dim&gt;::assemble_system_matrix()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(fe.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                            <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(dofs_per_cell, dofs_per_cell);</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     cell_rhs(dofs_per_cell);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.active_cell_iterators())</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a> = 0;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      fe_values.reinit(cell);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> diffusion_coefficient =</div>
<div class="line">        material_data.get_diffusion_coefficient(group, cell-&gt;material_id());</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> removal_XS =</div>
<div class="line">        material_data.get_removal_XS(group, cell-&gt;material_id());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; n_q_points; ++q_point)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j)</div>
<div class="line">            <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div>
<div class="line">              ((diffusion_coefficient * fe_values.shape_grad(i, q_point) *</div>
<div class="line">                  fe_values.shape_grad(j, q_point) +</div>
<div class="line">                removal_XS * fe_values.shape_value(i, q_point) *</div>
<div class="line">                  fe_values.shape_value(j, q_point)) *</div>
<div class="line">               fe_values.JxW(q_point));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      cell-&gt;get_dof_indices(local_dof_indices);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j)</div>
<div class="line">          system_matrix.add(local_dof_indices[i],</div>
<div class="line">                            local_dof_indices[j],</div>
<div class="line">                            <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  hanging_node_constraints.condense(system_matrix);</div>
<div class="line">}</div>
<div class="ttc" id="aclassFEValues_html"><div class="ttname"><a href="classFEValues.html">FEValues</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values_8h_source.html#l03905">fe_values.h:3906</a></div></div>
<div class="ttc" id="aclassFiniteElementData_html_a2cbf5ad6b464871261dbd054bced18a8"><div class="ttname"><a href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">FiniteElementData::degree</a></div><div class="ttdeci">const unsigned int degree</div><div class="ttdef"><b>Definition:</b> <a href="fe__base_8h_source.html#l00435">fe_base.h:435</a></div></div>
<div class="ttc" id="aclassFiniteElementData_html_a33b522422da89e5c080e7405ad49d7c7"><div class="ttname"><a href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">FiniteElementData::n_dofs_per_cell</a></div><div class="ttdeci">unsigned int n_dofs_per_cell() const</div></div>
<div class="ttc" id="aclassQGauss_html"><div class="ttname"><a href="classQGauss.html">QGauss</a></div><div class="ttdef"><b>Definition:</b> <a href="quadrature__lib_8h_source.html#l00038">quadrature_lib.h:39</a></div></div>
<div class="ttc" id="afe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea"><div class="ttname"><a href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a></div><div class="ttdeci">@ update_values</div><div class="ttdoc">Shape function values.</div><div class="ttdef"><b>Definition:</b> <a href="fe__update__flags_8h_source.html#l00078">fe_update_flags.h:78</a></div></div>
<div class="ttc" id="afe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85"><div class="ttname"><a href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a></div><div class="ttdeci">@ update_JxW_values</div><div class="ttdoc">Transformed quadrature weights.</div><div class="ttdef"><b>Definition:</b> <a href="fe__update__flags_8h_source.html#l00129">fe_update_flags.h:129</a></div></div>
<div class="ttc" id="afe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20"><div class="ttname"><a href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a></div><div class="ttdeci">@ update_gradients</div><div class="ttdoc">Shape function gradients.</div><div class="ttdef"><b>Definition:</b> <a href="fe__update__flags_8h_source.html#l00084">fe_update_flags.h:84</a></div></div>
<div class="ttc" id="anamespaceLocalIntegrators_1_1Advection_html_a8bc7b8136646134f73a4193adefe15f8"><div class="ttname"><a href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">LocalIntegrators::Advection::cell_matrix</a></div><div class="ttdeci">void cell_matrix(FullMatrix&lt; double &gt; &amp;M, const FEValuesBase&lt; dim &gt; &amp;fe, const FEValuesBase&lt; dim &gt; &amp;fetest, const ArrayView&lt; const std::vector&lt; double &gt;&gt; &amp;velocity, const double factor=1.)</div><div class="ttdef"><b>Definition:</b> <a href="advection_8h_source.html#l00075">advection.h:75</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="codeEnergyGroupassemble_ingroup_rhscode"></a> </p><h5><code>EnergyGroup::assemble_ingroup_rhs</code></h5>
<p><br  />
</p>
<p>正如 <code>EnergyGroup</code> 类的文档中所解释的，我们把组装右手边分成两部分：组内耦合和跨组耦合。首先，我们需要一个函数来组装这里的一个特定组的右手边，即包括一个无关的源（我们将在特征值问题上设置为零）以及组内裂变贡献。 组内散射已经在清除截面的定义中得到了考虑）。该函数的工作原理就组装右手边而言是非常标准的，因此不需要更多的评论，只是我们要提到在函数的开始部分将右手边的向量设置为零&ndash;这一点我们不打算对跨组项做，这些跨组项只是添加到右手边的向量。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">EnergyGroup&lt;dim&gt;::assemble_ingroup_rhs(<span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> &amp;extraneous_source)</div>
<div class="line">{</div>
<div class="line">  system_rhs.reinit(dof_handler.n_dofs());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(fe.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                            <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a>      cell_rhs(dofs_per_cell);</div>
<div class="line">  std::vector&lt;double&gt; extraneous_source_values(n_q_points);</div>
<div class="line">  std::vector&lt;double&gt; solution_old_values(n_q_points);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.active_cell_iterators())</div>
<div class="line">    {</div>
<div class="line">      cell_rhs = 0;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      fe_values.reinit(cell);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> fission_dist_XS =</div>
<div class="line">        material_data.get_fission_dist_XS(group, group, cell-&gt;material_id());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      extraneous_source.<a class="code" href="classFunction.html#a562fc1114e95e702e6696721f71528db">value_list</a>(fe_values.get_quadrature_points(),</div>
<div class="line">                                   extraneous_source_values);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      fe_values.get_function_values(solution_old, solution_old_values);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      cell-&gt;get_dof_indices(local_dof_indices);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; n_q_points; ++q_point)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div>
<div class="line">          cell_rhs(i) +=</div>
<div class="line">            ((extraneous_source_values[q_point] +</div>
<div class="line">              fission_dist_XS * solution_old_values[q_point]) *</div>
<div class="line">             fe_values.shape_value(i, q_point) * fe_values.JxW(q_point));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div>
<div class="line">        system_rhs(local_dof_indices[i]) += cell_rhs(i);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="aclassFunction_html_a562fc1114e95e702e6696721f71528db"><div class="ttname"><a href="classFunction.html#a562fc1114e95e702e6696721f71528db">Function::value_list</a></div><div class="ttdeci">virtual void value_list(const std::vector&lt; Point&lt; dim &gt;&gt; &amp;points, std::vector&lt; RangeNumberType &gt; &amp;values, const unsigned int component=0) const</div></div>
<div class="ttc" id="afe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a"><div class="ttname"><a href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a></div><div class="ttdeci">@ update_quadrature_points</div><div class="ttdoc">Transformed quadrature points.</div><div class="ttdef"><b>Definition:</b> <a href="fe__update__flags_8h_source.html#l00122">fe_update_flags.h:122</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="codeEnergyGroupassemble_cross_group_rhscode"></a></p><h5><code>EnergyGroup::assemble_cross_group_rhs</code></h5>
<p><br  />
</p>
<p>对于组装单一能量组方程的右手向量来说，更有趣的函数是耦合能量组 \(g\) 和 \(g&#39;\) 的函数。正如介绍中所解释的，我们首先要找到两个能量组的网格所共有的单元集。首先我们调用 <code>get_finest_common_cells</code> 来获得这一对来自两个网格的共同单元的列表。一对单元格中的两个单元格可能都不活跃，但至少有一个是活跃的。然后我们将这些单元对中的每一个交给一个函数，该函数将递归地计算右手边的项。 <br  />
</p>
<p>请注意，组内耦合在之前已经处理过了，所以如果 \(g=g&#39;\) 我们提前退出函数。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">EnergyGroup&lt;dim&gt;::assemble_cross_group_rhs(<span class="keyword">const</span> EnergyGroup&lt;dim&gt; &amp;g_prime)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (group == g_prime.group)</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> std::list&lt;std::pair&lt;typename DoFHandler&lt;dim&gt;::cell_iterator,</div>
<div class="line">                            <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler&lt;dim&gt;::cell_iterator</a>&gt;&gt;</div>
<div class="line">    cell_list =</div>
<div class="line">      <a class="code" href="namespaceGridTools.html#a32a5016c746ad756046ecff264dfa60d">GridTools::get_finest_common_cells</a>(dof_handler, g_prime.dof_handler);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell_pair : cell_list)</div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> unit_matrix(fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; unit_matrix.m(); ++i)</div>
<div class="line">        unit_matrix(i, i) = 1;</div>
<div class="line">      assemble_cross_group_rhs_recursive(g_prime,</div>
<div class="line">                                         cell_pair.first,</div>
<div class="line">                                         cell_pair.second,</div>
<div class="line">                                         unit_matrix);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="anamespaceGridTools_html_a32a5016c746ad756046ecff264dfa60d"><div class="ttname"><a href="namespaceGridTools.html#a32a5016c746ad756046ecff264dfa60d">GridTools::get_finest_common_cells</a></div><div class="ttdeci">std::list&lt; std::pair&lt; typename MeshType::cell_iterator, typename MeshType::cell_iterator &gt; &gt; get_finest_common_cells(const MeshType &amp;mesh_1, const MeshType &amp;mesh_2)</div><div class="ttdef"><b>Definition:</b> <a href="grid__tools__dof__handlers_8cc_source.html#l01110">grid_tools_dof_handlers.cc:1110</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="codeEnergyGroupassemble_cross_group_rhs_recursivecode"></a> </p><h5><code>EnergyGroup::assemble_cross_group_rhs_recursive</code></h5>
<p><br  />
</p>
<p>最后，这是处理在潜在的不同网格上递归地装配右手边项的函数，使用介绍中描述的算法。该函数需要一个对代表能量组 \(g&#39;\) 的对象的引用，以及对能量组 \(g\) 和 \(g&#39;\) 的网格中相应单元的迭代器。起初，即从上面的函数中调用这个函数时，这两个单元将是两个网格上的匹配单元；然而，这两个单元中的一个可能被进一步细化，我们将递归地调用这个函数，两个迭代器中的一个被原始单元的一个子单元所取代。 <br  />
</p>
<p>最后一个参数是介绍中的矩阵乘积矩阵 \(B_{c^{(k)}}^T \cdots B_{c&#39;}^T B_c^T\) ，它从两个单元中较粗的单元插值到较细的单元。如果这两个单元格匹配，那么这就是身份矩阵&ndash;正是我们最初传递给这个函数的东西。</p>
<p>该函数必须考虑两种情况：两个单元格都没有进一步细化，即没有子代，在这种情况下，我们可以最终组装这对单元格的右侧贡献；以及两个单元格中的一个被进一步细化，在这种情况下，我们必须通过循环未被激活的单元格的子代来不断地进行循环。这两种情况将在下面讨论。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> EnergyGroup&lt;dim&gt;::assemble_cross_group_rhs_recursive(</div>
<div class="line">  <span class="keyword">const</span> EnergyGroup&lt;dim&gt; &amp;                       g_prime,</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler&lt;dim&gt;::cell_iterator</a> &amp;cell_g,</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler&lt;dim&gt;::cell_iterator</a> &amp;cell_g_prime,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> &amp;                     prolongation_matrix)</div>
<div class="line">{</div>
</div><!-- fragment --><p>第一种情况是，两个单元格都没有进一步细化。在这种情况下，我们可以组装相关的条款（见介绍）。这涉及到在两个单元中较细的单元上组装质量矩阵（事实上，有两个具有不同系数的质量矩阵，一个用于裂变分布截面 \(\chi_g\nu\Sigma_{f,g&#39;}\) ，一个用于散射截面 \(\Sigma_{s,g&#39;\to g}\) ）。这是直截了当的，但请注意我们如何通过查看两个单元的细化水平来确定哪个是更细的单元。</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (!cell_g-&gt;has_children() &amp;&amp; !cell_g_prime-&gt;has_children())</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(fe.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cell_g-&gt;level() &gt; cell_g_prime-&gt;level())</div>
<div class="line">      fe_values.reinit(cell_g);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      fe_values.reinit(cell_g_prime);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> fission_dist_XS =</div>
<div class="line">      material_data.get_fission_dist_XS(group,</div>
<div class="line">                                        g_prime.group,</div>
<div class="line">                                        cell_g_prime-&gt;material_id());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> scattering_XS =</div>
<div class="line">      material_data.get_scattering_XS(g_prime.group,</div>
<div class="line">                                      group,</div>
<div class="line">                                      cell_g_prime-&gt;material_id());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_mass_matrix_f(fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>(),</div>
<div class="line">                                           fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_mass_matrix_g(fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>(),</div>
<div class="line">                                           fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; n_q_points; ++q_point)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>(); ++i)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>(); ++j)</div>
<div class="line">          {</div>
<div class="line">            local_mass_matrix_f(i, j) +=</div>
<div class="line">              (fission_dist_XS * fe_values.shape_value(i, q_point) *</div>
<div class="line">               fe_values.shape_value(j, q_point) * fe_values.JxW(q_point));</div>
<div class="line">            local_mass_matrix_g(i, j) +=</div>
<div class="line">              (scattering_XS * fe_values.shape_value(i, q_point) *</div>
<div class="line">               fe_values.shape_value(j, q_point) * fe_values.JxW(q_point));</div>
<div class="line">          }</div>
</div><!-- fragment --><p>现在我们有了所有的插值（延长）矩阵以及局部质量矩阵，所以我们只需要根据两个单元中哪一个更细，形成积 </p><p class="formulaDsp">
\[ F_i|_{K_{cc&#39;\cdots c^{(k)}}} = [B_c B_{c&#39;} \cdots B_{c^{(k)}} M_{K_{cc&#39;\cdots c^{(k)}}}]^{ij} \phi_{g&#39;}^j, \]
</p>
<p>或 </p><p class="formulaDsp">
\[ F_i|_{K_{cc&#39;\cdots c^{(k)}}} = [(B_c B_{c&#39;} \cdots B_{c^{(k)}} M_{K_{cc&#39;\cdots c^{(k)}}})^T]^{ij} \phi_{g&#39;}^j, \]
</p>
<p>。我们使用 <code>vmult</code> 函数提供的矩阵-向量乘积，或者使用 <code>Tvmult</code> 与转置矩阵进行乘积。这样做之后，我们将结果转移到能量组的全局右手向量中 \(g\) 。</p>
<div class="fragment"><div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> g_prime_new_values(fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> g_prime_old_values(fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">  cell_g_prime-&gt;get_dof_values(g_prime.solution_old, g_prime_old_values);</div>
<div class="line">  cell_g_prime-&gt;get_dof_values(g_prime.solution, g_prime_new_values);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> cell_rhs(fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> tmp(fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (cell_g-&gt;level() &gt; cell_g_prime-&gt;level())</div>
<div class="line">    {</div>
<div class="line">      prolongation_matrix.<a class="code" href="classFullMatrix.html#a65a409eeef6388d99ac15e2bbe8045f6">vmult</a>(tmp, g_prime_old_values);</div>
<div class="line">      local_mass_matrix_f.vmult(cell_rhs, tmp);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      prolongation_matrix.<a class="code" href="classFullMatrix.html#a65a409eeef6388d99ac15e2bbe8045f6">vmult</a>(tmp, g_prime_new_values);</div>
<div class="line">      local_mass_matrix_g.vmult_add(cell_rhs, tmp);</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      local_mass_matrix_f.vmult(tmp, g_prime_old_values);</div>
<div class="line">      prolongation_matrix.<a class="code" href="classFullMatrix.html#a8219d4fa962f1b041a506221a7a15379">Tvmult</a>(cell_rhs, tmp);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      local_mass_matrix_g.vmult(tmp, g_prime_new_values);</div>
<div class="line">      prolongation_matrix.<a class="code" href="classFullMatrix.html#abed6fffa5cb201496d751a4427cb59d6">Tvmult_add</a>(cell_rhs, tmp);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; local_dof_indices(</div>
<div class="line">    fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">  cell_g-&gt;get_dof_indices(local_dof_indices);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>(); ++i)</div>
<div class="line">    system_rhs(local_dof_indices[i]) += cell_rhs(i);</div>
<div class="line">}</div>
<div class="ttc" id="aclassFullMatrix_html_a65a409eeef6388d99ac15e2bbe8045f6"><div class="ttname"><a href="classFullMatrix.html#a65a409eeef6388d99ac15e2bbe8045f6">FullMatrix::vmult</a></div><div class="ttdeci">void vmult(Vector&lt; number2 &gt; &amp;w, const Vector&lt; number2 &gt; &amp;v, const bool adding=false) const</div></div>
<div class="ttc" id="aclassFullMatrix_html_a8219d4fa962f1b041a506221a7a15379"><div class="ttname"><a href="classFullMatrix.html#a8219d4fa962f1b041a506221a7a15379">FullMatrix::Tvmult</a></div><div class="ttdeci">void Tvmult(Vector&lt; number2 &gt; &amp;w, const Vector&lt; number2 &gt; &amp;v, const bool adding=false) const</div></div>
<div class="ttc" id="aclassFullMatrix_html_abed6fffa5cb201496d751a4427cb59d6"><div class="ttname"><a href="classFullMatrix.html#abed6fffa5cb201496d751a4427cb59d6">FullMatrix::Tvmult_add</a></div><div class="ttdeci">void Tvmult_add(Vector&lt; number2 &gt; &amp;w, const Vector&lt; number2 &gt; &amp;v) const</div></div>
</div><!-- fragment --><p>另一种情况是，两个单元中的一个被进一步细化。在这种情况下，我们必须在所有的子单元上循环，将现有的矩阵的插值（延长）乘以从现在的单元到其子单元的插值（使用矩阵-矩阵乘法函数 <code>mmult</code> ），然后将结果再次交给这个非常相同的函数，但有子单元被其子单元之一取代。</p>
<div class="fragment"><div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> child = 0;</div>
<div class="line">         child &lt; GeometryInfo&lt;dim&gt;::max_children_per_cell;</div>
<div class="line">         ++child)</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> new_matrix(fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>(),</div>
<div class="line">                                      fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">        fe.<a class="code" href="classFiniteElement.html#af78c7b6503befe61dc6df5eb41c99019">get_prolongation_matrix</a>(child).<a class="code" href="classFullMatrix.html#a21b873fcd180999ad0d268c3278a71ec">mmult</a>(new_matrix,</div>
<div class="line">                                                prolongation_matrix);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (cell_g-&gt;has_children())</div>
<div class="line">          assemble_cross_group_rhs_recursive(g_prime,</div>
<div class="line">                                             cell_g-&gt;child(child),</div>
<div class="line">                                             cell_g_prime,</div>
<div class="line">                                             new_matrix);</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          assemble_cross_group_rhs_recursive(g_prime,</div>
<div class="line">                                             cell_g,</div>
<div class="line">                                             cell_g_prime-&gt;child(child),</div>
<div class="line">                                             new_matrix);</div>
<div class="line">      }</div>
<div class="line">}</div>
<div class="ttc" id="aclassFiniteElement_html_af78c7b6503befe61dc6df5eb41c99019"><div class="ttname"><a href="classFiniteElement.html#af78c7b6503befe61dc6df5eb41c99019">FiniteElement::get_prolongation_matrix</a></div><div class="ttdeci">virtual const FullMatrix&lt; double &gt; &amp; get_prolongation_matrix(const unsigned int child, const RefinementCase&lt; dim &gt; &amp;refinement_case=RefinementCase&lt; dim &gt;::isotropic_refinement) const</div></div>
<div class="ttc" id="aclassFullMatrix_html_a21b873fcd180999ad0d268c3278a71ec"><div class="ttname"><a href="classFullMatrix.html#a21b873fcd180999ad0d268c3278a71ec">FullMatrix::mmult</a></div><div class="ttdeci">void mmult(FullMatrix&lt; number2 &gt; &amp;C, const FullMatrix&lt; number2 &gt; &amp;B, const bool adding=false) const</div></div>
</div><!-- fragment --><p><a class="anchor" id="codeEnergyGroupget_fission_sourcecode"></a> </p><h5><code>EnergyGroup::get_fission_source</code></h5>
<p><br  />
</p>
<p>在（反）功率迭代中，我们使用综合裂变源来更新 \(k\) -特征值。鉴于其定义，以下函数基本上是不言自明的。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> EnergyGroup&lt;dim&gt;::get_fission_source()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(fe.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  std::vector&lt;double&gt; solution_values(n_q_points);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> fission_source = 0;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.active_cell_iterators())</div>
<div class="line">    {</div>
<div class="line">      fe_values.reinit(cell);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> fission_XS =</div>
<div class="line">        material_data.get_fission_XS(group, cell-&gt;material_id());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      fe_values.get_function_values(solution, solution_values);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; n_q_points; ++q_point)</div>
<div class="line">        fission_source +=</div>
<div class="line">          (fission_XS * solution_values[q_point] * fe_values.JxW(q_point));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> fission_source;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="codeEnergyGroupsolvecode"></a> </p><h5><code>EnergyGroup::solve</code></h5>
<p><br  />
</p>
<p>接下来是一个解决之前组装的线性系统的函数。事情基本是标准的，只是我们把应用边界值的时间推迟到了这里，因为在之前的所有函数中，我们还是在为右边的向量做加法。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> EnergyGroup&lt;dim&gt;::solve()</div>
<div class="line">{</div>
<div class="line">  hanging_node_constraints.condense(system_rhs);</div>
<div class="line">  <a class="code" href="namespaceMatrixTools.html#a9ad0eb7a8662628534586716748d62fb">MatrixTools::apply_boundary_values</a>(boundary_values,</div>
<div class="line">                                     system_matrix,</div>
<div class="line">                                     solution,</div>
<div class="line">                                     system_rhs);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a>            solver_control(system_matrix.m(),</div>
<div class="line">                               1<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">e</a>-12 * system_rhs.l2_norm());</div>
<div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt; cg(solver_control);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;SparseMatrix&lt;double&gt;</a>&gt; preconditioner;</div>
<div class="line">  preconditioner.<a class="code" href="group__Preconditioners.html#ga7a3d66b17bb0ea1b16606e222474c2ea">initialize</a>(system_matrix, 1.2);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  cg.solve(system_matrix, solution, system_rhs, preconditioner);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  hanging_node_constraints.distribute(solution);</div>
<div class="line">}</div>
<div class="ttc" id="aclassPreconditionSSOR_html"><div class="ttname"><a href="classPreconditionSSOR.html">PreconditionSSOR</a></div><div class="ttdef"><b>Definition:</b> <a href="precondition_8h_source.html#l00650">precondition.h:651</a></div></div>
<div class="ttc" id="aclassSolverCG_html"><div class="ttname"><a href="classSolverCG.html">SolverCG</a></div><div class="ttdef"><b>Definition:</b> <a href="solver__cg_8h_source.html#l00095">solver_cg.h:96</a></div></div>
<div class="ttc" id="aclassSolverControl_html"><div class="ttname"><a href="classSolverControl.html">SolverControl</a></div><div class="ttdef"><b>Definition:</b> <a href="solver__control_8h_source.html#l00065">solver_control.h:66</a></div></div>
<div class="ttc" id="agroup__Preconditioners_html_ga7a3d66b17bb0ea1b16606e222474c2ea"><div class="ttname"><a href="group__Preconditioners.html#ga7a3d66b17bb0ea1b16606e222474c2ea">PreconditionSSOR::initialize</a></div><div class="ttdeci">void initialize(const MatrixType &amp;A, const typename BaseClass::AdditionalData &amp;parameters=typename BaseClass::AdditionalData())</div></div>
<div class="ttc" id="anamespaceMatrixTools_html_a9ad0eb7a8662628534586716748d62fb"><div class="ttname"><a href="namespaceMatrixTools.html#a9ad0eb7a8662628534586716748d62fb">MatrixTools::apply_boundary_values</a></div><div class="ttdeci">void apply_boundary_values(const std::map&lt; types::global_dof_index, number &gt; &amp;boundary_values, SparseMatrix&lt; number &gt; &amp;matrix, Vector&lt; number &gt; &amp;solution, Vector&lt; number &gt; &amp;right_hand_side, const bool eliminate_columns=true)</div><div class="ttdef"><b>Definition:</b> <a href="matrix__tools_8cc_source.html#l00081">matrix_tools.cc:81</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="codeEnergyGroupestimate_errorscode"></a></p><h5><code>EnergyGroup::estimate_errors</code></h5>
<p><br  />
</p>
<p>网格细化被分成两个函数。第一个函数估计每个单元的误差，用解的大小将其归一化，并将其返回到作为参数的向量中。调用函数收集所有能量组的误差指标，并计算出细化和粗化单元的阈值。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> EnergyGroup&lt;dim&gt;::estimate_errors(<a class="code" href="classVector.html">Vector&lt;float&gt;</a> &amp;error_indicators)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div>
<div class="line">    dof_handler,</div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(fe.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1),</div>
<div class="line">    std::map&lt;<a class="code" href="namespacetypes.html#aed8813fee8c8a2edcc6005e6a48c321a">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(),</div>
<div class="line">    solution,</div>
<div class="line">    error_indicators);</div>
<div class="line">  error_indicators /= solution.<a class="code" href="group__Vectors.html#ga9f6b7f7afb05aaff7e1ab8f9942b6dae">linfty_norm</a>();</div>
<div class="line">}</div>
<div class="ttc" id="aclassKellyErrorEstimator_html_aa0917e696d4f8ddb983223a68c512357"><div class="ttname"><a href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator::estimate</a></div><div class="ttdeci">static void estimate(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const Quadrature&lt; dim - 1 &gt; &amp;quadrature, const std::map&lt; types::boundary_id, const Function&lt; spacedim, typename InputVector::value_type &gt; * &gt; &amp;neumann_bc, const InputVector &amp;solution, Vector&lt; float &gt; &amp;error, const ComponentMask &amp;component_mask=ComponentMask(), const Function&lt; spacedim &gt; *coefficients=nullptr, const unsigned int n_threads=numbers::invalid_unsigned_int, const types::subdomain_id subdomain_id=numbers::invalid_subdomain_id, const types::material_id material_id=numbers::invalid_material_id, const Strategy strategy=cell_diameter_over_24)</div></div>
<div class="ttc" id="agroup__Vectors_html_ga9f6b7f7afb05aaff7e1ab8f9942b6dae"><div class="ttname"><a href="group__Vectors.html#ga9f6b7f7afb05aaff7e1ab8f9942b6dae">Vector::linfty_norm</a></div><div class="ttdeci">real_type linfty_norm() const</div></div>
<div class="ttc" id="anamespacetypes_html_aed8813fee8c8a2edcc6005e6a48c321a"><div class="ttname"><a href="namespacetypes.html#aed8813fee8c8a2edcc6005e6a48c321a">types::boundary_id</a></div><div class="ttdeci">unsigned int boundary_id</div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00129">types.h:129</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="codeEnergyGrouprefine_gridcode"></a></p><h5><code>EnergyGroup::refine_grid</code></h5>
<p><br  />
</p>
<p>第二部分是给定前一个函数中计算的误差指标和误差阈值来细化网格，超过这个阈值的单元应被细化，低于这个阈值的单元应被粗化。注意，我们在这里没有使用 <code><a class="el" href="namespaceGridRefinement.html">GridRefinement</a></code> 中的任何函数，而是自己设置细化标志。 <br  />
</p>
<p>在设置完这些标志后，我们使用SolutionTransfer类将求解向量从旧网格转移到新网格。这里使用的程序在该类的文档中已有详细描述。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> EnergyGroup&lt;dim&gt;::refine_grid(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;float&gt;</a> &amp;error_indicators,</div>
<div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">double</span>         refine_threshold,</div>
<div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">double</span>         coarsen_threshold)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.active_cell_iterators())</div>
<div class="line">    <span class="keywordflow">if</span> (error_indicators(cell-&gt;active_cell_index()) &gt; refine_threshold)</div>
<div class="line">      cell-&gt;set_refine_flag();</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (error_indicators(cell-&gt;active_cell_index()) &lt; coarsen_threshold)</div>
<div class="line">      cell-&gt;set_coarsen_flag();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim&gt;</a> soltrans(dof_handler);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.prepare_coarsening_and_refinement();</div>
<div class="line">  soltrans.prepare_for_coarsening_and_refinement(solution);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">  dof_handler.distribute_dofs(fe);</div>
<div class="line">  setup_linear_system();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  solution.reinit(dof_handler.n_dofs());</div>
<div class="line">  soltrans.interpolate(solution_old, solution);</div>
<div class="ttc" id="aclassSolutionTransfer_html"><div class="ttname"><a href="classSolutionTransfer.html">SolutionTransfer</a></div><div class="ttdef"><b>Definition:</b> <a href="numerics_2solution__transfer_8h_source.html#l00338">solution_transfer.h:339</a></div></div>
</div><!-- fragment --><p>强制执行约束条件，使插值后的解在新网格上符合要求。</p>
<div class="fragment"><div class="line">  hanging_node_constraints.distribute(solution);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  solution_old.reinit(dof_handler.n_dofs());</div>
<div class="line">  solution_old = solution;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="codeEnergyGroupoutput_resultscode"></a> </p><h5><code>EnergyGroup::output_results</code></h5>
<p><br  />
</p>
<p>该类的最后一个函数在每次网格迭代后输出网格和解。这在以前已经显示过很多次了。唯一值得指出的是使用 <code><a class="el" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a></code> 函数将一个整数转换成其字符串表示。该函数的第二个参数表示我们应使用多少个数字&ndash;如果这个值大于1，那么这个数字就会被前导零填充。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> EnergyGroup&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> std::string filename = std::string(<span class="stringliteral">&quot;solution-&quot;</span>) +</div>
<div class="line">                               <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(group, 2) + <span class="stringliteral">&quot;.&quot;</span> +</div>
<div class="line">                               <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(cycle, 2) + <span class="stringliteral">&quot;.vtu&quot;</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#ac1eb26168177faa30ffbcf9cbb9c3cd5">attach_dof_handler</a>(dof_handler);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">add_data_vector</a>(solution, <span class="stringliteral">&quot;solution&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#a5eb51872b8736849bb7e8d2007fae086">build_patches</a>();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  std::ofstream output(filename);</div>
<div class="line">  data_out.<a class="code" href="group__Exceptions.html#ga93c780f93105e0daaa76c6c43694b4ae">write_vtu</a>(output);</div>
<div class="line">}</div>
<div class="ttc" id="aclassDataOut__DoFData_html_ac1eb26168177faa30ffbcf9cbb9c3cd5"><div class="ttname"><a href="classDataOut__DoFData.html#ac1eb26168177faa30ffbcf9cbb9c3cd5">DataOut_DoFData::attach_dof_handler</a></div><div class="ttdeci">void attach_dof_handler(const DoFHandlerType &amp;)</div></div>
<div class="ttc" id="aclassDataOut__DoFData_html_ace4b76e565ba0701c4d32c26075ed3b9"><div class="ttname"><a href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">DataOut_DoFData::add_data_vector</a></div><div class="ttdeci">void add_data_vector(const VectorType &amp;data, const std::vector&lt; std::string &gt; &amp;names, const DataVectorType type=type_automatic, const std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt; &amp;data_component_interpretation=std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="data__out__dof__data_8h_source.html#l01087">data_out_dof_data.h:1087</a></div></div>
<div class="ttc" id="aclassDataOut_html"><div class="ttname"><a href="classDataOut.html">DataOut</a></div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out_8h_source.html#l00147">data_out.h:150</a></div></div>
<div class="ttc" id="aclassDataOut_html_a5eb51872b8736849bb7e8d2007fae086"><div class="ttname"><a href="classDataOut.html#a5eb51872b8736849bb7e8d2007fae086">DataOut::build_patches</a></div><div class="ttdeci">virtual void build_patches(const unsigned int n_subdivisions=0)</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out_8cc_source.html#l01085">data_out.cc:1085</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga93c780f93105e0daaa76c6c43694b4ae"><div class="ttname"><a href="group__Exceptions.html#ga93c780f93105e0daaa76c6c43694b4ae">DataOutInterface::write_vtu</a></div><div class="ttdeci">void write_vtu(std::ostream &amp;out) const</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8cc_source.html#l07188">data_out_base.cc:7188</a></div></div>
<div class="ttc" id="anamespaceUtilities_html_a6195c5f009ea8c7c536c6ffdf108c32f"><div class="ttname"><a href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a></div><div class="ttdeci">std::string int_to_string(const unsigned int value, const unsigned int digits=numbers::invalid_unsigned_int)</div><div class="ttdef"><b>Definition:</b> <a href="base_2utilities_8cc_source.html#l00473">utilities.cc:473</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeNeutronDiffusionProblemcodeclasstemplate"></a></p><h3>The <code>NeutronDiffusionProblem</code> class template</h3>
<p>这是程序的主类，不是因为它实现了所有的功能（事实上，大部分功能在 <code>EnergyGroup</code> 类中实现），而是因为它包含了决定什么时候计算的驱动算法。它主要是像其他许多教程程序中显示的那样，它有一个公共的 <code>run</code> 函数和私有函数来做其他的事情。在一些地方，我们必须为所有能源组做一些事情，在这种情况下，如果deal.II被配置为多线程，我们将为每个组启动任务，让这些事情并行运行。 关于并行化的策略，可以看一下 <a class="el" href="group__threads.html">Parallel computing with multiple processors accessing shared memory</a> 模块。 <br  />
</p>
<p>与以前的例子程序最大的不同是，我们还声明了一个嵌套类，该类有成员变量，用于所有可在输入文件中传递给程序的运行时参数。现在，这些参数是能量组的数量、细化周期的数量、要使用的有限元的多项式程度，以及用于确定反幂迭代何时收敛的公差。此外，我们有一个该类的构造函数，将所有这些值设置为默认值，还有一个函数 <code>declare_parameters</code> 向ParameterHandler类描述输入文件中接受哪些参数，还有一个函数 <code>get_parameters</code> 可以从ParameterHandler对象中提取这些参数的值。另一个使用ParameterHandler的例子见 <a class="el" href="step_29.html">step-29</a> 。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>NeutronDiffusionProblem</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">class </span>Parameters</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    Parameters();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">void</span> declare_parameters(<a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm);</div>
<div class="line">    <span class="keywordtype">void</span>        get_parameters(<a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_groups;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_refinement_cycles;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fe_degree;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> convergence_tolerance;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  NeutronDiffusionProblem(<span class="keyword">const</span> Parameters &amp;parameters);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="ttc" id="aclassParameterHandler_html"><div class="ttname"><a href="classParameterHandler.html">ParameterHandler</a></div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler_8h_source.html#l00840">parameter_handler.h:841</a></div></div>
<div class="ttc" id="anamespaceWorkStream_1_1internal_1_1tbb__no__coloring_html_a8673698a405bf47aa24002aeb6d76d70"><div class="ttname"><a href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">WorkStream::internal::tbb_no_coloring::run</a></div><div class="ttdeci">void run(const Iterator &amp;begin, const typename identity&lt; Iterator &gt;::type &amp;end, Worker worker, Copier copier, const ScratchData &amp;sample_scratch_data, const CopyData &amp;sample_copy_data, const unsigned int queue_length, const unsigned int chunk_size)</div><div class="ttdef"><b>Definition:</b> <a href="work__stream_8h_source.html#l00691">work_stream.h:691</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="codeNeutronDiffusionProblemcodeprivatememberfunctions"></a> </p><h5><code>NeutronDiffusionProblem</code> private member functions</h5>
<p>这个类中没有那么多的成员函数，因为大部分的功能已经被移到了 <code>EnergyGroup</code> 类中，只是从这个类的 <code><a class="el" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run()</a></code> 成员函数中调用。留下来的那些有不言自明的名字。</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> initialize_problem();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> refine_grid();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span> get_total_fission_source() <span class="keyword">const</span>;</div>
</div><!-- fragment --><p><a class="anchor" id="codeNeutronDiffusionProblemcodeprivatemembervariables"></a> </p><h5><code>NeutronDiffusionProblem</code> private member variables</h5>
<p>接下来，我们有一些成员变量。特别是，这些是（i）对参数对象的引用（由本程序的主函数拥有，并传递给本类的构造函数），（ii）描述输入文件中要求的能量组数量的材料参数的对象，以及（iii）所有能量组要使用的有限元。</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> Parameters &amp; parameters;</div>
<div class="line"><span class="keyword">const</span> MaterialData material_data;</div>
<div class="line"><a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>          fe;</div>
<div class="ttc" id="aclassFE__Q_html"><div class="ttname"><a href="classFE__Q.html">FE_Q</a></div><div class="ttdef"><b>Definition:</b> <a href="fe__q_8h_source.html#l00548">fe_q.h:549</a></div></div>
</div><!-- fragment --><p>此外，我们还有(iv)当前迭代时计算出的特征值的值。事实上，这是在所有能量组之间共享的解决方案的唯一部分&ndash;解决方案的所有其他部分，如中子通量，都是针对一个或另一个能量组的，因此被存储在描述单一能量组的对象中。</p>
<div class="fragment"><div class="line"><span class="keywordtype">double</span> k_eff;</div>
</div><!-- fragment --><p>最后一个计算对象（v）是一个指向能量组对象的指针数组。当然，这个数组的长度等于参数文件中指定的能量组的数量。</p>
<div class="fragment"><div class="line">std::vector&lt;std::unique_ptr&lt;EnergyGroup&lt;dim&gt;&gt;&gt; energy_groups;</div>
</div><!-- fragment --><p>最后（vi），我们有一个文件流，我们将把总结出来的输出保存到其中。</p>
<div class="fragment"><div class="line">  std::ofstream convergence_table_stream;</div>
<div class="line">};</div>
</div><!-- fragment --><p><a class="anchor" id="ImplementationofthecodeParameterscodeclass"></a></p><h4>Implementation of the <code>Parameters</code> class</h4>
<p>在继续实现外层类之前，我们必须先实现参数结构的功能。这是相当直接的，事实上，对于所有使用ParameterHandler功能的这类参数类来说，看起来都是一样的。因此，我们将不再对此进行评论。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">NeutronDiffusionProblem&lt;dim&gt;::Parameters::Parameters()</div>
<div class="line">  : n_groups(2)</div>
<div class="line">  , n_refinement_cycles(5)</div>
<div class="line">  , fe_degree(2)</div>
<div class="line">  , convergence_tolerance(1<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">e</a>-12)</div>
<div class="line">{}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> NeutronDiffusionProblem&lt;dim&gt;::Parameters::declare_parameters(</div>
<div class="line">  <a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm)</div>
<div class="line">{</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Number of energy groups&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;2&quot;</span>,</div>
<div class="line">                    <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(),</div>
<div class="line">                    <span class="stringliteral">&quot;The number of energy different groups considered&quot;</span>);</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Refinement cycles&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;5&quot;</span>,</div>
<div class="line">                    <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(),</div>
<div class="line">                    <span class="stringliteral">&quot;Number of refinement cycles to be performed&quot;</span>);</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Finite element degree&quot;</span>,</div>
<div class="line">                    <span class="stringliteral">&quot;2&quot;</span>,</div>
<div class="line">                    <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(),</div>
<div class="line">                    <span class="stringliteral">&quot;Polynomial degree of the finite element to be used&quot;</span>);</div>
<div class="line">  prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(</div>
<div class="line">    <span class="stringliteral">&quot;Power iteration tolerance&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;1e-12&quot;</span>,</div>
<div class="line">    <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(),</div>
<div class="line">    <span class="stringliteral">&quot;Inner power iterations are stopped when the change in k_eff falls &quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;below this tolerance&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> NeutronDiffusionProblem&lt;dim&gt;::Parameters::get_parameters(</div>
<div class="line">  <a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm)</div>
<div class="line">{</div>
<div class="line">  n_groups              = prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Number of energy groups&quot;</span>);</div>
<div class="line">  n_refinement_cycles   = prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Refinement cycles&quot;</span>);</div>
<div class="line">  fe_degree             = prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Finite element degree&quot;</span>);</div>
<div class="line">  convergence_tolerance = prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;Power iteration tolerance&quot;</span>);</div>
<div class="line">}</div>
<div class="ttc" id="aclassParameterHandler_html_a61fa98fdc0c52980a5b1de0ee1fc5bb2"><div class="ttname"><a href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">ParameterHandler::get_integer</a></div><div class="ttdeci">long int get_integer(const std::string &amp;entry_string) const</div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler_8cc_source.html#l01025">parameter_handler.cc:1025</a></div></div>
<div class="ttc" id="aclassParameterHandler_html_a6d65f458be69e23a348221cb67fc411d"><div class="ttname"><a href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">ParameterHandler::declare_entry</a></div><div class="ttdeci">void declare_entry(const std::string &amp;entry, const std::string &amp;default_value, const Patterns::PatternBase &amp;pattern=Patterns::Anything(), const std::string &amp;documentation=&quot;&quot;, const bool has_to_be_set=false)</div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler_8cc_source.html#l00796">parameter_handler.cc:796</a></div></div>
<div class="ttc" id="aclassParameterHandler_html_aeaf3c7846747695b1f327677e3716ec5"><div class="ttname"><a href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">ParameterHandler::get_double</a></div><div class="ttdeci">double get_double(const std::string &amp;entry_name) const</div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler_8cc_source.html#l01068">parameter_handler.cc:1068</a></div></div>
<div class="ttc" id="aclassPatterns_1_1Double_html"><div class="ttname"><a href="classPatterns_1_1Double.html">Patterns::Double</a></div><div class="ttdef"><b>Definition:</b> <a href="patterns_8h_source.html#l00292">patterns.h:293</a></div></div>
<div class="ttc" id="aclassPatterns_1_1Integer_html"><div class="ttname"><a href="classPatterns_1_1Integer.html">Patterns::Integer</a></div><div class="ttdef"><b>Definition:</b> <a href="patterns_8h_source.html#l00189">patterns.h:190</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="ImplementationofthecodeNeutronDiffusionProblemcodeclass"></a> </p><h4>Implementation of the <code>NeutronDiffusionProblem</code> class</h4>
<p>现在是 <code>NeutronDiffusionProblem</code> 类。构造函数和析构函数没有什么值得关注的地方。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">NeutronDiffusionProblem&lt;dim&gt;::NeutronDiffusionProblem(</div>
<div class="line">  <span class="keyword">const</span> Parameters &amp;parameters)</div>
<div class="line">  : parameters(parameters)</div>
<div class="line">  , material_data(parameters.n_groups)</div>
<div class="line">  , fe(parameters.fe_degree)</div>
<div class="line">  , k_eff(std::numeric_limits&lt;<a class="code" href="classdouble.html">double</a>&gt;::quiet_NaN())</div>
<div class="line">{}</div>
<div class="ttc" id="aclassdouble_html"><div class="ttname"><a href="classdouble.html">double</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="codeNeutronDiffusionProbleminitialize_problemcode"></a> </p><h5><code>NeutronDiffusionProblem::initialize_problem</code></h5>
<p><br  />
</p>
<p>第一个感兴趣的函数是设置反应堆核心的几何形状的函数。这在介绍中会有更详细的描述。 <br  />
</p>
<p>该函数的第一部分定义了几何数据，然后创建了一个粗略的网格，其单元数与我们模拟的那部分反应堆堆芯中的燃料棒（或针状单元）一样多。正如上面插值边界值时提到的， <code><a class="el" href="namespaceGridGenerator.html#ac76417d7404b75cf53c732f456e6e971">GridGenerator::subdivided_hyper_rectangle</a></code> 函数的最后一个参数指定域的两侧应具有唯一的边界指标，这将允许我们以简单的方式确定哪些边界具有诺伊曼条件，哪些具有迪里希特条件。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> NeutronDiffusionProblem&lt;dim&gt;::initialize_problem()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rods_per_assembly_x = 17, rods_per_assembly_y = 17;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>       pin_pitch_x = 1.26, pin_pitch_y = 1.26;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span>       assembly_height = 200;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> assemblies_x = 2, assemblies_y = 2, assemblies_z = 1;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> bottom_left = <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>();</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> upper_right =</div>
<div class="line">    (dim == 2 ? <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(assemblies_x * rods_per_assembly_x * pin_pitch_x,</div>
<div class="line">                           assemblies_y * rods_per_assembly_y * pin_pitch_y) :</div>
<div class="line">                <a class="code" href="classPoint.html">Point</a>&lt;dim&gt;(assemblies_x * rods_per_assembly_x * pin_pitch_x,</div>
<div class="line">                           assemblies_y * rods_per_assembly_y * pin_pitch_y,</div>
<div class="line">                           assemblies_z * assembly_height));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  std::vector&lt;unsigned int&gt; n_subdivisions;</div>
<div class="line">  n_subdivisions.push_back(assemblies_x * rods_per_assembly_x);</div>
<div class="line">  <span class="keywordflow">if</span> (dim &gt;= 2)</div>
<div class="line">    n_subdivisions.push_back(assemblies_y * rods_per_assembly_y);</div>
<div class="line">  <span class="keywordflow">if</span> (dim &gt;= 3)</div>
<div class="line">    n_subdivisions.push_back(assemblies_z);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> coarse_grid;</div>
<div class="line">  <a class="code" href="namespaceGridGenerator.html#ac76417d7404b75cf53c732f456e6e971">GridGenerator::subdivided_hyper_rectangle</a>(</div>
<div class="line">    coarse_grid, n_subdivisions, bottom_left, upper_right, <span class="keyword">true</span>);</div>
<div class="ttc" id="aclassPoint_html"><div class="ttname"><a href="classPoint.html">Point</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2point_8h_source.html#l00110">point.h:111</a></div></div>
<div class="ttc" id="anamespaceGridGenerator_html_ac76417d7404b75cf53c732f456e6e971"><div class="ttname"><a href="namespaceGridGenerator.html#ac76417d7404b75cf53c732f456e6e971">GridGenerator::subdivided_hyper_rectangle</a></div><div class="ttdeci">void subdivided_hyper_rectangle(Triangulation&lt; dim, spacedim &gt; &amp;tria, const std::vector&lt; unsigned int &gt; &amp;repetitions, const Point&lt; dim &gt; &amp;p1, const Point&lt; dim &gt; &amp;p2, const bool colorize=false)</div></div>
</div><!-- fragment --><p>该函数的第二部分涉及每种类型装配的销单元的材料数量。在这里，我们定义了四种不同类型的组件，对于这些组件，我们在下面的表格中描述了燃料棒的排列。 <br  />
</p>
<p>这里描述的组件取自介绍中提到的基准，它们是（按照这个顺序）。 </p><ol>
<li>
'UX'组件。二氧化铀燃料组件，带有24个导向管和一个中央可移动裂变室 </li>
<li>
'UA' 组件。带有24个AIC的二氧化铀燃料组件和一个中央可移动裂变室 </li>
<li>
'PX'组件。MOX燃料组件，带有24个导气管和一个中央可移动裂变室 </li>
<li>
'R'组件：一个反射器。 </li>
</ol>
<p><br  />
</p>
<p>请注意，这里列出的数字和从基准描述中提取的数字，以良好的老Fortran方式，是基于一的。我们以后在给各个单元分配材料时将从每个数字中减去1，以将事情转换为C语言风格的基于零的索引。</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_assemblies = 4;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> assembly_materials</div>
<div class="line">  [n_assemblies][rods_per_assembly_x][rods_per_assembly_y] = {</div>
<div class="line">    {{1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 5, 1, 1, 5, 1, 1, 5, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 5, 1, 1, 1, 1, 1, 1, 1, 1, 1, 5, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 5, 1, 1, 5, 1, 1, 5, 1, 1, 5, 1, 1, 5, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 5, 1, 1, 5, 1, 1, 7, 1, 1, 5, 1, 1, 5, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 5, 1, 1, 5, 1, 1, 5, 1, 1, 5, 1, 1, 5, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 5, 1, 1, 1, 1, 1, 1, 1, 1, 1, 5, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 5, 1, 1, 5, 1, 1, 5, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1}},</div>
<div class="line">    {{1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 8, 1, 1, 8, 1, 1, 8, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 8, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 8, 1, 1, 8, 1, 1, 8, 1, 1, 8, 1, 1, 8, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 8, 1, 1, 8, 1, 1, 7, 1, 1, 8, 1, 1, 8, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 8, 1, 1, 8, 1, 1, 8, 1, 1, 8, 1, 1, 8, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 8, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 8, 1, 1, 8, 1, 1, 8, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">     {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1}},</div>
<div class="line">    {{2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2},</div>
<div class="line">     {2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2},</div>
<div class="line">     {2, 3, 3, 3, 3, 5, 3, 3, 5, 3, 3, 5, 3, 3, 3, 3, 2},</div>
<div class="line">     {2, 3, 3, 5, 3, 4, 4, 4, 4, 4, 4, 4, 3, 5, 3, 3, 2},</div>
<div class="line">     {2, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 2},</div>
<div class="line">     {2, 3, 5, 4, 4, 5, 4, 4, 5, 4, 4, 5, 4, 4, 5, 3, 2},</div>
<div class="line">     {2, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 2},</div>
<div class="line">     {2, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 2},</div>
<div class="line">     {2, 3, 5, 4, 4, 5, 4, 4, 7, 4, 4, 5, 4, 4, 5, 3, 2},</div>
<div class="line">     {2, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 2},</div>
<div class="line">     {2, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 2},</div>
<div class="line">     {2, 3, 5, 4, 4, 5, 4, 4, 5, 4, 4, 5, 4, 4, 5, 3, 2},</div>
<div class="line">     {2, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 2},</div>
<div class="line">     {2, 3, 3, 5, 3, 4, 4, 4, 4, 4, 4, 4, 3, 5, 3, 3, 2},</div>
<div class="line">     {2, 3, 3, 3, 3, 5, 3, 3, 5, 3, 3, 5, 3, 3, 3, 3, 2},</div>
<div class="line">     {2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2},</div>
<div class="line">     {2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2}},</div>
<div class="line">    {{6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">     {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">     {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">     {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">     {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">     {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">     {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">     {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">     {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">     {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">     {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">     {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">     {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">     {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">     {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">     {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">     {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6}}};</div>
</div><!-- fragment --><p>在描述了组成装配体的材料之后，我们必须指定装配体在核心中的排列。我们使用一种对称模式，实际上只使用'UX'和'PX'装配体。</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> core[assemblies_x][assemblies_y][assemblies_z] = {</div>
<div class="line">  {{0}, {2}}, {{2}, {0}}};</div>
</div><!-- fragment --><p>我们现在可以为每个单元实际设置材料ID。为此，我们在所有单元中循环，查看单元中心的位置，并确定这将在哪个组件和燃料棒中。我们增加了一些检查，以确保我们计算的位置在我们必须查找材料的数组的范围内）。在循环结束时，我们相应地设置材料标识符。</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;cell : coarse_grid.<a class="code" href="group__CPP11.html#ga23e860c5192f6501650dda8bb3e2b497">active_cell_iterators</a>())</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> cell_center = cell-&gt;center();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tmp_x = int(cell_center[0] / pin_pitch_x);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ax    = tmp_x / rods_per_assembly_x;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cx    = tmp_x - ax * rods_per_assembly_x;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span>     tmp_y = int(cell_center[1] / pin_pitch_y);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ay    = tmp_y / rods_per_assembly_y;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cy    = tmp_y - ay * rods_per_assembly_y;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> az =</div>
<div class="line">      (dim == 2 ? 0 : int(cell_center[dim - 1] / assembly_height));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(ax &lt; assemblies_x, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(ay &lt; assemblies_y, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(az &lt; assemblies_z, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(core[ax][ay][az] &lt; n_assemblies, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(cx &lt; rods_per_assembly_x, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(cy &lt; rods_per_assembly_y, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    cell-&gt;set_material_id(assembly_materials[core[ax][ay][az]][cx][cy] - 1);</div>
<div class="line">  }</div>
<div class="ttc" id="agroup__CPP11_html_ga23e860c5192f6501650dda8bb3e2b497"><div class="ttname"><a href="group__CPP11.html#ga23e860c5192f6501650dda8bb3e2b497">Triangulation::active_cell_iterators</a></div><div class="ttdeci">IteratorRange&lt; active_cell_iterator &gt; active_cell_iterators() const</div></div>
<div class="ttc" id="agroup__Exceptions_html_ga31978c026b8b6b5116df30b8e748f6b7"><div class="ttname"><a href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">StandardExceptions::ExcInternalError</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcInternalError()</div></div>
</div><!-- fragment --><p>在粗略网格被初始化后，我们创建适当数量的能量组对象，并让它们用上面生成的粗略网格来初始化各自的网格。</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">    energy_groups.emplace_back(std::make_unique&lt;EnergyGroup&lt;dim&gt;&gt;(</div>
<div class="line">      group, material_data, coarse_grid, fe));</div>
<div class="line">  convergence_table_stream.open(<span class="stringliteral">&quot;convergence_table&quot;</span>);</div>
<div class="line">  convergence_table_stream.precision(12);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="codeNeutronDiffusionProblemget_total_fission_sourcecode"></a></p><h5><code>NeutronDiffusionProblem::get_total_fission_source</code></h5>
<p><br  />
</p>
<p>在特征值计算中，我们需要在每次功率迭代后计算总裂变中子源。然后用总功率来更新K效。 <br  />
</p>
<p>由于总裂变源是所有能量组的总和，而且每个总和都可以独立计算，所以我们实际上是以并行方式进行的。其中一个问题是， <code>EnergyGroup</code> 类中计算裂变源的函数会返回一个值。我们想在循环本身中把这些值加在一起：理想的情况是，每个任务计算它的值，然后立即把它加到总数中。以这种方式同时加值需要两个功能。 </p><ol>
<li>
我们需要一种存储数值的方式，使多个线程能够以防止数据竞赛的方式并发地读入和写入（即线程安全的读写）。  </li>
<li>
我们需要一种方法来增加这样一个值，而且是线程安全的。  </li>
</ol>
<p><br  />
</p>
<p>第一个功能可以通过模板类实现 <code>std::atomic</code> 。然而，由 <code>std::atomic&lt;double&gt;::fetch_add()</code> 实现的第二个特性只在C++20及以后的版本中可用：由于deal.II支持旧版本的C++语言标准，我们还不能使用这一特性。因此，取而代之的是，我们简单地将每个组的值写成一个向量的条目，并在函数的最后将这些值相加。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> NeutronDiffusionProblem&lt;dim&gt;::get_total_fission_source()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  std::vector&lt;double&gt;  fission_sources(parameters.n_groups);</div>
<div class="line">  <a class="code" href="classThreads_1_1TaskGroup.html">Threads::TaskGroup&lt;&gt;</a> tasks;</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">    tasks += Threads::new_task&lt;&gt;([&amp;, group]() {</div>
<div class="line">      fission_sources[group] = energy_groups[group]-&gt;get_fission_source();</div>
<div class="line">    });</div>
<div class="line">  tasks.<a class="code" href="group__Exceptions.html#ga2917c607a567538f8e560c849fa88ac6">join_all</a>();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> std::accumulate(fission_sources.begin(), fission_sources.end(), 0.0);</div>
<div class="line">}</div>
<div class="ttc" id="aclassThreads_1_1TaskGroup_html"><div class="ttname"><a href="classThreads_1_1TaskGroup.html">Threads::TaskGroup</a></div><div class="ttdef"><b>Definition:</b> <a href="thread__management_8h_source.html#l01491">thread_management.h:1492</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga2917c607a567538f8e560c849fa88ac6"><div class="ttname"><a href="group__Exceptions.html#ga2917c607a567538f8e560c849fa88ac6">Threads::TaskGroup::join_all</a></div><div class="ttdeci">void join_all() const</div><div class="ttdef"><b>Definition:</b> <a href="thread__management_8h_source.html#l01526">thread_management.h:1526</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="codeNeutronDiffusionProblemrefine_gridcode"></a> </p><h5><code>NeutronDiffusionProblem::refine_grid</code></h5>
<p><br  />
</p>
<p>下一个函数让各个能量组对象细化其网格。这其中的大部分，也是可以独立并行完成的任务：首先，让所有的能量组对象并行计算它们的误差指标，然后计算所有能量组的最大误差指标，并确定细化和粗化单元的阈值，然后要求所有能量组相应地细化它们的网格，同样是并行的。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> NeutronDiffusionProblem&lt;dim&gt;::refine_grid()</div>
<div class="line">{</div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; <a class="code" href="namespaceinternal_1_1TriangulationImplementation.html#a9f815604be9b560fea00beef8d720480">n_cells</a>(parameters.n_groups);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">    <a class="code" href="namespaceinternal_1_1TriangulationImplementation.html#a9f815604be9b560fea00beef8d720480">n_cells</a>[group] = energy_groups[group]-&gt;<a class="code" href="namespaceinternal_1_1TriangulationImplementation.html#a3344398031a9e10cb9eef0784f8da1be">n_active_cells</a>();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classBlockVector.html">BlockVector&lt;float&gt;</a> group_error_indicators(<a class="code" href="namespaceinternal_1_1TriangulationImplementation.html#a9f815604be9b560fea00beef8d720480">n_cells</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classThreads_1_1TaskGroup.html">Threads::TaskGroup&lt;&gt;</a> tasks;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">      tasks += <a class="code" href="group__threads.html#ga8c1e15b84e1bb58a8029fc6d6ddf3cbf">Threads::new_task</a>([&amp;, group]() {</div>
<div class="line">        energy_groups[group]-&gt;estimate_errors(</div>
<div class="line">          group_error_indicators.block(group));</div>
<div class="line">      });</div>
<div class="line">  }</div>
<div class="ttc" id="aclassBlockVector_html"><div class="ttname"><a href="classBlockVector.html">BlockVector</a></div><div class="ttdef"><b>Definition:</b> <a href="block__vector_8h_source.html#l00070">block_vector.h:71</a></div></div>
<div class="ttc" id="agroup__threads_html_ga8c1e15b84e1bb58a8029fc6d6ddf3cbf"><div class="ttname"><a href="group__threads.html#ga8c1e15b84e1bb58a8029fc6d6ddf3cbf">Threads::new_task</a></div><div class="ttdeci">Task&lt; RT &gt; new_task(const std::function&lt; RT()&gt; &amp;function)</div><div class="ttdef"><b>Definition:</b> <a href="thread__management_8h_source.html#l01324">thread_management.h:1324</a></div></div>
<div class="ttc" id="anamespaceinternal_1_1TriangulationImplementation_html_a9f815604be9b560fea00beef8d720480"><div class="ttname"><a href="namespaceinternal_1_1TriangulationImplementation.html#a9f815604be9b560fea00beef8d720480">internal::TriangulationImplementation::n_cells</a></div><div class="ttdeci">unsigned int n_cells(const internal::TriangulationImplementation::NumberCache&lt; 1 &gt; &amp;c)</div><div class="ttdef"><b>Definition:</b> <a href="grid_2tria_8cc_source.html#l12651">tria.cc:12651</a></div></div>
</div><!-- fragment --><p><a class="el" href="classThreads_1_1TaskGroup.html">Threads::TaskGroup</a> 的析构器连接所有线程，因此我们知道在我们退出范围时，计算已经完成。</p>
<div class="fragment"><div class="line">  <span class="keyword">const</span> <span class="keywordtype">float</span> max_error         = group_error_indicators.linfty_norm();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">float</span> refine_threshold  = 0.3 * max_error;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">float</span> coarsen_threshold = 0.01 * max_error;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classThreads_1_1TaskGroup.html">Threads::TaskGroup&lt;void&gt;</a> tasks;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">      tasks += <a class="code" href="group__threads.html#ga8c1e15b84e1bb58a8029fc6d6ddf3cbf">Threads::new_task</a>([&amp;, group]() {</div>
<div class="line">        energy_groups[group]-&gt;refine_grid(group_error_indicators.block(group),</div>
<div class="line">                                          refine_threshold,</div>
<div class="line">                                          coarsen_threshold);</div>
<div class="line">      });</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="codeNeutronDiffusionProblemruncode"></a> </p><h5><code>NeutronDiffusionProblem::run</code></h5>
<p><br  />
</p>
<p>最后，这是肉体所在的函数：在一连串的网格上迭代，并在每一个网格上做幂级迭代来计算特征值。 <br  />
</p>
<p>鉴于介绍中对算法的描述，实际上没有什么可评论的。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">NeutronDiffusionProblem&lt;dim&gt;::run</a>()</div>
<div class="line">{</div>
</div><!-- fragment --><p>我们想改变的只是这个函数的输出精度，并在这个函数返回时恢复 <code>std::cout</code> 的状态。因此，我们需要一种方法来撤销输出格式的改变。Boost提供了一种方便的方法来保存输出流的状态，并在当前块结束时（当调用 <code>restore_flags</code> 的析构器时）用 <code>ios_flags_saver</code> 类来恢复它，我们在这里使用了这种方法。</p>
<div class="fragment"><div class="line">boost::io::ios_flags_saver restore_flags(std::cout);</div>
<div class="line">std::cout &lt;&lt; std::setprecision(12) &lt;&lt; std::fixed;</div>
</div><!-- fragment --><p>我们通过k_eff的变化来计算下面的误差（即k_eff_old的差异。</p>
<div class="fragment"><div class="line"><span class="keywordtype">double</span> k_eff_old = 0.0;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle = 0; cycle &lt; parameters.n_refinement_cycles;</div>
<div class="line">     ++cycle)</div>
<div class="line">  {</div>
</div><!-- fragment --><p>下面我们将测量每个周期所花费的CPU时间。定时器的构造函数调用 <a class="el" href="classTimer.html#a3a8b5272198d029779dc9302a54305a8">Timer::start()</a>, ，所以一旦我们创建了一个定时器，我们就可以查询它的信息。由于这个循环的许多部分是用任务并行化的，所以我们测量的CPU时间（如果我们用一个以上的线程运行）将大于墙的时间。</p>
<div class="fragment"><div class="line"><a class="code" href="classTimer.html">Timer</a> timer;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (cycle == 0)</div>
<div class="line">  {</div>
<div class="line">    initialize_problem();</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">      energy_groups[group]-&gt;setup_linear_system();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">  {</div>
<div class="line">    refine_grid();</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">      energy_groups[group]-&gt;solution *= k_eff;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;   Numbers of active cells:       &quot;</span>;</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">  std::cout &lt;&lt; energy_groups[group]-&gt;<a class="code" href="namespaceinternal_1_1TriangulationImplementation.html#a3344398031a9e10cb9eef0784f8da1be">n_active_cells</a>() &lt;&lt; <span class="charliteral">&#39; &#39;</span>;</div>
<div class="line">std::cout &lt;&lt; std::endl;</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;   Numbers of degrees of freedom: &quot;</span>;</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">  std::cout &lt;&lt; energy_groups[group]-&gt;n_dofs() &lt;&lt; <span class="charliteral">&#39; &#39;</span>;</div>
<div class="line">std::cout &lt;&lt; std::endl &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><a class="code" href="classThreads_1_1TaskGroup.html">Threads::TaskGroup&lt;&gt;</a> tasks;</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">  tasks += <a class="code" href="group__threads.html#ga8c1e15b84e1bb58a8029fc6d6ddf3cbf">Threads::new_task</a>(</div>
<div class="line">    [&amp;, group]() { energy_groups[group]-&gt;assemble_system_matrix(); });</div>
<div class="line">tasks.<a class="code" href="group__Exceptions.html#ga2917c607a567538f8e560c849fa88ac6">join_all</a>();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">double</span>       error;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iteration = 1;</div>
<div class="line"><span class="keywordflow">do</span></div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">      {</div>
<div class="line">        energy_groups[group]-&gt;assemble_ingroup_rhs(</div>
<div class="line">          <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a>());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bgroup = 0; bgroup &lt; parameters.n_groups;</div>
<div class="line">             ++bgroup)</div>
<div class="line">          energy_groups[group]-&gt;assemble_cross_group_rhs(</div>
<div class="line">            *energy_groups[bgroup]);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        energy_groups[group]-&gt;solve();</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    k_eff = get_total_fission_source();</div>
<div class="line">    error = <a class="code" href="numbers_8h.html#a0ebae11c64606a73e80a6328b1ab0802">std::abs</a>(k_eff - k_eff_old) / <a class="code" href="numbers_8h.html#a0ebae11c64606a73e80a6328b1ab0802">std::abs</a>(k_eff);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> flux_ratio = energy_groups[0]-&gt;solution.linfty_norm() /</div>
<div class="line">                              energy_groups[1]-&gt;solution.linfty_norm();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> max_thermal = energy_groups[1]-&gt;solution.linfty_norm();</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Iter number:&quot;</span> &lt;&lt; std::setw(2) &lt;&lt; std::right</div>
<div class="line">              &lt;&lt; iteration &lt;&lt; <span class="stringliteral">&quot; k_eff=&quot;</span> &lt;&lt; k_eff</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot; flux_ratio=&quot;</span> &lt;&lt; flux_ratio</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot; max_thermal=&quot;</span> &lt;&lt; max_thermal &lt;&lt; std::endl;</div>
<div class="line">    k_eff_old = k_eff;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">      {</div>
<div class="line">        energy_groups[group]-&gt;solution_old =</div>
<div class="line">          energy_groups[group]-&gt;solution;</div>
<div class="line">        energy_groups[group]-&gt;solution_old /= k_eff;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    ++iteration;</div>
<div class="line">  }</div>
<div class="line"><span class="keywordflow">while</span> ((error &gt; parameters.convergence_tolerance) &amp;&amp; (iteration &lt; 500));</div>
<div class="line">convergence_table_stream &lt;&lt; cycle &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; energy_groups[0]-&gt;n_dofs()</div>
<div class="line">                         &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; energy_groups[1]-&gt;n_dofs() &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; k_eff &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                         &lt;&lt; energy_groups[0]-&gt;solution.linfty_norm() /</div>
<div class="line">                              energy_groups[1]-&gt;solution.linfty_norm()</div>
<div class="line">                         &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">  energy_groups[group]-&gt;output_results(cycle);</div>
<div class="ttc" id="aclassTimer_html"><div class="ttname"><a href="classTimer.html">Timer</a></div><div class="ttdef"><b>Definition:</b> <a href="timer_8h_source.html#l00118">timer.h:119</a></div></div>
<div class="ttc" id="anumbers_8h_html_a0ebae11c64606a73e80a6328b1ab0802"><div class="ttname"><a href="numbers_8h.html#a0ebae11c64606a73e80a6328b1ab0802">std::abs</a></div><div class="ttdeci">::VectorizedArray&lt; Number, width &gt; abs(const ::VectorizedArray&lt; Number, width &gt; &amp;)</div><div class="ttdef"><b>Definition:</b> <a href="vectorization_8h_source.html#l05444">vectorization.h:5444</a></div></div>
</div><!-- fragment --><p>打印出关于模拟的信息以及耗费的CPU时间。我们可以不先调用 <a class="el" href="classTimer.html#a4e3933a78790d7455daff5acab3f8432">Timer::cpu_time()</a> 来获得调用该函数时的已用CPU时间。</p>
<div class="fragment"><div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Cycle=&quot;</span> &lt;&lt; cycle &lt;&lt; <span class="stringliteral">&quot;, n_dofs=&quot;</span></div>
<div class="line">                  &lt;&lt; energy_groups[0]-&gt;n_dofs() + energy_groups[1]-&gt;n_dofs()</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;,  k_eff=&quot;</span> &lt;&lt; k_eff &lt;&lt; <span class="stringliteral">&quot;, time=&quot;</span> &lt;&lt; timer.<a class="code" href="classTimer.html#a4e3933a78790d7455daff5acab3f8432">cpu_time</a>()</div>
<div class="line">                  &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step28</span></div>
<div class="ttc" id="aclassTimer_html_a4e3933a78790d7455daff5acab3f8432"><div class="ttname"><a href="classTimer.html#a4e3933a78790d7455daff5acab3f8432">Timer::cpu_time</a></div><div class="ttdeci">double cpu_time() const</div><div class="ttdef"><b>Definition:</b> <a href="timer_8cc_source.html#l00236">timer.cc:236</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="Thecodemaincodefunction"></a> </p><h3>The <code>main()</code> function</h3>
<p>程序中的最后一件事是 <code>main()</code> 函数。其结构与其他大多数教程程序一样，唯一的例外是我们在这里处理一个参数文件。 为此，我们首先看一下传递给这个函数的命令行参数：如果在命令行上没有指定输入文件，那么就使用 "project.prm"，否则就取命令行上作为第一个参数给出的文件名。</p>
<p>这样，我们创建一个ParameterHandler对象，让 <code>NeutronDiffusionProblem::Parameters</code> 类声明它想在输入文件中看到的所有参数（或者，采取默认值，如果参数文件中没有列出任何参数），然后读取输入文件，要求参数对象提取数值，最后把所有东西交给 <code>NeutronDiffusionProblem</code> 类型的对象，以便计算特征值。</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line">      <span class="keyword">using namespace </span>Step28;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      std::string filename;</div>
<div class="line">      <span class="keywordflow">if</span> (argc &lt; 2)</div>
<div class="line">        filename = <span class="stringliteral">&quot;project.prm&quot;</span>;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        filename = argv[1];</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dim = 2;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classParameterHandler.html">ParameterHandler</a> parameter_handler;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      NeutronDiffusionProblem&lt;dim&gt;::Parameters parameters;</div>
<div class="line">      parameters.declare_parameters(parameter_handler);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      parameter_handler.<a class="code" href="classParameterHandler.html#a0ddaa05c5463c6c0b7701e18005717a9">parse_input</a>(filename);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      parameters.get_parameters(parameter_handler);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      NeutronDiffusionProblem&lt;dim&gt; neutron_diffusion_problem(parameters);</div>
<div class="line">      neutron_diffusion_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aclassParameterHandler_html_a0ddaa05c5463c6c0b7701e18005717a9"><div class="ttname"><a href="classParameterHandler.html#a0ddaa05c5463c6c0b7701e18005717a9">ParameterHandler::parse_input</a></div><div class="ttdeci">virtual void parse_input(std::istream &amp;input, const std::string &amp;filename=&quot;input file&quot;, const std::string &amp;last_line=&quot;&quot;, const bool skip_undefined=false)</div><div class="ttdef"><b>Definition:</b> <a href="parameter__handler_8cc_source.html#l00399">parameter_handler.cc:399</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>我们可以用下面的输入文件运行程序。</p>
<div class="fragment"><div class="line"><span class="preprocessor"># Listing of Parameters</span></div>
<div class="line"><span class="preprocessor"># ---------------------</span></div>
<div class="line"><span class="preprocessor"># Polynomial degree of the finite element to be used</span></div>
<div class="line"><a class="code" href="group__CUDAWrappers.html#gabb7130e2cea54654455ca41ef304f939">set</a> Finite element degree     = 2</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># The number of energy different groups considered</span></div>
<div class="line"><a class="code" href="group__CUDAWrappers.html#gabb7130e2cea54654455ca41ef304f939">set</a> Number of energy groups   = 2</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># Inner power iterations are stopped when the change in k_eff falls below this</span></div>
<div class="line"><span class="preprocessor"># tolerance</span></div>
<div class="line"><a class="code" href="group__CUDAWrappers.html#gabb7130e2cea54654455ca41ef304f939">set</a> Power iteration tolerance = 1<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">e</a>-12</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># Number of refinement cycles to be performed</span></div>
<div class="line"><span class="preprocessor">set Refinement cycles         = 12</span></div>
<div class="ttc" id="agroup__CUDAWrappers_html_gabb7130e2cea54654455ca41ef304f939"><div class="ttname"><a href="group__CUDAWrappers.html#gabb7130e2cea54654455ca41ef304f939">LinearAlgebra::CUDAWrappers::kernel::set</a></div><div class="ttdeci">__global__ void set(Number *val, const Number s, const size_type N)</div></div>
</div><!-- fragment --><p>这个程序的输出包括控制台输出，一个名为 "convergence_table "的文件来记录网格迭代的主要结果，以及vtu格式的图形输出。</p>
<p>控制台的输出看起来像这样。</p>
<div class="fragment"><div class="line">Cycle 0:</div>
<div class="line">   Numbers of active cells:       1156 1156</div>
<div class="line">   Numbers of degrees of freedom: 4761 4761</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Iter number: 1 k_eff=319.375676634310 flux_ratio=6.836246075630 max_thermal=1.433899030144</div>
<div class="line">Iter number: 2 k_eff=0.834072546055 flux_ratio=5.204601882144 max_thermal=0.004630925876</div>
<div class="line">Iter number: 3 k_eff=0.862826188043 flux_ratio=4.645051765984 max_thermal=0.005380396338</div>
<div class="line">...</div>
<div class="line">Iter number:69 k_eff=0.906841960370 flux_ratio=4.384056022578 max_thermal=0.008466414246</div>
<div class="line">Iter number:70 k_eff=0.906841960371 flux_ratio=4.384056022583 max_thermal=0.008466414246</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">   Cycle=0, n_dofs=9522,  k_eff=0.906841960371, time=7.623425000000</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Cycle 1:</div>
<div class="line">   Numbers of active cells:       1156 2380</div>
<div class="line">   Numbers of degrees of freedom: 4761 10667</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Iter number: 1 k_eff=0.906838267472 flux_ratio=4.385474405125 max_thermal=0.008463675976</div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Cycle 11:</div>
<div class="line">   Numbers of active cells:       11749 47074</div>
<div class="line">   Numbers of degrees of freedom: 50261 204523</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Iter number: 1 k_eff=0.906798057750 flux_ratio=4.384878772166 max_thermal=0.008464822382</div>
<div class="line">Iter number: 2 k_eff=0.906833008185 flux_ratio=4.384868138638 max_thermal=0.008465057191</div>
<div class="line">...</div>
<div class="line">Iter number:32 k_eff=0.906834736550 flux_ratio=4.384846081793 max_thermal=0.008465019607</div>
<div class="line">Iter number:33 k_eff=0.906834736551 flux_ratio=4.384846081798 max_thermal=0.008465019607</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">   Cycle=11, n_dofs=254784,  k_eff=0.906834736551, time=238.593762000000</div>
</div><!-- fragment --><p>我们看到，由于用上一次网格迭代的解进行初始化，在第0周期后，动力迭代确实收敛得比较快。收敛表 "的内容是。</p>
<div class="fragment"><div class="line">0 4761 4761 0.906841960371 4.38405602258</div>
<div class="line">1 4761 10667 0.906837901031 4.38548908776</div>
<div class="line">2 4761 18805 0.906836075928 4.3854666475</div>
<div class="line">3 6629 27301 0.90683550011 4.38540458087</div>
<div class="line">4 12263 48095 0.906835001796 4.38538179873</div>
<div class="line">5 17501 69297 0.906834858174 4.38485382341</div>
<div class="line">6 19933 78605 0.90683482406 4.38485065879</div>
<div class="line">7 23979 93275 0.906834787555 4.38484837926</div>
<div class="line">8 30285 117017 0.906834761604 4.38484654495</div>
<div class="line">9 40087 154355 0.906834746215 4.38484608319</div>
<div class="line">10 45467 179469 0.906834740155 4.38484600505</div>
<div class="line">11 50261 204523 0.906834736551 4.3848460818</div>
</div><!-- fragment --><p>列的含义是：网格迭代次数，快速能量组的自由度数，热能组的自由度数，收敛的K效应和快速通量的最大值与热能组的最大值之比。</p>
<p>网格迭代#9时，快速和热能组的网格看起来如下。</p>
<p><img src="https://www.dealii.org/images/steps/developer/step-28.grid-0.9.order2.png" alt="" width="400" class="inline"/> &#160; <img src="https://www.dealii.org/images/steps/developer/step-28.grid-1.9.order2.png" alt="" width="400" class="inline"/> 。</p>
<p>我们看到，热能组的网格比快速组的网格要细得多。在这些网格上的解决方案是：（注意：通量被归一化，总裂变源等于1）。</p>
<p><img src="https://www.dealii.org/images/steps/developer/step-28.solution-0.9.order2.png" alt="" width="400" class="inline"/> &#160; <img src="https://www.dealii.org/images/steps/developer/step-28.solution-1.9.order2.png" alt="" width="400" class="inline"/> 。</p>
<p>然后我们绘制多项式阶数等于1、2和3的收敛数据。</p>
<p><img src="https://www.dealii.org/images/steps/developer/step-28.convergence.png" alt="" class="inline"/> <br  />
</p>
<p>估计的 "精确的 "k-effective=0.906834721253，这只是从最后一次网格迭代的多项式阶数3减去2e-10。我们看到，h-adaptive计算提供了一个代数收敛性。多项式阶数越高，网格迭代收敛的速度越快。在我们的问题中，我们需要更少的DoFs数量来达到相同的精度，而更高的多项式阶数。<a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2009 - 2020 by the deal.II authors</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div>
<div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div>
<div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div>
<div class="line"><span class="comment"> * the top level directory of deal.II.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Author: Yaqi Wang, Texas A&amp;M University, 2009, 2010</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="timer_8h.html">deal.II/base/timer.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="parameter__handler_8h.html">deal.II/base/parameter_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="thread__management_8h.html">deal.II/base/thread_management.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparsity__pattern_8h.html">deal.II/lac/sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparse__matrix_8h.html">deal.II/lac/sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__out_8h.html">deal.II/grid/grid_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="block__vector_8h.html">deal.II/lac/block_vector.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__tools_8h.html">deal.II/grid/grid_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;boost/io/ios_state.hpp&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;list&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iomanip&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>Step28</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">class </span>MaterialData</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    MaterialData(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_groups);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> get_diffusion_coefficient(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group,</div>
<div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>) <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">double</span> get_removal_XS(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group,</div>
<div class="line">                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>) <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">double</span> get_fission_XS(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group,</div>
<div class="line">                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>) <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">double</span> get_fission_dist_XS(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_1,</div>
<div class="line">                               <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_2,</div>
<div class="line">                               <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>) <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">double</span> get_scattering_XS(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_1,</div>
<div class="line">                             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_2,</div>
<div class="line">                             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>) <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">double</span> get_fission_spectrum(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group,</div>
<div class="line">                                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_groups;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_materials;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTable.html">Table&lt;2, double&gt;</a> diffusion;</div>
<div class="line">    <a class="code" href="classTable.html">Table&lt;2, double&gt;</a> sigma_r;</div>
<div class="line">    <a class="code" href="classTable.html">Table&lt;2, double&gt;</a> nu_sigma_f;</div>
<div class="line">    <a class="code" href="classTable.html">Table&lt;3, double&gt;</a> sigma_s;</div>
<div class="line">    <a class="code" href="classTable.html">Table&lt;2, double&gt;</a> chi;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line">  MaterialData::MaterialData(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_groups)</div>
<div class="line">    : n_groups(n_groups)</div>
<div class="line">    , n_materials(8)</div>
<div class="line">    , diffusion(n_materials, n_groups)</div>
<div class="line">    , sigma_r(n_materials, n_groups)</div>
<div class="line">    , nu_sigma_f(n_materials, n_groups)</div>
<div class="line">    , sigma_s(n_materials, n_groups, n_groups)</div>
<div class="line">    , chi(n_materials, n_groups)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">switch</span> (this-&gt;n_groups)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">case</span> 2:</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> m = 0; m &lt; n_materials; ++m)</div>
<div class="line">              {</div>
<div class="line">                diffusion[m][0] = 1.2;</div>
<div class="line">                diffusion[m][1] = 0.4;</div>
<div class="line">                chi[m][0]       = 1.0;</div>
<div class="line">                chi[m][1]       = 0.0;</div>
<div class="line">                sigma_r[m][0]   = 0.03;</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_1 = 0; group_1 &lt; n_groups; ++group_1)</div>
<div class="line">                  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_2 = 0; group_2 &lt; n_groups; ++group_2)</div>
<div class="line">                    sigma_s[m][group_1][group_2] = 0.0;</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">            diffusion[5][1] = 0.2;</div>
<div class="line"> </div>
<div class="line">            sigma_r[4][0] = 0.026;</div>
<div class="line">            sigma_r[5][0] = 0.051;</div>
<div class="line">            sigma_r[6][0] = 0.026;</div>
<div class="line">            sigma_r[7][0] = 0.050;</div>
<div class="line"> </div>
<div class="line">            sigma_r[0][1] = 0.100;</div>
<div class="line">            sigma_r[1][1] = 0.200;</div>
<div class="line">            sigma_r[2][1] = 0.250;</div>
<div class="line">            sigma_r[3][1] = 0.300;</div>
<div class="line">            sigma_r[4][1] = 0.020;</div>
<div class="line">            sigma_r[5][1] = 0.040;</div>
<div class="line">            sigma_r[6][1] = 0.020;</div>
<div class="line">            sigma_r[7][1] = 0.800;</div>
<div class="line"> </div>
<div class="line">            nu_sigma_f[0][0] = 0.0050;</div>
<div class="line">            nu_sigma_f[1][0] = 0.0075;</div>
<div class="line">            nu_sigma_f[2][0] = 0.0075;</div>
<div class="line">            nu_sigma_f[3][0] = 0.0075;</div>
<div class="line">            nu_sigma_f[4][0] = 0.000;</div>
<div class="line">            nu_sigma_f[5][0] = 0.000;</div>
<div class="line">            nu_sigma_f[6][0] = 1<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">e</a>-7;</div>
<div class="line">            nu_sigma_f[7][0] = 0.00;</div>
<div class="line"> </div>
<div class="line">            nu_sigma_f[0][1] = 0.125;</div>
<div class="line">            nu_sigma_f[1][1] = 0.300;</div>
<div class="line">            nu_sigma_f[2][1] = 0.375;</div>
<div class="line">            nu_sigma_f[3][1] = 0.450;</div>
<div class="line">            nu_sigma_f[4][1] = 0.000;</div>
<div class="line">            nu_sigma_f[5][1] = 0.000;</div>
<div class="line">            nu_sigma_f[6][1] = 3<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">e</a>-6;</div>
<div class="line">            nu_sigma_f[7][1] = 0.00;</div>
<div class="line"> </div>
<div class="line">            sigma_s[0][0][1] = 0.020;</div>
<div class="line">            sigma_s[1][0][1] = 0.015;</div>
<div class="line">            sigma_s[2][0][1] = 0.015;</div>
<div class="line">            sigma_s[3][0][1] = 0.015;</div>
<div class="line">            sigma_s[4][0][1] = 0.025;</div>
<div class="line">            sigma_s[5][0][1] = 0.050;</div>
<div class="line">            sigma_s[6][0][1] = 0.025;</div>
<div class="line">            sigma_s[7][0][1] = 0.010;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>,</div>
<div class="line">                 <a class="code" href="group__Exceptions.html#gae9a45f517af1401c50811a11083f9114">ExcMessage</a>(</div>
<div class="line">                   <span class="stringliteral">&quot;Presently, only data for 2 groups is implemented&quot;</span>));</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span></div>
<div class="line">  MaterialData::get_diffusion_coefficient(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group,</div>
<div class="line">                                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(group &lt; n_groups, <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(group, 0, n_groups));</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a> &lt; n_materials,</div>
<div class="line">           <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>, 0, n_materials));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> diffusion[<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>][group];</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> MaterialData::get_removal_XS(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group,</div>
<div class="line">                                      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(group &lt; n_groups, <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(group, 0, n_groups));</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a> &lt; n_materials,</div>
<div class="line">           <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>, 0, n_materials));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> sigma_r[<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>][group];</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> MaterialData::get_fission_XS(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group,</div>
<div class="line">                                      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(group &lt; n_groups, <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(group, 0, n_groups));</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a> &lt; n_materials,</div>
<div class="line">           <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>, 0, n_materials));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> nu_sigma_f[<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>][group];</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> MaterialData::get_scattering_XS(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_1,</div>
<div class="line">                                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_2,</div>
<div class="line">                                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(group_1 &lt; n_groups, <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(group_1, 0, n_groups));</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(group_2 &lt; n_groups, <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(group_2, 0, n_groups));</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a> &lt; n_materials,</div>
<div class="line">           <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>, 0, n_materials));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> sigma_s[<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>][group_1][group_2];</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span></div>
<div class="line">  MaterialData::get_fission_spectrum(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group,</div>
<div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(group &lt; n_groups, <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(group, 0, n_groups));</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a> &lt; n_materials,</div>
<div class="line">           <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>, 0, n_materials));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> chi[<a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>][group];</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> MaterialData::get_fission_dist_XS(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_1,</div>
<div class="line">                                           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group_2,</div>
<div class="line">                                           <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">return</span> (get_fission_spectrum(group_1, <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>) *</div>
<div class="line">            get_fission_XS(group_2, <a class="code" href="namespacetypes.html#ae22a1b4da339109d8dc9cc2a112b1a69">material_id</a>));</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>EnergyGroup</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    EnergyGroup(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        group,</div>
<div class="line">                <span class="keyword">const</span> MaterialData &amp;      material_data,</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> &amp;coarse_grid,</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;fe);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> setup_linear_system();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceinternal_1_1TriangulationImplementation.html#a3344398031a9e10cb9eef0784f8da1be">n_active_cells</a>() <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_dofs() <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> assemble_system_matrix();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_ingroup_rhs(<span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> &amp;extraneous_source);</div>
<div class="line">    <span class="keywordtype">void</span> assemble_cross_group_rhs(<span class="keyword">const</span> EnergyGroup&lt;dim&gt; &amp;g_prime);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> solve();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> get_fission_source() <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> estimate_errors(<a class="code" href="classVector.html">Vector&lt;float&gt;</a> &amp;error_indicators) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> refine_grid(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;float&gt;</a> &amp;error_indicators,</div>
<div class="line">                     <span class="keyword">const</span> <span class="keywordtype">double</span>         refine_threshold,</div>
<div class="line">                     <span class="keyword">const</span> <span class="keywordtype">double</span>         coarsen_threshold);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> solution;</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> solution_old;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  group;</div>
<div class="line">    <span class="keyword">const</span> MaterialData &amp;material_data;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>        <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;fe;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>           dof_handler;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      sparsity_pattern;</div>
<div class="line">    <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> system_rhs;</div>
<div class="line"> </div>
<div class="line">    std::map&lt;types::global_dof_index, double&gt; boundary_values;</div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a>                 hanging_node_constraints;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> assemble_cross_group_rhs_recursive(</div>
<div class="line">      <span class="keyword">const</span> EnergyGroup&lt;dim&gt; &amp;                       g_prime,</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler&lt;dim&gt;::cell_iterator</a> &amp;cell_g,</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler&lt;dim&gt;::cell_iterator</a> &amp;cell_g_prime,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> &amp;                     prolongation_matrix);</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  EnergyGroup&lt;dim&gt;::EnergyGroup(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>        group,</div>
<div class="line">                                <span class="keyword">const</span> MaterialData &amp;      material_data,</div>
<div class="line">                                <span class="keyword">const</span> <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> &amp;coarse_grid,</div>
<div class="line">                                <span class="keyword">const</span> <a class="code" href="classFiniteElement.html">FiniteElement&lt;dim&gt;</a> &amp;fe)</div>
<div class="line">    : group(group)</div>
<div class="line">    , material_data(material_data)</div>
<div class="line">    , fe(fe)</div>
<div class="line">    , dof_handler(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.copy_triangulation(coarse_grid);</div>
<div class="line">    dof_handler.distribute_dofs(fe);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceinternal_1_1TriangulationImplementation.html#a3344398031a9e10cb9eef0784f8da1be">EnergyGroup&lt;dim&gt;::n_active_cells</a>()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> EnergyGroup&lt;dim&gt;::n_dofs()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">return</span> dof_handler.n_dofs();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> EnergyGroup&lt;dim&gt;::setup_linear_system()</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_dofs = dof_handler.n_dofs();</div>
<div class="line"> </div>
<div class="line">    hanging_node_constraints.clear();</div>
<div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler,</div>
<div class="line">                                            hanging_node_constraints);</div>
<div class="line">    hanging_node_constraints.close();</div>
<div class="line"> </div>
<div class="line">    system_matrix.clear();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(n_dofs, n_dofs);</div>
<div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler, dsp);</div>
<div class="line">    hanging_node_constraints.condense(dsp);</div>
<div class="line">    sparsity_pattern.copy_from(dsp);</div>
<div class="line"> </div>
<div class="line">    system_matrix.reinit(sparsity_pattern);</div>
<div class="line"> </div>
<div class="line">    system_rhs.reinit(n_dofs);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (solution.size() == 0)</div>
<div class="line">      {</div>
<div class="line">        solution.reinit(n_dofs);</div>
<div class="line">        solution_old.reinit(n_dofs);</div>
<div class="line">        solution_old = 1.0;</div>
<div class="line">        solution     = solution_old;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    boundary_values.clear();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dim; ++i)</div>
<div class="line">      <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                               2 * i + 1,</div>
<div class="line">                                               <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a>(),</div>
<div class="line">                                               boundary_values);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> EnergyGroup&lt;dim&gt;::assemble_system_matrix()</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(fe.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                              <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(dofs_per_cell, dofs_per_cell);</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     cell_rhs(dofs_per_cell);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a> = 0;</div>
<div class="line"> </div>
<div class="line">        fe_values.reinit(cell);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> diffusion_coefficient =</div>
<div class="line">          material_data.get_diffusion_coefficient(group, cell-&gt;material_id());</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> removal_XS =</div>
<div class="line">          material_data.get_removal_XS(group, cell-&gt;material_id());</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; n_q_points; ++q_point)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j)</div>
<div class="line">              <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j) +=</div>
<div class="line">                ((diffusion_coefficient * fe_values.shape_grad(i, q_point) *</div>
<div class="line">                    fe_values.shape_grad(j, q_point) +</div>
<div class="line">                  removal_XS * fe_values.shape_value(i, q_point) *</div>
<div class="line">                    fe_values.shape_value(j, q_point)) *</div>
<div class="line">                 fe_values.JxW(q_point));</div>
<div class="line"> </div>
<div class="line">        cell-&gt;get_dof_indices(local_dof_indices);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j)</div>
<div class="line">            system_matrix.add(local_dof_indices[i],</div>
<div class="line">                              local_dof_indices[j],</div>
<div class="line">                              <a class="code" href="namespaceLocalIntegrators_1_1Advection.html#a8bc7b8136646134f73a4193adefe15f8">cell_matrix</a>(i, j));</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    hanging_node_constraints.condense(system_matrix);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span></div>
<div class="line">  EnergyGroup&lt;dim&gt;::assemble_ingroup_rhs(<span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> &amp;extraneous_source)</div>
<div class="line">  {</div>
<div class="line">    system_rhs.reinit(dof_handler.n_dofs());</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(fe.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                              <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>      cell_rhs(dofs_per_cell);</div>
<div class="line">    std::vector&lt;double&gt; extraneous_source_values(n_q_points);</div>
<div class="line">    std::vector&lt;double&gt; solution_old_values(n_q_points);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        cell_rhs = 0;</div>
<div class="line"> </div>
<div class="line">        fe_values.reinit(cell);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> fission_dist_XS =</div>
<div class="line">          material_data.get_fission_dist_XS(group, group, cell-&gt;material_id());</div>
<div class="line"> </div>
<div class="line">        extraneous_source.<a class="code" href="classFunction.html#a562fc1114e95e702e6696721f71528db">value_list</a>(fe_values.get_quadrature_points(),</div>
<div class="line">                                     extraneous_source_values);</div>
<div class="line"> </div>
<div class="line">        fe_values.get_function_values(solution_old, solution_old_values);</div>
<div class="line"> </div>
<div class="line">        cell-&gt;get_dof_indices(local_dof_indices);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; n_q_points; ++q_point)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div>
<div class="line">            cell_rhs(i) +=</div>
<div class="line">              ((extraneous_source_values[q_point] +</div>
<div class="line">                fission_dist_XS * solution_old_values[q_point]) *</div>
<div class="line">               fe_values.shape_value(i, q_point) * fe_values.JxW(q_point));</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div>
<div class="line">          system_rhs(local_dof_indices[i]) += cell_rhs(i);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span></div>
<div class="line">  EnergyGroup&lt;dim&gt;::assemble_cross_group_rhs(<span class="keyword">const</span> EnergyGroup&lt;dim&gt; &amp;g_prime)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (group == g_prime.group)</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::list&lt;std::pair&lt;typename DoFHandler&lt;dim&gt;::cell_iterator,</div>
<div class="line">                              <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler&lt;dim&gt;::cell_iterator</a>&gt;&gt;</div>
<div class="line">      cell_list =</div>
<div class="line">        <a class="code" href="namespaceGridTools.html#a32a5016c746ad756046ecff264dfa60d">GridTools::get_finest_common_cells</a>(dof_handler, g_prime.dof_handler);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell_pair : cell_list)</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> unit_matrix(fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; unit_matrix.m(); ++i)</div>
<div class="line">          unit_matrix(i, i) = 1;</div>
<div class="line">        assemble_cross_group_rhs_recursive(g_prime,</div>
<div class="line">                                           cell_pair.first,</div>
<div class="line">                                           cell_pair.second,</div>
<div class="line">                                           unit_matrix);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> EnergyGroup&lt;dim&gt;::assemble_cross_group_rhs_recursive(</div>
<div class="line">    <span class="keyword">const</span> EnergyGroup&lt;dim&gt; &amp;                       g_prime,</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler&lt;dim&gt;::cell_iterator</a> &amp;cell_g,</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler&lt;dim&gt;::cell_iterator</a> &amp;cell_g_prime,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> &amp;                     prolongation_matrix)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (!cell_g-&gt;has_children() &amp;&amp; !cell_g_prime-&gt;has_children())</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(fe.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe,</div>
<div class="line">                                quadrature_formula,</div>
<div class="line">                                <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (cell_g-&gt;level() &gt; cell_g_prime-&gt;level())</div>
<div class="line">          fe_values.reinit(cell_g);</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          fe_values.reinit(cell_g_prime);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> fission_dist_XS =</div>
<div class="line">          material_data.get_fission_dist_XS(group,</div>
<div class="line">                                            g_prime.group,</div>
<div class="line">                                            cell_g_prime-&gt;material_id());</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> scattering_XS =</div>
<div class="line">          material_data.get_scattering_XS(g_prime.group,</div>
<div class="line">                                          group,</div>
<div class="line">                                          cell_g_prime-&gt;material_id());</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_mass_matrix_f(fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>(),</div>
<div class="line">                                               fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">        <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_mass_matrix_g(fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>(),</div>
<div class="line">                                               fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; n_q_points; ++q_point)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>(); ++i)</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>(); ++j)</div>
<div class="line">              {</div>
<div class="line">                local_mass_matrix_f(i, j) +=</div>
<div class="line">                  (fission_dist_XS * fe_values.shape_value(i, q_point) *</div>
<div class="line">                   fe_values.shape_value(j, q_point) * fe_values.JxW(q_point));</div>
<div class="line">                local_mass_matrix_g(i, j) +=</div>
<div class="line">                  (scattering_XS * fe_values.shape_value(i, q_point) *</div>
<div class="line">                   fe_values.shape_value(j, q_point) * fe_values.JxW(q_point));</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classVector.html">Vector&lt;double&gt;</a> g_prime_new_values(fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">        <a class="code" href="classVector.html">Vector&lt;double&gt;</a> g_prime_old_values(fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">        cell_g_prime-&gt;get_dof_values(g_prime.solution_old, g_prime_old_values);</div>
<div class="line">        cell_g_prime-&gt;get_dof_values(g_prime.solution, g_prime_new_values);</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classVector.html">Vector&lt;double&gt;</a> cell_rhs(fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">        <a class="code" href="classVector.html">Vector&lt;double&gt;</a> tmp(fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (cell_g-&gt;level() &gt; cell_g_prime-&gt;level())</div>
<div class="line">          {</div>
<div class="line">            prolongation_matrix.<a class="code" href="classFullMatrix.html#a65a409eeef6388d99ac15e2bbe8045f6">vmult</a>(tmp, g_prime_old_values);</div>
<div class="line">            local_mass_matrix_f.vmult(cell_rhs, tmp);</div>
<div class="line"> </div>
<div class="line">            prolongation_matrix.<a class="code" href="classFullMatrix.html#a65a409eeef6388d99ac15e2bbe8045f6">vmult</a>(tmp, g_prime_new_values);</div>
<div class="line">            local_mass_matrix_g.vmult_add(cell_rhs, tmp);</div>
<div class="line">          }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          {</div>
<div class="line">            local_mass_matrix_f.vmult(tmp, g_prime_old_values);</div>
<div class="line">            prolongation_matrix.<a class="code" href="classFullMatrix.html#a8219d4fa962f1b041a506221a7a15379">Tvmult</a>(cell_rhs, tmp);</div>
<div class="line"> </div>
<div class="line">            local_mass_matrix_g.vmult(tmp, g_prime_new_values);</div>
<div class="line">            prolongation_matrix.<a class="code" href="classFullMatrix.html#abed6fffa5cb201496d751a4427cb59d6">Tvmult_add</a>(cell_rhs, tmp);</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;types::global_dof_index&gt; local_dof_indices(</div>
<div class="line">          fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">        cell_g-&gt;get_dof_indices(local_dof_indices);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>(); ++i)</div>
<div class="line">          system_rhs(local_dof_indices[i]) += cell_rhs(i);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> child = 0;</div>
<div class="line">           child &lt; GeometryInfo&lt;dim&gt;::max_children_per_cell;</div>
<div class="line">           ++child)</div>
<div class="line">        {</div>
<div class="line">          <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> new_matrix(fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>(),</div>
<div class="line">                                        fe.<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">          fe.<a class="code" href="classFiniteElement.html#af78c7b6503befe61dc6df5eb41c99019">get_prolongation_matrix</a>(child).<a class="code" href="classFullMatrix.html#a21b873fcd180999ad0d268c3278a71ec">mmult</a>(new_matrix,</div>
<div class="line">                                                  prolongation_matrix);</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">if</span> (cell_g-&gt;has_children())</div>
<div class="line">            assemble_cross_group_rhs_recursive(g_prime,</div>
<div class="line">                                               cell_g-&gt;child(child),</div>
<div class="line">                                               cell_g_prime,</div>
<div class="line">                                               new_matrix);</div>
<div class="line">          <span class="keywordflow">else</span></div>
<div class="line">            assemble_cross_group_rhs_recursive(g_prime,</div>
<div class="line">                                               cell_g,</div>
<div class="line">                                               cell_g_prime-&gt;child(child),</div>
<div class="line">                                               new_matrix);</div>
<div class="line">        }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> EnergyGroup&lt;dim&gt;::get_fission_source()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>  quadrature_formula(fe.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;double&gt; solution_values(n_q_points);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> fission_source = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        fe_values.reinit(cell);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> fission_XS =</div>
<div class="line">          material_data.get_fission_XS(group, cell-&gt;material_id());</div>
<div class="line"> </div>
<div class="line">        fe_values.get_function_values(solution, solution_values);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_point = 0; q_point &lt; n_q_points; ++q_point)</div>
<div class="line">          fission_source +=</div>
<div class="line">            (fission_XS * solution_values[q_point] * fe_values.JxW(q_point));</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> fission_source;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> EnergyGroup&lt;dim&gt;::solve()</div>
<div class="line">  {</div>
<div class="line">    hanging_node_constraints.condense(system_rhs);</div>
<div class="line">    <a class="code" href="namespaceMatrixTools.html#a9ad0eb7a8662628534586716748d62fb">MatrixTools::apply_boundary_values</a>(boundary_values,</div>
<div class="line">                                       system_matrix,</div>
<div class="line">                                       solution,</div>
<div class="line">                                       system_rhs);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a>            solver_control(system_matrix.m(),</div>
<div class="line">                                 1<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">e</a>-12 * system_rhs.l2_norm());</div>
<div class="line">    <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt; cg(solver_control);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;SparseMatrix&lt;double&gt;</a>&gt; preconditioner;</div>
<div class="line">    preconditioner.<a class="code" href="group__Preconditioners.html#ga7a3d66b17bb0ea1b16606e222474c2ea">initialize</a>(system_matrix, 1.2);</div>
<div class="line"> </div>
<div class="line">    cg.solve(system_matrix, solution, system_rhs, preconditioner);</div>
<div class="line"> </div>
<div class="line">    hanging_node_constraints.distribute(solution);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> EnergyGroup&lt;dim&gt;::estimate_errors(<a class="code" href="classVector.html">Vector&lt;float&gt;</a> &amp;error_indicators)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div>
<div class="line">      dof_handler,</div>
<div class="line">      <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(fe.<a class="code" href="classFiniteElementData.html#a2cbf5ad6b464871261dbd054bced18a8">degree</a> + 1),</div>
<div class="line">      std::map&lt;<a class="code" href="namespacetypes.html#aed8813fee8c8a2edcc6005e6a48c321a">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(),</div>
<div class="line">      solution,</div>
<div class="line">      error_indicators);</div>
<div class="line">    error_indicators /= solution.<a class="code" href="group__Vectors.html#ga9f6b7f7afb05aaff7e1ab8f9942b6dae">linfty_norm</a>();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> EnergyGroup&lt;dim&gt;::refine_grid(<span class="keyword">const</span> <a class="code" href="classVector.html">Vector&lt;float&gt;</a> &amp;error_indicators,</div>
<div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">double</span>         refine_threshold,</div>
<div class="line">                                     <span class="keyword">const</span> <span class="keywordtype">double</span>         coarsen_threshold)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.active_cell_iterators())</div>
<div class="line">      <span class="keywordflow">if</span> (error_indicators(cell-&gt;active_cell_index()) &gt; refine_threshold)</div>
<div class="line">        cell-&gt;set_refine_flag();</div>
<div class="line">      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (error_indicators(cell-&gt;active_cell_index()) &lt; coarsen_threshold)</div>
<div class="line">        cell-&gt;set_coarsen_flag();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim&gt;</a> soltrans(dof_handler);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.prepare_coarsening_and_refinement();</div>
<div class="line">    soltrans.prepare_for_coarsening_and_refinement(solution);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">    dof_handler.distribute_dofs(fe);</div>
<div class="line">    setup_linear_system();</div>
<div class="line"> </div>
<div class="line">    solution.reinit(dof_handler.n_dofs());</div>
<div class="line">    soltrans.interpolate(solution_old, solution);</div>
<div class="line"> </div>
<div class="line">    hanging_node_constraints.distribute(solution);</div>
<div class="line"> </div>
<div class="line">    solution_old.reinit(dof_handler.n_dofs());</div>
<div class="line">    solution_old = solution;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> EnergyGroup&lt;dim&gt;::output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keyword">const</span> std::string filename = std::string(<span class="stringliteral">&quot;solution-&quot;</span>) +</div>
<div class="line">                                 <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(group, 2) + <span class="stringliteral">&quot;.&quot;</span> +</div>
<div class="line">                                 <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(cycle, 2) + <span class="stringliteral">&quot;.vtu&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line"> </div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#ac1eb26168177faa30ffbcf9cbb9c3cd5">attach_dof_handler</a>(dof_handler);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">add_data_vector</a>(solution, <span class="stringliteral">&quot;solution&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="classDataOut.html#a5eb51872b8736849bb7e8d2007fae086">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">    std::ofstream output(filename);</div>
<div class="line">    data_out.<a class="code" href="group__Exceptions.html#ga93c780f93105e0daaa76c6c43694b4ae">write_vtu</a>(output);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>NeutronDiffusionProblem</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">class </span>Parameters</div>
<div class="line">    {</div>
<div class="line">    <span class="keyword">public</span>:</div>
<div class="line">      Parameters();</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">static</span> <span class="keywordtype">void</span> declare_parameters(<a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm);</div>
<div class="line">      <span class="keywordtype">void</span>        get_parameters(<a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm);</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_groups;</div>
<div class="line">      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_refinement_cycles;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fe_degree;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">double</span> convergence_tolerance;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    NeutronDiffusionProblem(<span class="keyword">const</span> Parameters &amp;parameters);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> initialize_problem();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> refine_grid();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> get_total_fission_source() <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> Parameters &amp; parameters;</div>
<div class="line">    <span class="keyword">const</span> MaterialData material_data;</div>
<div class="line">    <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>          fe;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> k_eff;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;std::unique_ptr&lt;EnergyGroup&lt;dim&gt;&gt;&gt; energy_groups;</div>
<div class="line"> </div>
<div class="line">    std::ofstream convergence_table_stream;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  NeutronDiffusionProblem&lt;dim&gt;::Parameters::Parameters()</div>
<div class="line">    : n_groups(2)</div>
<div class="line">    , n_refinement_cycles(5)</div>
<div class="line">    , fe_degree(2)</div>
<div class="line">    , convergence_tolerance(1<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">e</a>-12)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> NeutronDiffusionProblem&lt;dim&gt;::Parameters::declare_parameters(</div>
<div class="line">    <a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm)</div>
<div class="line">  {</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Number of energy groups&quot;</span>,</div>
<div class="line">                      <span class="stringliteral">&quot;2&quot;</span>,</div>
<div class="line">                      <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(),</div>
<div class="line">                      <span class="stringliteral">&quot;The number of energy different groups considered&quot;</span>);</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Refinement cycles&quot;</span>,</div>
<div class="line">                      <span class="stringliteral">&quot;5&quot;</span>,</div>
<div class="line">                      <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(),</div>
<div class="line">                      <span class="stringliteral">&quot;Number of refinement cycles to be performed&quot;</span>);</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(<span class="stringliteral">&quot;Finite element degree&quot;</span>,</div>
<div class="line">                      <span class="stringliteral">&quot;2&quot;</span>,</div>
<div class="line">                      <a class="code" href="classPatterns_1_1Integer.html">Patterns::Integer</a>(),</div>
<div class="line">                      <span class="stringliteral">&quot;Polynomial degree of the finite element to be used&quot;</span>);</div>
<div class="line">    prm.<a class="code" href="classParameterHandler.html#a6d65f458be69e23a348221cb67fc411d">declare_entry</a>(</div>
<div class="line">      <span class="stringliteral">&quot;Power iteration tolerance&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;1e-12&quot;</span>,</div>
<div class="line">      <a class="code" href="classPatterns_1_1Double.html">Patterns::Double</a>(),</div>
<div class="line">      <span class="stringliteral">&quot;Inner power iterations are stopped when the change in k_eff falls &quot;</span></div>
<div class="line">      <span class="stringliteral">&quot;below this tolerance&quot;</span>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> NeutronDiffusionProblem&lt;dim&gt;::Parameters::get_parameters(</div>
<div class="line">    <a class="code" href="classParameterHandler.html">ParameterHandler</a> &amp;prm)</div>
<div class="line">  {</div>
<div class="line">    n_groups              = prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Number of energy groups&quot;</span>);</div>
<div class="line">    n_refinement_cycles   = prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Refinement cycles&quot;</span>);</div>
<div class="line">    fe_degree             = prm.<a class="code" href="classParameterHandler.html#a61fa98fdc0c52980a5b1de0ee1fc5bb2">get_integer</a>(<span class="stringliteral">&quot;Finite element degree&quot;</span>);</div>
<div class="line">    convergence_tolerance = prm.<a class="code" href="classParameterHandler.html#aeaf3c7846747695b1f327677e3716ec5">get_double</a>(<span class="stringliteral">&quot;Power iteration tolerance&quot;</span>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  NeutronDiffusionProblem&lt;dim&gt;::NeutronDiffusionProblem(</div>
<div class="line">    <span class="keyword">const</span> Parameters &amp;parameters)</div>
<div class="line">    : parameters(parameters)</div>
<div class="line">    , material_data(parameters.n_groups)</div>
<div class="line">    , fe(parameters.fe_degree)</div>
<div class="line">    , k_eff(std::numeric_limits&lt;<a class="code" href="classdouble.html">double</a>&gt;::quiet_NaN())</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> NeutronDiffusionProblem&lt;dim&gt;::initialize_problem()</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rods_per_assembly_x = 17, rods_per_assembly_y = 17;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>       pin_pitch_x = 1.26, pin_pitch_y = 1.26;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>       assembly_height = 200;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> assemblies_x = 2, assemblies_y = 2, assemblies_z = 1;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> bottom_left = <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>();</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> upper_right =</div>
<div class="line">      (dim == 2 ? <a class="code" href="classPoint.html">Point&lt;dim&gt;</a>(assemblies_x * rods_per_assembly_x * pin_pitch_x,</div>
<div class="line">                             assemblies_y * rods_per_assembly_y * pin_pitch_y) :</div>
<div class="line">                  <a class="code" href="classPoint.html">Point</a>&lt;dim&gt;(assemblies_x * rods_per_assembly_x * pin_pitch_x,</div>
<div class="line">                             assemblies_y * rods_per_assembly_y * pin_pitch_y,</div>
<div class="line">                             assemblies_z * assembly_height));</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;unsigned int&gt; n_subdivisions;</div>
<div class="line">    n_subdivisions.push_back(assemblies_x * rods_per_assembly_x);</div>
<div class="line">    <span class="keywordflow">if</span> (dim &gt;= 2)</div>
<div class="line">      n_subdivisions.push_back(assemblies_y * rods_per_assembly_y);</div>
<div class="line">    <span class="keywordflow">if</span> (dim &gt;= 3)</div>
<div class="line">      n_subdivisions.push_back(assemblies_z);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> coarse_grid;</div>
<div class="line">    <a class="code" href="namespaceGridGenerator.html#ac76417d7404b75cf53c732f456e6e971">GridGenerator::subdivided_hyper_rectangle</a>(</div>
<div class="line">      coarse_grid, n_subdivisions, bottom_left, upper_right, <span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_assemblies = 4;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> assembly_materials</div>
<div class="line">      [n_assemblies][rods_per_assembly_x][rods_per_assembly_y] = {</div>
<div class="line">        {{1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 5, 1, 1, 5, 1, 1, 5, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 5, 1, 1, 1, 1, 1, 1, 1, 1, 1, 5, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 5, 1, 1, 5, 1, 1, 5, 1, 1, 5, 1, 1, 5, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 5, 1, 1, 5, 1, 1, 7, 1, 1, 5, 1, 1, 5, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 5, 1, 1, 5, 1, 1, 5, 1, 1, 5, 1, 1, 5, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 5, 1, 1, 1, 1, 1, 1, 1, 1, 1, 5, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 5, 1, 1, 5, 1, 1, 5, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1}},</div>
<div class="line">        {{1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 8, 1, 1, 8, 1, 1, 8, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 8, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 8, 1, 1, 8, 1, 1, 8, 1, 1, 8, 1, 1, 8, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 8, 1, 1, 8, 1, 1, 7, 1, 1, 8, 1, 1, 8, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 8, 1, 1, 8, 1, 1, 8, 1, 1, 8, 1, 1, 8, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 8, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 8, 1, 1, 8, 1, 1, 8, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1},</div>
<div class="line">         {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1}},</div>
<div class="line">        {{2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2},</div>
<div class="line">         {2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2},</div>
<div class="line">         {2, 3, 3, 3, 3, 5, 3, 3, 5, 3, 3, 5, 3, 3, 3, 3, 2},</div>
<div class="line">         {2, 3, 3, 5, 3, 4, 4, 4, 4, 4, 4, 4, 3, 5, 3, 3, 2},</div>
<div class="line">         {2, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 2},</div>
<div class="line">         {2, 3, 5, 4, 4, 5, 4, 4, 5, 4, 4, 5, 4, 4, 5, 3, 2},</div>
<div class="line">         {2, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 2},</div>
<div class="line">         {2, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 2},</div>
<div class="line">         {2, 3, 5, 4, 4, 5, 4, 4, 7, 4, 4, 5, 4, 4, 5, 3, 2},</div>
<div class="line">         {2, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 2},</div>
<div class="line">         {2, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 2},</div>
<div class="line">         {2, 3, 5, 4, 4, 5, 4, 4, 5, 4, 4, 5, 4, 4, 5, 3, 2},</div>
<div class="line">         {2, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 2},</div>
<div class="line">         {2, 3, 3, 5, 3, 4, 4, 4, 4, 4, 4, 4, 3, 5, 3, 3, 2},</div>
<div class="line">         {2, 3, 3, 3, 3, 5, 3, 3, 5, 3, 3, 5, 3, 3, 3, 3, 2},</div>
<div class="line">         {2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2},</div>
<div class="line">         {2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2}},</div>
<div class="line">        {{6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">         {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">         {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">         {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">         {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">         {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">         {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">         {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">         {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">         {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">         {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">         {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">         {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">         {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">         {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">         {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6},</div>
<div class="line">         {6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6}}};</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> core[assemblies_x][assemblies_y][assemblies_z] = {</div>
<div class="line">      {{0}, {2}}, {{2}, {0}}};</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;cell : coarse_grid.<a class="code" href="group__CPP11.html#ga23e860c5192f6501650dda8bb3e2b497">active_cell_iterators</a>())</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> cell_center = cell-&gt;center();</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tmp_x = int(cell_center[0] / pin_pitch_x);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ax    = tmp_x / rods_per_assembly_x;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cx    = tmp_x - ax * rods_per_assembly_x;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span>     tmp_y = int(cell_center[1] / pin_pitch_y);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ay    = tmp_y / rods_per_assembly_y;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cy    = tmp_y - ay * rods_per_assembly_y;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> az =</div>
<div class="line">          (dim == 2 ? 0 : int(cell_center[dim - 1] / assembly_height));</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(ax &lt; assemblies_x, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(ay &lt; assemblies_y, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(az &lt; assemblies_z, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(core[ax][ay][az] &lt; n_assemblies, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(cx &lt; rods_per_assembly_x, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(cy &lt; rods_per_assembly_y, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">        cell-&gt;set_material_id(assembly_materials[core[ax][ay][az]][cx][cy] - 1);</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">      energy_groups.emplace_back(std::make_unique&lt;EnergyGroup&lt;dim&gt;&gt;(</div>
<div class="line">        group, material_data, coarse_grid, fe));</div>
<div class="line">    convergence_table_stream.open(<span class="stringliteral">&quot;convergence_table&quot;</span>);</div>
<div class="line">    convergence_table_stream.precision(12);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> NeutronDiffusionProblem&lt;dim&gt;::get_total_fission_source()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    std::vector&lt;double&gt;  fission_sources(parameters.n_groups);</div>
<div class="line">    <a class="code" href="classThreads_1_1TaskGroup.html">Threads::TaskGroup&lt;&gt;</a> tasks;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">      tasks += Threads::new_task&lt;&gt;([&amp;, group]() {</div>
<div class="line">        fission_sources[group] = energy_groups[group]-&gt;get_fission_source();</div>
<div class="line">      });</div>
<div class="line">    tasks.<a class="code" href="group__Exceptions.html#ga2917c607a567538f8e560c849fa88ac6">join_all</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> std::accumulate(fission_sources.begin(), fission_sources.end(), 0.0);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> NeutronDiffusionProblem&lt;dim&gt;::refine_grid()</div>
<div class="line">  {</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; <a class="code" href="namespaceinternal_1_1TriangulationImplementation.html#a9f815604be9b560fea00beef8d720480">n_cells</a>(parameters.n_groups);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">      <a class="code" href="namespaceinternal_1_1TriangulationImplementation.html#a9f815604be9b560fea00beef8d720480">n_cells</a>[group] = energy_groups[group]-&gt;<a class="code" href="namespaceinternal_1_1TriangulationImplementation.html#a3344398031a9e10cb9eef0784f8da1be">n_active_cells</a>();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classBlockVector.html">BlockVector&lt;float&gt;</a> group_error_indicators(<a class="code" href="namespaceinternal_1_1TriangulationImplementation.html#a9f815604be9b560fea00beef8d720480">n_cells</a>);</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classThreads_1_1TaskGroup.html">Threads::TaskGroup&lt;&gt;</a> tasks;</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">        tasks += <a class="code" href="group__threads.html#ga8c1e15b84e1bb58a8029fc6d6ddf3cbf">Threads::new_task</a>([&amp;, group]() {</div>
<div class="line">          energy_groups[group]-&gt;estimate_errors(</div>
<div class="line">            group_error_indicators.block(group));</div>
<div class="line">        });</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> max_error         = group_error_indicators.linfty_norm();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> refine_threshold  = 0.3 * max_error;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> coarsen_threshold = 0.01 * max_error;</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classThreads_1_1TaskGroup.html">Threads::TaskGroup&lt;void&gt;</a> tasks;</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">        tasks += <a class="code" href="group__threads.html#ga8c1e15b84e1bb58a8029fc6d6ddf3cbf">Threads::new_task</a>([&amp;, group]() {</div>
<div class="line">          energy_groups[group]-&gt;refine_grid(group_error_indicators.block(group),</div>
<div class="line">                                            refine_threshold,</div>
<div class="line">                                            coarsen_threshold);</div>
<div class="line">        });</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">NeutronDiffusionProblem&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    boost::io::ios_flags_saver restore_flags(std::cout);</div>
<div class="line">    std::cout &lt;&lt; std::setprecision(12) &lt;&lt; std::fixed;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> k_eff_old = 0.0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle = 0; cycle &lt; parameters.n_refinement_cycles;</div>
<div class="line">         ++cycle)</div>
<div class="line">      {</div>
<div class="line">        <a class="code" href="classTimer.html">Timer</a> timer;</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (cycle == 0)</div>
<div class="line">          {</div>
<div class="line">            initialize_problem();</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">              energy_groups[group]-&gt;setup_linear_system();</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          {</div>
<div class="line">            refine_grid();</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">              energy_groups[group]-&gt;solution *= k_eff;</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Numbers of active cells:       &quot;</span>;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">          std::cout &lt;&lt; energy_groups[group]-&gt;<a class="code" href="namespaceinternal_1_1TriangulationImplementation.html#a3344398031a9e10cb9eef0784f8da1be">n_active_cells</a>() &lt;&lt; <span class="charliteral">&#39; &#39;</span>;</div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Numbers of degrees of freedom: &quot;</span>;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">          std::cout &lt;&lt; energy_groups[group]-&gt;n_dofs() &lt;&lt; <span class="charliteral">&#39; &#39;</span>;</div>
<div class="line">        std::cout &lt;&lt; std::endl &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="classThreads_1_1TaskGroup.html">Threads::TaskGroup&lt;&gt;</a> tasks;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">          tasks += <a class="code" href="group__threads.html#ga8c1e15b84e1bb58a8029fc6d6ddf3cbf">Threads::new_task</a>(</div>
<div class="line">            [&amp;, group]() { energy_groups[group]-&gt;assemble_system_matrix(); });</div>
<div class="line">        tasks.<a class="code" href="group__Exceptions.html#ga2917c607a567538f8e560c849fa88ac6">join_all</a>();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">double</span>       error;</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> iteration = 1;</div>
<div class="line">        <span class="keywordflow">do</span></div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">              {</div>
<div class="line">                energy_groups[group]-&gt;assemble_ingroup_rhs(</div>
<div class="line">                  <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a>());</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bgroup = 0; bgroup &lt; parameters.n_groups;</div>
<div class="line">                     ++bgroup)</div>
<div class="line">                  energy_groups[group]-&gt;assemble_cross_group_rhs(</div>
<div class="line">                    *energy_groups[bgroup]);</div>
<div class="line"> </div>
<div class="line">                energy_groups[group]-&gt;solve();</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            k_eff = get_total_fission_source();</div>
<div class="line">            error = <a class="code" href="numbers_8h.html#a0ebae11c64606a73e80a6328b1ab0802">std::abs</a>(k_eff - k_eff_old) / <a class="code" href="numbers_8h.html#a0ebae11c64606a73e80a6328b1ab0802">std::abs</a>(k_eff);</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> flux_ratio = energy_groups[0]-&gt;solution.linfty_norm() /</div>
<div class="line">                                      energy_groups[1]-&gt;solution.linfty_norm();</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> max_thermal = energy_groups[1]-&gt;solution.linfty_norm();</div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;Iter number:&quot;</span> &lt;&lt; std::setw(2) &lt;&lt; std::right</div>
<div class="line">                      &lt;&lt; iteration &lt;&lt; <span class="stringliteral">&quot; k_eff=&quot;</span> &lt;&lt; k_eff</div>
<div class="line">                      &lt;&lt; <span class="stringliteral">&quot; flux_ratio=&quot;</span> &lt;&lt; flux_ratio</div>
<div class="line">                      &lt;&lt; <span class="stringliteral">&quot; max_thermal=&quot;</span> &lt;&lt; max_thermal &lt;&lt; std::endl;</div>
<div class="line">            k_eff_old = k_eff;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">              {</div>
<div class="line">                energy_groups[group]-&gt;solution_old =</div>
<div class="line">                  energy_groups[group]-&gt;solution;</div>
<div class="line">                energy_groups[group]-&gt;solution_old /= k_eff;</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">            ++iteration;</div>
<div class="line">          }</div>
<div class="line">        <span class="keywordflow">while</span> ((error &gt; parameters.convergence_tolerance) &amp;&amp; (iteration &lt; 500));</div>
<div class="line">        convergence_table_stream &lt;&lt; cycle &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; energy_groups[0]-&gt;n_dofs()</div>
<div class="line">                                 &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; energy_groups[1]-&gt;n_dofs() &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                 &lt;&lt; k_eff &lt;&lt; <span class="stringliteral">&quot; &quot;</span></div>
<div class="line">                                 &lt;&lt; energy_groups[0]-&gt;solution.linfty_norm() /</div>
<div class="line">                                      energy_groups[1]-&gt;solution.linfty_norm()</div>
<div class="line">                                 &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> group = 0; group &lt; parameters.n_groups; ++group)</div>
<div class="line">          energy_groups[group]-&gt;output_results(cycle);</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Cycle=&quot;</span> &lt;&lt; cycle &lt;&lt; <span class="stringliteral">&quot;, n_dofs=&quot;</span></div>
<div class="line">                  &lt;&lt; energy_groups[0]-&gt;n_dofs() + energy_groups[1]-&gt;n_dofs()</div>
<div class="line">                  &lt;&lt; <span class="stringliteral">&quot;,  k_eff=&quot;</span> &lt;&lt; k_eff &lt;&lt; <span class="stringliteral">&quot;, time=&quot;</span> &lt;&lt; timer.<a class="code" href="classTimer.html#a4e3933a78790d7455daff5acab3f8432">cpu_time</a>()</div>
<div class="line">                  &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step28</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line">      <span class="keyword">using namespace </span>Step28;</div>
<div class="line"> </div>
<div class="line">      std::string filename;</div>
<div class="line">      <span class="keywordflow">if</span> (argc &lt; 2)</div>
<div class="line">        filename = <span class="stringliteral">&quot;project.prm&quot;</span>;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        filename = argv[1];</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dim = 2;</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classParameterHandler.html">ParameterHandler</a> parameter_handler;</div>
<div class="line"> </div>
<div class="line">      NeutronDiffusionProblem&lt;dim&gt;::Parameters parameters;</div>
<div class="line">      parameters.declare_parameters(parameter_handler);</div>
<div class="line"> </div>
<div class="line">      parameter_handler.<a class="code" href="classParameterHandler.html#a0ddaa05c5463c6c0b7701e18005717a9">parse_input</a>(filename);</div>
<div class="line"> </div>
<div class="line">      parameters.get_parameters(parameter_handler);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      NeutronDiffusionProblem&lt;dim&gt; neutron_diffusion_problem(parameters);</div>
<div class="line">      neutron_diffusion_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <br  />
 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
