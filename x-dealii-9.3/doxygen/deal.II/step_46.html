<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="canonical" href="https://www.dealii.org/current/doxygen/deal.II/step_46.html" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The step-46 tutorial program 。</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2021 by the deal.II authors"></meta>
<meta name="deal.II-version" content="9.3.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 9.3.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--Extra macros for MathJax:-->
<div style="display:none">
\(\newcommand{\dealvcentcolon}{\mathrel{\mathop{:}}}\)
\(\newcommand{\dealcoloneq}{\dealvcentcolon\mathrel{\mkern-1.2mu}=}\)
\(\newcommand{\jump}[1]{\left[\!\left[ #1 \right]\!\right]}\)
\(\newcommand{\average}[1]{\left\{\!\left\{ #1 \right\}\!\right\}}\)
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The step-46 tutorial program 。 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>本教程取决于 <a class="el" href="step_8.html">step-8</a> , <a class="el" href="step_22.html">step-22</a> , <a class="el" href="step_27.html">step-27</a> 。</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a><a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Thegeneralidea">The general idea</a><a href="#Thegeneralidea">The general idea</a>
        <li><a href="#Implementation">Implementation</a><a href="#Implementation">Implementation</a>
        <li><a href="#Specificsoftheimplementation"> Specifics of the implementation </a><a href="#Specificsoftheimplementation"> Specifics of the implementation </a>
      <ul>
        <li><a href="#Dealingwiththeinterfaceterms">Dealing with the interface terms</a><a href="#Dealingwiththeinterfaceterms">Dealing with the interface terms</a>
        <li><a href="#Velocityboundaryconditionsontheinterface">Velocity boundary conditions on the interface</a><a href="#Velocityboundaryconditionsontheinterface">Velocity boundary conditions on the interface</a>
      </ul>
        <li><a href="#Thetestcase">The testcase</a><a href="#Thetestcase">The testcase</a>
      <ul>
        <li><a href="#Identifyingwhichsubdomainacellisin">Identifying which subdomain a cell is in</a><a href="#Identifyingwhichsubdomainacellisin">Identifying which subdomain a cell is in</a>
        <li><a href="#Linearsolvers">Linear solvers</a><a href="#Linearsolvers">Linear solvers</a>
        <li><a href="#Meshrefinement">Mesh refinement</a><a href="#Meshrefinement">Mesh refinement</a>
    </ul>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a><a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#Includefiles">Include files</a><a href="#Includefiles">Include files</a>
        <li><a href="#ThecodeFluidStructureProblemcodeclasstemplate">The <code>FluidStructureProblem</code> class template</a><a href="#ThecodeFluidStructureProblemcodeclasstemplate">The <code>FluidStructureProblem</code> class template</a>
        <li><a href="#Boundaryvaluesandrighthandside">Boundary values and right hand side</a><a href="#Boundaryvaluesandrighthandside">Boundary values and right hand side</a>
        <li><a href="#ThecodeFluidStructureProblemcodeimplementation">The <code>FluidStructureProblem</code> implementation</a><a href="#ThecodeFluidStructureProblemcodeimplementation">The <code>FluidStructureProblem</code> implementation</a>
      <ul>
        <li><a href="#Constructorsandhelperfunctions">Constructors and helper functions</a><a href="#Constructorsandhelperfunctions">Constructors and helper functions</a>
        <li><a href="#Meshesandassigningsubdomains">Meshes and assigning subdomains</a> ]<a href="#Meshesandassigningsubdomains">Meshes and assigning subdomains</a>
        <li><a href="#codeFluidStructureProblemsetup_dofscode"><code>FluidStructureProblem::setup_dofs</code></a><a href="#codeFluidStructureProblemsetup_dofscode"><code>FluidStructureProblem::setup_dofs</code></a>
        <li><a href="#codeFluidStructureProblemassemble_systemcode"><code>FluidStructureProblem::assemble_system</code></a><a href="#codeFluidStructureProblemassemble_systemcode"><code>FluidStructureProblem::assemble_system</code></a>
        <li><a href="#codeFluidStructureProblemsolvecode"><code>FluidStructureProblem::solve</code></a><a href="#codeFluidStructureProblemsolvecode"><code>FluidStructureProblem::solve</code></a>
        <li><a href="#codeFluidStructureProblemoutput_resultscode"><code>FluidStructureProblem::output_results</code></a><a href="#codeFluidStructureProblemoutput_resultscode"><code>FluidStructureProblem::output_results</code></a>
        <li><a href="#codeFluidStructureProblemrefine_meshcode"><code>FluidStructureProblem::refine_mesh</code></a><a href="#codeFluidStructureProblemrefine_meshcode"><code>FluidStructureProblem::refine_mesh</code></a>
        <li><a href="#codeFluidStructureProblemruncode"><code>FluidStructureProblem::run</code></a><a href="#codeFluidStructureProblemruncode"><code>FluidStructureProblem::run</code></a>
        <li><a href="#Thecodemaincodefunction">The <code>main()</code> function</a><a href="#Thecodemaincodefunction">The <code>main()</code> function</a>
      </ul>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a><a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#2dresults">2d results</a><a href="#2dresults">2d results</a>
        <li><a href="#3dresults">3d results</a><a href="#3dresults">3d results</a>
        <li><a href="#Possibilitiesforextensions">Possibilities for extensions</a><a href="#Possibilitiesforextensions">Possibilities for extensions</a>
      <ul>
        <li><a href="#Linearsolversandpreconditioners">Linear solvers and preconditioners</a><a href="#Linearsolversandpreconditioners">Linear solvers and preconditioners</a>
        <li><a href="#Refinementindicators">Refinement indicators</a><a href="#Refinementindicators">Refinement indicators</a>
        <li><a href="#Verification">Verification</a><a href="#Verification">Verification</a>
        <li><a href="#Bettermodels">Better models</a><a href="#Bettermodels">Better models</a>
    </ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a><a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
</p>
<p><br  />
 <br  />
</p>
<p><em>This program was contributed by Wolfgang Bangerth. <br  />
 This material is based upon work partly supported by the National Science Foundation under Award No. EAR-0949446 and The University of California &ndash; Davis. Any opinions, findings, and conclusions or recommendations expressed in this publication are those of the author and do not necessarily reflect the views of the National Science Foundation or of The University of California &ndash; Davis. </em></p>
<p><a class="anchor" id="Intro"></a><a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>这个程序处理的是在领域的不同部分耦合不同物理学的问题。具体来说，让我们考虑以下情况，将斯托克斯流体与弹性固体耦合起来（这两个问题之前在 <a class="el" href="step_22.html">step-22</a> 和 <a class="el" href="step_8.html">step-8</a> 中分别讨论过，你可能想在那里阅读一下各个方程）。</p>
<ul>
<li><p class="startli">在 \(\Omega\) 的 \(\Omega_f\) 部分，我们有一个满足时间独立的斯托克斯方程（以涉及应变张量的形式）的流体在流动。 </p><p class="formulaDsp">
\begin{align*} -2\eta\nabla \cdot \varepsilon(\mathbf v) + \nabla p &amp;= 0, \qquad \qquad &amp;&amp; \text{in}\ \Omega_f\\ -\nabla \cdot \mathbf v &amp;= 0 &amp;&amp; \text{in}\ \Omega_f. \end{align*}
</p>
<p class="startli">这里， \(\mathbf v, p\) 分别是流体的速度和压力。 我们规定了部分外部边界上的速度， </p><p class="formulaDsp">
\begin{align*} \mathbf v = \mathbf v_0 \qquad\qquad \text{on}\ \Gamma_{f,1} \subset \partial\Omega \cap \partial\Omega_f \end{align*}
</p>
<p class="startli">而我们假设外部边界的其余部分为自由流动条件， </p><p class="formulaDsp">
\begin{align*} (2\eta \varepsilon(\mathbf v) - p \mathbf 1) \cdot \mathbf n = 0 \qquad\qquad \text{on}\ \Gamma_{f,2} = \partial\Omega \cap \partial\Omega_f \backslash \Gamma_{f,1}. \end{align*}
</p>
</li>
<li><p class="startli">域的其余部分， \(\Omega_s = \Omega \backslash \Omega_f\) 被一个固体占据，其变形场 \(\mathbf u\) 满足弹性方程， </p><p class="formulaDsp">
\begin{align*} -\nabla \cdot C \varepsilon(\mathbf u) = 0 \qquad\qquad &amp; \text{in}\ \Omega_s, \end{align*}
</p>
<p class="startli">其中 \(C\) 是等级4的弹性张量（我们将使用一个特别简单的形式，假设该固体是各向同性的）。 它在对沿固体边界流动的流体所施加的力的反应中发生变形。我们假设这种变形非常小，以至于它对流体没有反馈作用，也就是说，这种耦合只是在一个方向。为了简单起见，我们将假设固体的外部边界是被夹紧的，即 </p><p class="formulaDsp">
\begin{align*} \mathbf u = \mathbf 0 \qquad\qquad \text{on}\ \Gamma_{s,1} = \partial\Omega \cap \partial\Omega_s \end{align*}
</p>
</li>
<li><p class="startli">作为小位移假设的结果，我们将在流体和固体之间的界面上提出以下边界条件：首先，我们对流体没有滑移边界条件， </p><p class="formulaDsp">
\begin{align*} \mathbf v = \mathbf 0 \qquad\qquad \text{on}\ \Gamma_{i} = \partial\Omega_s \cap \partial\Omega_f. \end{align*}
</p>
<p class="startli">第二，固体上的力（牵引力）等于流体的法向应力， </p><p class="formulaDsp">
\begin{align*} (C \varepsilon(\mathbf u)) \mathbf n = (2 \eta \varepsilon(\mathbf v) - p \mathbf 1) \mathbf n \qquad\qquad \text{on}\ \Gamma_{i} = \partial\Omega_s \cap \partial\Omega_f, \end{align*}
</p>
<p class="startli">其中 \(\mathbf{n}\) 是 \(\Gamma_{i}\) 上从固体指向流体的法向量。</p>
</li>
</ul>
<p>通过遵循我们通常的规则，即从左边乘以一个测试函数并在域上进行积分，我们得到了这个问题的弱表述。然后它看起来像这样。找到 \(y = \{\mathbf v, p, \mathbf u\} \in Y \subset H^1(\Omega_f)^d \times L_2(\Omega_f) \times H^1(\Omega_s)^d\) ，使得</p>
<p class="formulaDsp">
\begin{align*} 2 \eta (\varepsilon(\mathbf a), \varepsilon(\mathbf v))_{\Omega_f} - (\nabla \cdot \mathbf a, p)_{\Omega_f} - (q, \nabla \cdot \mathbf v)_{\Omega_f} &amp; \\ + (\varepsilon(\mathbf b), C \varepsilon(\mathbf u))_{\Omega_s} &amp; \\ - (\mathbf b, (2 \eta \varepsilon(\mathbf v) - p \mathbf 1) \mathbf n)_{\Gamma_i} &amp;= 0, \end{align*}
</p>
<p>为所有测试函数 \(\mathbf a, q, \mathbf b\) ；第一、第二和第三行分别对应于流体、固体和界面贡献。注意， \(Y\) 只是上述空间的一个子空间，以适应各种迪里希特边界条件。</p>
<p>这种耦合当然可以通过简单地拥有两个Triangulation和两个DoFHandler对象来实现，两个子域各一个。另一方面，如果有一个知道整个问题离散化的单一DoFHandler对象，那么deal.II的使用就简单多了。</p>
<p>这个程序是关于如何实现这一点的。请注意，我们的目标并不是要提出一个特别有用的物理模型（一个现实的流体-结构相互作用模型必须考虑到固体的有限变形和它对流体的影响）：这毕竟只是一个旨在演示技术的教程程序，而不是为了解决实际问题。此外，我们将假设子域之间的界面与粗略的网格单元面对齐。</p>
<p><a class="anchor" id="Thegeneralidea"></a></p><h3>The general idea</h3>
<p>在讨论更多的细节之前，让我们先说明一个显而易见的问题：这是一个有多个求解变量的问题；为此，你可能想先阅读 <a class="el" href="group__vector__valued.html">Handling vector valued problems</a> 文件模块，它介绍了我们处理有多个求解变量问题的基本哲学框架。但回到手头的问题上。</p>
<p>在deal.II中实现这类问题的基本思路如下：在问题的表述中，速度和压力变量 \(\mathbf v, p\) 只存在于流体子域中 \(\Omega_f\) 。但我们假设将它们以零点扩展到整个域 \(\Omega\) （在一般情况下，这意味着它们沿 \(\Gamma_i\) 将是不连续的）。那么，对于这些变量来说，什么是合适的函数空间呢？我们知道在 \(\Omega_f\) 上我们应该要求 \(\mathbf v \in H^1(\Omega_f)^d, p \in L_2(\Omega_f)\) ，所以对于 \(\tilde{\mathbf v}, \tilde p\) 到整个领域的扩展，下面出现了一组有用的函数空间。</p>
<p class="formulaDsp">
\begin{align*} \tilde {\mathbf v} &amp;\in V = \{\tilde {\mathbf v}|_{\Omega_f} \in H^1(\Omega_f)^d, \quad \tilde {\mathbf v}|_{\Omega_s} = 0 \} \\ \tilde p &amp;\in P = \{\tilde p|_{\Omega_f} \in L_2(\Omega_f), \quad \tilde p|_{\Omega_s} = 0 \}. \end{align*}
</p>
<p>由于这对目前的讨论并不重要，我们在选择函数空间时省略了边界值的问题；这个问题也影响到我们是否可以为压力选择 \(L_2\) ，或者我们是否必须为压力选择空间 \(L_{2,0}(\Omega_f)=\{q\in L_2(\Omega_f): \int_{\Omega_f} q = 0\}\) 。不过，这些问题都与下面的讨论无关)。</p>
<p>请注意，这些确实是一个具有明显规范的线性函数空间。由于在实践中不可能发生混淆，因此我们将再次省略省略号，以表示一个函数对整个域的扩展，并简单地用 \(\mathbf v, p\) 指代原始函数和扩展函数。</p>
<p>对于离散化，我们需要 \(V, P\) 的有限维子空间 \(V_h,P_h\) 。对于斯托克斯，我们从 <a class="el" href="step_22.html">step-22</a> 中知道，适当的选择是 \(Q_{p+1}^d\times Q_P\) ，但这只适用于流体占据的那部分域。对于扩展场，让我们使用以下定义在三角形上的子空间 \(\mathbb T\) 。</p>
<p class="formulaDsp">
\begin{align*} V_h &amp;= \{{\mathbf v}_h \quad | \quad \forall K \in {\mathbb T}: {\mathbf v}_h|_K \in Q_{p+1}^d\ \text{if}\ K\subset {\Omega_f}, \quad {\mathbf v}_h|_{\Omega_f}\ \text{is continuous}, \quad {\mathbf v}_h|_K = 0\ \text{if}\ K\subset {\Omega_s}\} &amp;&amp; \subset V \\ P_h &amp;= \{ p_h \quad | \quad \forall K \in {\mathbb T}: p_h|_K \in Q_p\ \text{if}\ K\subset {\Omega_f}, \quad p_h|_{\Omega_f}\ \text{is continuous}, \quad p_h|_K = 0\ \text{if}\ K\subset {\Omega_s}\ \} &amp;&amp; \subset P. \end{align*}
</p>
<p>换句话说，在 \(\Omega_f\) 上，我们选择通常的离散空间，但我们保持（不连续的）扩展为零。要说明的是，我们现在需要一个描述在单元上为零的函数的有限元空间&amp;mdash；这就是FE_Nothing类的作用：它描述了一个恒定为零的函数的有限维函数空间。这个奇特的线性向量空间的一个特殊属性是它没有自由度：它不仅仅是有限维度的，它实际上是零维的，因此对于这种类型的对象， <a class="el" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">FiniteElement::n_dofs_per_cell()</a> 将返回零。为了下面的讨论，让我们给这个空间一个适当的符号。 </p><p class="formulaDsp">
\[ Z = \{ \varphi: \varphi(x)=0 \}. \]
</p>
<p> 符号 \(Z\) 提醒了这个空间的函数为零的事实。很明显，我们选择 \(Z_h=Z\) 。</p>
<p>对于我们用来描述弹性方程的变量，上面的整个讨论都可以重复。这里，对于扩展变量，我们有</p>
<p class="formulaDsp">
\begin{align*} \tilde {\mathbf u} &amp;\in U = \{\tilde {\mathbf u}|_{\Omega_s} \in H^1(\Omega_f)^d, \quad \tilde {\mathbf u}|_{\Omega_f} \in Z(\Omega_s)^d \}, \end{align*}
</p>
<p>而我们通常会使用这样的有限元空间</p>
<p class="formulaDsp">
\begin{align*} U_h &amp;= \{{\mathbf u}_h \quad | \quad \forall K \in {\mathbb T}: {\mathbf u}_h|_K \in Q_r^d\ \text{if}\ K\subset {\Omega_s}, \quad {\mathbf u}_h|_{\Omega_f}\ \text{is continuous}, \quad {\mathbf u}_h|_K \in Z^d\ \text{if}\ K\subset {\Omega_f}\} &amp;&amp; \subset U \end{align*}
</p>
<p>的多项式度数 \(r\) 。</p>
<p>所以总结起来，我们要在以下空间中寻找离散的矢量值解 \(y_h = \{\mathbf v_h, p_h, \mathbf u_h\}\) 。</p>
<p class="formulaDsp">
\begin{align*} Y_h = \{ &amp; y_h = \{\mathbf v_h, p_h, \mathbf u_h\} : \\ &amp; y_h|_{\Omega_f} \in Q_{p+1}^d \times Q_p \times Z^d, \\ &amp; y_h|_{\Omega_s} \in Z^d \times Z \times Q_r^d \}. \end{align*}
</p>
<p><a class="anchor" id="Implementation"></a></p><h3>Implementation</h3>
<p>那么，我们如何实现这种事情呢？首先，我们意识到离散空间 \(Y_h\) 本质上需要两个不同的有限元。首先，在流体子域上，我们需要元素 \(Q_{p+1}^d \times Q_p \times Z^d\) ，这在deal.II中很容易实现，即</p>
<div class="fragment"><div class="line"><a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a> (<a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>(p+1), dim,</div>
<div class="line">               <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>(p), 1,</div>
<div class="line">               <a class="code" href="classFE__Nothing.html">FE_Nothing&lt;dim&gt;</a>(), dim),</div>
<div class="ttc" id="aclassFESystem_html"><div class="ttname"><a href="classFESystem.html">FESystem</a></div><div class="ttdef"><b>Definition:</b> <a href="fe__system_8h_source.html#l00215">fe_system.h:216</a></div></div>
<div class="ttc" id="aclassFE__Nothing_html"><div class="ttname"><a href="classFE__Nothing.html">FE_Nothing</a></div><div class="ttdef"><b>Definition:</b> <a href="fe__nothing_8h_source.html#l00129">fe_nothing.h:130</a></div></div>
<div class="ttc" id="aclassFE__Q_html"><div class="ttname"><a href="classFE__Q.html">FE_Q</a></div><div class="ttdef"><b>Definition:</b> <a href="fe__q_8h_source.html#l00548">fe_q.h:549</a></div></div>
</div><!-- fragment --><p>其中 <code><a class="el" href="classFE__Nothing.html">FE_Nothing</a></code> 实现了永远为零的函数空间。第二，在实体子域上，我们需要元素 \(\in Z^d \times Z \times Q_r^d\) ，我们用</p><div class="fragment"><div class="line"><a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a> (<a class="code" href="classFE__Nothing.html">FE_Nothing&lt;dim&gt;</a>(), dim,</div>
<div class="line">               <a class="code" href="classFE__Nothing.html">FE_Nothing&lt;dim&gt;</a>(), 1,</div>
<div class="line">               <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>(r), dim),</div>
</div><!-- fragment --><p>得到它。</p>
<div class="fragment"><div class="line"><a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a> (<a class="code" href="classFE__Nothing.html">FE_Nothing&lt;dim&gt;</a>(), dim,</div>
<div class="line">               <a class="code" href="classFE__Nothing.html">FE_Nothing&lt;dim&gt;</a>(), 1,</div>
<div class="line">               <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>(r), dim),</div>
</div><!-- fragment --><p>下一步是，我们将这两个元素分别与占据两个子域的单元相关联。为此，我们认识到，从某种意义上说，这两个元素只是彼此的变化，因为它们具有相同数量的向量分量，但具有不同的多项式度数&amp;mdash；这听起来非常像 \(hp\) 有限元方法中的做法，这也正是我们在这里要做的：我们将（ab）使用hp-namespace的类和设施，将不同的元素分配给不同的单元。换句话说，我们将使用 <a class="el" href="classhp_1_1FECollection.html">hp::FECollection</a>, 中的两个有限元与适当的 <a class="el" href="classhp_1_1QCollection.html">hp::QCollection</a> 集成，使用 <a class="el" href="classhp_1_1FEValues.html">hp::FEValues</a> 对象，而我们的DoFHandler将处于<em>hp</em>模式。你不妨看看 <a class="el" href="step_27.html">step-27</a> ，了解所有这些概念的概况。</p>
<p>在继续描述测试案例之前，让我们先澄清一下<em>why</em>这种将函数以0扩展到整个领域，然后将问题映射到hp-framework上的方法是有意义的。</p>
<ul>
<li>它使事情变得统一。在所有单元上，向量分量的数量是相同的（这里是 <code>2*dim+1</code> ）。这使得各种事情都成为可能，因为统一的描述允许代码的重复使用。例如，计算每个向量分量的自由度 (<a class="el" href="namespaceDoFTools.html#a956ac5c6aab03ec1c04f1ad955301db9">DoFTools::count_dofs_per_fe_component</a>), 按分量对自由度进行排序 (<a class="el" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>), ，随后将矩阵和向量分割成块，以及其他许多函数都能像以前一样工作，而不需要给它们添加特殊的逻辑，描述某些变量只存在于部分域的情况。因此，你在像现在这样的程序中已经有了各种工具，这些工具最初并不是为多物理场情况编写的，但在目前的情况下却能正常工作。</li>
<li>它允许简单的图形化输出。我们支持的所有图形输出格式都要求输出中的每个字段都定义在网格的所有节点上。但是考虑到现在所有的解决方案组件都存在于各个地方，我们现有的DataOut例程可以像以前一样工作，并产生适合于可视化的图形输出&ndash;这些字段将简单地被扩展为0，如果不需要，可视化程序可以很容易地过滤掉这个值。</li>
<li>基本上没有任何成本。FE_Nothing的技巧并没有给整个问题增加任何自由度，我们也不需要处理属于这些分量的形状函数&amp;mdash；FE_Nothing没有自由度，也没有形状函数，它所做的只是占用矢量分量。</li>
</ul>
<p><a class="anchor" id="Specificsoftheimplementation"></a></p><h3>Specifics of the implementation </h3>
<p>更具体地说，在程序中我们要解决以下几点。</p>
<ul>
<li>实现双线性形式，特别是处理界面项，包括矩阵和稀疏模式。</li>
<li>在边界的外部和内部部分实现迪里希特边界条件 \(\partial\Omega_f,\partial\Omega_s\) 。</li>
</ul>
<p><a class="anchor" id="Dealingwiththeinterfaceterms"></a></p><h4>Dealing with the interface terms</h4>
<p>让我们首先讨论实现双线性形式，在离散水平上，我们记得它是</p>
<p class="formulaDsp">
\begin{align*} 2 \eta (\varepsilon(\mathbf a_h), \varepsilon(\mathbf v_h))_{\Omega_f} - (\nabla \cdot \mathbf a_h, p_h)_{\Omega_f} - (q_h, \nabla \cdot \mathbf v_h)_{\Omega_f} &amp; \\ + (\varepsilon(\mathbf b_h), C \varepsilon(\mathbf u_h))_{\Omega_s} &amp; \\ - (\mathbf b_h, (2 \eta \varepsilon(\mathbf v_h) - p \mathbf 1) \mathbf n)_{\Gamma_i} &amp;= 0, \end{align*}
</p>
<p>鉴于我们已经将场扩展为零，原则上我们可以将子域上的积分写成整个域 \(\Omega\) ，尽管在决定哪些项要积分之前，首先询问一个单元是弹性区域还是流体区域的一部分，这几乎没有什么额外的努力。实际上，对这些项进行积分并不十分困难；对于斯托克斯方程，相关步骤已在 <a class="el" href="step_22.html">step-22</a> 中显示，而对于弹性方程，我们基本上采取 <a class="el" href="group__vector__valued.html">Handling vector valued problems</a> 模块中的形式（而不是 <a class="el" href="step_8.html">step-8</a> 中的形式）。</p>
<p>更感兴趣的是界面项， </p><p class="formulaDsp">
\[ -(\mathbf b_h, (2 \eta \varepsilon(\mathbf v_h) - p \mathbf 1) \mathbf n)_{\Gamma_i}. \]
</p>
<p> 基于我们的假设，即界面 \(\Gamma_i\) 与细胞边界重合，这实际上可以写成一组面积分。如果我们用提取器符号 \(\psi_i[\mathbf v],\psi_i[p], \psi_i[\mathbf u]\) 表示形状函数 \(\psi_i\in Y_h\) 的速度、压力和位移分量，那么上面的项对全局矩阵项 \(i,j\) 的贡献如下： </p><p class="formulaDsp">
\[ -\sum_K (\psi_i[\mathbf u], (2 \eta \varepsilon(\psi_j[\mathbf v]) - \psi_j[p] \mathbf 1) \mathbf n)_{\partial K \cap \Gamma_i}. \]
</p>
<p> 虽然不是很明显，但这个项有一个小小的复杂化：虽然 \(\psi_i[\mathbf u]\) ]和 \(\mathbf n\) 是在界面的实体侧评估的（它们分别是位移和法向量 \(\Omega_s\) 的测试函数，我们需要在界面的流体侧评估 \(\psi_j[\mathbf v],\psi_j[p]\) ，因为它们对应于流体施加的应力/力。换句话说，在我们的实现中，我们将需要界面两边的FEFaceValue对象。让事情变得更糟糕的是，我们可能还必须处理这样一个事实，即一方或另一方可能被细化，使我们需要在一个面的部分区域进行整合。看看下面的实现，看看如何处理这个问题。</p>
<p>作为一个额外的复杂因素，这个项产生的矩阵条目需要以某种方式添加到矩阵的稀疏模式中。这是DoFTools命名空间中各种函数的领域，比如 <a class="el" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a> 和 <a class="el" href="group__constraints.html#ga7b2627e9bde96b98d4fcf95b629e4fd4">DoFTools::make_flux_sparsity_pattern</a>. 本质上，这些函数所做的是模拟系统矩阵装配过程中发生的事情：每当装配将非零条目写入全局矩阵，DoFTools中的函数将添加一个条目到稀疏模式中。因此，我们可以这样做：让 <a class="el" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a> 将所有由常规的逐格积分产生的条目添加到稀疏性模式中，然后用手做同样的事情，即由接口项产生的条目。如果你看一下下面的程序中界面积分的实现，那么如何做应该是显而易见的，最多只需要不超过100行的代码。</p>
<p>但我们是懒人：界面项是沿一个面的两个相邻单元的自由度的耦合，这正是人们在非连续Galerkin方案中要做的事情，函数 <a class="el" href="group__constraints.html#ga7b2627e9bde96b98d4fcf95b629e4fd4">DoFTools::make_flux_sparsity_pattern</a> 就是为这种方案而写的。与通常的 <a class="el" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>: 相比，这是一个矩阵条目的超集，它还将添加所有计算来自所有面的两侧自由度耦合项的条目。不幸的是，对于这个函数的最简单版本，这是一个相当大的超集。例如，考虑以下有两个单元和一个 \(Q_1\) 有限元的网格。</p>
<div class="fragment"><div class="line">2---3---5</div>
<div class="line">|   |   |</div>
<div class="line">0---1---4</div>
</div><!-- fragment --><p>这里，由 <a class="el" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a> 产生的稀疏模式将只有在单元上耦合的自由度的条目。然而，它不会有稀疏模式条目 \((0,4),(0,5),(2,4),(2,5)\) 。然而，由 <a class="el" href="group__constraints.html#ga7b2627e9bde96b98d4fcf95b629e4fd4">DoFTools::make_flux_sparsity_pattern</a> 产生的稀疏模式将有这些条目：它假定你想为一个双线性形式建立一个稀疏模式，该形式将<em>all</em>自由度从相邻的单元中耦合起来。这不是我们想要的：我们的界面项只作用于一小部分单元，我们当然不需要两个相邻流体单元或两个相邻固体单元之间的所有额外耦合。此外，我们使用高阶元素的事实意味着我们确实会产生比实际需要多得多的条目：在最粗的网格上，在2D中，44,207个非零条目而不是16,635个 <a class="el" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>, ，导致我们后来建立的矩阵中出现大量的零（当然，16,635是不够的，因为它们不包括界面条目）。这个比例在三维中会更糟糕。</p>
<p>所以极度懒惰是有代价的：矩阵中的条目太多。但我们可以适度偷懒：有一个 <a class="el" href="group__constraints.html#ga7b2627e9bde96b98d4fcf95b629e4fd4">DoFTools::make_flux_sparsity_pattern</a> 的变种，允许我们指定有限元的哪些矢量分量与哪些其他分量相耦合，既可以是单元，也可以是面。对于处于实体子域中的单元，我们将所有位移相互耦合；对于流体单元，所有速度与所有速度和压力耦合，但压力不与自身耦合。由于没有一个单元同时拥有两组变量，所以没有必要区分这两种单元，所以我们可以这样写掩码。</p>
<div class="fragment"><div class="line"><a class="code" href="classTable.html">Table&lt;2,DoFTools::Coupling&gt;</a> cell_coupling (fe_collection.n_components(),</div>
<div class="line">                                           fe_collection.n_components());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c=0; c&lt;fe_collection.n_components(); ++c)</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>=0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>&lt;fe_collection.n_components(); ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div>
<div class="line">    <span class="keywordflow">if</span> (((c&lt;dim+1) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>&lt;dim+1)</div>
<div class="line">         &amp;&amp; !((c==dim) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>==dim)))</div>
<div class="line">        ||</div>
<div class="line">        ((c&gt;=dim+1) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>&gt;=dim+1)))</div>
<div class="line">      cell_coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::Coupling::always</a>;</div>
<div class="ttc" id="aclassTable_html"><div class="ttname"><a href="classTable.html">Table</a></div><div class="ttdef"><b>Definition:</b> <a href="table_8h_source.html#l00666">table.h:667</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec"><div class="ttname"><a href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a></div><div class="ttdeci">@ always</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools_8h_source.html#l00235">dof_tools.h:235</a></div></div>
<div class="ttc" id="anamespacePhysics_1_1Elasticity_1_1Kinematics_html_a15728437b942dab0b0042eb06a407d2c"><div class="ttname"><a href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">Physics::Elasticity::Kinematics::d</a></div><div class="ttdeci">SymmetricTensor&lt; 2, dim, Number &gt; d(const Tensor&lt; 2, dim, Number &gt; &amp;F, const Tensor&lt; 2, dim, Number &gt; &amp;dF_dt)</div></div>
</div><!-- fragment --><p>这里，我们利用了这样一个事实：有限元的第一个 <code>dim</code> 分量是速度，然后是压力，最后是 <code>dim</code> 位移。(我们也可以说，速度/压力也与位移耦合，因为没有一个单元同时拥有两组变量)。另一方面，界面条款需要一个像这样的掩码。</p>
<div class="fragment"><div class="line"><a class="code" href="classTable.html">Table&lt;2,DoFTools::Coupling&gt;</a> face_coupling (fe_collection.n_components(),</div>
<div class="line">                                           fe_collection.n_components());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c=0; c&lt;fe_collection.n_components(); ++c)</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>=0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>&lt;fe_collection.n_components(); ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div>
<div class="line">    <span class="keywordflow">if</span> ((c&gt;=dim+1) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>&lt;dim+1))</div>
<div class="line">      face_coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::Coupling::always</a>;</div>
</div><!-- fragment --><p>换句话说，所有位移测试函数（组件 <code>c&gt;=dim+1</code> ）与界面另一侧的所有速度和压力形状函数耦合。这并不完全正确，尽管很接近：事实上，界面的确切形式仅指那些在共同界面上确实为非零的压力位移形状函数，这对所有形状函数来说并不正确；另一方面，它确实耦合了所有速度（因为积分涉及速度形状函数的梯度，这些梯度在单元的所有面上均为非零）。然而，我们在上面建立的掩码，并不具备这些微妙的能力。尽管如此，通过这些掩码，我们设法将稀疏模式的条目数降低到21028个&mdash;目前来说已经足够了。</p>
<p><a class="anchor" id="Velocityboundaryconditionsontheinterface"></a></p><h4>Velocity boundary conditions on the interface</h4>
<p>第二个困难是，虽然我们知道如何在外部边界上强制执行速度或应力为零（使用 <a class="el" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>, 调用适当的分量掩码，并为固体和流体外部边界设置不同的边界指标），但我们现在也需要在内部界面上的速度为零，即 \(\mathbf v|_{\Gamma_i}=0\) 。在写这篇文章时，deal.II中没有处理这部分的函数，但用手实现并不特别困难：基本上，我们只需要在所有单元上循环，如果它是一个流体单元，而它的邻居是一个固体单元，然后添加约束，确保这个面上的速度自由度是零。在处理相邻的固体单元被细化的情况下，需要注意一些问题，产生的代码如下。</p>
<div class="fragment"><div class="line">std::vector&lt;unsigned int&gt; local_face_dof_indices (stokes_fe.dofs_per_face);</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell: dof_handler.active_cell_iterators())</div>
<div class="line">  <span class="keywordflow">if</span> (cell_is_in_fluid_domain (cell))</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> f : cell-&gt;face_indices())</div>
<div class="line">      <span class="keywordflow">if</span> (!cell-&gt;at_boundary(f))</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordtype">bool</span> face_is_on_interface = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">if</span> ((cell-&gt;neighbor(f)-&gt;has_children() == <span class="keyword">false</span>)</div>
<div class="line">                  &amp;&amp;</div>
<div class="line">                  (cell_is_in_solid_domain (cell-&gt;neighbor(f))))</div>
<div class="line">                face_is_on_interface = <span class="keyword">true</span>;</div>
<div class="line">          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cell-&gt;neighbor(f)-&gt;has_children() == <span class="keyword">true</span>)</div>
<div class="line">                {</div>
<div class="line">              <span class="comment">// The neighbor does have children. See if any of the cells</span></div>
<div class="line">              <span class="comment">// on the other side are elastic</span></div>
<div class="line">                  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sf=0; sf&lt;cell-&gt;face(f)-&gt;n_children(); ++sf)</div>
<div class="line">                    <span class="keywordflow">if</span> (cell_is_in_solid_domain (cell-&gt;neighbor_child_on_subface(f, sf)))</div>
<div class="line">                      {</div>
<div class="line">                   face_is_on_interface = <span class="keyword">true</span>;</div>
<div class="line">                            <span class="keywordflow">break</span>;</div>
<div class="line">                      }</div>
<div class="line">                }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">if</span> (face_is_on_interface)</div>
<div class="line">           {</div>
<div class="line">             cell-&gt;face(f)-&gt;get_dof_indices (local_face_dof_indices, 0);</div>
<div class="line">             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;local_face_dof_indices.size(); ++i)</div>
<div class="line">             <span class="keywordflow">if</span> (stokes_fe.face_system_to_component_index(i).first &lt; dim)</div>
<div class="line">               constraints.add_line (local_face_dof_indices[i]);</div>
<div class="line">           }</div>
<div class="line">        }</div>
</div><!-- fragment --><p>调用 <code>constraints.add_line(t)</code> 告诉AffineConstraints为自由度 <code>t</code> 启动一个新的约束，其形式为 \(x_t=\sum_{l=0}^{N-1} c_{tl} x_l + b_t\) 。通常情况下，我们会将单个系数 \(c_{tl}\) 设置为非零值（使用 <a class="el" href="classAffineConstraints.html#a2b7756e9cb8e53553211add5426f8e50">AffineConstraints::add_entry</a>) 或将 \(b_t\) 设置为非零值（使用 <a class="el" href="classAffineConstraints.html#a4f7cb22b3c971599a839fddc988ef92a">AffineConstraints::set_inhomogeneity</a>); 像上面那样什么都不做，看起来很有趣，只是让约束成为 \(x_t=0\) ，这正是我们在当前情况下需要的。对 <a class="el" href="classFiniteElement.html#acba0deae067f2cebed8497f22f888edb">FiniteElement::face_system_to_component_index</a> 的调用确保了我们只将速度分量的边界值设置为零，而不是压力分量。</p>
<p>请注意，在有些情况下，这可能会产生不正确的结果：特别是，一旦我们找到当前流体单元的一个实体邻接子，我们就会认为共同面上的所有邻接子都在实体子域中。但事实并非如此，例如，考虑以下的网格。</p>
<div class="fragment"><div class="line">+---------+----+----+</div>
<div class="line">|         | f  |    |</div>
<div class="line">|    f    +----+----+</div>
<div class="line">|         | s  |    |</div>
<div class="line">+---------+----+----+</div>
</div><!-- fragment --><p>在这种情况下，我们会将左单元右面的所有速度自由度设置为零，这对该面的顶部自由度来说是不正确的。也就是说，只有当流体和固体子域不与一组完整的粗网格单元重合时才会发生这种情况&mdash;但这与本介绍第一节末尾所述的假设相矛盾。</p>
<p><a class="anchor" id="Thetestcase"></a></p><h3>The testcase</h3>
<p>我们将考虑以下情况作为一个测试案例。</p>
<p><img src="https://www.dealii.org/images/steps/developer/step-46.layout.png" alt="" class="inline"/> <br  />
</p>
<p>正如本文顶部所讨论的，我们需要在一些地方假设一个单元完全处于域的流体部分或固体部分，此外，一个不活动单元的所有子域也属于同一个子域。如果粗略网格已经将网格细分为固体和流体粗略网格单元，这一点肯定可以得到保证；考虑到上面概述的几何形状，我们可以通过使用 \(8\times 8\) 粗略网格，方便地提供 <a class="el" href="namespaceGridGenerator.html#ac76417d7404b75cf53c732f456e6e971">GridGenerator::subdivided_hyper_rectangle</a> 函数来实现。</p>
<p>底部的固定边界意味着 \(\mathbf u=0\) ，我们也为顶部的流动规定了迪里希特条件，因此我们在左边得到流入，在右边得到流出。在左边和右边的边界，没有对流动施加明确的边界条件，产生隐含的无应力条件 \((2\eta \varepsilon(\mathbf v) - p \mathbf 1) \cdot \mathbf n = 0\) 。上面已经讨论了两个域之间的界面条件。</p>
<p>为了简单起见，我们选择材料参数为 \(\eta=\lambda=\mu=1\) 。在下面的结果部分，我们还将展示一个可以从同一程序中获得的三维模拟。边界条件和几何形状的定义几乎与上面的2d情况类似。</p>
<p><a class="anchor" id="Identifyingwhichsubdomainacellisin"></a></p><h4>Identifying which subdomain a cell is in</h4>
<p>在程序中，我们需要一种方法来识别一个单元所处的域的哪一部分。有许多不同的方法可以做到这一点。一个典型的方法是使用每个单元的 <a class="el" href="DEALGlossary.html#GlossSubdomainId">subdomain_id </a>标签，尽管这个字段在并行计算中具有特殊意义。另一种方法是 <a class="el" href="DEALGlossary.html#GlossMaterialId">material_id </a>字段，也是每个单元格都有的。它有一个额外的优点，即在网格细化时，它可以从母体继承到子体；换句话说，我们在创建网格时设置一次材料ID，即使经过几次细化循环，它对所有活动单元都是正确的。因此，我们采用这种方法：我们定义一个 <code>enum</code> ，用符号名称来表示material_id数字，并将用它们来识别一个单元在域的哪一部分。</p>
<p>其次，我们使用一个在<em>hp</em>模式下操作的DoFHandler类型的对象。该类需要知道哪些单元将使用斯托克斯有限元，哪些使用弹性有限元。因此，在每个细化周期的开始，我们必须走过所有的单元，并将（在hp-parlance中）活动FE索引设置为任何适合当前情况的索引。虽然我们可以使用符号名称来表示材料ID，但实际上主动FE索引是一个数字，经常用于索引对象的集合（例如 <a class="el" href="classhp_1_1FECollection.html">hp::FECollection</a> 和 <a class="el" href="classhp_1_1QCollection.html">hp::QCollection</a>); 类型，这意味着主动FE索引实际上必须对流体部分的数值为0，对领域的弹性部分为1。</p>
<p><a class="anchor" id="Linearsolvers"></a></p><h4>Linear solvers</h4>
<p>这个程序主要是为了展示如何处理域的不同部分的不同物理现象，以及如何在deal.II中实现这样的模型。因此，我们不会费力想出一个好的求解器：我们只是使用SparseDirectUMFPACK类，它总是有效的，即使不是以最佳的复杂性。然而，我们将在<a href="#Results">results</a>部分对可能的其他求解器进行评论。</p>
<p><a class="anchor" id="Meshrefinement"></a></p><h4>Mesh refinement</h4>
<p>这个程序的一个比较棘手的方面是如何估计误差。因为它几乎适用于任何程序，所以我们想使用KellyErrorEstimator，在这里我们也可以用下面这样的代码相对容易地做到。</p>
<div class="fragment"><div class="line"><a class="code" href="classVector.html">Vector&lt;float&gt;</a> stokes_estimated_error_per_cell (<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells());</div>
<div class="line"><a class="code" href="classVector.html">Vector&lt;float&gt;</a> elasticity_estimated_error_per_cell (<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">std::vector&lt;bool&gt; stokes_component_mask (dim+1+dim, <span class="keyword">false</span>);</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>=0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>&lt;dim; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div>
<div class="line">  stokes_component_mask[<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <span class="keyword">true</span>;</div>
<div class="line"><a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a> (dof_handler,</div>
<div class="line">                                    face_q_collection,</div>
<div class="line">                                    std::map&lt;<a class="code" href="namespacetypes.html#aed8813fee8c8a2edcc6005e6a48c321a">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a>*&gt;(),</div>
<div class="line">                                    solution,</div>
<div class="line">                                    stokes_estimated_error_per_cell,</div>
<div class="line">                                    stokes_component_mask);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">std::vector&lt;bool&gt; elasticity_component_mask (dim+1+dim, <span class="keyword">false</span>);</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>=0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>&lt;dim; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div>
<div class="line">  elasticity_component_mask[dim+1+<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <span class="keyword">true</span>;</div>
<div class="line"><a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a> (dof_handler,</div>
<div class="line">                                    face_q_collection,</div>
<div class="line">                                    std::map&lt;<a class="code" href="namespacetypes.html#aed8813fee8c8a2edcc6005e6a48c321a">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a>*&gt;(),</div>
<div class="line">                                    solution,</div>
<div class="line">                                    elasticity_estimated_error_per_cell,</div>
<div class="line">                                    elasticity_component_mask);</div>
<div class="ttc" id="aclassFunction_html"><div class="ttname"><a href="classFunction.html">Function</a></div><div class="ttdef"><b>Definition:</b> <a href="function_8h_source.html#l00150">function.h:153</a></div></div>
<div class="ttc" id="aclassKellyErrorEstimator_html_aa0917e696d4f8ddb983223a68c512357"><div class="ttname"><a href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator::estimate</a></div><div class="ttdeci">static void estimate(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const Quadrature&lt; dim - 1 &gt; &amp;quadrature, const std::map&lt; types::boundary_id, const Function&lt; spacedim, typename InputVector::value_type &gt; * &gt; &amp;neumann_bc, const InputVector &amp;solution, Vector&lt; float &gt; &amp;error, const ComponentMask &amp;component_mask=ComponentMask(), const Function&lt; spacedim &gt; *coefficients=nullptr, const unsigned int n_threads=numbers::invalid_unsigned_int, const types::subdomain_id subdomain_id=numbers::invalid_subdomain_id, const types::material_id material_id=numbers::invalid_material_id, const Strategy strategy=cell_diameter_over_24)</div></div>
<div class="ttc" id="aclassVector_html"><div class="ttname"><a href="classVector.html">Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="vector_8h_source.html#l00109">vector.h:110</a></div></div>
<div class="ttc" id="anamespacetypes_html_aed8813fee8c8a2edcc6005e6a48c321a"><div class="ttname"><a href="namespacetypes.html#aed8813fee8c8a2edcc6005e6a48c321a">types::boundary_id</a></div><div class="ttdeci">unsigned int boundary_id</div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00129">types.h:129</a></div></div>
<div class="ttc" id="ap4est__wrappers_8cc_html_ace00f2f80d9780ef9aa1007e1c22c6a4"><div class="ttname"><a href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a></div><div class="ttdeci">const ::parallel::distributed::Triangulation&lt; dim, spacedim &gt; * triangulation</div><div class="ttdef"><b>Definition:</b> <a href="p4est__wrappers_8cc_source.html#l00069">p4est_wrappers.cc:69</a></div></div>
</div><!-- fragment --><p>这就为每个单元格提供了两套误差指标。然后，我们将以某种方式将它们合并为一个网格细化，例如使用如下代码（注意，我们将两个向量中的平方误差指标归一化，因为误差量的物理单位在当前情况下并不匹配，导致两个子域之间的误差指标可能有数量级的差异）。</p>
<div class="fragment"><div class="line">stokes_estimated_error_per_cell /= stokes_estimated_error_per_cell.l2_norm();</div>
<div class="line">elasticity_estimated_error_per_cell /= elasticity_estimated_error_per_cell.l2_norm();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell (<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells());</div>
<div class="line">estimated_error_per_cell += stokes_estimated_error_per_cell;</div>
<div class="line">estimated_error_per_cell += elasticity_estimated_error_per_cell;</div>
</div><!-- fragment --><p>(在代码中，我们实际上以4:1的比例权衡误差指标，有利于在斯托克斯子域上计算的误差指标，因为细化在其他方面严重偏向弹性子域，但这只是一个技术问题。因素4已经被启发式地确定为合理的工作。)</p>
<p>虽然这个原则是合理的，但它并不完全像预期的那样工作。原因是KellyErrorEstimator类是通过整合每个单元面周围的解的梯度跳跃来计算误差指标。这个跳跃在解不连续和扩展为零的位置可能非常大；它也不会随着网格的细化而变小。KellyErrorEstimator类不能忽视这个接口，因为它基本上只看到<em>hp</em>模式下的DoFHandler，其中元素类型从一个单元改变到另一个单元&amp;mdash；正是<em>hp</em>模式所设计的东西，当前程序中的接口看起来与 <a class="el" href="step_27.html">step-27</a> 中的接口没有区别，例如，当然也不乏合法性。尽管如此，最终的结果是，在两个子域之间的界面两侧都有一层单元，其误差指标大得不合理。因此，大部分的网格细化工作都集中在界面上。</p>
<p>如果我们有一个真正了解问题的细化指标，在积分跳跃项时简单地忽略子域之间的界面，这种情况显然不会发生。另一方面，这个程序是关于展示如何表示我们在不同子域有不同物理学的问题，而不是关于KellyErrorEstimator的特殊性，因此我们求助于被称为 "启发式 "的大锤子：我们简单地将界面上的单元的误差指标设置为零。这就切断了误差指标中的尖峰。乍看之下，人们也会认为它阻止了网格在界面上的细化，但是相邻的单元只能有一级细化的要求，仍然会导致一个合理的细化网格。</p>
<p>虽然这显然是一个次优的解决方案，但它目前是可行的，并为未来的改进留下了空间。<a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p><a class="anchor" id="Includefiles"></a> </p><h3>Include files</h3>
<p>这个程序的包含文件与之前许多其他程序的包含文件相同。唯一的新文件是在介绍中讨论的声明FE_Nothing的文件。hp目录下的文件已经在 <a class="el" href="step_27.html">step-27</a> 中讨论过了。</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparse__matrix_8h.html">deal.II/lac/sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparse__direct_8h.html">deal.II/lac/sparse_direct.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__nothing_8h.html">deal.II/fe/fe_nothing.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__collection_8h.html">deal.II/hp/fe_collection.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="hp_2fe__values_8h.html">deal.II/hp/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>Step46</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="ttc" id="aaffine__constraints_8h_html"><div class="ttname"><a href="affine__constraints_8h.html">affine_constraints.h</a></div></div>
<div class="ttc" id="adof__tools_8h_html"><div class="ttname"><a href="dof__tools_8h.html">dof_tools.h</a></div></div>
<div class="ttc" id="aerror__estimator_8h_html"><div class="ttname"><a href="error__estimator_8h.html">error_estimator.h</a></div></div>
<div class="ttc" id="afe_2fe__values_8h_html"><div class="ttname"><a href="fe_2fe__values_8h.html">fe_values.h</a></div></div>
<div class="ttc" id="afe__collection_8h_html"><div class="ttname"><a href="fe__collection_8h.html">fe_collection.h</a></div></div>
<div class="ttc" id="afe__nothing_8h_html"><div class="ttname"><a href="fe__nothing_8h.html">fe_nothing.h</a></div></div>
<div class="ttc" id="afe__q_8h_html"><div class="ttname"><a href="fe__q_8h.html">fe_q.h</a></div></div>
<div class="ttc" id="afe__system_8h_html"><div class="ttname"><a href="fe__system_8h.html">fe_system.h</a></div></div>
<div class="ttc" id="afull__matrix_8h_html"><div class="ttname"><a href="full__matrix_8h.html">full_matrix.h</a></div></div>
<div class="ttc" id="afunction_8h_html"><div class="ttname"><a href="function_8h.html">function.h</a></div></div>
<div class="ttc" id="agrid_2grid__refinement_8h_html"><div class="ttname"><a href="grid_2grid__refinement_8h.html">grid_refinement.h</a></div></div>
<div class="ttc" id="agrid_2tria_8h_html"><div class="ttname"><a href="grid_2tria_8h.html">tria.h</a></div></div>
<div class="ttc" id="agrid__generator_8h_html"><div class="ttname"><a href="grid__generator_8h.html">grid_generator.h</a></div></div>
<div class="ttc" id="ahp_2fe__values_8h_html"><div class="ttname"><a href="hp_2fe__values_8h.html">fe_values.h</a></div></div>
<div class="ttc" id="ainclude_2deal_8II_2base_2utilities_8h_html"><div class="ttname"><a href="include_2deal_8II_2base_2utilities_8h.html">utilities.h</a></div></div>
<div class="ttc" id="alogstream_8h_html"><div class="ttname"><a href="logstream_8h.html">logstream.h</a></div></div>
<div class="ttc" id="anamespacedealii_html"><div class="ttname"><a href="namespacedealii.html">dealii</a></div><div class="ttdef"><b>Definition:</b> <a href="namespace__dealii_8h_source.html#l00025">namespace_dealii.h:26</a></div></div>
<div class="ttc" id="anumerics_2data__out_8h_html"><div class="ttname"><a href="numerics_2data__out_8h.html">data_out.h</a></div></div>
<div class="ttc" id="aquadrature__lib_8h_html"><div class="ttname"><a href="quadrature__lib_8h.html">quadrature_lib.h</a></div></div>
<div class="ttc" id="asparse__direct_8h_html"><div class="ttname"><a href="sparse__direct_8h.html">sparse_direct.h</a></div></div>
<div class="ttc" id="asparse__matrix_8h_html"><div class="ttname"><a href="sparse__matrix_8h.html">sparse_matrix.h</a></div></div>
<div class="ttc" id="avector_8h_html"><div class="ttname"><a href="vector_8h.html">vector.h</a></div></div>
<div class="ttc" id="avector__tools_8h_html"><div class="ttname"><a href="vector__tools_8h.html">vector_tools.h</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeFluidStructureProblemcodeclasstemplate"></a> </p><h3>The <code>FluidStructureProblem</code> class template</h3>
<p>这是主类。如果你想的话，它是 <a class="el" href="step_8.html">step-8</a> 和 <a class="el" href="step_22.html">step-22</a> 的组合，因为它的成员变量要么针对全局问题（Triangulation和DoFHandler对象，以及 <a class="el" href="classhp_1_1FECollection.html">hp::FECollection</a> 和各种线性代数对象），要么与弹性或斯托克斯子问题有关。然而，该类的一般结构与其他大多数实现静止问题的程序一样。 <br  />
</p>
<p>有几个不言自明的辅助函数（<code>cell_is_in_fluid_domain, cell_is_in_solid_domain</code>）（对两个子域的符号名称进行操作，这些符号名称将被用作属于子域的单元的 material_ids。正如介绍中所解释的那样）和几个函数（<code>make_grid, set_active_fe_indices, assemble_interface_terms</code>），这些函数已经从其他函数中分离出来，可以在其他许多教程程序中找到，我们将在实现它们时讨论。 <br  />
</p>
<p>最后一组变量（ <code>viscosity, lambda, eta</code> ）描述了用于两个物理模型的材料属性。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>FluidStructureProblem</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  FluidStructureProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> stokes_degree,</div>
<div class="line">                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> elasticity_degree);</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keyword">enum</span></div>
<div class="line">  {</div>
<div class="line">    fluid_domain_id,</div>
<div class="line">    solid_domain_id</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">bool</span> cell_is_in_fluid_domain(</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler&lt;dim&gt;::cell_iterator</a> &amp;cell);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">bool</span> cell_is_in_solid_domain(</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler&lt;dim&gt;::cell_iterator</a> &amp;cell);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> make_grid();</div>
<div class="line">  <span class="keywordtype">void</span> set_active_fe_indices();</div>
<div class="line">  <span class="keywordtype">void</span> setup_dofs();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_system();</div>
<div class="line">  <span class="keywordtype">void</span> assemble_interface_term(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEFaceValuesBase.html">FEFaceValuesBase&lt;dim&gt;</a> &amp;         elasticity_fe_face_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEFaceValuesBase.html">FEFaceValuesBase&lt;dim&gt;</a> &amp;         stokes_fe_face_values,</div>
<div class="line">    std::vector&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;         elasticity_phi,</div>
<div class="line">    std::vector&lt;<a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a>&gt; &amp;stokes_symgrad_phi_u,</div>
<div class="line">    std::vector&lt;double&gt; &amp;                 stokes_phi_p,</div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> &amp;                  local_interface_matrix) <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">void</span> solve();</div>
<div class="line">  <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle) <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">void</span> refine_mesh();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> stokes_degree;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> elasticity_degree;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>    <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div>
<div class="line">  <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>         stokes_fe;</div>
<div class="line">  <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>         elasticity_fe;</div>
<div class="line">  <a class="code" href="classhp_1_1FECollection.html">hp::FECollection&lt;dim&gt;</a> fe_collection;</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>       dof_handler;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      sparsity_pattern;</div>
<div class="line">  <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> solution;</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> system_rhs;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> viscosity;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="group__Exceptions.html#gga841a7b84dc17bf2ba675522093a97e8ba945f3fc449518a73b9f5f32868db466c">lambda</a>;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacemu.html">mu</a>;</div>
<div class="line">};</div>
<div class="ttc" id="aclassAffineConstraints_html"><div class="ttname"><a href="classAffineConstraints.html">AffineConstraints&lt; double &gt;</a></div></div>
<div class="ttc" id="aclassDoFHandler_html"><div class="ttname"><a href="classDoFHandler.html">DoFHandler</a></div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__handler_8h_source.html#l00314">dof_handler.h:315</a></div></div>
<div class="ttc" id="aclassFEFaceValuesBase_html"><div class="ttname"><a href="classFEFaceValuesBase.html">FEFaceValuesBase</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values_8h_source.html#l04044">fe_values.h:4045</a></div></div>
<div class="ttc" id="aclassFullMatrix_html"><div class="ttname"><a href="classFullMatrix.html">FullMatrix&lt; double &gt;</a></div></div>
<div class="ttc" id="aclassSparseMatrix_html"><div class="ttname"><a href="classSparseMatrix.html">SparseMatrix&lt; double &gt;</a></div></div>
<div class="ttc" id="aclassSparsityPattern_html"><div class="ttname"><a href="classSparsityPattern.html">SparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="sparsity__pattern_8h_source.html#l00868">sparsity_pattern.h:869</a></div></div>
<div class="ttc" id="aclassSymmetricTensor_html"><div class="ttname"><a href="classSymmetricTensor.html">SymmetricTensor&lt; 2, dim &gt;</a></div></div>
<div class="ttc" id="aclassTensor_html"><div class="ttname"><a href="classTensor.html">Tensor&lt; 1, dim &gt;</a></div></div>
<div class="ttc" id="aclassTriangulation_html"><div class="ttname"><a href="classTriangulation.html">Triangulation</a></div><div class="ttdef"><b>Definition:</b> <a href="grid_2tria_8h_source.html#l01127">tria.h:1128</a></div></div>
<div class="ttc" id="aclasshp_1_1FECollection_html"><div class="ttname"><a href="classhp_1_1FECollection.html">hp::FECollection</a></div><div class="ttdef"><b>Definition:</b> <a href="fe__collection_8h_source.html#l00053">fe_collection.h:54</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_gga841a7b84dc17bf2ba675522093a97e8ba945f3fc449518a73b9f5f32868db466c"><div class="ttname"><a href="group__Exceptions.html#gga841a7b84dc17bf2ba675522093a97e8ba945f3fc449518a73b9f5f32868db466c">Differentiation::SD::OptimizerType::lambda</a></div><div class="ttdeci">@ lambda</div></div>
<div class="ttc" id="agroup__Iterators_html_ga32b2a057d9abd2e1752bf8a3cb88e644"><div class="ttname"><a href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler::cell_iterator</a></div><div class="ttdeci">typename ActiveSelector::cell_iterator cell_iterator</div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__handler_8h_source.html#l00466">dof_handler.h:466</a></div></div>
<div class="ttc" id="anamespaceWorkStream_1_1internal_1_1tbb__no__coloring_html_a8673698a405bf47aa24002aeb6d76d70"><div class="ttname"><a href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">WorkStream::internal::tbb_no_coloring::run</a></div><div class="ttdeci">void run(const Iterator &amp;begin, const typename identity&lt; Iterator &gt;::type &amp;end, Worker worker, Copier copier, const ScratchData &amp;sample_scratch_data, const CopyData &amp;sample_copy_data, const unsigned int queue_length, const unsigned int chunk_size)</div><div class="ttdef"><b>Definition:</b> <a href="work__stream_8h_source.html#l00691">work_stream.h:691</a></div></div>
<div class="ttc" id="anamespacemu_html"><div class="ttname"><a href="namespacemu.html">mu</a></div><div class="ttdef"><b>Definition:</b> <a href="function__parser_8h_source.html#l00032">function_parser.h:33</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="Boundaryvaluesandrighthandside"></a> </p><h3>Boundary values and right hand side</h3>
<p>下面这个类就像它的名字所暗示的那样。速度的边界值分别为2d的 \(\mathbf u=(0, \sin(\pi x))^T\) 和3d的 \(\mathbf u=(0, 0, \sin(\pi x)\sin(\pi y))^T\) 。这个问题的其余边界条件都是同质的，在引言中已经讨论过。右边的强迫项对于流体和固体来说都是零，所以我们不需要为它提供一个额外的类。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>StokesBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  StokesBoundaryValues()</div>
<div class="line">    : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1 + dim)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div>
<div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">vector_value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div>
<div class="line">                            <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value) <span class="keyword">const override</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> StokesBoundaryValues&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div>
<div class="line">                                        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(component &lt; this-&gt;n_components,</div>
<div class="line">         <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(component, 0, this-&gt;n_components));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (component == dim - 1)</div>
<div class="line">    <span class="keywordflow">switch</span> (dim)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">case</span> 2:</div>
<div class="line">          <span class="keywordflow">return</span> <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">std::sin</a>(<a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a> * p[0]);</div>
<div class="line">        <span class="keywordflow">case</span> 3:</div>
<div class="line">          <span class="keywordflow">return</span> <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">std::sin</a>(<a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a> * p[0]) * <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">std::sin</a>(<a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a> * p[1]);</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> StokesBoundaryValues&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div>
<div class="line">                                             <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; this-&gt;n_components; ++c)</div>
<div class="line">    <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">values</a>(c) = StokesBoundaryValues&lt;dim&gt;::value(p, c);</div>
<div class="line">}</div>
<div class="ttc" id="aclassFunction_html_acbfcab66b2fc63bfea59268f40772bb4"><div class="ttname"><a href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">Function::value</a></div><div class="ttdeci">virtual RangeNumberType value(const Point&lt; dim &gt; &amp;p, const unsigned int component=0) const</div></div>
<div class="ttc" id="aclassFunction_html_ae316ebc05d21989d573024f8a23c49cb"><div class="ttname"><a href="classFunction.html#ae316ebc05d21989d573024f8a23c49cb">Function::vector_value</a></div><div class="ttdeci">virtual void vector_value(const Point&lt; dim &gt; &amp;p, Vector&lt; RangeNumberType &gt; &amp;values) const</div></div>
<div class="ttc" id="aclassPoint_html"><div class="ttname"><a href="classPoint.html">Point</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2point_8h_source.html#l00110">point.h:111</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga0d685aad996180f9851183ae3e29019a"><div class="ttname"><a href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">StandardExceptions::ExcIndexRange</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcIndexRange(int arg1, int arg2, int arg3)</div></div>
<div class="ttc" id="agroup__Exceptions_html_ga70a0bb353656e704acf927945277bbc6"><div class="ttname"><a href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a></div><div class="ttdeci">#define Assert(cond, exc)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01473">exceptions.h:1473</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga7b52b286796c23ef9ff178faf7a4b68f"><div class="ttname"><a href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">StandardExceptions::ExcNotImplemented</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcNotImplemented()</div></div>
<div class="ttc" id="anamespaceEvaluationFlags_html_a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58"><div class="ttname"><a href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">EvaluationFlags::values</a></div><div class="ttdeci">@ values</div><div class="ttdef"><b>Definition:</b> <a href="evaluation__flags_8h_source.html#l00051">evaluation_flags.h:51</a></div></div>
<div class="ttc" id="anamespacenumbers_html_a3e24f194a9cb9b6ff4442b8a7a877d4a"><div class="ttname"><a href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a></div><div class="ttdeci">static constexpr double PI</div><div class="ttdef"><b>Definition:</b> <a href="numbers_8h_source.html#l00231">numbers.h:231</a></div></div>
<div class="ttc" id="anumbers_8h_html_a27989bdc7b4b828564982787d126bd91"><div class="ttname"><a href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">std::sin</a></div><div class="ttdeci">::VectorizedArray&lt; Number, width &gt; sin(const ::VectorizedArray&lt; Number, width &gt; &amp;)</div><div class="ttdef"><b>Definition:</b> <a href="vectorization_8h_source.html#l05291">vectorization.h:5291</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeFluidStructureProblemcodeimplementation"></a> </p><h3>The <code>FluidStructureProblem</code> implementation</h3>
<p><a class="anchor" id="Constructorsandhelperfunctions"></a> </p><h4>Constructors and helper functions</h4>
<p>现在我们来谈谈这个程序的主类的实现。最初的几个函数是构造函数和辅助函数，可以用来确定一个单元格在域的哪个部分。鉴于介绍中对这些主题的讨论，它们的实现是相当明显的。在构造函数中，注意我们必须从斯托克斯和弹性的基本元素中构造 <a class="el" href="classhp_1_1FECollection.html">hp::FECollection</a> 对象；使用 <a class="el" href="classhp_1_1FECollection.html#a4b0e75a805ff012e76d33ad6d4c3eac8">hp::FECollection::push_back</a> 函数将它们在这个集合中的位置分配为0和1，这个顺序我们必须记住，并在程序的其余部分一致使用。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">FluidStructureProblem&lt;dim&gt;::FluidStructureProblem(</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> stokes_degree,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> elasticity_degree)</div>
<div class="line">  : stokes_degree(stokes_degree)</div>
<div class="line">  , elasticity_degree(elasticity_degree)</div>
<div class="line">  , <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>(<a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::maximum_smoothing)</div>
<div class="line">  , stokes_fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(stokes_degree + 1),</div>
<div class="line">              dim,</div>
<div class="line">              <a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(stokes_degree),</div>
<div class="line">              1,</div>
<div class="line">              <a class="code" href="classFE__Nothing.html">FE_Nothing</a>&lt;dim&gt;(),</div>
<div class="line">              dim)</div>
<div class="line">  , elasticity_fe(<a class="code" href="classFE__Nothing.html">FE_Nothing</a>&lt;dim&gt;(),</div>
<div class="line">                  dim,</div>
<div class="line">                  <a class="code" href="classFE__Nothing.html">FE_Nothing</a>&lt;dim&gt;(),</div>
<div class="line">                  1,</div>
<div class="line">                  <a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(elasticity_degree),</div>
<div class="line">                  dim)</div>
<div class="line">  , dof_handler(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>)</div>
<div class="line">  , viscosity(2)</div>
<div class="line">  , <a class="code" href="group__Exceptions.html#gga841a7b84dc17bf2ba675522093a97e8ba945f3fc449518a73b9f5f32868db466c">lambda</a>(1)</div>
<div class="line">  , <a class="code" href="namespacemu.html">mu</a>(1)</div>
<div class="line">{</div>
<div class="line">  fe_collection.push_back(stokes_fe);</div>
<div class="line">  fe_collection.push_back(elasticity_fe);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">bool</span> FluidStructureProblem&lt;dim&gt;::cell_is_in_fluid_domain(</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler&lt;dim&gt;::cell_iterator</a> &amp;cell)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> (cell-&gt;material_id() == fluid_domain_id);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">bool</span> FluidStructureProblem&lt;dim&gt;::cell_is_in_solid_domain(</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler&lt;dim&gt;::cell_iterator</a> &amp;cell)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> (cell-&gt;material_id() == solid_domain_id);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Meshesandassigningsubdomains"></a> </p><h4>Meshes and assigning subdomains</h4>
<p>下一对函数是处理生成网格，并确保所有表示子域的标志都是正确的。 <code>make_grid</code> ，正如在介绍中所讨论的，生成一个 \(8\times 8\) 的网格（或者一个 \(8\times 8\times 8\) 的三维网格）以确保每个粗略的网格单元完全在一个子域中。生成这个网格后，我们在其边界上循环，并在顶部边界设置边界指标为1，这是我们设置非零迪里希特边界条件的唯一地方。在这之后，我们再次在所有单元上循环，设置材料指标&amp;mdash；用来表示我们处于域的哪一部分，是流体指标还是固体指标。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> FluidStructureProblem&lt;dim&gt;::make_grid()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="namespaceGridGenerator.html#a358d5bd545bc115c8645d93fa79b64bc">GridGenerator::subdivided_hyper_cube</a>(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>, 8, -1, 1);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.active_cell_iterators())</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;face : cell-&gt;face_iterators())</div>
<div class="line">      <span class="keywordflow">if</span> (face-&gt;at_boundary() &amp;&amp; (face-&gt;center()[dim - 1] == 1))</div>
<div class="line">        face-&gt;set_all_boundary_ids(1);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.active_cell_iterators())</div>
<div class="line">    <span class="keywordflow">if</span> (((<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(cell-&gt;center()[0]) &lt; 0.25) &amp;&amp;</div>
<div class="line">         (cell-&gt;center()[dim - 1] &gt; 0.5)) ||</div>
<div class="line">        ((<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(cell-&gt;center()[0]) &gt;= 0.25) &amp;&amp;</div>
<div class="line">         (cell-&gt;center()[dim - 1] &gt; -0.5)))</div>
<div class="line">      cell-&gt;set_material_id(fluid_domain_id);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      cell-&gt;set_material_id(solid_domain_id);</div>
<div class="line">}</div>
<div class="ttc" id="anamespaceDifferentiation_1_1SD_html_a592560ee80355620422a86087f11b9df"><div class="ttname"><a href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">Differentiation::SD::fabs</a></div><div class="ttdeci">Expression fabs(const Expression &amp;x)</div><div class="ttdef"><b>Definition:</b> <a href="symengine__math_8cc_source.html#l00273">symengine_math.cc:273</a></div></div>
<div class="ttc" id="anamespaceGridGenerator_html_a358d5bd545bc115c8645d93fa79b64bc"><div class="ttname"><a href="namespaceGridGenerator.html#a358d5bd545bc115c8645d93fa79b64bc">GridGenerator::subdivided_hyper_cube</a></div><div class="ttdeci">void subdivided_hyper_cube(Triangulation&lt; dim, spacedim &gt; &amp;tria, const unsigned int repetitions, const double left=0., const double right=1., const bool colorize=false)</div></div>
</div><!-- fragment --><p>这对函数的第二部分决定了在每个单元上使用哪一个有限元。上面我们已经为每个粗略网格单元设置了材料指标，正如介绍中提到的，这个信息在网格细化时是由母单元继承到子单元的。 <br  />
</p>
<p>换句话说，只要我们细化（或创建）了网格，我们就可以依靠材料指标来正确描述一个单元所处的域的哪一部分。然后我们利用这一点将单元的活动FE索引设置为该类的 <a class="el" href="classhp_1_1FECollection.html">hp::FECollection</a> 成员变量的相应元素：流体单元为0，固体单元为1。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> FluidStructureProblem&lt;dim&gt;::set_active_fe_indices()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.active_cell_iterators())</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> (cell_is_in_fluid_domain(cell))</div>
<div class="line">        cell-&gt;set_active_fe_index(0);</div>
<div class="line">      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cell_is_in_solid_domain(cell))</div>
<div class="line">        cell-&gt;set_active_fe_index(1);</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="codeFluidStructureProblemsetup_dofscode"></a> </p><h4><code>FluidStructureProblem::setup_dofs</code></h4>
<p>下一步是为线性系统设置数据结构。为此，我们首先要用上面的函数设置活动FE指数，然后分配自由度，再确定线性系统的约束。后者包括像往常一样的悬挂节点约束，但也包括顶部流体边界的不均匀边界值，以及沿固体子域周边的零边界值。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> FluidStructureProblem&lt;dim&gt;::setup_dofs()</div>
<div class="line">{</div>
<div class="line">  set_active_fe_indices();</div>
<div class="line">  dof_handler.distribute_dofs(fe_collection);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  {</div>
<div class="line">    constraints.clear();</div>
<div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                             1,</div>
<div class="line">                                             StokesBoundaryValues&lt;dim&gt;(),</div>
<div class="line">                                             constraints,</div>
<div class="line">                                             fe_collection.component_mask(</div>
<div class="line">                                               velocities));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> displacements(dim + 1);</div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(</div>
<div class="line">      dof_handler,</div>
<div class="line">      0,</div>
<div class="line">      <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a>(dim + 1 + dim),</div>
<div class="line">      constraints,</div>
<div class="line">      fe_collection.component_mask(displacements));</div>
<div class="line">  }</div>
<div class="ttc" id="aclassFunctions_1_1ZeroFunction_html"><div class="ttname"><a href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction</a></div><div class="ttdef"><b>Definition:</b> <a href="function_8h_source.html#l00510">function.h:511</a></div></div>
<div class="ttc" id="agroup__constraints_html_ga3b4ea7dfd313e388d868c4e4aa685799"><div class="ttname"><a href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a></div><div class="ttdeci">void make_hanging_node_constraints(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, AffineConstraints&lt; number &gt; &amp;constraints)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__constraints_8cc_source.html#l01787">dof_tools_constraints.cc:1787</a></div></div>
<div class="ttc" id="anamespaceVectorTools_html_ab2562d41bb26f362043f9719a8cd9b87"><div class="ttname"><a href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a></div><div class="ttdeci">void interpolate_boundary_values(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const std::map&lt; types::boundary_id, const Function&lt; spacedim, number &gt; * &gt; &amp;function_map, std::map&lt; types::global_dof_index, number &gt; &amp;boundary_values, const ComponentMask &amp;component_mask=ComponentMask())</div></div>
<div class="ttc" id="astructFEValuesExtractors_1_1Vector_html"><div class="ttname"><a href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="fe__values__extractors_8h_source.html#l00150">fe_values_extractors.h:151</a></div></div>
</div><!-- fragment --><p>不过，我们还必须处理更多的约束条件：我们必须确保在流体和固体的界面上速度为零。下面这段代码已经在介绍中介绍过了。</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; local_face_dof_indices(</div>
<div class="line">    stokes_fe.n_dofs_per_face());</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.active_cell_iterators())</div>
<div class="line">    <span class="keywordflow">if</span> (cell_is_in_fluid_domain(cell))</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> face_no : cell-&gt;face_indices())</div>
<div class="line">        <span class="keywordflow">if</span> (cell-&gt;face(face_no)-&gt;at_boundary() == <span class="keyword">false</span>)</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordtype">bool</span> face_is_on_interface = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> ((cell-&gt;neighbor(face_no)-&gt;has_children() == <span class="keyword">false</span>) &amp;&amp;</div>
<div class="line">                (cell_is_in_solid_domain(cell-&gt;neighbor(face_no))))</div>
<div class="line">              face_is_on_interface = <span class="keyword">true</span>;</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cell-&gt;neighbor(face_no)-&gt;has_children() == <span class="keyword">true</span>)</div>
<div class="line">              {</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sf = 0;</div>
<div class="line">                     sf &lt; cell-&gt;face(face_no)-&gt;n_children();</div>
<div class="line">                     ++sf)</div>
<div class="line">                  <span class="keywordflow">if</span> (cell_is_in_solid_domain(</div>
<div class="line">                        cell-&gt;neighbor_child_on_subface(face_no, sf)))</div>
<div class="line">                    {</div>
<div class="line">                      face_is_on_interface = <span class="keyword">true</span>;</div>
<div class="line">                      <span class="keywordflow">break</span>;</div>
<div class="line">                    }</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (face_is_on_interface)</div>
<div class="line">              {</div>
<div class="line">                cell-&gt;face(face_no)-&gt;get_dof_indices(local_face_dof_indices,</div>
<div class="line">                                                     0);</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; local_face_dof_indices.size();</div>
<div class="line">                     ++i)</div>
<div class="line">                  <span class="keywordflow">if</span> (stokes_fe.face_system_to_component_index(i).first &lt;</div>
<div class="line">                      dim)</div>
<div class="line">                    constraints.add_line(local_face_dof_indices[i]);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">}</div>
</div><!-- fragment --><p>在这一切结束时，我们可以向约束对象声明，我们现在已经准备好了所有的约束，并且该对象可以重建其内部数据结构以获得更好的效率。</p>
<div class="fragment"><div class="line">constraints.close();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;   Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells()</div>
<div class="line">          &lt;&lt; std::endl</div>
<div class="line">          &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.n_dofs()</div>
<div class="line">          &lt;&lt; std::endl;</div>
</div><!-- fragment --><p>在这个函数的其余部分，我们创建了一个在介绍中广泛讨论的稀疏模式，并使用它来初始化矩阵；然后还将向量设置为正确的大小。</p>
<div class="fragment"><div class="line">  {</div>
<div class="line">    <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.n_dofs(), dof_handler.n_dofs());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> cell_coupling(fe_collection.n_components(),</div>
<div class="line">                                               fe_collection.n_components());</div>
<div class="line">    <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> face_coupling(fe_collection.n_components(),</div>
<div class="line">                                               fe_collection.n_components());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; fe_collection.n_components(); ++c)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> &lt; fe_collection.n_components(); ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">if</span> (((c &lt; dim + 1) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> &lt; dim + 1) &amp;&amp;</div>
<div class="line">               !((c == dim) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> == dim))) ||</div>
<div class="line">              ((c &gt;= dim + 1) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> &gt;= dim + 1)))</div>
<div class="line">            cell_coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">if</span> ((c &gt;= dim + 1) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> &lt; dim + 1))</div>
<div class="line">            face_coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__constraints.html#ga7b2627e9bde96b98d4fcf95b629e4fd4">DoFTools::make_flux_sparsity_pattern</a>(dof_handler,</div>
<div class="line">                                         dsp,</div>
<div class="line">                                         cell_coupling,</div>
<div class="line">                                         face_coupling);</div>
<div class="line">    constraints.condense(dsp);</div>
<div class="line">    sparsity_pattern.copy_from(dsp);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  system_matrix.reinit(sparsity_pattern);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  solution.reinit(dof_handler.n_dofs());</div>
<div class="line">  system_rhs.reinit(dof_handler.n_dofs());</div>
<div class="line">}</div>
<div class="ttc" id="aclassDynamicSparsityPattern_html"><div class="ttname"><a href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="dynamic__sparsity__pattern_8h_source.html#l00318">dynamic_sparsity_pattern.h:319</a></div></div>
<div class="ttc" id="agroup__constraints_html_ga7b2627e9bde96b98d4fcf95b629e4fd4"><div class="ttname"><a href="group__constraints.html#ga7b2627e9bde96b98d4fcf95b629e4fd4">DoFTools::make_flux_sparsity_pattern</a></div><div class="ttdeci">void make_flux_sparsity_pattern(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, SparsityPatternType &amp;sparsity_pattern)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__sparsity_8cc_source.html#l00699">dof_tools_sparsity.cc:699</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="codeFluidStructureProblemassemble_systemcode"></a> </p><h4><code>FluidStructureProblem::assemble_system</code></h4>
<p>下面是这个程序的中心函数：组装线性系统的函数。它在开始时有一长段设置辅助函数的内容：从创建正交公式到设置FEValues、FEFaceValues和FESubfaceValues对象，这些都是整合单元项以及界面项所必需的，以应对界面上的单元以相同尺寸或不同的细化程度聚集在一起的情况...</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> FluidStructureProblem&lt;dim&gt;::assemble_system()</div>
<div class="line">{</div>
<div class="line">  system_matrix = 0;</div>
<div class="line">  system_rhs    = 0;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> stokes_quadrature(stokes_degree + 2);</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> elasticity_quadrature(elasticity_degree + 2);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classhp_1_1QCollection.html">hp::QCollection&lt;dim&gt;</a> q_collection;</div>
<div class="line">  q_collection.<a class="code" href="classhp_1_1QCollection.html#a87ec95076ccc4b7c10fa24523bb926df">push_back</a>(stokes_quadrature);</div>
<div class="line">  q_collection.<a class="code" href="classhp_1_1QCollection.html#a87ec95076ccc4b7c10fa24523bb926df">push_back</a>(elasticity_quadrature);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classhp_1_1FEValues.html">hp::FEValues&lt;dim&gt;</a> hp_fe_values(fe_collection,</div>
<div class="line">                                 q_collection,</div>
<div class="line">                                 <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                   <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss</a>&lt;dim - 1&gt; common_face_quadrature(</div>
<div class="line">    <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">std::max</a>(stokes_degree + 2, elasticity_degree + 2));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a>    stokes_fe_face_values(stokes_fe,</div>
<div class="line">                                          common_face_quadrature,</div>
<div class="line">                                          <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> |</div>
<div class="line">                                            <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> | <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">  <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a>    elasticity_fe_face_values(elasticity_fe,</div>
<div class="line">                                              common_face_quadrature,</div>
<div class="line">                                              <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                                <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">  <a class="code" href="classFESubfaceValues.html">FESubfaceValues&lt;dim&gt;</a> stokes_fe_subface_values(stokes_fe,</div>
<div class="line">                                                common_face_quadrature,</div>
<div class="line">                                                <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> |</div>
<div class="line">                                                  <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                                  <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">  <a class="code" href="classFESubfaceValues.html">FESubfaceValues&lt;dim&gt;</a> elasticity_fe_subface_values(elasticity_fe,</div>
<div class="line">                                                    common_face_quadrature,</div>
<div class="line">                                                    <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                                      <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="ttc" id="aclassFEFaceValues_html"><div class="ttname"><a href="classFEFaceValues.html">FEFaceValues</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values_8h_source.html#l04157">fe_values.h:4158</a></div></div>
<div class="ttc" id="aclassFESubfaceValues_html"><div class="ttname"><a href="classFESubfaceValues.html">FESubfaceValues</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values_8h_source.html#l04323">fe_values.h:4324</a></div></div>
<div class="ttc" id="aclassQGauss_html"><div class="ttname"><a href="classQGauss.html">QGauss</a></div><div class="ttdef"><b>Definition:</b> <a href="quadrature__lib_8h_source.html#l00038">quadrature_lib.h:39</a></div></div>
<div class="ttc" id="aclasshp_1_1FEValues_html"><div class="ttname"><a href="classhp_1_1FEValues.html">hp::FEValues</a></div><div class="ttdef"><b>Definition:</b> <a href="hp_2fe__values_8h_source.html#l00315">fe_values.h:317</a></div></div>
<div class="ttc" id="aclasshp_1_1QCollection_html"><div class="ttname"><a href="classhp_1_1QCollection.html">hp::QCollection</a></div><div class="ttdef"><b>Definition:</b> <a href="q__collection_8h_source.html#l00046">q_collection.h:47</a></div></div>
<div class="ttc" id="aclasshp_1_1QCollection_html_a87ec95076ccc4b7c10fa24523bb926df"><div class="ttname"><a href="classhp_1_1QCollection.html#a87ec95076ccc4b7c10fa24523bb926df">hp::QCollection::push_back</a></div><div class="ttdeci">void push_back(const Quadrature&lt; dim_in &gt; &amp;new_quadrature)</div><div class="ttdef"><b>Definition:</b> <a href="q__collection_8h_source.html#l00223">q_collection.h:223</a></div></div>
<div class="ttc" id="afe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea"><div class="ttname"><a href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a></div><div class="ttdeci">@ update_values</div><div class="ttdoc">Shape function values.</div><div class="ttdef"><b>Definition:</b> <a href="fe__update__flags_8h_source.html#l00078">fe_update_flags.h:78</a></div></div>
<div class="ttc" id="afe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f"><div class="ttname"><a href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a></div><div class="ttdeci">@ update_normal_vectors</div><div class="ttdoc">Normal vectors.</div><div class="ttdef"><b>Definition:</b> <a href="fe__update__flags_8h_source.html#l00136">fe_update_flags.h:136</a></div></div>
<div class="ttc" id="afe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85"><div class="ttname"><a href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a></div><div class="ttdeci">@ update_JxW_values</div><div class="ttdoc">Transformed quadrature weights.</div><div class="ttdef"><b>Definition:</b> <a href="fe__update__flags_8h_source.html#l00129">fe_update_flags.h:129</a></div></div>
<div class="ttc" id="afe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20"><div class="ttname"><a href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a></div><div class="ttdeci">@ update_gradients</div><div class="ttdoc">Shape function gradients.</div><div class="ttdef"><b>Definition:</b> <a href="fe__update__flags_8h_source.html#l00084">fe_update_flags.h:84</a></div></div>
<div class="ttc" id="afe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a"><div class="ttname"><a href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a></div><div class="ttdeci">@ update_quadrature_points</div><div class="ttdoc">Transformed quadrature points.</div><div class="ttdef"><b>Definition:</b> <a href="fe__update__flags_8h_source.html#l00122">fe_update_flags.h:122</a></div></div>
<div class="ttc" id="anamespaceVectorTools_1_1EvaluationFlags_html_ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420"><div class="ttname"><a href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">VectorTools::EvaluationFlags::max</a></div><div class="ttdeci">@ max</div><div class="ttdef"><b>Definition:</b> <a href="vector__tools__evaluate_8h_source.html#l00053">vector_tools_evaluate.h:53</a></div></div>
</div><!-- fragment --><p>...描述对全局线性系统的局部贡献所需的对象...</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> stokes_dofs_per_cell = stokes_fe.n_dofs_per_cell();</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> elasticity_dofs_per_cell =</div>
<div class="line">  elasticity_fe.n_dofs_per_cell();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix;</div>
<div class="line"><a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_interface_matrix(elasticity_dofs_per_cell,</div>
<div class="line">                                          stokes_dofs_per_cell);</div>
<div class="line"><a class="code" href="classVector.html">Vector&lt;double&gt;</a>     local_rhs;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">std::vector&lt;types::global_dof_index&gt; local_dof_indices;</div>
<div class="line">std::vector&lt;types::global_dof_index&gt; neighbor_dof_indices(</div>
<div class="line">  stokes_dofs_per_cell);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a> right_hand_side(dim + 1);</div>
</div><!-- fragment --><p>...允许我们提取形状函数的某些成分并缓存其值的变量，而不必在每个正交点重新计算它们。</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div>
<div class="line"><span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> pressure(dim);</div>
<div class="line"><span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> displacements(dim + 1);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; stokes_symgrad_phi_u(</div>
<div class="line">  stokes_dofs_per_cell);</div>
<div class="line">std::vector&lt;double&gt; stokes_div_phi_u(stokes_dofs_per_cell);</div>
<div class="line">std::vector&lt;double&gt; stokes_phi_p(stokes_dofs_per_cell);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">std::vector&lt;Tensor&lt;2, dim&gt;&gt; elasticity_grad_phi(elasticity_dofs_per_cell);</div>
<div class="line">std::vector&lt;double&gt;         elasticity_div_phi(elasticity_dofs_per_cell);</div>
<div class="line">std::vector&lt;Tensor&lt;1, dim&gt;&gt; elasticity_phi(elasticity_dofs_per_cell);</div>
<div class="ttc" id="astructFEValuesExtractors_1_1Scalar_html"><div class="ttname"><a href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a></div><div class="ttdef"><b>Definition:</b> <a href="fe__values__extractors_8h_source.html#l00095">fe_values_extractors.h:96</a></div></div>
</div><!-- fragment --><p>然后是所有单元的主循环，和 <a class="el" href="step_27.html">step-27</a> 一样，为当前单元初始化 <a class="el" href="classhp_1_1FEValues.html">hp::FEValues</a> 对象，并提取适合当前单元的FEValues对象。</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.active_cell_iterators())</div>
<div class="line">  {</div>
<div class="line">    hp_fe_values.reinit(cell);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;fe_values = hp_fe_values.<a class="code" href="classFEValues.html#a902429920d32c81c9c279d9a15faa263">get_present_fe_values</a>();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    local_matrix.<a class="code" href="classTableBase.html#a302ef67031a523602fd39911b968d6ab">reinit</a>(cell-&gt;<a class="code" href="classDoFHandler.html#ac1fedeb50b5f03b13d8b69f86e33f726">get_fe</a>().<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>(),</div>
<div class="line">                        cell-&gt;<a class="code" href="classDoFHandler.html#ac1fedeb50b5f03b13d8b69f86e33f726">get_fe</a>().<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">    local_rhs.<a class="code" href="group__Vectors.html#gac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(cell-&gt;<a class="code" href="classDoFHandler.html#ac1fedeb50b5f03b13d8b69f86e33f726">get_fe</a>().<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="ttc" id="aclassDoFHandler_html_ac1fedeb50b5f03b13d8b69f86e33f726"><div class="ttname"><a href="classDoFHandler.html#ac1fedeb50b5f03b13d8b69f86e33f726">DoFHandler::get_fe</a></div><div class="ttdeci">const FiniteElement&lt; dim, spacedim &gt; &amp; get_fe(const unsigned int index=0) const</div></div>
<div class="ttc" id="aclassFEValues_html"><div class="ttname"><a href="classFEValues.html">FEValues</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values_8h_source.html#l03905">fe_values.h:3906</a></div></div>
<div class="ttc" id="aclassFEValues_html_a902429920d32c81c9c279d9a15faa263"><div class="ttname"><a href="classFEValues.html#a902429920d32c81c9c279d9a15faa263">FEValues::get_present_fe_values</a></div><div class="ttdeci">const FEValues&lt; dim, spacedim &gt; &amp; get_present_fe_values() const</div></div>
<div class="ttc" id="aclassFiniteElementData_html_a33b522422da89e5c080e7405ad49d7c7"><div class="ttname"><a href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">FiniteElementData::n_dofs_per_cell</a></div><div class="ttdeci">unsigned int n_dofs_per_cell() const</div></div>
<div class="ttc" id="aclassTableBase_html_a302ef67031a523602fd39911b968d6ab"><div class="ttname"><a href="classTableBase.html#a302ef67031a523602fd39911b968d6ab">TableBase::reinit</a></div><div class="ttdeci">void reinit(const TableIndices&lt; N &gt; &amp;new_size, const bool omit_default_initialization=false)</div></div>
<div class="ttc" id="agroup__Vectors_html_gac4a4dbef7dd65ef8ad35ae56b57d7c05"><div class="ttname"><a href="group__Vectors.html#gac4a4dbef7dd65ef8ad35ae56b57d7c05">Vector::reinit</a></div><div class="ttdeci">virtual void reinit(const size_type N, const bool omit_zeroing_entries=false)</div></div>
</div><!-- fragment --><p>所有这些完成后，我们继续为属于斯托克斯和弹性区域的单元组装单元项。虽然我们原则上可以在一个公式中完成，实际上是实现了介绍中所说的一个双线性形式，但我们意识到，我们的有限元空间的选择方式是，在每个单元上，一组变量（速度和压力，或位移）总是零，因此，计算局部积分的一个更有效的方法是，根据 <code>if</code> 条款，只做必要的，测试我们在域的哪一部分。 <br  />
</p>
<p>局部矩阵的实际计算与 <a class="el" href="step_22.html">step-22</a> 以及 <a class="el" href="group__vector__valued.html">Handling vector valued problems</a> 文件模块中给出的弹性方程的计算相同。</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (cell_is_in_fluid_domain(cell))</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = cell-&gt;<a class="code" href="classDoFHandler.html#ac1fedeb50b5f03b13d8b69f86e33f726">get_fe</a>().<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dofs_per_cell == stokes_dofs_per_cell, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; fe_values.<a class="code" href="classFEValuesBase.html#a807c3049bfe81743fc0f237dfc2fbdea">n_quadrature_points</a>; ++q)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; dofs_per_cell; ++k)</div>
<div class="line">          {</div>
<div class="line">            stokes_symgrad_phi_u[k] =</div>
<div class="line">              fe_values[velocities].symmetric_gradient(k, q);</div>
<div class="line">            stokes_div_phi_u[k] =</div>
<div class="line">              fe_values[velocities].divergence(k, q);</div>
<div class="line">            stokes_phi_p[k] = fe_values[pressure].value(k, q);</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j)</div>
<div class="line">            local_matrix(i, j) +=</div>
<div class="line">              (2 * viscosity * stokes_symgrad_phi_u[i] *</div>
<div class="line">                 stokes_symgrad_phi_u[j] -</div>
<div class="line">               stokes_div_phi_u[i] * stokes_phi_p[j] -</div>
<div class="line">               stokes_phi_p[i] * stokes_div_phi_u[j]) *</div>
<div class="line">              fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = cell-&gt;<a class="code" href="classDoFHandler.html#ac1fedeb50b5f03b13d8b69f86e33f726">get_fe</a>().<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dofs_per_cell == elasticity_dofs_per_cell,</div>
<div class="line">           <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; fe_values.<a class="code" href="classFEValuesBase.html#a807c3049bfe81743fc0f237dfc2fbdea">n_quadrature_points</a>; ++q)</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; dofs_per_cell; ++k)</div>
<div class="line">          {</div>
<div class="line">            elasticity_grad_phi[k] =</div>
<div class="line">              fe_values[displacements].gradient(k, q);</div>
<div class="line">            elasticity_div_phi[k] =</div>
<div class="line">              fe_values[displacements].divergence(k, q);</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j)</div>
<div class="line">            {</div>
<div class="line">              local_matrix(i, j) +=</div>
<div class="line">                (<a class="code" href="group__Exceptions.html#gga841a7b84dc17bf2ba675522093a97e8ba945f3fc449518a73b9f5f32868db466c">lambda</a> * elasticity_div_phi[i] *</div>
<div class="line">                   elasticity_div_phi[j] +</div>
<div class="line">                 <a class="code" href="namespacemu.html">mu</a> * <a class="code" href="classSymmetricTensor.html#ab14ac27fc9ab74d4de531698b492d8de">scalar_product</a>(elasticity_grad_phi[i],</div>
<div class="line">                                     elasticity_grad_phi[j]) +</div>
<div class="line">                 <a class="code" href="namespacemu.html">mu</a> *</div>
<div class="line">                   <a class="code" href="classSymmetricTensor.html#ab14ac27fc9ab74d4de531698b492d8de">scalar_product</a>(elasticity_grad_phi[i],</div>
<div class="line">                                  <a class="code" href="classDerivativeForm.html#a3c201452e8dd28e4f5be4a316cb9305f">transpose</a>(elasticity_grad_phi[j]))) *</div>
<div class="line">                fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div>
<div class="line">            }</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="ttc" id="aclassDerivativeForm_html_a3c201452e8dd28e4f5be4a316cb9305f"><div class="ttname"><a href="classDerivativeForm.html#a3c201452e8dd28e4f5be4a316cb9305f">DerivativeForm::transpose</a></div><div class="ttdeci">DerivativeForm&lt; 1, spacedim, dim, Number &gt; transpose(const DerivativeForm&lt; 1, dim, spacedim, Number &gt; &amp;DF)</div><div class="ttdef"><b>Definition:</b> <a href="derivative__form_8h_source.html#l00522">derivative_form.h:522</a></div></div>
<div class="ttc" id="aclassFEValuesBase_html_a807c3049bfe81743fc0f237dfc2fbdea"><div class="ttname"><a href="classFEValuesBase.html#a807c3049bfe81743fc0f237dfc2fbdea">FEValuesBase::n_quadrature_points</a></div><div class="ttdeci">const unsigned int n_quadrature_points</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values_8h_source.html#l02344">fe_values.h:2344</a></div></div>
<div class="ttc" id="aclassFEValuesBase_html_abade89efb068b71b7ced7082012a2441"><div class="ttname"><a href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">FEValuesBase::JxW</a></div><div class="ttdeci">double JxW(const unsigned int quadrature_point) const</div></div>
<div class="ttc" id="aclassSymmetricTensor_html_ab14ac27fc9ab74d4de531698b492d8de"><div class="ttname"><a href="classSymmetricTensor.html#ab14ac27fc9ab74d4de531698b492d8de">SymmetricTensor::scalar_product</a></div><div class="ttdeci">constexpr ProductType&lt; Number, OtherNumber &gt;::type scalar_product(const SymmetricTensor&lt; 2, dim, Number &gt; &amp;t1, const SymmetricTensor&lt; 2, dim, OtherNumber &gt; &amp;t2)</div><div class="ttdef"><b>Definition:</b> <a href="symmetric__tensor_8h_source.html#l03693">symmetric_tensor.h:3693</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga31978c026b8b6b5116df30b8e748f6b7"><div class="ttname"><a href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">StandardExceptions::ExcInternalError</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcInternalError()</div></div>
</div><!-- fragment --><p>一旦我们有了单元积分的贡献，我们就把它们复制到全局矩阵中（通过 <a class="el" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">AffineConstraints::distribute_local_to_global</a> 函数，立即处理约束）。请注意，我们没有向 <code>local_rhs</code> 变量中写入任何东西，尽管我们仍然需要传递它，因为消除非零边界值需要修改局部，因此也需要修改全局的右手值。</p>
<div class="fragment"><div class="line">local_dof_indices.resize(cell-&gt;<a class="code" href="classDoFHandler.html#ac1fedeb50b5f03b13d8b69f86e33f726">get_fe</a>().<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">cell-&gt;get_dof_indices(local_dof_indices);</div>
<div class="line">constraints.distribute_local_to_global(local_matrix,</div>
<div class="line">                                       local_rhs,</div>
<div class="line">                                       local_dof_indices,</div>
<div class="line">                                       system_matrix,</div>
<div class="line">                                       system_rhs);</div>
</div><!-- fragment --><p>这个函数更有趣的部分是我们在两个子域之间的界面上看到的关于面的条款。为此，我们首先要确保我们只组装一次，尽管在所有单元的所有面的循环会遇到界面的每个部分两次。我们武断地决定，只有当当前单元是固体子域的一部分，并且因此一个面不在边界上，并且它后面的潜在邻居是流体域的一部分时，我们才会评估界面条款。让我们从这些条件开始。</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (cell_is_in_solid_domain(cell))</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> f : cell-&gt;face_indices())</div>
<div class="line">    <span class="keywordflow">if</span> (cell-&gt;face(f)-&gt;at_boundary() == <span class="keyword">false</span>)</div>
<div class="line">      {</div>
</div><!-- fragment --><p>在这一点上，我们知道当前的单元是一个候选的积分，并且面 <code>f</code> 后面存在一个邻居。现在有三种可能性。</p>
<ul>
<li>邻居处于相同的细化水平，没有子女。</li>
<li>邻居有孩子。</li>
<li>邻居更粗。 <br  />
</li>
</ul>
<p>在所有这三种情况下，我们只对它感兴趣，如果它是流体子域的一部分。因此，让我们从第一种最简单的情况开始：如果邻居处于同一层次，没有子女，并且是一个流体单元，那么这两个单元共享一个边界，这个边界是我们想要整合接口项的一部分。我们所要做的就是用当前面和邻接单元的面初始化两个FEFaceValues对象（注意我们是如何找出邻接单元的哪个面与当前单元接壤的），然后把东西传给评估界面项的函数（这个函数的第三个到第五个参数为它提供了抓取数组）。然后，结果再次被复制到全局矩阵中，使用一个知道本地矩阵的行和列的DoF指数来自不同单元的函数。</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> ((cell-&gt;neighbor(f)-&gt;level() == cell-&gt;level()) &amp;&amp;</div>
<div class="line">    (cell-&gt;neighbor(f)-&gt;has_children() == <span class="keyword">false</span>) &amp;&amp;</div>
<div class="line">    cell_is_in_fluid_domain(cell-&gt;neighbor(f)))</div>
<div class="line">  {</div>
<div class="line">    elasticity_fe_face_values.reinit(cell, f);</div>
<div class="line">    stokes_fe_face_values.reinit(cell-&gt;neighbor(f),</div>
<div class="line">                                 cell-&gt;neighbor_of_neighbor(f));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    assemble_interface_term(elasticity_fe_face_values,</div>
<div class="line">                            stokes_fe_face_values,</div>
<div class="line">                            elasticity_phi,</div>
<div class="line">                            stokes_symgrad_phi_u,</div>
<div class="line">                            stokes_phi_p,</div>
<div class="line">                            local_interface_matrix);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    cell-&gt;neighbor(f)-&gt;get_dof_indices(neighbor_dof_indices);</div>
<div class="line">    constraints.distribute_local_to_global(</div>
<div class="line">      local_interface_matrix,</div>
<div class="line">      local_dof_indices,</div>
<div class="line">      neighbor_dof_indices,</div>
<div class="line">      system_matrix);</div>
<div class="line">  }</div>
</div><!-- fragment --><p>第二种情况是如果邻居有更多的孩子。在这种情况下，我们必须对邻居的所有子代进行循环，看它们是否属于流体子域。如果它们是，那么我们就在共同界面上进行整合，这个界面是邻居的一个面和当前单元的一个子面，要求我们对邻居使用FEFaceValues，对当前单元使用FESubfaceValues。</p>
<div class="fragment"><div class="line"><span class="keywordflow">else</span> <span class="keywordflow">if</span> ((cell-&gt;neighbor(f)-&gt;level() == cell-&gt;level()) &amp;&amp;</div>
<div class="line">         (cell-&gt;neighbor(f)-&gt;has_children() == <span class="keyword">true</span>))</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> subface = 0;</div>
<div class="line">         subface &lt; cell-&gt;face(f)-&gt;n_children();</div>
<div class="line">         ++subface)</div>
<div class="line">      <span class="keywordflow">if</span> (cell_is_in_fluid_domain(</div>
<div class="line">            cell-&gt;neighbor_child_on_subface(f, subface)))</div>
<div class="line">        {</div>
<div class="line">          elasticity_fe_subface_values.reinit(cell, f, subface);</div>
<div class="line">          stokes_fe_face_values.reinit(</div>
<div class="line">            cell-&gt;neighbor_child_on_subface(f, subface),</div>
<div class="line">            cell-&gt;neighbor_of_neighbor(f));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">          assemble_interface_term(elasticity_fe_subface_values,</div>
<div class="line">                                  stokes_fe_face_values,</div>
<div class="line">                                  elasticity_phi,</div>
<div class="line">                                  stokes_symgrad_phi_u,</div>
<div class="line">                                  stokes_phi_p,</div>
<div class="line">                                  local_interface_matrix);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">          cell-&gt;neighbor_child_on_subface(f, subface)</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">            -&gt;get_dof_indices(neighbor_dof_indices);</div>
<div class="line">          constraints.distribute_local_to_global(</div>
<div class="line">            local_interface_matrix,</div>
<div class="line">            local_dof_indices,</div>
<div class="line">            neighbor_dof_indices,</div>
<div class="line">            system_matrix);</div>
<div class="line">        }</div>
<div class="line">  }</div>
</div><!-- fragment --><p>最后一个选项是，邻居是比较粗糙的。在这种情况下，我们必须为邻居使用一个FESubfaceValues对象，为当前单元使用一个FEFaceValues；其余部分与之前相同。</p>
<div class="fragment"><div class="line">              <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cell-&gt;neighbor_is_coarser(f) &amp;&amp;</div>
<div class="line">                       cell_is_in_fluid_domain(cell-&gt;neighbor(f)))</div>
<div class="line">                {</div>
<div class="line">                  elasticity_fe_face_values.reinit(cell, f);</div>
<div class="line">                  stokes_fe_subface_values.reinit(</div>
<div class="line">                    cell-&gt;neighbor(f),</div>
<div class="line">                    cell-&gt;neighbor_of_coarser_neighbor(f).first,</div>
<div class="line">                    cell-&gt;neighbor_of_coarser_neighbor(f).second);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">                  assemble_interface_term(elasticity_fe_face_values,</div>
<div class="line">                                          stokes_fe_subface_values,</div>
<div class="line">                                          elasticity_phi,</div>
<div class="line">                                          stokes_symgrad_phi_u,</div>
<div class="line">                                          stokes_phi_p,</div>
<div class="line">                                          local_interface_matrix);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">                  cell-&gt;neighbor(f)-&gt;get_dof_indices(neighbor_dof_indices);</div>
<div class="line">                  constraints.distribute_local_to_global(</div>
<div class="line">                    local_interface_matrix,</div>
<div class="line">                    local_dof_indices,</div>
<div class="line">                    neighbor_dof_indices,</div>
<div class="line">                    system_matrix);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>在组装全局系统的函数中，我们将计算接口条款传递给了我们在此讨论的一个单独的函数。关键是，尽管我们无法预测FEFaceValues和FESubfaceValues对象的组合，但它们都是从FEFaceValuesBase类派生出来的，因此我们不必在意：调用该函数时，只需输入两个这样的对象，表示面的两边正交点上的形状函数值。然后我们做我们一直在做的事情：我们用形状函数的值和它们的导数来填充从头数组，然后循环计算矩阵的所有条目来计算局部积分。我们在这里评估的双线性形式的细节在介绍中给出。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> FluidStructureProblem&lt;dim&gt;::assemble_interface_term(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFEFaceValuesBase.html">FEFaceValuesBase&lt;dim&gt;</a> &amp;         elasticity_fe_face_values,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classFEFaceValuesBase.html">FEFaceValuesBase&lt;dim&gt;</a> &amp;         stokes_fe_face_values,</div>
<div class="line">  std::vector&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;         elasticity_phi,</div>
<div class="line">  std::vector&lt;<a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a>&gt; &amp;stokes_symgrad_phi_u,</div>
<div class="line">  std::vector&lt;double&gt; &amp;                 stokes_phi_p,</div>
<div class="line">  <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> &amp;                  local_interface_matrix)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(stokes_fe_face_values.<a class="code" href="classFEValuesBase.html#a807c3049bfe81743fc0f237dfc2fbdea">n_quadrature_points</a> ==</div>
<div class="line">           elasticity_fe_face_values.<a class="code" href="classFEValuesBase.html#a807c3049bfe81743fc0f237dfc2fbdea">n_quadrature_points</a>,</div>
<div class="line">         <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_face_quadrature_points =</div>
<div class="line">    elasticity_fe_face_values.<a class="code" href="classFEValuesBase.html#a807c3049bfe81743fc0f237dfc2fbdea">n_quadrature_points</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> pressure(dim);</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> displacements(dim + 1);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  local_interface_matrix = 0;</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_face_quadrature_points; ++q)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> normal_vector =</div>
<div class="line">        elasticity_fe_face_values.<a class="code" href="classFEValuesBase.html#ac25ec6835799c3b6c7c842f8acb05eb3">normal_vector</a>(q);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; stokes_fe_face_values.<a class="code" href="classFEValuesBase.html#a5b264d5b2fb6615f5dea7a21135ed1a5">dofs_per_cell</a>; ++k)</div>
<div class="line">        {</div>
<div class="line">          stokes_symgrad_phi_u[k] =</div>
<div class="line">            stokes_fe_face_values[velocities].symmetric_gradient(k, q);</div>
<div class="line">          stokes_phi_p[k] = stokes_fe_face_values[pressure].value(k, q);</div>
<div class="line">        }</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; elasticity_fe_face_values.<a class="code" href="classFEValuesBase.html#a5b264d5b2fb6615f5dea7a21135ed1a5">dofs_per_cell</a>;</div>
<div class="line">           ++k)</div>
<div class="line">        elasticity_phi[k] =</div>
<div class="line">          elasticity_fe_face_values[displacements].<a class="code" href="namespaceinternal.html#aa5bef221c94bc6b9c5441c306a72cdbaa2063c1608d6e0baf80249c42e2be5804">value</a>(k, q);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; elasticity_fe_face_values.<a class="code" href="classFEValuesBase.html#a5b264d5b2fb6615f5dea7a21135ed1a5">dofs_per_cell</a>;</div>
<div class="line">           ++i)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; stokes_fe_face_values.<a class="code" href="classFEValuesBase.html#a5b264d5b2fb6615f5dea7a21135ed1a5">dofs_per_cell</a>; ++j)</div>
<div class="line">          local_interface_matrix(i, j) +=</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">            -((2 * viscosity * (stokes_symgrad_phi_u[j] * normal_vector) -</div>
<div class="line">               stokes_phi_p[j] * normal_vector) *</div>
<div class="line">              elasticity_phi[i] * stokes_fe_face_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q));</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="aclassFEValuesBase_html_a5b264d5b2fb6615f5dea7a21135ed1a5"><div class="ttname"><a href="classFEValuesBase.html#a5b264d5b2fb6615f5dea7a21135ed1a5">FEValuesBase::dofs_per_cell</a></div><div class="ttdeci">const unsigned int dofs_per_cell</div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values_8h_source.html#l02362">fe_values.h:2362</a></div></div>
<div class="ttc" id="aclassFEValuesBase_html_ac25ec6835799c3b6c7c842f8acb05eb3"><div class="ttname"><a href="classFEValuesBase.html#ac25ec6835799c3b6c7c842f8acb05eb3">FEValuesBase::normal_vector</a></div><div class="ttdeci">const Tensor&lt; 1, spacedim &gt; &amp; normal_vector(const unsigned int i) const</div></div>
<div class="ttc" id="anamespaceinternal_html_aa5bef221c94bc6b9c5441c306a72cdbaa2063c1608d6e0baf80249c42e2be5804"><div class="ttname"><a href="namespaceinternal.html#aa5bef221c94bc6b9c5441c306a72cdbaa2063c1608d6e0baf80249c42e2be5804">internal::EvaluatorQuantity::value</a></div><div class="ttdeci">@ value</div></div>
</div><!-- fragment --><p><a class="anchor" id="codeFluidStructureProblemsolvecode"></a></p><h4><code>FluidStructureProblem::solve</code></h4>
<p>正如介绍中所讨论的，我们在这里使用了一个相当琐碎的求解器：我们只是将线性系统传递给SparseDirectUMFPACK直接求解器（例如，见 <a class="el" href="step_29.html">step-29</a> ）。我们在求解后唯一要做的是确保悬挂的节点和边界值约束是正确的。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> FluidStructureProblem&lt;dim&gt;::solve()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a> direct_solver;</div>
<div class="line">  direct_solver.<a class="code" href="classSparseDirectUMFPACK.html#a25b1d3c7dbb88158a76165a4a56a16d6">initialize</a>(system_matrix);</div>
<div class="line">  direct_solver.<a class="code" href="classSparseDirectUMFPACK.html#adc154e4830b0e16be265f10a5c8b7103">vmult</a>(solution, system_rhs);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  constraints.distribute(solution);</div>
<div class="line">}</div>
<div class="ttc" id="aclassSparseDirectUMFPACK_html"><div class="ttname"><a href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a></div><div class="ttdef"><b>Definition:</b> <a href="sparse__direct_8h_source.html#l00087">sparse_direct.h:88</a></div></div>
<div class="ttc" id="aclassSparseDirectUMFPACK_html_a25b1d3c7dbb88158a76165a4a56a16d6"><div class="ttname"><a href="classSparseDirectUMFPACK.html#a25b1d3c7dbb88158a76165a4a56a16d6">SparseDirectUMFPACK::initialize</a></div><div class="ttdeci">void initialize(const SparsityPattern &amp;sparsity_pattern)</div><div class="ttdef"><b>Definition:</b> <a href="sparse__direct_8cc_source.html#l00049">sparse_direct.cc:49</a></div></div>
<div class="ttc" id="aclassSparseDirectUMFPACK_html_adc154e4830b0e16be265f10a5c8b7103"><div class="ttname"><a href="classSparseDirectUMFPACK.html#adc154e4830b0e16be265f10a5c8b7103">SparseDirectUMFPACK::vmult</a></div><div class="ttdeci">void vmult(Vector&lt; double &gt; &amp;dst, const Vector&lt; double &gt; &amp;src) const</div><div class="ttdef"><b>Definition:</b> <a href="sparse__direct_8cc_source.html#l00762">sparse_direct.cc:762</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="codeFluidStructureProblemoutput_resultscode"></a> </p><h4><code>FluidStructureProblem::output_results</code></h4>
<p>生成图形输出在这里是相当微不足道的：我们所要做的就是确定解向量的哪些分量属于标量和/或向量（例如，见 <a class="el" href="step_22.html">step-22</a> 之前的例子），然后把它全部传递给DataOut类。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> FluidStructureProblem&lt;dim&gt;::output_results(</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  std::vector&lt;std::string&gt; solution_names(dim, <span class="stringliteral">&quot;velocity&quot;</span>);</div>
<div class="line">  solution_names.emplace_back(<span class="stringliteral">&quot;pressure&quot;</span>);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> &lt; dim; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;displacement&quot;</span>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">    data_component_interpretation(</div>
<div class="line">      dim, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa783915dbc182d5a49e111815fd23fe0">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line">  data_component_interpretation.push_back(</div>
<div class="line">    <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a1f3cd50135818a6458f1d3ff7ea4bb51">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> &lt; dim; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa783915dbc182d5a49e111815fd23fe0">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#ac1eb26168177faa30ffbcf9cbb9c3cd5">attach_dof_handler</a>(dof_handler);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">add_data_vector</a>(solution,</div>
<div class="line">                           solution_names,</div>
<div class="line">                           <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div>
<div class="line">                           data_component_interpretation);</div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#a5eb51872b8736849bb7e8d2007fae086">build_patches</a>();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  std::ofstream output(</div>
<div class="line">    <span class="stringliteral">&quot;solution-&quot;</span> + <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(refinement_cycle, 2) + <span class="stringliteral">&quot;.vtk&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="group__Exceptions.html#gacad99726038e4fca7f605fdffb3317e4">write_vtk</a>(output);</div>
<div class="line">}</div>
<div class="ttc" id="aclassDataOut__DoFData_html_ac1eb26168177faa30ffbcf9cbb9c3cd5"><div class="ttname"><a href="classDataOut__DoFData.html#ac1eb26168177faa30ffbcf9cbb9c3cd5">DataOut_DoFData::attach_dof_handler</a></div><div class="ttdeci">void attach_dof_handler(const DoFHandlerType &amp;)</div></div>
<div class="ttc" id="aclassDataOut__DoFData_html_ace4b76e565ba0701c4d32c26075ed3b9"><div class="ttname"><a href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">DataOut_DoFData::add_data_vector</a></div><div class="ttdeci">void add_data_vector(const VectorType &amp;data, const std::vector&lt; std::string &gt; &amp;names, const DataVectorType type=type_automatic, const std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt; &amp;data_component_interpretation=std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="data__out__dof__data_8h_source.html#l01087">data_out_dof_data.h:1087</a></div></div>
<div class="ttc" id="aclassDataOut_html"><div class="ttname"><a href="classDataOut.html">DataOut</a></div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out_8h_source.html#l00147">data_out.h:150</a></div></div>
<div class="ttc" id="aclassDataOut_html_a5eb51872b8736849bb7e8d2007fae086"><div class="ttname"><a href="classDataOut.html#a5eb51872b8736849bb7e8d2007fae086">DataOut::build_patches</a></div><div class="ttdeci">virtual void build_patches(const unsigned int n_subdivisions=0)</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out_8cc_source.html#l01085">data_out.cc:1085</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_gacad99726038e4fca7f605fdffb3317e4"><div class="ttname"><a href="group__Exceptions.html#gacad99726038e4fca7f605fdffb3317e4">DataOutInterface::write_vtk</a></div><div class="ttdeci">void write_vtk(std::ostream &amp;out) const</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8cc_source.html#l07177">data_out_base.cc:7177</a></div></div>
<div class="ttc" id="anamespaceDataComponentInterpretation_html_a0cd2da3afe902f9004c23a73dbcc8ab0a1f3cd50135818a6458f1d3ff7ea4bb51"><div class="ttname"><a href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a1f3cd50135818a6458f1d3ff7ea4bb51">DataComponentInterpretation::component_is_scalar</a></div><div class="ttdeci">@ component_is_scalar</div><div class="ttdef"><b>Definition:</b> <a href="data__component__interpretation_8h_source.html#l00053">data_component_interpretation.h:53</a></div></div>
<div class="ttc" id="anamespaceDataComponentInterpretation_html_a0cd2da3afe902f9004c23a73dbcc8ab0aa783915dbc182d5a49e111815fd23fe0"><div class="ttname"><a href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa783915dbc182d5a49e111815fd23fe0">DataComponentInterpretation::component_is_part_of_vector</a></div><div class="ttdeci">@ component_is_part_of_vector</div><div class="ttdef"><b>Definition:</b> <a href="data__component__interpretation_8h_source.html#l00059">data_component_interpretation.h:59</a></div></div>
<div class="ttc" id="anamespaceUtilities_html_a6195c5f009ea8c7c536c6ffdf108c32f"><div class="ttname"><a href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a></div><div class="ttdeci">std::string int_to_string(const unsigned int value, const unsigned int digits=numbers::invalid_unsigned_int)</div><div class="ttdef"><b>Definition:</b> <a href="base_2utilities_8cc_source.html#l00473">utilities.cc:473</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="codeFluidStructureProblemrefine_meshcode"></a> </p><h4><code>FluidStructureProblem::refine_mesh</code></h4>
<p>下一步是细化网格。正如在介绍中所讨论的，这有点棘手，主要是因为流体和固体子域使用的变量具有不同的物理尺寸，因此误差估计的绝对大小不能直接比较。因此，我们将不得不对它们进行缩放。因此，在函数的顶部，我们首先分别计算不同变量的误差估计值（在流体域中使用速度而不是压力，在固体域中使用位移）。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> FluidStructureProblem&lt;dim&gt;::refine_mesh()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> stokes_estimated_error_per_cell(</div>
<div class="line">    <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells());</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> elasticity_estimated_error_per_cell(</div>
<div class="line">    <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss</a>&lt;dim - 1&gt; stokes_face_quadrature(stokes_degree + 2);</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss</a>&lt;dim - 1&gt; elasticity_face_quadrature(elasticity_degree + 2);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classhp_1_1QCollection.html">hp::QCollection</a>&lt;dim - 1&gt; face_q_collection;</div>
<div class="line">  face_q_collection.<a class="code" href="classhp_1_1QCollection.html#a87ec95076ccc4b7c10fa24523bb926df">push_back</a>(stokes_face_quadrature);</div>
<div class="line">  face_q_collection.push_back(elasticity_face_quadrature);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div>
<div class="line">  <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div>
<div class="line">    dof_handler,</div>
<div class="line">    face_q_collection,</div>
<div class="line">    std::map&lt;<a class="code" href="namespacetypes.html#aed8813fee8c8a2edcc6005e6a48c321a">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(),</div>
<div class="line">    solution,</div>
<div class="line">    stokes_estimated_error_per_cell,</div>
<div class="line">    fe_collection.component_mask(velocities));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> displacements(dim + 1);</div>
<div class="line">  <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div>
<div class="line">    dof_handler,</div>
<div class="line">    face_q_collection,</div>
<div class="line">    std::map&lt;<a class="code" href="namespacetypes.html#aed8813fee8c8a2edcc6005e6a48c321a">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(),</div>
<div class="line">    solution,</div>
<div class="line">    elasticity_estimated_error_per_cell,</div>
<div class="line">    fe_collection.component_mask(displacements));</div>
</div><!-- fragment --><p>然后我们将误差估计值除以其常数进行归一化处理，并将流体误差指标按导言中讨论的4的系数进行缩放。然后将结果加在一起，形成一个包含所有单元的误差指标的向量。</p>
<div class="fragment"><div class="line">stokes_estimated_error_per_cell *=</div>
<div class="line">  4. / stokes_estimated_error_per_cell.l2_norm();</div>
<div class="line">elasticity_estimated_error_per_cell *=</div>
<div class="line">  1. / elasticity_estimated_error_per_cell.l2_norm();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">estimated_error_per_cell += stokes_estimated_error_per_cell;</div>
<div class="line">estimated_error_per_cell += elasticity_estimated_error_per_cell;</div>
</div><!-- fragment --><p>在实际细化网格之前，函数的倒数第二部分涉及到我们在介绍中已经提到的启发式方法：由于解是不连续的，KellyErrorEstimator类会对位于子域之间边界的单元感到困惑：它认为那里的误差大是因为梯度的跳跃大，尽管这完全是预期的，事实上在精确解中也存在这一特征，因此不表明任何数值误差。 <br  />
</p>
<p>因此，我们将界面上的所有单元的误差指标设置为零；决定影响哪些单元的条件略显尴尬，因为我们必须考虑到自适应细化网格的可能性，这意味着邻近的单元可能比当前的单元更粗，或者事实上可能被细化一些。这些嵌套条件的结构与我们在 <code>assemble_system</code> 中组装界面条款时遇到的情况大致相同。</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.active_cell_iterators())</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> f : cell-&gt;face_indices())</div>
<div class="line">      <span class="keywordflow">if</span> (cell_is_in_solid_domain(cell))</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">if</span> ((cell-&gt;at_boundary(f) == <span class="keyword">false</span>) &amp;&amp;</div>
<div class="line">              (((cell-&gt;neighbor(f)-&gt;level() == cell-&gt;level()) &amp;&amp;</div>
<div class="line">                (cell-&gt;neighbor(f)-&gt;has_children() == <span class="keyword">false</span>) &amp;&amp;</div>
<div class="line">                cell_is_in_fluid_domain(cell-&gt;neighbor(f))) ||</div>
<div class="line">               ((cell-&gt;neighbor(f)-&gt;level() == cell-&gt;level()) &amp;&amp;</div>
<div class="line">                (cell-&gt;neighbor(f)-&gt;has_children() == <span class="keyword">true</span>) &amp;&amp;</div>
<div class="line">                (cell_is_in_fluid_domain(</div>
<div class="line">                  cell-&gt;neighbor_child_on_subface(f, 0)))) ||</div>
<div class="line">               (cell-&gt;neighbor_is_coarser(f) &amp;&amp;</div>
<div class="line">                cell_is_in_fluid_domain(cell-&gt;neighbor(f)))))</div>
<div class="line">            estimated_error_per_cell(cell-&gt;active_cell_index()) = 0;</div>
<div class="line">        }</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">if</span> ((cell-&gt;at_boundary(f) == <span class="keyword">false</span>) &amp;&amp;</div>
<div class="line">              (((cell-&gt;neighbor(f)-&gt;level() == cell-&gt;level()) &amp;&amp;</div>
<div class="line">                (cell-&gt;neighbor(f)-&gt;has_children() == <span class="keyword">false</span>) &amp;&amp;</div>
<div class="line">                cell_is_in_solid_domain(cell-&gt;neighbor(f))) ||</div>
<div class="line">               ((cell-&gt;neighbor(f)-&gt;level() == cell-&gt;level()) &amp;&amp;</div>
<div class="line">                (cell-&gt;neighbor(f)-&gt;has_children() == <span class="keyword">true</span>) &amp;&amp;</div>
<div class="line">                (cell_is_in_solid_domain(</div>
<div class="line">                  cell-&gt;neighbor_child_on_subface(f, 0)))) ||</div>
<div class="line">               (cell-&gt;neighbor_is_coarser(f) &amp;&amp;</div>
<div class="line">                cell_is_in_solid_domain(cell-&gt;neighbor(f)))))</div>
<div class="line">            estimated_error_per_cell(cell-&gt;active_cell_index()) = 0;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceGridRefinement.html#a48e5395381ed87155942a61a1edd134d">GridRefinement::refine_and_coarsen_fixed_number</a>(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>,</div>
<div class="line">                                                  estimated_error_per_cell,</div>
<div class="line">                                                  0.3,</div>
<div class="line">                                                  0.0);</div>
<div class="line">  <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">}</div>
<div class="ttc" id="anamespaceGridRefinement_html_a48e5395381ed87155942a61a1edd134d"><div class="ttname"><a href="namespaceGridRefinement.html#a48e5395381ed87155942a61a1edd134d">GridRefinement::refine_and_coarsen_fixed_number</a></div><div class="ttdeci">void refine_and_coarsen_fixed_number(Triangulation&lt; dim, spacedim &gt; &amp;triangulation, const Vector&lt; Number &gt; &amp;criteria, const double top_fraction_of_cells, const double bottom_fraction_of_cells, const unsigned int max_n_cells=std::numeric_limits&lt; unsigned int &gt;::max())</div><div class="ttdef"><b>Definition:</b> <a href="grid_2grid__refinement_8cc_source.html#l00322">grid_refinement.cc:322</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="codeFluidStructureProblemruncode"></a> </p><h4><code>FluidStructureProblem::run</code></h4>
<p>像往常一样，这是控制整个操作流程的函数。如果你读过教程程序 <a class="el" href="step_1.html">step-1</a> 到 <a class="el" href="step_6.html">step-6</a> ，例如，那么你已经对以下结构相当熟悉。</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">FluidStructureProblem&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    make_grid();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle = 0; refinement_cycle &lt; 10 - 2 * dim;</div>
<div class="line">         ++refinement_cycle)</div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Refinement cycle &quot;</span> &lt;&lt; refinement_cycle &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (refinement_cycle &gt; 0)</div>
<div class="line">          refine_mesh();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        setup_dofs();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Assembling...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        assemble_system();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        solve();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Writing output...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        output_results(refinement_cycle);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step46</span></div>
</div><!-- fragment --><p><a class="anchor" id="Thecodemaincodefunction"></a> </p><h4>The <code>main()</code> function</h4>
<p>这个，也就是最后的函数，包含的内容几乎与其他大多数教程程序的内容完全一样。</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span>Step46;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      FluidStructureProblem&lt;2&gt; flow_problem(1, 1);</div>
<div class="line">      flow_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Results"></a> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p><a class="anchor" id="2dresults"></a></p><h3>2d results</h3>
<p>当运行该程序时，你应该得到如下的输出。</p>
<div class="fragment"><div class="line">Refinement cycle 0</div>
<div class="line">   Number of active cells: 64</div>
<div class="line">   Number of degrees of freedom: 531</div>
<div class="line">   Assembling...</div>
<div class="line">   Solving...</div>
<div class="line">   Writing output...</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Refinement cycle 1</div>
<div class="line">   Number of active cells: 136</div>
<div class="line">   Number of degrees of freedom: 1260</div>
<div class="line">   Assembling...</div>
<div class="line">   Solving...</div>
<div class="line">   Writing output...</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Refinement cycle 2</div>
<div class="line">   Number of active cells: 436</div>
<div class="line">   Number of degrees of freedom: 3723</div>
<div class="line">   Assembling...</div>
<div class="line">   Solving...</div>
<div class="line">   Writing output...</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Refinement cycle 3</div>
<div class="line">   Number of active cells: 1072</div>
<div class="line">   Number of degrees of freedom: 7493</div>
<div class="line">   Assembling...</div>
<div class="line">   Solving...</div>
<div class="line">   Writing output...</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Refinement cycle 4</div>
<div class="line">   Number of active cells: 2632</div>
<div class="line">   Number of degrees of freedom: 15005</div>
<div class="line">   Assembling...</div>
<div class="line">   Solving...</div>
<div class="line">   Writing output...</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Refinement cycle 5</div>
<div class="line">   Number of active cells: 5944</div>
<div class="line">   Number of degrees of freedom: 29437</div>
<div class="line">   Assembling...</div>
<div class="line">   Solving...</div>
<div class="line">   Writing output...</div>
</div><!-- fragment --><p>结果很容易就能看出来。</p>
<table width="80%" align="center">
<tr valign="top">
<td valign="top" align="center"><p class="starttd" align="center"><img src="https://www.dealii.org/images/steps/developer/step-46.9.2.velocity-2d.png" alt="" class="inline"/> </p>
<p class="intertd">Magnitude and vectors for the fluid velocity. </p>
<p class="endtd"></p>
</td><td valign="top" align="center"><p class="starttd" align="center"><img src="https://www.dealii.org/images/steps/developer/step-46.9.2.pressure-2d.png" alt="" class="inline"/> </p>
<p class="intertd">Fluid pressure. The dynamic range has been truncated to cut off the pressure singularities at the top left and right corners of the domain as well as the top corners of the solid that forms re-entrant corners into the fluid domain. </p>
<p class="endtd"></p>
</td><td valign="top" align="center"><p class="starttd" align="center"><img src="https://www.dealii.org/images/steps/developer/step-46.9.2.displacement-2d.png" alt="" class="inline"/> </p>
<p class="intertd">Magnitude and vectors for the solid displacement. </p>
<p class="endtd"></p>
</td></tr>
</table>
<p><br  />
</p>
<p>图形很容易解释：当水流在固体直立部分的左侧向下、右侧向上时，它产生的压力在左侧高、右侧低，这些力量使固体的垂直部分向右弯曲。</p>
<p><a class="anchor" id="3dresults"></a></p><h3>3d results</h3>
<p>通过将 <code>main()</code> 中的 <code>FluidStructureProblem</code> 类的尺寸改为3，我们也可以运行同样的问题3D。你会得到如下的输出。</p>
<div class="fragment"><div class="line">Refinement cycle 0</div>
<div class="line">   Number of active cells: 512</div>
<div class="line">   Number of degrees of freedom: 11631</div>
<div class="line">   Assembling...</div>
<div class="line">   Solving...</div>
<div class="line">   Writing output...</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Refinement cycle 1</div>
<div class="line">   Number of active cells: 1716</div>
<div class="line">   Number of degrees of freedom: 48984</div>
<div class="line">   Assembling...</div>
<div class="line">   Solving...</div>
<div class="line">   Writing output...</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Refinement cycle 2</div>
<div class="line">   Number of active cells: 8548</div>
<div class="line">   Number of degrees of freedom: 245746</div>
<div class="line">   Assembling...</div>
<div class="line">   Solving...</div>
</div><!-- fragment --><p>你会注意到，最大的瓶颈是求解器。SparseDirectUmfpack在2016年的工作站上解决这个问题的最后一次迭代需要将近5个小时和大约80GB的内存（倒数第二次迭代只需要16分钟）。显然，这里需要一个更好的求解器，这个话题在下面讨论。</p>
<p>结果也可以被可视化，并产生良好的图片。这里有一张，显示了速度的矢量图（橙色），实体位移（蓝色），以及实体区域的阴影。</p>
<p align="center"></p>
<p><img src="https://www.dealii.org/images/steps/developer/step-46.9.2.3d.png" alt="" class="inline"/> </p>
<p><br  />
</p>
<p>除了缺乏一个好的求解器外，网格也有点不平衡：网格细化严重偏向于流体子域（在2D中，情况正好相反，促使我们对流体误差指标的权重更高）。显然，如果想继续做更多的三维计算，对两个子域中误差指标的相对重要性进行一些调整是很重要的。</p>
<p><a class="anchor" id="extensions"></a> <a class="anchor" id="Possibilitiesforextensions"></a></p><h3>Possibilities for extensions</h3>
<p><a class="anchor" id="Linearsolversandpreconditioners"></a></p><h4>Linear solvers and preconditioners</h4>
<p>改进程序的一个明显的地方是使用一个更复杂的求解器&amp;mdash；特别是一个能很好地扩展并能解决现实的三维问题的求解器。这在这里其实不难实现，因为从流体到固体是单向耦合的。为此，假设我们对自由度进行了重新排序，首先是所有的速度和压力自由度，然后是所有的位移（这很容易用 <a class="el" href="namespaceDoFRenumbering.html#a52c1941406d1ce2937e29a46edf111f4">DoFRenumbering::component_wise</a>). 实现），那么系统矩阵可以分成以下的块状形式。 </p><p class="formulaDsp">
\[ A_\text{global} = \begin{pmatrix} A_{\text{fluid}} &amp; 0 \\ B &amp; A_{\text{solid}} \end{pmatrix} \]
</p>
<p> 其中 \(A_{\text{fluid}}\) 是速度和压力的斯托克斯矩阵（它可以进一步细分为 <a class="el" href="step_22.html">step-22</a> 中的 \(2\times 2\) 矩阵，尽管这对目前的目的并不重要）， \(A_{\text{solid}}\) 是位移的弹性方程的结果，而 \(B\) 是来自界面条件的矩阵。现在注意到，矩阵 </p><p class="formulaDsp">
\[ A_\text{global}^{-1} = \begin{pmatrix} A_{\text{fluid}}^{-1} &amp; 0 \\ -A_\text{solid}^{-1} B A_\text{fluid}^{-1} &amp; A_{\text{solid}}^{-1} \end{pmatrix} \]
</p>
<p>是 \(A_\text{global}\) 的逆。应用这个矩阵只需要用 \(A_\text{fluid}\) 和 \(A_\text{solid}\) 各解一次，因为 </p><p class="formulaDsp">
\[ \begin{pmatrix} p_x \\ p_y \end{pmatrix} = \begin{pmatrix} A_{\text{fluid}}^{-1} &amp; 0 \\ -A_\text{solid}^{-1} B A_\text{fluid}^{-1} &amp; A_{\text{solid}}^{-1} \end{pmatrix} \begin{pmatrix} x \\ y \end{pmatrix} \]
</p>
<p>可以被计算为 \(p_x = A_{\text{fluid}}^{-1} x\) ，然后是 \(p_y = A_{\text{solid}}^{-1} (y-Bp_x)\) 。</p>
<p>因此，我们可以预期，如果 \(\widetilde{A_{\text{fluid}}^{-1}} \approx A_{\text{fluid}}^{-1}, \widetilde{A_{\text{solid}}^{-1}} \approx A_{\text{solid}}^{-1}\) ， </p><p class="formulaDsp">
\[ \widetilde{A_\text{global}^{-1}} = \begin{pmatrix} \widetilde{A_{\text{fluid}}^{-1}} &amp; 0 \\ -\widetilde{A_\text{solid}^{-1}} B \widetilde{A_\text{fluid}^{-1}} &amp; \widetilde{A_{\text{solid}}^{-1}} \end{pmatrix} \]
</p>
<p>将是一个好的预处理程序。</p>
<p>这意味着，我们只需要为斯托克斯和弹性方程分别提供良好的预处理。这些都是众所周知的：对于斯托克斯，我们可以使用 <a class="el" href="step_22.html">step-22</a> 的结果部分所讨论的预处理器；对于弹性，一个好的预处理器将是一个几何或代数多重网格的单一V形周期。然而，还有更多的问题有待解决。对于由两个子调节器构建的 "优化 "求解器块-三角调节器，经常出现的一点是，在为子调节器选择参数时，单独解决两个问题时效果好的值，在组合成多物理学调节器时可能不是最佳值。 特别是，当单独解决固体或流体力学问题时，在收敛所需的迭代次数和每次迭代应用预调节器的成本之间进行平衡，可能导致人们为斯托克斯问题选择昂贵的预调节器，为弹性问题选择便宜的预调节器（或者反之）。 然而，当结合在一起时，还有一个额外的约束，即你希望两个子预处理程序以大致相同的速度收敛，否则，便宜的预处理程序可能会增加全局的迭代次数，而昂贵的预处理程序则会增加每迭代的成本。例如，虽然单一的AMG V-循环本身是一个很好的弹性方法，但当结合到一个多物理问题时，可能会有动力使用一个完整的W-循环或多个循环来帮助降低总求解时间。</p>
<p><a class="anchor" id="Refinementindicators"></a></p><h4>Refinement indicators</h4>
<p>正如介绍中提到的，我们在这个程序中使用的细化指标是相当临时的。一个更好的会明白，解的梯度在界面上的跳跃并不表示错误，而是可以预期的，并且在积分跳跃项的时候忽略界面。然而，这并不是KellyErrorEstimator类所做的。另一个更大的问题是，这种估计器首先是否是一个好的策略：例如，如果我们想在位移的某个特定方面（例如实体右上角的位移）有最大的准确性，那么将流体和实体的误差指标放大到相同的程度是否合适？也许有必要用比固体更高的精度来解决流体问题，因为流体的解决方案直接影响到固体的解决方案？也许恰恰相反？</p>
<p>因此，改进程序的一个明显的可能性是实施一个更好的细化标准。关于这个问题有一些文献；Thomas Wick的论文 "Adaptive finite elements for monolithic fluid-structure interaction on a prolongated domain "是各种可能的起点之一。应用于心脏瓣膜模拟"，2011年机械学计算机方法会议论文集（CMM-2011），2011年5月9-12日，波兰华沙。</p>
<p><a class="anchor" id="Verification"></a></p><h4>Verification</h4>
<p>上面的结果纯粹是定性的，因为没有证据表明我们的方案实际上是收敛的。因此，一个显而易见的事情是增加一些定量的措施来检查该方案至少收敛到<em>something</em>。例如，我们可以为每个细化周期输出实体的右上角突出到流体子域的部分的偏移。或者我们可以计算出流体对实体施加的净力向量或扭矩。</p>
<p><a class="anchor" id="Bettermodels"></a></p><h4>Better models</h4>
<p>在现实中，大多数流体结构的相互作用问题是这样的，即固体的运动确实影响到流体的流动。例如，空气在气箔周围的作用力导致它弯曲并改变其形状。同样地，一面旗子在风中飘动，完全改变了它的形状。</p>
<p>这种双向耦合的问题通常在任意拉格朗日欧拉（ALE）框架中处理，其中固体的位移以某种平滑的方式扩展到流体领域，而不是像我们在这里做的那样以零为单位。然后，扩展的位移场被用来对我们计算流体流动的网格进行变形。此外，界面上流体的边界条件不再是速度为零；相反，在一个时间相关的程序中，流体速度必须等于沿界面的位移的时间导数。<a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2011 - 2020 by the deal.II authors</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div>
<div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div>
<div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div>
<div class="line"><span class="comment"> * the top level directory of deal.II.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Author: Wolfgang Bangerth, Texas A&amp;M University, 2011</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparse__matrix_8h.html">deal.II/lac/sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparse__direct_8h.html">deal.II/lac/sparse_direct.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__nothing_8h.html">deal.II/fe/fe_nothing.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__system_8h.html">deal.II/fe/fe_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__collection_8h.html">deal.II/hp/fe_collection.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="hp_2fe__values_8h.html">deal.II/hp/fe_values.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>Step46</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>FluidStructureProblem</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    FluidStructureProblem(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> stokes_degree,</div>
<div class="line">                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> elasticity_degree);</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">enum</span></div>
<div class="line">    {</div>
<div class="line">      fluid_domain_id,</div>
<div class="line">      solid_domain_id</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">bool</span> cell_is_in_fluid_domain(</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler&lt;dim&gt;::cell_iterator</a> &amp;cell);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">bool</span> cell_is_in_solid_domain(</div>
<div class="line">      <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler&lt;dim&gt;::cell_iterator</a> &amp;cell);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> make_grid();</div>
<div class="line">    <span class="keywordtype">void</span> set_active_fe_indices();</div>
<div class="line">    <span class="keywordtype">void</span> setup_dofs();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_system();</div>
<div class="line">    <span class="keywordtype">void</span> assemble_interface_term(</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classFEFaceValuesBase.html">FEFaceValuesBase&lt;dim&gt;</a> &amp;         elasticity_fe_face_values,</div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="classFEFaceValuesBase.html">FEFaceValuesBase&lt;dim&gt;</a> &amp;         stokes_fe_face_values,</div>
<div class="line">      std::vector&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;         elasticity_phi,</div>
<div class="line">      std::vector&lt;<a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a>&gt; &amp;stokes_symgrad_phi_u,</div>
<div class="line">      std::vector&lt;double&gt; &amp;                 stokes_phi_p,</div>
<div class="line">      <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> &amp;                  local_interface_matrix) <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">void</span> solve();</div>
<div class="line">    <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle) <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">void</span> refine_mesh();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> stokes_degree;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> elasticity_degree;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a>    <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div>
<div class="line">    <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>         stokes_fe;</div>
<div class="line">    <a class="code" href="classFESystem.html">FESystem&lt;dim&gt;</a>         elasticity_fe;</div>
<div class="line">    <a class="code" href="classhp_1_1FECollection.html">hp::FECollection&lt;dim&gt;</a> fe_collection;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>       dof_handler;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      sparsity_pattern;</div>
<div class="line">    <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> solution;</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> system_rhs;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> viscosity;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="group__Exceptions.html#gga841a7b84dc17bf2ba675522093a97e8ba945f3fc449518a73b9f5f32868db466c">lambda</a>;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacemu.html">mu</a>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>StokesBoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    StokesBoundaryValues()</div>
<div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;(dim + 1 + dim)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="namespaceinternal.html#aa5bef221c94bc6b9c5441c306a72cdbaa2063c1608d6e0baf80249c42e2be5804">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div>
<div class="line">                              <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  value) <span class="keyword">const override</span>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> StokesBoundaryValues&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div>
<div class="line">                                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(component &lt; this-&gt;n_components,</div>
<div class="line">           <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(component, 0, this-&gt;n_components));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (component == dim - 1)</div>
<div class="line">      <span class="keywordflow">switch</span> (dim)</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">case</span> 2:</div>
<div class="line">            <span class="keywordflow">return</span> <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">std::sin</a>(<a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a> * p[0]);</div>
<div class="line">          <span class="keywordflow">case</span> 3:</div>
<div class="line">            <span class="keywordflow">return</span> <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">std::sin</a>(<a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a> * p[0]) * <a class="code" href="numbers_8h.html#a27989bdc7b4b828564982787d126bd91">std::sin</a>(<a class="code" href="namespacenumbers.html#a3e24f194a9cb9b6ff4442b8a7a877d4a">numbers::PI</a> * p[1]);</div>
<div class="line">          <span class="keywordflow">default</span>:</div>
<div class="line">            <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> StokesBoundaryValues&lt;dim&gt;::vector_value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp;p,</div>
<div class="line">                                               <a class="code" href="classVector.html">Vector&lt;double&gt;</a> &amp;  <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">values</a>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; this-&gt;n_components; ++c)</div>
<div class="line">      <a class="code" href="namespaceEvaluationFlags.html#a9b7c6d689cb76386839d0d13640f59aeaf9825c682f693a6a200094641a0d6a58">values</a>(c) = StokesBoundaryValues&lt;dim&gt;::value(p, c);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  FluidStructureProblem&lt;dim&gt;::FluidStructureProblem(</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> stokes_degree,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> elasticity_degree)</div>
<div class="line">    : stokes_degree(stokes_degree)</div>
<div class="line">    , elasticity_degree(elasticity_degree)</div>
<div class="line">    , <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>(<a class="code" href="classTriangulation.html">Triangulation</a>&lt;dim&gt;::maximum_smoothing)</div>
<div class="line">    , stokes_fe(<a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(stokes_degree + 1),</div>
<div class="line">                dim,</div>
<div class="line">                <a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(stokes_degree),</div>
<div class="line">                1,</div>
<div class="line">                <a class="code" href="classFE__Nothing.html">FE_Nothing</a>&lt;dim&gt;(),</div>
<div class="line">                dim)</div>
<div class="line">    , elasticity_fe(<a class="code" href="classFE__Nothing.html">FE_Nothing</a>&lt;dim&gt;(),</div>
<div class="line">                    dim,</div>
<div class="line">                    <a class="code" href="classFE__Nothing.html">FE_Nothing</a>&lt;dim&gt;(),</div>
<div class="line">                    1,</div>
<div class="line">                    <a class="code" href="classFE__Q.html">FE_Q</a>&lt;dim&gt;(elasticity_degree),</div>
<div class="line">                    dim)</div>
<div class="line">    , dof_handler(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>)</div>
<div class="line">    , viscosity(2)</div>
<div class="line">    , <a class="code" href="group__Exceptions.html#gga841a7b84dc17bf2ba675522093a97e8ba945f3fc449518a73b9f5f32868db466c">lambda</a>(1)</div>
<div class="line">    , <a class="code" href="namespacemu.html">mu</a>(1)</div>
<div class="line">  {</div>
<div class="line">    fe_collection.push_back(stokes_fe);</div>
<div class="line">    fe_collection.push_back(elasticity_fe);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">bool</span> FluidStructureProblem&lt;dim&gt;::cell_is_in_fluid_domain(</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler&lt;dim&gt;::cell_iterator</a> &amp;cell)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">return</span> (cell-&gt;material_id() == fluid_domain_id);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">bool</span> FluidStructureProblem&lt;dim&gt;::cell_is_in_solid_domain(</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="group__Iterators.html#ga32b2a057d9abd2e1752bf8a3cb88e644">DoFHandler&lt;dim&gt;::cell_iterator</a> &amp;cell)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">return</span> (cell-&gt;material_id() == solid_domain_id);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> FluidStructureProblem&lt;dim&gt;::make_grid()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="namespaceGridGenerator.html#a358d5bd545bc115c8645d93fa79b64bc">GridGenerator::subdivided_hyper_cube</a>(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>, 8, -1, 1);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.active_cell_iterators())</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;face : cell-&gt;face_iterators())</div>
<div class="line">        <span class="keywordflow">if</span> (face-&gt;at_boundary() &amp;&amp; (face-&gt;center()[dim - 1] == 1))</div>
<div class="line">          face-&gt;set_all_boundary_ids(1);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.active_cell_iterators())</div>
<div class="line">      <span class="keywordflow">if</span> (((<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(cell-&gt;center()[0]) &lt; 0.25) &amp;&amp;</div>
<div class="line">           (cell-&gt;center()[dim - 1] &gt; 0.5)) ||</div>
<div class="line">          ((<a class="code" href="namespaceDifferentiation_1_1SD.html#a592560ee80355620422a86087f11b9df">std::fabs</a>(cell-&gt;center()[0]) &gt;= 0.25) &amp;&amp;</div>
<div class="line">           (cell-&gt;center()[dim - 1] &gt; -0.5)))</div>
<div class="line">        cell-&gt;set_material_id(fluid_domain_id);</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        cell-&gt;set_material_id(solid_domain_id);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> FluidStructureProblem&lt;dim&gt;::set_active_fe_indices()</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">if</span> (cell_is_in_fluid_domain(cell))</div>
<div class="line">          cell-&gt;set_active_fe_index(0);</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cell_is_in_solid_domain(cell))</div>
<div class="line">          cell-&gt;set_active_fe_index(1);</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(<span class="keyword">false</span>, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> FluidStructureProblem&lt;dim&gt;::setup_dofs()</div>
<div class="line">  {</div>
<div class="line">    set_active_fe_indices();</div>
<div class="line">    dof_handler.distribute_dofs(fe_collection);</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      constraints.clear();</div>
<div class="line">      <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div>
<div class="line">      <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                               1,</div>
<div class="line">                                               StokesBoundaryValues&lt;dim&gt;(),</div>
<div class="line">                                               constraints,</div>
<div class="line">                                               fe_collection.component_mask(</div>
<div class="line">                                                 velocities));</div>
<div class="line"> </div>
<div class="line">      <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> displacements(dim + 1);</div>
<div class="line">      <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(</div>
<div class="line">        dof_handler,</div>
<div class="line">        0,</div>
<div class="line">        <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a>(dim + 1 + dim),</div>
<div class="line">        constraints,</div>
<div class="line">        fe_collection.component_mask(displacements));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      std::vector&lt;types::global_dof_index&gt; local_face_dof_indices(</div>
<div class="line">        stokes_fe.n_dofs_per_face());</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.active_cell_iterators())</div>
<div class="line">        <span class="keywordflow">if</span> (cell_is_in_fluid_domain(cell))</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> face_no : cell-&gt;face_indices())</div>
<div class="line">            <span class="keywordflow">if</span> (cell-&gt;face(face_no)-&gt;at_boundary() == <span class="keyword">false</span>)</div>
<div class="line">              {</div>
<div class="line">                <span class="keywordtype">bool</span> face_is_on_interface = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> ((cell-&gt;neighbor(face_no)-&gt;has_children() == <span class="keyword">false</span>) &amp;&amp;</div>
<div class="line">                    (cell_is_in_solid_domain(cell-&gt;neighbor(face_no))))</div>
<div class="line">                  face_is_on_interface = <span class="keyword">true</span>;</div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cell-&gt;neighbor(face_no)-&gt;has_children() == <span class="keyword">true</span>)</div>
<div class="line">                  {</div>
<div class="line">                    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sf = 0;</div>
<div class="line">                         sf &lt; cell-&gt;face(face_no)-&gt;n_children();</div>
<div class="line">                         ++sf)</div>
<div class="line">                      <span class="keywordflow">if</span> (cell_is_in_solid_domain(</div>
<div class="line">                            cell-&gt;neighbor_child_on_subface(face_no, sf)))</div>
<div class="line">                        {</div>
<div class="line">                          face_is_on_interface = <span class="keyword">true</span>;</div>
<div class="line">                          <span class="keywordflow">break</span>;</div>
<div class="line">                        }</div>
<div class="line">                  }</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">if</span> (face_is_on_interface)</div>
<div class="line">                  {</div>
<div class="line">                    cell-&gt;face(face_no)-&gt;get_dof_indices(local_face_dof_indices,</div>
<div class="line">                                                         0);</div>
<div class="line">                    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; local_face_dof_indices.size();</div>
<div class="line">                         ++i)</div>
<div class="line">                      <span class="keywordflow">if</span> (stokes_fe.face_system_to_component_index(i).first &lt;</div>
<div class="line">                          dim)</div>
<div class="line">                        constraints.add_line(local_face_dof_indices[i]);</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    constraints.close();</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;   Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells()</div>
<div class="line">              &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.n_dofs()</div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">      <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.n_dofs(), dof_handler.n_dofs());</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> cell_coupling(fe_collection.n_components(),</div>
<div class="line">                                                 fe_collection.n_components());</div>
<div class="line">      <a class="code" href="classTable.html">Table&lt;2, DoFTools::Coupling&gt;</a> face_coupling(fe_collection.n_components(),</div>
<div class="line">                                                 fe_collection.n_components());</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = 0; c &lt; fe_collection.n_components(); ++c)</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> &lt; fe_collection.n_components(); ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">if</span> (((c &lt; dim + 1) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> &lt; dim + 1) &amp;&amp;</div>
<div class="line">                 !((c == dim) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> == dim))) ||</div>
<div class="line">                ((c &gt;= dim + 1) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> &gt;= dim + 1)))</div>
<div class="line">              cell_coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> ((c &gt;= dim + 1) &amp;&amp; (<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> &lt; dim + 1))</div>
<div class="line">              face_coupling[c][<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>] = <a class="code" href="namespaceDoFTools.html#ad31df71a29dd76de9b4ab241b2527160a6a742e14fbc92a1c202d77d4f319d5ec">DoFTools::always</a>;</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">      <a class="code" href="group__constraints.html#ga7b2627e9bde96b98d4fcf95b629e4fd4">DoFTools::make_flux_sparsity_pattern</a>(dof_handler,</div>
<div class="line">                                           dsp,</div>
<div class="line">                                           cell_coupling,</div>
<div class="line">                                           face_coupling);</div>
<div class="line">      constraints.condense(dsp);</div>
<div class="line">      sparsity_pattern.copy_from(dsp);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    system_matrix.reinit(sparsity_pattern);</div>
<div class="line"> </div>
<div class="line">    solution.reinit(dof_handler.n_dofs());</div>
<div class="line">    system_rhs.reinit(dof_handler.n_dofs());</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> FluidStructureProblem&lt;dim&gt;::assemble_system()</div>
<div class="line">  {</div>
<div class="line">    system_matrix = 0;</div>
<div class="line">    system_rhs    = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> stokes_quadrature(stokes_degree + 2);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> elasticity_quadrature(elasticity_degree + 2);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classhp_1_1QCollection.html">hp::QCollection&lt;dim&gt;</a> q_collection;</div>
<div class="line">    q_collection.<a class="code" href="classhp_1_1QCollection.html#a87ec95076ccc4b7c10fa24523bb926df">push_back</a>(stokes_quadrature);</div>
<div class="line">    q_collection.<a class="code" href="classhp_1_1QCollection.html#a87ec95076ccc4b7c10fa24523bb926df">push_back</a>(elasticity_quadrature);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classhp_1_1FEValues.html">hp::FEValues&lt;dim&gt;</a> hp_fe_values(fe_collection,</div>
<div class="line">                                   q_collection,</div>
<div class="line">                                   <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                                     <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> | <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss</a>&lt;dim - 1&gt; common_face_quadrature(</div>
<div class="line">      <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">std::max</a>(stokes_degree + 2, elasticity_degree + 2));</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a>    stokes_fe_face_values(stokes_fe,</div>
<div class="line">                                            common_face_quadrature,</div>
<div class="line">                                            <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> |</div>
<div class="line">                                              <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> | <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">    <a class="code" href="classFEFaceValues.html">FEFaceValues&lt;dim&gt;</a>    elasticity_fe_face_values(elasticity_fe,</div>
<div class="line">                                                common_face_quadrature,</div>
<div class="line">                                                <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                                  <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">    <a class="code" href="classFESubfaceValues.html">FESubfaceValues&lt;dim&gt;</a> stokes_fe_subface_values(stokes_fe,</div>
<div class="line">                                                  common_face_quadrature,</div>
<div class="line">                                                  <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> |</div>
<div class="line">                                                    <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                                    <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line">    <a class="code" href="classFESubfaceValues.html">FESubfaceValues&lt;dim&gt;</a> elasticity_fe_subface_values(elasticity_fe,</div>
<div class="line">                                                      common_face_quadrature,</div>
<div class="line">                                                      <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa5e7366a91c84a50ca4e7dbd43ca6369f">update_normal_vectors</a> |</div>
<div class="line">                                                        <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> stokes_dofs_per_cell = stokes_fe.n_dofs_per_cell();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> elasticity_dofs_per_cell =</div>
<div class="line">      elasticity_fe.n_dofs_per_cell();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_matrix;</div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> local_interface_matrix(elasticity_dofs_per_cell,</div>
<div class="line">                                              stokes_dofs_per_cell);</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a>     local_rhs;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; local_dof_indices;</div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; neighbor_dof_indices(</div>
<div class="line">      stokes_dofs_per_cell);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a> right_hand_side(dim + 1);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> pressure(dim);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> displacements(dim + 1);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;SymmetricTensor&lt;2, dim&gt;&gt; stokes_symgrad_phi_u(</div>
<div class="line">      stokes_dofs_per_cell);</div>
<div class="line">    std::vector&lt;double&gt; stokes_div_phi_u(stokes_dofs_per_cell);</div>
<div class="line">    std::vector&lt;double&gt; stokes_phi_p(stokes_dofs_per_cell);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;Tensor&lt;2, dim&gt;&gt; elasticity_grad_phi(elasticity_dofs_per_cell);</div>
<div class="line">    std::vector&lt;double&gt;         elasticity_div_phi(elasticity_dofs_per_cell);</div>
<div class="line">    std::vector&lt;Tensor&lt;1, dim&gt;&gt; elasticity_phi(elasticity_dofs_per_cell);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.active_cell_iterators())</div>
<div class="line">      {</div>
<div class="line">        hp_fe_values.reinit(cell);</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> &amp;fe_values = hp_fe_values.<a class="code" href="classFEValues.html#a902429920d32c81c9c279d9a15faa263">get_present_fe_values</a>();</div>
<div class="line"> </div>
<div class="line">        local_matrix.<a class="code" href="classTableBase.html#a302ef67031a523602fd39911b968d6ab">reinit</a>(cell-&gt;<a class="code" href="classDoFHandler.html#ac1fedeb50b5f03b13d8b69f86e33f726">get_fe</a>().<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>(),</div>
<div class="line">                            cell-&gt;<a class="code" href="classDoFHandler.html#ac1fedeb50b5f03b13d8b69f86e33f726">get_fe</a>().<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">        local_rhs.<a class="code" href="group__Vectors.html#gac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(cell-&gt;<a class="code" href="classDoFHandler.html#ac1fedeb50b5f03b13d8b69f86e33f726">get_fe</a>().<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (cell_is_in_fluid_domain(cell))</div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = cell-&gt;<a class="code" href="classDoFHandler.html#ac1fedeb50b5f03b13d8b69f86e33f726">get_fe</a>().<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line">            <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dofs_per_cell == stokes_dofs_per_cell, <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; fe_values.<a class="code" href="classFEValuesBase.html#a807c3049bfe81743fc0f237dfc2fbdea">n_quadrature_points</a>; ++q)</div>
<div class="line">              {</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; dofs_per_cell; ++k)</div>
<div class="line">                  {</div>
<div class="line">                    stokes_symgrad_phi_u[k] =</div>
<div class="line">                      fe_values[velocities].symmetric_gradient(k, q);</div>
<div class="line">                    stokes_div_phi_u[k] =</div>
<div class="line">                      fe_values[velocities].divergence(k, q);</div>
<div class="line">                    stokes_phi_p[k] = fe_values[pressure].value(k, q);</div>
<div class="line">                  }</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div>
<div class="line">                  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j)</div>
<div class="line">                    local_matrix(i, j) +=</div>
<div class="line">                      (2 * viscosity * stokes_symgrad_phi_u[i] *</div>
<div class="line">                         stokes_symgrad_phi_u[j] -</div>
<div class="line">                       stokes_div_phi_u[i] * stokes_phi_p[j] -</div>
<div class="line">                       stokes_phi_p[i] * stokes_div_phi_u[j]) *</div>
<div class="line">                      fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = cell-&gt;<a class="code" href="classDoFHandler.html#ac1fedeb50b5f03b13d8b69f86e33f726">get_fe</a>().<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>();</div>
<div class="line">            <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dofs_per_cell == elasticity_dofs_per_cell,</div>
<div class="line">                   <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; fe_values.<a class="code" href="classFEValuesBase.html#a807c3049bfe81743fc0f237dfc2fbdea">n_quadrature_points</a>; ++q)</div>
<div class="line">              {</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; dofs_per_cell; ++k)</div>
<div class="line">                  {</div>
<div class="line">                    elasticity_grad_phi[k] =</div>
<div class="line">                      fe_values[displacements].gradient(k, q);</div>
<div class="line">                    elasticity_div_phi[k] =</div>
<div class="line">                      fe_values[displacements].divergence(k, q);</div>
<div class="line">                  }</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div>
<div class="line">                  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; dofs_per_cell; ++j)</div>
<div class="line">                    {</div>
<div class="line">                      local_matrix(i, j) +=</div>
<div class="line">                        (<a class="code" href="group__Exceptions.html#gga841a7b84dc17bf2ba675522093a97e8ba945f3fc449518a73b9f5f32868db466c">lambda</a> * elasticity_div_phi[i] *</div>
<div class="line">                           elasticity_div_phi[j] +</div>
<div class="line">                         <a class="code" href="namespacemu.html">mu</a> * <a class="code" href="classSymmetricTensor.html#ab14ac27fc9ab74d4de531698b492d8de">scalar_product</a>(elasticity_grad_phi[i],</div>
<div class="line">                                             elasticity_grad_phi[j]) +</div>
<div class="line">                         <a class="code" href="namespacemu.html">mu</a> *</div>
<div class="line">                           <a class="code" href="classSymmetricTensor.html#ab14ac27fc9ab74d4de531698b492d8de">scalar_product</a>(elasticity_grad_phi[i],</div>
<div class="line">                                          <a class="code" href="classDerivativeForm.html#a3c201452e8dd28e4f5be4a316cb9305f">transpose</a>(elasticity_grad_phi[j]))) *</div>
<div class="line">                        fe_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q);</div>
<div class="line">                    }</div>
<div class="line">              }</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        local_dof_indices.resize(cell-&gt;<a class="code" href="classDoFHandler.html#ac1fedeb50b5f03b13d8b69f86e33f726">get_fe</a>().<a class="code" href="classFiniteElementData.html#a33b522422da89e5c080e7405ad49d7c7">n_dofs_per_cell</a>());</div>
<div class="line">        cell-&gt;get_dof_indices(local_dof_indices);</div>
<div class="line">        constraints.distribute_local_to_global(local_matrix,</div>
<div class="line">                                               local_rhs,</div>
<div class="line">                                               local_dof_indices,</div>
<div class="line">                                               system_matrix,</div>
<div class="line">                                               system_rhs);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (cell_is_in_solid_domain(cell))</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> f : cell-&gt;face_indices())</div>
<div class="line">            <span class="keywordflow">if</span> (cell-&gt;face(f)-&gt;at_boundary() == <span class="keyword">false</span>)</div>
<div class="line">              {</div>
<div class="line">                <span class="keywordflow">if</span> ((cell-&gt;neighbor(f)-&gt;level() == cell-&gt;level()) &amp;&amp;</div>
<div class="line">                    (cell-&gt;neighbor(f)-&gt;has_children() == <span class="keyword">false</span>) &amp;&amp;</div>
<div class="line">                    cell_is_in_fluid_domain(cell-&gt;neighbor(f)))</div>
<div class="line">                  {</div>
<div class="line">                    elasticity_fe_face_values.<a class="code" href="classDoFHandler.html#a84b803d7c74ab87a3eb2e1367611246b">reinit</a>(cell, f);</div>
<div class="line">                    stokes_fe_face_values.reinit(cell-&gt;neighbor(f),</div>
<div class="line">                                                 cell-&gt;neighbor_of_neighbor(f));</div>
<div class="line"> </div>
<div class="line">                    assemble_interface_term(elasticity_fe_face_values,</div>
<div class="line">                                            stokes_fe_face_values,</div>
<div class="line">                                            elasticity_phi,</div>
<div class="line">                                            stokes_symgrad_phi_u,</div>
<div class="line">                                            stokes_phi_p,</div>
<div class="line">                                            local_interface_matrix);</div>
<div class="line"> </div>
<div class="line">                    cell-&gt;neighbor(f)-&gt;get_dof_indices(neighbor_dof_indices);</div>
<div class="line">                    constraints.distribute_local_to_global(</div>
<div class="line">                      local_interface_matrix,</div>
<div class="line">                      local_dof_indices,</div>
<div class="line">                      neighbor_dof_indices,</div>
<div class="line">                      system_matrix);</div>
<div class="line">                  }</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((cell-&gt;neighbor(f)-&gt;level() == cell-&gt;level()) &amp;&amp;</div>
<div class="line">                         (cell-&gt;neighbor(f)-&gt;has_children() == <span class="keyword">true</span>))</div>
<div class="line">                  {</div>
<div class="line">                    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> subface = 0;</div>
<div class="line">                         subface &lt; cell-&gt;face(f)-&gt;n_children();</div>
<div class="line">                         ++subface)</div>
<div class="line">                      <span class="keywordflow">if</span> (cell_is_in_fluid_domain(</div>
<div class="line">                            cell-&gt;neighbor_child_on_subface(f, subface)))</div>
<div class="line">                        {</div>
<div class="line">                          elasticity_fe_subface_values.<a class="code" href="classDoFHandler.html#a84b803d7c74ab87a3eb2e1367611246b">reinit</a>(cell, f, subface);</div>
<div class="line">                          stokes_fe_face_values.reinit(</div>
<div class="line">                            cell-&gt;neighbor_child_on_subface(f, subface),</div>
<div class="line">                            cell-&gt;neighbor_of_neighbor(f));</div>
<div class="line"> </div>
<div class="line">                          assemble_interface_term(elasticity_fe_subface_values,</div>
<div class="line">                                                  stokes_fe_face_values,</div>
<div class="line">                                                  elasticity_phi,</div>
<div class="line">                                                  stokes_symgrad_phi_u,</div>
<div class="line">                                                  stokes_phi_p,</div>
<div class="line">                                                  local_interface_matrix);</div>
<div class="line"> </div>
<div class="line">                          cell-&gt;neighbor_child_on_subface(f, subface)</div>
<div class="line">                            -&gt;get_dof_indices(neighbor_dof_indices);</div>
<div class="line">                          constraints.distribute_local_to_global(</div>
<div class="line">                            local_interface_matrix,</div>
<div class="line">                            local_dof_indices,</div>
<div class="line">                            neighbor_dof_indices,</div>
<div class="line">                            system_matrix);</div>
<div class="line">                        }</div>
<div class="line">                  }</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cell-&gt;neighbor_is_coarser(f) &amp;&amp;</div>
<div class="line">                         cell_is_in_fluid_domain(cell-&gt;neighbor(f)))</div>
<div class="line">                  {</div>
<div class="line">                    elasticity_fe_face_values.<a class="code" href="classDoFHandler.html#a84b803d7c74ab87a3eb2e1367611246b">reinit</a>(cell, f);</div>
<div class="line">                    stokes_fe_subface_values.reinit(</div>
<div class="line">                      cell-&gt;neighbor(f),</div>
<div class="line">                      cell-&gt;neighbor_of_coarser_neighbor(f).first,</div>
<div class="line">                      cell-&gt;neighbor_of_coarser_neighbor(f).second);</div>
<div class="line"> </div>
<div class="line">                    assemble_interface_term(elasticity_fe_face_values,</div>
<div class="line">                                            stokes_fe_subface_values,</div>
<div class="line">                                            elasticity_phi,</div>
<div class="line">                                            stokes_symgrad_phi_u,</div>
<div class="line">                                            stokes_phi_p,</div>
<div class="line">                                            local_interface_matrix);</div>
<div class="line"> </div>
<div class="line">                    cell-&gt;neighbor(f)-&gt;get_dof_indices(neighbor_dof_indices);</div>
<div class="line">                    constraints.distribute_local_to_global(</div>
<div class="line">                      local_interface_matrix,</div>
<div class="line">                      local_dof_indices,</div>
<div class="line">                      neighbor_dof_indices,</div>
<div class="line">                      system_matrix);</div>
<div class="line">                  }</div>
<div class="line">              }</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> FluidStructureProblem&lt;dim&gt;::assemble_interface_term(</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEFaceValuesBase.html">FEFaceValuesBase&lt;dim&gt;</a> &amp;         elasticity_fe_face_values,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classFEFaceValuesBase.html">FEFaceValuesBase&lt;dim&gt;</a> &amp;         stokes_fe_face_values,</div>
<div class="line">    std::vector&lt;<a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a>&gt; &amp;         elasticity_phi,</div>
<div class="line">    std::vector&lt;<a class="code" href="classSymmetricTensor.html">SymmetricTensor&lt;2, dim&gt;</a>&gt; &amp;stokes_symgrad_phi_u,</div>
<div class="line">    std::vector&lt;double&gt; &amp;                 stokes_phi_p,</div>
<div class="line">    <a class="code" href="classFullMatrix.html">FullMatrix&lt;double&gt;</a> &amp;                  local_interface_matrix)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(stokes_fe_face_values.<a class="code" href="classFEValuesBase.html#a807c3049bfe81743fc0f237dfc2fbdea">n_quadrature_points</a> ==</div>
<div class="line">             elasticity_fe_face_values.<a class="code" href="classFEValuesBase.html#a807c3049bfe81743fc0f237dfc2fbdea">n_quadrature_points</a>,</div>
<div class="line">           <a class="code" href="group__Exceptions.html#ga31978c026b8b6b5116df30b8e748f6b7">ExcInternalError</a>());</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_face_quadrature_points =</div>
<div class="line">      elasticity_fe_face_values.<a class="code" href="classFEValuesBase.html#a807c3049bfe81743fc0f237dfc2fbdea">n_quadrature_points</a>;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Scalar.html">FEValuesExtractors::Scalar</a> pressure(dim);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> displacements(dim + 1);</div>
<div class="line"> </div>
<div class="line">    local_interface_matrix = 0;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q = 0; q &lt; n_face_quadrature_points; ++q)</div>
<div class="line">      {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classTensor.html">Tensor&lt;1, dim&gt;</a> normal_vector =</div>
<div class="line">          elasticity_fe_face_values.<a class="code" href="classFEValuesBase.html#ac25ec6835799c3b6c7c842f8acb05eb3">normal_vector</a>(q);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; stokes_fe_face_values.<a class="code" href="classFEValuesBase.html#a5b264d5b2fb6615f5dea7a21135ed1a5">dofs_per_cell</a>; ++k)</div>
<div class="line">          {</div>
<div class="line">            stokes_symgrad_phi_u[k] =</div>
<div class="line">              stokes_fe_face_values[velocities].symmetric_gradient(k, q);</div>
<div class="line">            stokes_phi_p[k] = stokes_fe_face_values[pressure].value(k, q);</div>
<div class="line">          }</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = 0; k &lt; elasticity_fe_face_values.<a class="code" href="classFEValuesBase.html#a5b264d5b2fb6615f5dea7a21135ed1a5">dofs_per_cell</a>;</div>
<div class="line">             ++k)</div>
<div class="line">          elasticity_phi[k] =</div>
<div class="line">            elasticity_fe_face_values[displacements].<a class="code" href="namespaceinternal.html#aa5bef221c94bc6b9c5441c306a72cdbaa2063c1608d6e0baf80249c42e2be5804">value</a>(k, q);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; elasticity_fe_face_values.<a class="code" href="classFEValuesBase.html#a5b264d5b2fb6615f5dea7a21135ed1a5">dofs_per_cell</a>;</div>
<div class="line">             ++i)</div>
<div class="line">          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; stokes_fe_face_values.<a class="code" href="classFEValuesBase.html#a5b264d5b2fb6615f5dea7a21135ed1a5">dofs_per_cell</a>; ++j)</div>
<div class="line">            local_interface_matrix(i, j) +=</div>
<div class="line">              -((2 * viscosity * (stokes_symgrad_phi_u[j] * normal_vector) -</div>
<div class="line">                 stokes_phi_p[j] * normal_vector) *</div>
<div class="line">                elasticity_phi[i] * stokes_fe_face_values.<a class="code" href="classFEValuesBase.html#abade89efb068b71b7ced7082012a2441">JxW</a>(q));</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> FluidStructureProblem&lt;dim&gt;::solve()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classSparseDirectUMFPACK.html">SparseDirectUMFPACK</a> direct_solver;</div>
<div class="line">    direct_solver.<a class="code" href="classSparseDirectUMFPACK.html#a25b1d3c7dbb88158a76165a4a56a16d6">initialize</a>(system_matrix);</div>
<div class="line">    direct_solver.<a class="code" href="classSparseDirectUMFPACK.html#adc154e4830b0e16be265f10a5c8b7103">vmult</a>(solution, system_rhs);</div>
<div class="line"> </div>
<div class="line">    constraints.distribute(solution);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> FluidStructureProblem&lt;dim&gt;::output_results(</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    std::vector&lt;std::string&gt; solution_names(dim, <span class="stringliteral">&quot;velocity&quot;</span>);</div>
<div class="line">    solution_names.emplace_back(<span class="stringliteral">&quot;pressure&quot;</span>);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> &lt; dim; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div>
<div class="line">      solution_names.emplace_back(<span class="stringliteral">&quot;displacement&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt;</div>
<div class="line">      data_component_interpretation(</div>
<div class="line">        dim, <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa783915dbc182d5a49e111815fd23fe0">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line">    data_component_interpretation.push_back(</div>
<div class="line">      <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0a1f3cd50135818a6458f1d3ff7ea4bb51">DataComponentInterpretation::component_is_scalar</a>);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> = 0; <a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a> &lt; dim; ++<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a15728437b942dab0b0042eb06a407d2c">d</a>)</div>
<div class="line">      data_component_interpretation.push_back(</div>
<div class="line">        <a class="code" href="namespaceDataComponentInterpretation.html#a0cd2da3afe902f9004c23a73dbcc8ab0aa783915dbc182d5a49e111815fd23fe0">DataComponentInterpretation::component_is_part_of_vector</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#ac1eb26168177faa30ffbcf9cbb9c3cd5">attach_dof_handler</a>(dof_handler);</div>
<div class="line"> </div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">add_data_vector</a>(solution,</div>
<div class="line">                             solution_names,</div>
<div class="line">                             <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;::type_dof_data</a>,</div>
<div class="line">                             data_component_interpretation);</div>
<div class="line">    data_out.<a class="code" href="classDataOut.html#a5eb51872b8736849bb7e8d2007fae086">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">    std::ofstream output(</div>
<div class="line">      <span class="stringliteral">&quot;solution-&quot;</span> + <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(refinement_cycle, 2) + <span class="stringliteral">&quot;.vtk&quot;</span>);</div>
<div class="line">    data_out.<a class="code" href="group__Exceptions.html#gacad99726038e4fca7f605fdffb3317e4">write_vtk</a>(output);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> FluidStructureProblem&lt;dim&gt;::refine_mesh()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;float&gt;</a> stokes_estimated_error_per_cell(</div>
<div class="line">      <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells());</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;float&gt;</a> elasticity_estimated_error_per_cell(</div>
<div class="line">      <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells());</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss</a>&lt;dim - 1&gt; stokes_face_quadrature(stokes_degree + 2);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss</a>&lt;dim - 1&gt; elasticity_face_quadrature(elasticity_degree + 2);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classhp_1_1QCollection.html">hp::QCollection</a>&lt;dim - 1&gt; face_q_collection;</div>
<div class="line">    face_q_collection.<a class="code" href="classhp_1_1QCollection.html#a87ec95076ccc4b7c10fa24523bb926df">push_back</a>(stokes_face_quadrature);</div>
<div class="line">    face_q_collection.push_back(elasticity_face_quadrature);</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> velocities(0);</div>
<div class="line">    <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div>
<div class="line">      dof_handler,</div>
<div class="line">      face_q_collection,</div>
<div class="line">      std::map&lt;<a class="code" href="namespacetypes.html#aed8813fee8c8a2edcc6005e6a48c321a">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(),</div>
<div class="line">      solution,</div>
<div class="line">      stokes_estimated_error_per_cell,</div>
<div class="line">      fe_collection.component_mask(velocities));</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structFEValuesExtractors_1_1Vector.html">FEValuesExtractors::Vector</a> displacements(dim + 1);</div>
<div class="line">    <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div>
<div class="line">      dof_handler,</div>
<div class="line">      face_q_collection,</div>
<div class="line">      std::map&lt;<a class="code" href="namespacetypes.html#aed8813fee8c8a2edcc6005e6a48c321a">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(),</div>
<div class="line">      solution,</div>
<div class="line">      elasticity_estimated_error_per_cell,</div>
<div class="line">      fe_collection.component_mask(displacements));</div>
<div class="line"> </div>
<div class="line">    stokes_estimated_error_per_cell *=</div>
<div class="line">      4. / stokes_estimated_error_per_cell.l2_norm();</div>
<div class="line">    elasticity_estimated_error_per_cell *=</div>
<div class="line">      1. / elasticity_estimated_error_per_cell.l2_norm();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells());</div>
<div class="line"> </div>
<div class="line">    estimated_error_per_cell += stokes_estimated_error_per_cell;</div>
<div class="line">    estimated_error_per_cell += elasticity_estimated_error_per_cell;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.active_cell_iterators())</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> f : cell-&gt;face_indices())</div>
<div class="line">        <span class="keywordflow">if</span> (cell_is_in_solid_domain(cell))</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">if</span> ((cell-&gt;at_boundary(f) == <span class="keyword">false</span>) &amp;&amp;</div>
<div class="line">                (((cell-&gt;neighbor(f)-&gt;level() == cell-&gt;level()) &amp;&amp;</div>
<div class="line">                  (cell-&gt;neighbor(f)-&gt;has_children() == <span class="keyword">false</span>) &amp;&amp;</div>
<div class="line">                  cell_is_in_fluid_domain(cell-&gt;neighbor(f))) ||</div>
<div class="line">                 ((cell-&gt;neighbor(f)-&gt;level() == cell-&gt;level()) &amp;&amp;</div>
<div class="line">                  (cell-&gt;neighbor(f)-&gt;has_children() == <span class="keyword">true</span>) &amp;&amp;</div>
<div class="line">                  (cell_is_in_fluid_domain(</div>
<div class="line">                    cell-&gt;neighbor_child_on_subface(f, 0)))) ||</div>
<div class="line">                 (cell-&gt;neighbor_is_coarser(f) &amp;&amp;</div>
<div class="line">                  cell_is_in_fluid_domain(cell-&gt;neighbor(f)))))</div>
<div class="line">              estimated_error_per_cell(cell-&gt;active_cell_index()) = 0;</div>
<div class="line">          }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">if</span> ((cell-&gt;at_boundary(f) == <span class="keyword">false</span>) &amp;&amp;</div>
<div class="line">                (((cell-&gt;neighbor(f)-&gt;level() == cell-&gt;level()) &amp;&amp;</div>
<div class="line">                  (cell-&gt;neighbor(f)-&gt;has_children() == <span class="keyword">false</span>) &amp;&amp;</div>
<div class="line">                  cell_is_in_solid_domain(cell-&gt;neighbor(f))) ||</div>
<div class="line">                 ((cell-&gt;neighbor(f)-&gt;level() == cell-&gt;level()) &amp;&amp;</div>
<div class="line">                  (cell-&gt;neighbor(f)-&gt;has_children() == <span class="keyword">true</span>) &amp;&amp;</div>
<div class="line">                  (cell_is_in_solid_domain(</div>
<div class="line">                    cell-&gt;neighbor_child_on_subface(f, 0)))) ||</div>
<div class="line">                 (cell-&gt;neighbor_is_coarser(f) &amp;&amp;</div>
<div class="line">                  cell_is_in_solid_domain(cell-&gt;neighbor(f)))))</div>
<div class="line">              estimated_error_per_cell(cell-&gt;active_cell_index()) = 0;</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceGridRefinement.html#a48e5395381ed87155942a61a1edd134d">GridRefinement::refine_and_coarsen_fixed_number</a>(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>,</div>
<div class="line">                                                    estimated_error_per_cell,</div>
<div class="line">                                                    0.3,</div>
<div class="line">                                                    0.0);</div>
<div class="line">    <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">FluidStructureProblem&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    make_grid();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refinement_cycle = 0; refinement_cycle &lt; 10 - 2 * dim;</div>
<div class="line">         ++refinement_cycle)</div>
<div class="line">      {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Refinement cycle &quot;</span> &lt;&lt; refinement_cycle &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (refinement_cycle &gt; 0)</div>
<div class="line">          refine_mesh();</div>
<div class="line"> </div>
<div class="line">        setup_dofs();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Assembling...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        assemble_system();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Solving...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        solve();</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;   Writing output...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        output_results(refinement_cycle);</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step46</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span>Step46;</div>
<div class="line"> </div>
<div class="line">      FluidStructureProblem&lt;2&gt; flow_problem(1, 1);</div>
<div class="line">      flow_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aclassDoFHandler_html_a84b803d7c74ab87a3eb2e1367611246b"><div class="ttname"><a href="classDoFHandler.html#a84b803d7c74ab87a3eb2e1367611246b">DoFHandler::reinit</a></div><div class="ttdeci">void reinit(const Triangulation&lt; dim, spacedim &gt; &amp;tria)</div></div>
</div><!-- fragment --><p> <br  />
 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
