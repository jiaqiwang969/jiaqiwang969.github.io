<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="canonical" href="https://www.dealii.org/current/doxygen/deal.II/step_64.html" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The step-64 tutorial program   &lt;br&gt;</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2021 by the deal.II authors"></meta>
<meta name="deal.II-version" content="9.3.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 9.3.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--Extra macros for MathJax:-->
<div style="display:none">
\(\newcommand{\dealvcentcolon}{\mathrel{\mathop{:}}}\)
\(\newcommand{\dealcoloneq}{\dealvcentcolon\mathrel{\mkern-1.2mu}=}\)
\(\newcommand{\jump}[1]{\left[\!\left[ #1 \right]\!\right]}\)
\(\newcommand{\average}[1]{\left\{\!\left\{ #1 \right\}\!\right\}}\)
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The step-64 tutorial program <br  />
 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>本教程取决于 <a class="el" href="step_7.html">step-7</a> , <a class="el" href="step_37.html">step-37</a> 。</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a><a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Thetestcase">The test case</a><a href="#Thetestcase">The test case</a>
        <li><a href="#Movingdatatoandfromthedevice">Moving data to and from the device</a><a href="#Movingdatatoandfromthedevice">Moving data to and from the device</a>
        <li><a href="#Matrixvectorproductimplementation">Matrix-vector product implementation</a><a href="#Matrixvectorproductimplementation">Matrix-vector product implementation</a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a><a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#ClasscodeVaryingCoefficientFunctorcode">Class <code>VaryingCoefficientFunctor</code></a><a href="#ClasscodeVaryingCoefficientFunctorcode">Class <code>VaryingCoefficientFunctor</code></a>
        <li><a href="#ClasscodeHelmholtzOperatorQuadcode">Class <code>HelmholtzOperatorQuad</code></a><a href="#ClasscodeHelmholtzOperatorQuadcode">Class <code>HelmholtzOperatorQuad</code></a>
        <li><a href="#ClasscodeLocalHelmholtzOperatorcode">Class <code>LocalHelmholtzOperator</code></a><a href="#ClasscodeLocalHelmholtzOperatorcode">Class <code>LocalHelmholtzOperator</code></a>
        <li><a href="#ClasscodeHelmholtzOperatorcode">Class <code>HelmholtzOperator</code></a><a href="#ClasscodeHelmholtzOperatorcode">Class <code>HelmholtzOperator</code></a>
        <li><a href="#ClasscodeHelmholtzProblemcode">Class <code>HelmholtzProblem</code></a><a href="#ClasscodeHelmholtzProblemcode">Class <code>HelmholtzProblem</code></a>
        <li><a href="#Thecodemaincodefunction">The <code>main()</code> function</a><a href="#Thecodemaincodefunction">The <code>main()</code> function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a><a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Possibilitiesforextensions"> Possibilities for extensions </a><a href="#Possibilitiesforextensions"> Possibilities for extensions </a>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a><a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
</p>
<p><br  />
 <br  />
</p>
<p><em> This program was contributed by Bruno Turcksin and Daniel Arndt, Oak Ridge National Laboratory. </em></p>
<p><a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p>这个例子展示了如何使用CUDA在GPU上实现一个无矩阵的方法，用于超立方体上系数可变的亥姆霍兹方程。该线性系统将使用共轭梯度法进行求解，并使用MPI进行并行化。</p>
<p>在过去的几年里，异构计算，特别是GPU，已经获得了很大的普及。这是因为在给定的功率预算下，GPU比CPU提供更好的计算能力和内存带宽。在2019年初的架构中，对于PDE相关的任务，GPU的功率效率约为服务器CPU的2-3倍，宽<a href="https://en.wikipedia.org/wiki/SIMD">SIMD</a>。GPU也是机器学习中最受欢迎的架构。另一方面，GPU并不容易编程。这个程序探索了deal.II的能力，看看这样的程序可以如何有效地实现。</p>
<p>虽然我们试图让CPU和GPU的无矩阵类的界面尽可能接近，但还是有一些区别。当在GPU上使用无矩阵框架时，人们必须编写一些CUDA代码。然而，数量相当少，而且对CUDA的使用仅限于几个关键词。</p>
<p><a class="anchor" id="Thetestcase"></a></p><h3>The test case</h3>
<p>在这个例子中，我们考虑Helmholtz问题 </p><p class="formulaDsp">
\begin{eqnarray*} - \nabla \cdot \nabla u + a(\mathbf x) u &amp;=&amp;1,\\ u &amp;=&amp; 0 \quad \text{on } \partial \Omega \end{eqnarray*}
</p>
<p>其中 \(a(\mathbf x)\) 是一个可变系数。</p>
<p>我们选择 \(\Omega=[0,1]^3\) 和 \(a(\mathbf x)=\frac{10}{0.05 + 2\|\mathbf x\|^2}\) 作为域。由于系数是围绕原点对称的，但域不是，我们最终会得到一个非对称的解决方案。</p>
<p>如果你在本教程中读到这里，你就会知道这个问题的弱表述是什么样子的，以及原则上如何为它组装线性系统。当然，在这个程序中，我们实际上不会形成矩阵，而只是表示它与之相乘时的作用。</p>
<p><a class="anchor" id="Movingdatatoandfromthedevice"></a></p><h3>Moving data to and from the device</h3>
<p>GPU（我们从现在开始用 "设备 "一词来指代GPU）有自己的内存，与CPU（我们从现在开始用 "主机 "一词）可访问的内存分开。设备上的正常计算可以分为三个独立的步骤。</p>
<ol type="1">
<li>数据从主机移到设备上。</li>
<li>计算在设备上完成。</li>
<li>结果从设备上移回主机。</li>
</ol>
<p>数据移动可以由用户代码明确完成，也可以使用UVM（统一虚拟内存）自动完成。在deal.II中，只支持第一种方法。虽然这意味着用户有额外的负担，但这可以更好地控制数据移动，更重要的是可以避免在主机上而不是设备上错误地运行重要的内核。</p>
<p>deal.II中的数据移动是通过 <a class="el" href="classLinearAlgebra_1_1ReadWriteVector.html">LinearAlgebra::ReadWriteVector</a>. 完成的，这些向量可以被看作是主机上的缓冲区，用来存储从设备上收到的数据或发送数据到设备上。有两种类型的向量可以在设备上使用。</p>
<ul>
<li><a class="el" href="classLinearAlgebra_1_1CUDAWrappers_1_1Vector.html">LinearAlgebra::CUDAWrappers::Vector</a>, 它类似于更常见的Vector&lt;Number&gt;，和</li>
<li>LinearAlgebra::distributed::Vector&lt;Number,   MemorySpace::CUDA&gt;, 这是一个普通的 <a class="el" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector</a> ，我们指定了要使用哪个内存空间。</li>
</ul>
<p>如果没有指定内存空间，默认是 <a class="el" href="structMemorySpace_1_1Host.html">MemorySpace::Host</a>. 。</p>
<p>接下来，我们展示如何使用 <a class="el" href="classLinearAlgebra_1_1CUDAWrappers_1_1Vector.html">LinearAlgebra::CUDAWrappers::Vector</a>: 将数据移入/移出设备。</p>
<div class="fragment"><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size = 10;</div>
<div class="line"><a class="code" href="classLinearAlgebra_1_1ReadWriteVector.html">LinearAlgebra::ReadWriteVector&lt;double&gt;</a> rw_vector(size);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">...do something with the rw_vector...</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Move the data to the device:</span></div>
<div class="line">LinearAlgebra::CUDAWrappers::Vector&lt;<span class="keywordtype">double</span>&gt; vector_dev(size);</div>
<div class="line">vector_dev.import(rw_vector, <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda4ed1da4f7c4036896a6aeb19338d1a81">VectorOperations::insert</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">...do some computations on the device...</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Move the data back to the host:</span></div>
<div class="line">rw_vector.import(vector_dev, <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda4ed1da4f7c4036896a6aeb19338d1a81">VectorOperations::insert</a>);</div>
<div class="ttc" id="aclassLinearAlgebra_1_1ReadWriteVector_html"><div class="ttname"><a href="classLinearAlgebra_1_1ReadWriteVector.html">LinearAlgebra::ReadWriteVector</a></div><div class="ttdef"><b>Definition:</b> <a href="read__write__vector_8h_source.html#l00133">read_write_vector.h:134</a></div></div>
<div class="ttc" id="anamespaceVectorTools_1_1EvaluationFlags_html_ac6721740e24732d6afabcf28ddfc1ffda4ed1da4f7c4036896a6aeb19338d1a81"><div class="ttname"><a href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda4ed1da4f7c4036896a6aeb19338d1a81">VectorTools::EvaluationFlags::insert</a></div><div class="ttdeci">@ insert</div><div class="ttdef"><b>Definition:</b> <a href="vector__tools__evaluate_8h_source.html#l00064">vector_tools_evaluate.h:63</a></div></div>
</div><!-- fragment --><p>这里使用的两个向量类都只在一台机器上工作，也就是说，一个内存空间在主机上，一个在设备上。</p>
<p>但在有些情况下，人们希望在若干台机器上的多个MPI进程之间运行并行计算，而每台机器都配备有GPU。在这种情况下，人们希望使用 <code><a class="el" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector</a>&lt;Number,<a class="el" href="structMemorySpace_1_1CUDA.html">MemorySpace::CUDA</a>&gt;</code>, ，它是类似的，但<code>import()</code>阶段可能涉及MPI通信。</p>
<div class="fragment"><div class="line"><a class="code" href="classIndexSet.html">IndexSet</a> locally_owned_dofs, locally_relevant_dofs;</div>
<div class="line">...fill the two <a class="code" href="classIndexSet.html">IndexSet</a> objects...</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create the ReadWriteVector using an IndexSet instead of the size</span></div>
<div class="line">LinearAlgebra::ReadWriteVector&lt;<span class="keywordtype">double</span>&gt; owned_rw_vector(locally_owned_dofs);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">...do something with the rw_vector...</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Move the data to the device:</span></div>
<div class="line">LinearAlgebra::distributed::Vector&lt;<a class="code" href="classdouble.html">double</a>, <a class="code" href="structMemorySpace_1_1CUDA.html">MemorySpace::CUDA</a>&gt;</div>
<div class="line">  distributed_vector_dev(locally_owned_dofs, MPI_COMM_WORLD);</div>
<div class="line">distributed_vector_dev.import(owned_rw_vector, <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda4ed1da4f7c4036896a6aeb19338d1a81">VectorOperations::insert</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">...do something with the dev_vector...</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a ReadWriteVector with a different IndexSet:</span></div>
<div class="line">LinearAlgebra::ReadWriteVector&lt;<span class="keywordtype">double</span>&gt;</div>
<div class="line">  relevant_rw_vector(locally_relevant_dofs);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Move the data to the host, possibly using MPI communication:</span></div>
<div class="line">relevant_rw_vector.import(distributed_vector_dev, <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda4ed1da4f7c4036896a6aeb19338d1a81">VectorOperations::insert</a>);</div>
<div class="ttc" id="aclassIndexSet_html"><div class="ttname"><a href="classIndexSet.html">IndexSet</a></div><div class="ttdef"><b>Definition:</b> <a href="index__set_8h_source.html#l00072">index_set.h:73</a></div></div>
<div class="ttc" id="aclassdouble_html"><div class="ttname"><a href="classdouble.html">double</a></div></div>
<div class="ttc" id="astructMemorySpace_1_1CUDA_html"><div class="ttname"><a href="structMemorySpace_1_1CUDA.html">MemorySpace::CUDA</a></div><div class="ttdef"><b>Definition:</b> <a href="memory__space_8h_source.html#l00039">memory_space.h:40</a></div></div>
</div><!-- fragment --><p><code>relevant_rw_vector</code>是一个存储向量所有元素的子集的对象。通常，这些是 <a class="el" href="DEALGlossary.html#GlossLocallyRelevantDof">本地相关的DoF</a>，这意味着它们在不同的MPI进程之间是重叠的。因此，一台机器上存储在该向量中的元素可能与该机器上的GPU存储的元素不一致，需要MPI通信来导入它们。</p>
<p>在所有这些情况下，在导入一个向量时，可以插入数值（使用 <a class="el" href="group__Vectors.html#gga40c50779cd14ba89bbf0bd9b4561964cae5042eefddc828c7c31e1e8e26da8b09">VectorOperation::insert</a>) 或添加到向量的先前内容中（使用 <a class="el" href="group__Vectors.html#gga40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>). <br  />
</p>
<p><a class="anchor" id="Matrixvectorproductimplementation"></a></p><h3>Matrix-vector product implementation</h3>
<p>在设备上评估无矩阵算子所需的代码与主机上的代码非常相似。然而，也有一些区别，主要是 Step-37 中的<code>local_apply()</code>函数和正交点的循环都需要封装在自己的函数中。<a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<p>首先包括从以前的教程中知道的deal.II库中的必要文件。</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="conditional__ostream_8h.html">deal.II/base/conditional_ostream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="la__parallel__vector_8h.html">deal.II/lac/la_parallel_vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="ttc" id="aaffine__constraints_8h_html"><div class="ttname"><a href="affine__constraints_8h.html">affine_constraints.h</a></div></div>
<div class="ttc" id="aconditional__ostream_8h_html"><div class="ttname"><a href="conditional__ostream_8h.html">conditional_ostream.h</a></div></div>
<div class="ttc" id="adof__tools_8h_html"><div class="ttname"><a href="dof__tools_8h.html">dof_tools.h</a></div></div>
<div class="ttc" id="afe__q_8h_html"><div class="ttname"><a href="fe__q_8h.html">fe_q.h</a></div></div>
<div class="ttc" id="agrid_2tria_8h_html"><div class="ttname"><a href="grid_2tria_8h.html">tria.h</a></div></div>
<div class="ttc" id="agrid__generator_8h_html"><div class="ttname"><a href="grid__generator_8h.html">grid_generator.h</a></div></div>
<div class="ttc" id="ala__parallel__vector_8h_html"><div class="ttname"><a href="la__parallel__vector_8h.html">la_parallel_vector.h</a></div></div>
<div class="ttc" id="anumerics_2data__out_8h_html"><div class="ttname"><a href="numerics_2data__out_8h.html">data_out.h</a></div></div>
<div class="ttc" id="aprecondition_8h_html"><div class="ttname"><a href="precondition_8h.html">precondition.h</a></div></div>
<div class="ttc" id="aquadrature__lib_8h_html"><div class="ttname"><a href="quadrature__lib_8h.html">quadrature_lib.h</a></div></div>
<div class="ttc" id="asolver__cg_8h_html"><div class="ttname"><a href="solver__cg_8h.html">solver_cg.h</a></div></div>
<div class="ttc" id="avector__tools_8h_html"><div class="ttname"><a href="vector__tools_8h.html">vector_tools.h</a></div></div>
</div><!-- fragment --><p>下面的包括在GPU上实现无矩阵方法的数据结构。</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2cuda_8h.html">deal.II/base/cuda.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cuda__fe__evaluation_8h.html">deal.II/matrix_free/cuda_fe_evaluation.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cuda__matrix__free_8h.html">deal.II/matrix_free/cuda_matrix_free.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="operators_8h.html">deal.II/matrix_free/operators.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="ttc" id="acuda__fe__evaluation_8h_html"><div class="ttname"><a href="cuda__fe__evaluation_8h.html">cuda_fe_evaluation.h</a></div></div>
<div class="ttc" id="acuda__matrix__free_8h_html"><div class="ttname"><a href="cuda__matrix__free_8h.html">cuda_matrix_free.h</a></div></div>
<div class="ttc" id="ainclude_2deal_8II_2base_2cuda_8h_html"><div class="ttname"><a href="include_2deal_8II_2base_2cuda_8h.html">cuda.h</a></div></div>
<div class="ttc" id="aoperators_8h_html"><div class="ttname"><a href="operators_8h.html">operators.h</a></div></div>
</div><!-- fragment --><p>像往常一样，我们把所有的东西都包围在一个自己的命名空间中。</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>Step64</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="ttc" id="anamespacedealii_html"><div class="ttname"><a href="namespacedealii.html">dealii</a></div><div class="ttdef"><b>Definition:</b> <a href="namespace__dealii_8h_source.html#l00025">namespace_dealii.h:26</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="ClasscodeVaryingCoefficientFunctorcode"></a> </p><h3>Class <code>VaryingCoefficientFunctor</code></h3>
<p>接下来，我们定义一个类，实现我们想在亥姆霍兹算子中使用的变化系数。后来，我们想把这个类型的对象传递给一个 <a class="el" href="classCUDAWrappers_1_1MatrixFree.html">CUDAWrappers::MatrixFree</a> 对象，该对象希望该类有一个<code>运算器()</code>，为给定的单元填充构造器中提供的值。这个操作符需要在设备上运行，所以它需要为编译器标记为<code>__device__</code>。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line"><span class="keyword">class </span>VaryingCoefficientFunctor</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  VaryingCoefficientFunctor(<span class="keywordtype">double</span> *coefficient)</div>
<div class="line">    : coef(coefficient)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  __device__ <span class="keywordtype">void</span> operator()(</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>                                          cell,</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="structCUDAWrappers_1_1MatrixFree_1_1Data.html">CUDAWrappers::MatrixFree&lt;dim, double&gt;::Data</a> *gpu_data);</div>
<div class="ttc" id="astructCUDAWrappers_1_1MatrixFree_1_1Data_html"><div class="ttname"><a href="structCUDAWrappers_1_1MatrixFree_1_1Data.html">CUDAWrappers::MatrixFree::Data</a></div><div class="ttdef"><b>Definition:</b> <a href="cuda__matrix__free_8h_source.html#l00167">cuda_matrix_free.h:168</a></div></div>
</div><!-- fragment --><p>由于 <a class="el" href="structCUDAWrappers_1_1MatrixFree_1_1Data.html">CUDAWrappers::MatrixFree::Data</a> 不知道其数组的大小，我们需要在这个类中存储正交点的数量和自由度的数量，以进行必要的索引转换。</p>
<div class="fragment"><div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_dofs_1d = fe_degree + 1;</div>
<div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_local_dofs =</div>
<div class="line">    ::Utilities::pow(n_dofs_1d, dim);</div>
<div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points =</div>
<div class="line">    ::Utilities::pow(n_dofs_1d, dim);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">double</span> *coef;</div>
<div class="line">};</div>
</div><!-- fragment --><p>下面的函数实现了这个系数。记得在介绍中，我们曾将其定义为 \(a(\mathbf x)=\frac{10}{0.05 + 2\|\mathbf x\|^2}\)</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line">__device__ <span class="keywordtype">void</span> VaryingCoefficientFunctor&lt;dim, fe_degree&gt;::operator()(</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>                                          cell,</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="structCUDAWrappers_1_1MatrixFree_1_1Data.html">CUDAWrappers::MatrixFree&lt;dim, double&gt;::Data</a> *gpu_data)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos = CUDAWrappers::local_q_point_id&lt;dim, double&gt;(</div>
<div class="line">    cell, gpu_data, n_dofs_1d, n_q_points);</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> q_point =</div>
<div class="line">    CUDAWrappers::get_quadrature_point&lt;dim, double&gt;(cell,</div>
<div class="line">                                                    gpu_data,</div>
<div class="line">                                                    n_dofs_1d);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span> p_square = 0.;</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dim; ++i)</div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">double</span> coord = q_point[i];</div>
<div class="line">      p_square += coord * coord;</div>
<div class="line">    }</div>
<div class="line">  coef[pos] = 10. / (0.05 + 2. * p_square);</div>
<div class="line">}</div>
<div class="ttc" id="aclassPoint_html"><div class="ttname"><a href="classPoint.html">Point</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2point_8h_source.html#l00110">point.h:111</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="ClasscodeHelmholtzOperatorQuadcode"></a> </p><h3>Class <code>HelmholtzOperatorQuad</code></h3>
<p>类<code>HelmholtzOperatorQuad</code>实现了Helmholtz算子在每个正交点的评估。它使用了类似于 <a class="el" href="step_37.html">step-37</a> 中介绍的 <a class="el" href="classMatrixFree.html">MatrixFree</a> 框架的机制。与那里不同的是，实际的正交点索引是通过转换当前线程索引隐式处理的。和以前一样，这个类的函数需要在设备上运行，所以需要为编译器标记为<code>__device__</code>。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line"><span class="keyword">class </span>HelmholtzOperatorQuad</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  __device__ HelmholtzOperatorQuad(<span class="keywordtype">double</span> coef)</div>
<div class="line">    : coef(coef)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  __device__ <span class="keywordtype">void</span></div>
<div class="line">  operator()(<a class="code" href="classCUDAWrappers_1_1FEEvaluation.html">CUDAWrappers::FEEvaluation&lt;dim, fe_degree&gt;</a> *fe_eval) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">double</span> coef;</div>
<div class="line">};</div>
<div class="ttc" id="aclassCUDAWrappers_1_1FEEvaluation_html"><div class="ttname"><a href="classCUDAWrappers_1_1FEEvaluation.html">CUDAWrappers::FEEvaluation</a></div><div class="ttdef"><b>Definition:</b> <a href="cuda__fe__evaluation_8h_source.html#l00090">cuda_fe_evaluation.h:91</a></div></div>
</div><!-- fragment --><p>我们在这里要解决的Helmholtz问题以弱的形式写成如下。 </p><p class="formulaDsp">
\begin{eqnarray*} (\nabla v, \nabla u)+ (v, a(\mathbf x) u) &amp;=&amp;(v,1) \quad \forall v. \end{eqnarray*}
</p>
<p>如果你看过 <a class="el" href="step_37.html">step-37</a> ，那么很明显，左边的两个项对应着这里的两个函数调用。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line">__device__ <span class="keywordtype">void</span> HelmholtzOperatorQuad&lt;dim, fe_degree&gt;::</div>
<div class="line">                operator()(<a class="code" href="classCUDAWrappers_1_1FEEvaluation.html">CUDAWrappers::FEEvaluation&lt;dim, fe_degree&gt;</a> *fe_eval)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  fe_eval-&gt;<a class="code" href="classCUDAWrappers_1_1FEEvaluation.html#a3be578a3c2e5e88cd6ac8f49ced97d6b">submit_value</a>(coef * fe_eval-&gt;<a class="code" href="classCUDAWrappers_1_1FEEvaluation.html#a71e01c65a41a3d7029891a2f2b0460ac">get_value</a>());</div>
<div class="line">  fe_eval-&gt;<a class="code" href="classCUDAWrappers_1_1FEEvaluation.html#aa3ec27abdb02e9aff693c89a2e8b290c">submit_gradient</a>(fe_eval-&gt;<a class="code" href="classCUDAWrappers_1_1FEEvaluation.html#a311d421e71503742acd1aff7e258abfd">get_gradient</a>());</div>
<div class="line">}</div>
<div class="ttc" id="aclassCUDAWrappers_1_1FEEvaluation_html_a311d421e71503742acd1aff7e258abfd"><div class="ttname"><a href="classCUDAWrappers_1_1FEEvaluation.html#a311d421e71503742acd1aff7e258abfd">CUDAWrappers::FEEvaluation::get_gradient</a></div><div class="ttdeci">gradient_type get_gradient(const unsigned int q_point) const</div><div class="ttdef"><b>Definition:</b> <a href="cuda__fe__evaluation_8h_source.html#l00628">cuda_fe_evaluation.h:629</a></div></div>
<div class="ttc" id="aclassCUDAWrappers_1_1FEEvaluation_html_a3be578a3c2e5e88cd6ac8f49ced97d6b"><div class="ttname"><a href="classCUDAWrappers_1_1FEEvaluation.html#a3be578a3c2e5e88cd6ac8f49ced97d6b">CUDAWrappers::FEEvaluation::submit_value</a></div><div class="ttdeci">void submit_value(const value_type &amp;val_in, const unsigned int q_point)</div><div class="ttdef"><b>Definition:</b> <a href="cuda__fe__evaluation_8h_source.html#l00566">cuda_fe_evaluation.h:567</a></div></div>
<div class="ttc" id="aclassCUDAWrappers_1_1FEEvaluation_html_a71e01c65a41a3d7029891a2f2b0460ac"><div class="ttname"><a href="classCUDAWrappers_1_1FEEvaluation.html#a71e01c65a41a3d7029891a2f2b0460ac">CUDAWrappers::FEEvaluation::get_value</a></div><div class="ttdeci">value_type get_value(const unsigned int q_point) const</div><div class="ttdef"><b>Definition:</b> <a href="cuda__fe__evaluation_8h_source.html#l00496">cuda_fe_evaluation.h:496</a></div></div>
<div class="ttc" id="aclassCUDAWrappers_1_1FEEvaluation_html_aa3ec27abdb02e9aff693c89a2e8b290c"><div class="ttname"><a href="classCUDAWrappers_1_1FEEvaluation.html#aa3ec27abdb02e9aff693c89a2e8b290c">CUDAWrappers::FEEvaluation::submit_gradient</a></div><div class="ttdeci">void submit_gradient(const gradient_type &amp;grad_in, const unsigned int q_point)</div><div class="ttdef"><b>Definition:</b> <a href="cuda__fe__evaluation_8h_source.html#l00690">cuda_fe_evaluation.h:691</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="ClasscodeLocalHelmholtzOperatorcode"></a> </p><h3>Class <code>LocalHelmholtzOperator</code></h3>
<p>最后，我们需要定义一个类，实现整个运算符的评估，在基于矩阵的方法中对应于矩阵-向量积。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line"><span class="keyword">class </span>LocalHelmholtzOperator</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  LocalHelmholtzOperator(<span class="keywordtype">double</span> *coefficient)</div>
<div class="line">    : coef(coefficient)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  __device__ <span class="keywordtype">void</span> operator()(</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>                                          cell,</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="structCUDAWrappers_1_1MatrixFree_1_1Data.html">CUDAWrappers::MatrixFree&lt;dim, double&gt;::Data</a> *gpu_data,</div>
<div class="line">    <a class="code" href="structCUDAWrappers_1_1SharedData.html">CUDAWrappers::SharedData&lt;dim, double&gt;</a> *                     shared_data,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> *                                              src,</div>
<div class="line">    <span class="keywordtype">double</span> *                                                    dst) <span class="keyword">const</span>;</div>
<div class="ttc" id="astructCUDAWrappers_1_1SharedData_html"><div class="ttname"><a href="structCUDAWrappers_1_1SharedData.html">CUDAWrappers::SharedData</a></div><div class="ttdef"><b>Definition:</b> <a href="cuda__matrix__free_8h_source.html#l00661">cuda_matrix_free.h:662</a></div></div>
</div><!-- fragment --><p>同样， <a class="el" href="classCUDAWrappers_1_1MatrixFree.html">CUDAWrappers::MatrixFree</a> 对象不知道自由度的数量和正交点的数量，所以我们需要在调用算子中存储这些用于索引计算。</p>
<div class="fragment"><div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_dofs_1d    = fe_degree + 1;</div>
<div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_local_dofs = <a class="code" href="namespaceUtilities.html#a0900f35b37ee122e73fb2c80bba9beb9">Utilities::pow</a>(fe_degree + 1, dim);</div>
<div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points   = <a class="code" href="namespaceUtilities.html#a0900f35b37ee122e73fb2c80bba9beb9">Utilities::pow</a>(fe_degree + 1, dim);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">double</span> *coef;</div>
<div class="line">};</div>
<div class="ttc" id="anamespaceUtilities_html_a0900f35b37ee122e73fb2c80bba9beb9"><div class="ttname"><a href="namespaceUtilities.html#a0900f35b37ee122e73fb2c80bba9beb9">Utilities::pow</a></div><div class="ttdeci">constexpr T pow(const T base, const int iexp)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2utilities_8h_source.html#l00461">utilities.h:461</a></div></div>
</div><!-- fragment --><p>这是一个调用算子，在给定的单元上执行亥姆霍兹算子的评估，类似于CPU上的MatrixFree框架。特别是，我们需要访问源向量的值和梯度，我们将值和梯度信息写入目标向量。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line">__device__ <span class="keywordtype">void</span> LocalHelmholtzOperator&lt;dim, fe_degree&gt;::operator()(</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>                                          cell,</div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">typename</span> <a class="code" href="structCUDAWrappers_1_1MatrixFree_1_1Data.html">CUDAWrappers::MatrixFree&lt;dim, double&gt;::Data</a> *gpu_data,</div>
<div class="line">  <a class="code" href="structCUDAWrappers_1_1SharedData.html">CUDAWrappers::SharedData&lt;dim, double&gt;</a> *                     shared_data,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> *                                              src,</div>
<div class="line">  <span class="keywordtype">double</span> *                                                    dst)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos = CUDAWrappers::local_q_point_id&lt;dim, double&gt;(</div>
<div class="line">    cell, gpu_data, n_dofs_1d, n_q_points);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classCUDAWrappers_1_1FEEvaluation.html">CUDAWrappers::FEEvaluation&lt;dim, fe_degree, fe_degree + 1, 1, double&gt;</a></div>
<div class="line">    fe_eval(cell, gpu_data, shared_data);</div>
<div class="line">  fe_eval.<a class="code" href="classCUDAWrappers_1_1FEEvaluation.html#ae0e594e5dc5dc91391190c4bb1d8c45c">read_dof_values</a>(src);</div>
<div class="line">  fe_eval.<a class="code" href="classCUDAWrappers_1_1FEEvaluation.html#aa50f53d6eb1b0416a791008a5e1a3b25">evaluate</a>(<span class="keyword">true</span>, <span class="keyword">true</span>);</div>
<div class="line">  fe_eval.<a class="code" href="classCUDAWrappers_1_1FEEvaluation.html#af54da23ff99a33dcd23ddccf52dee2f5">apply_for_each_quad_point</a>(</div>
<div class="line">    HelmholtzOperatorQuad&lt;dim, fe_degree&gt;(coef[pos]));</div>
<div class="line">  fe_eval.<a class="code" href="classCUDAWrappers_1_1FEEvaluation.html#a12939db3c43822e5cbf51520ad52dedb">integrate</a>(<span class="keyword">true</span>, <span class="keyword">true</span>);</div>
<div class="line">  fe_eval.<a class="code" href="classCUDAWrappers_1_1FEEvaluation.html#a90c2f1b2718e90aa49b7d49fac3600d5">distribute_local_to_global</a>(dst);</div>
<div class="line">}</div>
<div class="ttc" id="aclassCUDAWrappers_1_1FEEvaluation_html_a12939db3c43822e5cbf51520ad52dedb"><div class="ttname"><a href="classCUDAWrappers_1_1FEEvaluation.html#a12939db3c43822e5cbf51520ad52dedb">CUDAWrappers::FEEvaluation::integrate</a></div><div class="ttdeci">void integrate(const bool integrate_val, const bool integrate_grad)</div><div class="ttdef"><b>Definition:</b> <a href="cuda__fe__evaluation_8h_source.html#l00456">cuda_fe_evaluation.h:456</a></div></div>
<div class="ttc" id="aclassCUDAWrappers_1_1FEEvaluation_html_a90c2f1b2718e90aa49b7d49fac3600d5"><div class="ttname"><a href="classCUDAWrappers_1_1FEEvaluation.html#a90c2f1b2718e90aa49b7d49fac3600d5">CUDAWrappers::FEEvaluation::distribute_local_to_global</a></div><div class="ttdeci">void distribute_local_to_global(Number *dst) const</div><div class="ttdef"><b>Definition:</b> <a href="cuda__fe__evaluation_8h_source.html#l00391">cuda_fe_evaluation.h:392</a></div></div>
<div class="ttc" id="aclassCUDAWrappers_1_1FEEvaluation_html_aa50f53d6eb1b0416a791008a5e1a3b25"><div class="ttname"><a href="classCUDAWrappers_1_1FEEvaluation.html#aa50f53d6eb1b0416a791008a5e1a3b25">CUDAWrappers::FEEvaluation::evaluate</a></div><div class="ttdeci">void evaluate(const bool evaluate_val, const bool evaluate_grad)</div><div class="ttdef"><b>Definition:</b> <a href="cuda__fe__evaluation_8h_source.html#l00417">cuda_fe_evaluation.h:417</a></div></div>
<div class="ttc" id="aclassCUDAWrappers_1_1FEEvaluation_html_ae0e594e5dc5dc91391190c4bb1d8c45c"><div class="ttname"><a href="classCUDAWrappers_1_1FEEvaluation.html#ae0e594e5dc5dc91391190c4bb1d8c45c">CUDAWrappers::FEEvaluation::read_dof_values</a></div><div class="ttdeci">void read_dof_values(const Number *src)</div><div class="ttdef"><b>Definition:</b> <a href="cuda__fe__evaluation_8h_source.html#l00366">cuda_fe_evaluation.h:367</a></div></div>
<div class="ttc" id="aclassCUDAWrappers_1_1FEEvaluation_html_af54da23ff99a33dcd23ddccf52dee2f5"><div class="ttname"><a href="classCUDAWrappers_1_1FEEvaluation.html#af54da23ff99a33dcd23ddccf52dee2f5">CUDAWrappers::FEEvaluation::apply_for_each_quad_point</a></div><div class="ttdeci">void apply_for_each_quad_point(const Functor &amp;func)</div><div class="ttdef"><b>Definition:</b> <a href="cuda__fe__evaluation_8h_source.html#l00755">cuda_fe_evaluation.h:756</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="ClasscodeHelmholtzOperatorcode"></a> </p><h3>Class <code>HelmholtzOperator</code></h3>
<p>HelmholtzOperator "类作为 "LocalHelmholtzOperator "的封装器，定义了一个可以与SolverCG等线性求解器一起使用的接口。特别是，像每一个实现线性算子接口的类一样，它需要有一个`vmult()'函数来执行线性算子对源向量的操作。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line"><span class="keyword">class </span>HelmholtzOperator</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  HelmholtzOperator(<span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a> &amp;          dof_handler,</div>
<div class="line">                    <span class="keyword">const</span> <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> &amp;constraints);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span></div>
<div class="line">  vmult(<a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double, MemorySpace::CUDA&gt;</a> &amp;dst,</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double, MemorySpace::CUDA&gt;</a></div>
<div class="line">          &amp;src) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> initialize_dof_vector(</div>
<div class="line">    <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double, MemorySpace::CUDA&gt;</a> &amp;vec) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <a class="code" href="classCUDAWrappers_1_1MatrixFree.html">CUDAWrappers::MatrixFree&lt;dim, double&gt;</a>       mf_data;</div>
<div class="line">  <a class="code" href="classLinearAlgebra_1_1CUDAWrappers_1_1Vector.html">LinearAlgebra::CUDAWrappers::Vector&lt;double&gt;</a> coef;</div>
<div class="line">};</div>
<div class="ttc" id="aclassAffineConstraints_html"><div class="ttname"><a href="classAffineConstraints.html">AffineConstraints&lt; double &gt;</a></div></div>
<div class="ttc" id="aclassCUDAWrappers_1_1MatrixFree_html"><div class="ttname"><a href="classCUDAWrappers_1_1MatrixFree.html">CUDAWrappers::MatrixFree</a></div><div class="ttdef"><b>Definition:</b> <a href="cuda__matrix__free_8h_source.html#l00082">cuda_matrix_free.h:83</a></div></div>
<div class="ttc" id="aclassDoFHandler_html"><div class="ttname"><a href="classDoFHandler.html">DoFHandler</a></div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__handler_8h_source.html#l00314">dof_handler.h:315</a></div></div>
<div class="ttc" id="aclassLinearAlgebra_1_1CUDAWrappers_1_1Vector_html"><div class="ttname"><a href="classLinearAlgebra_1_1CUDAWrappers_1_1Vector.html">LinearAlgebra::CUDAWrappers::Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="cuda__vector_8h_source.html#l00055">cuda_vector.h:56</a></div></div>
<div class="ttc" id="aclassLinearAlgebra_1_1distributed_1_1Vector_html"><div class="ttname"><a href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="la__parallel__vector_8h_source.html#l00248">la_parallel_vector.h:250</a></div></div>
</div><!-- fragment --><p>下面是这个类的构造函数的实现。在第一部分，我们初始化<code>mf_data</code>成员变量，该变量将在评估算子时为我们提供必要的信息。 <br  />
</p>
<p>在第二部分中，我们需要在每个活动的、本地拥有的单元中存储每个正交点的系数值。我们可以向平行三角法询问活动的、本地拥有的单元的数量，但手头只有一个DoFHandler对象。由于 <a class="el" href="classDoFHandler.html#a7797f796c0be511fbc7f230ccc22532e">DoFHandler::get_triangulation()</a> 返回的是Triangulation对象，而不是 <a class="el" href="classparallel_1_1TriangulationBase.html">parallel::TriangulationBase</a> 对象，我们必须对返回值进行下移。在这里这样做是安全的，因为我们知道三角形实际上是一个 parallel:distributed::<a class="el" href="classTriangulation.html">Triangulation</a> 对象。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line">HelmholtzOperator&lt;dim, fe_degree&gt;::HelmholtzOperator(</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a> &amp;          dof_handler,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> &amp;constraints)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classMappingQGeneric.html">MappingQGeneric&lt;dim&gt;</a> mapping(fe_degree);</div>
<div class="line">  <span class="keyword">typename</span> <a class="code" href="structCUDAWrappers_1_1MatrixFree_1_1AdditionalData.html">CUDAWrappers::MatrixFree&lt;dim, double&gt;::AdditionalData</a></div>
<div class="line">    additional_data;</div>
<div class="line">  additional_data.<a class="code" href="structCUDAWrappers_1_1MatrixFree_1_1AdditionalData.html#a4fc9f434f93f40a8c1dff4ed6b9fd509">mapping_update_flags</a> = <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a> |</div>
<div class="line">                                         <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a> |</div>
<div class="line">                                         <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a>;</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;1&gt;</a> quad(fe_degree + 1);</div>
<div class="line">  mf_data.reinit(mapping, dof_handler, constraints, quad, additional_data);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_owned_cells =</div>
<div class="line">    <span class="keyword">dynamic_cast&lt;</span><span class="keyword">const </span><a class="code" href="classparallel_1_1TriangulationBase.html">parallel::TriangulationBase&lt;dim&gt;</a> *<span class="keyword">&gt;</span>(</div>
<div class="line">      &amp;dof_handler.<a class="code" href="classDoFHandler.html#a7797f796c0be511fbc7f230ccc22532e">get_triangulation</a>())</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      -&gt;n_locally_owned_active_cells();</div>
<div class="line">  coef.reinit(<a class="code" href="namespaceUtilities.html#a0900f35b37ee122e73fb2c80bba9beb9">Utilities::pow</a>(fe_degree + 1, dim) * n_owned_cells);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> VaryingCoefficientFunctor&lt;dim, fe_degree&gt; functor(coef.get_values());</div>
<div class="line">  mf_data.evaluate_coefficients(functor);</div>
<div class="line">}</div>
<div class="ttc" id="aclassDoFHandler_html_a7797f796c0be511fbc7f230ccc22532e"><div class="ttname"><a href="classDoFHandler.html#a7797f796c0be511fbc7f230ccc22532e">DoFHandler::get_triangulation</a></div><div class="ttdeci">const Triangulation&lt; dim, spacedim &gt; &amp; get_triangulation() const</div></div>
<div class="ttc" id="aclassMappingQGeneric_html"><div class="ttname"><a href="classMappingQGeneric.html">MappingQGeneric</a></div><div class="ttdef"><b>Definition:</b> <a href="mapping__q__generic_8h_source.html#l00135">mapping_q_generic.h:136</a></div></div>
<div class="ttc" id="aclassQGauss_html"><div class="ttname"><a href="classQGauss.html">QGauss</a></div><div class="ttdef"><b>Definition:</b> <a href="quadrature__lib_8h_source.html#l00038">quadrature_lib.h:39</a></div></div>
<div class="ttc" id="aclassparallel_1_1TriangulationBase_html"><div class="ttname"><a href="classparallel_1_1TriangulationBase.html">parallel::TriangulationBase</a></div><div class="ttdef"><b>Definition:</b> <a href="tria__base_8h_source.html#l00078">tria_base.h:79</a></div></div>
<div class="ttc" id="afe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea"><div class="ttname"><a href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a></div><div class="ttdeci">@ update_values</div><div class="ttdoc">Shape function values.</div><div class="ttdef"><b>Definition:</b> <a href="fe__update__flags_8h_source.html#l00078">fe_update_flags.h:78</a></div></div>
<div class="ttc" id="afe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85"><div class="ttname"><a href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a></div><div class="ttdeci">@ update_JxW_values</div><div class="ttdoc">Transformed quadrature weights.</div><div class="ttdef"><b>Definition:</b> <a href="fe__update__flags_8h_source.html#l00129">fe_update_flags.h:129</a></div></div>
<div class="ttc" id="afe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20"><div class="ttname"><a href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52facbcc430975fa6af05f75ca786dc6fe20">update_gradients</a></div><div class="ttdeci">@ update_gradients</div><div class="ttdoc">Shape function gradients.</div><div class="ttdef"><b>Definition:</b> <a href="fe__update__flags_8h_source.html#l00084">fe_update_flags.h:84</a></div></div>
<div class="ttc" id="afe__update__flags_8h_html_aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a"><div class="ttname"><a href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a></div><div class="ttdeci">@ update_quadrature_points</div><div class="ttdoc">Transformed quadrature points.</div><div class="ttdef"><b>Definition:</b> <a href="fe__update__flags_8h_source.html#l00122">fe_update_flags.h:122</a></div></div>
<div class="ttc" id="astructCUDAWrappers_1_1MatrixFree_1_1AdditionalData_html"><div class="ttname"><a href="structCUDAWrappers_1_1MatrixFree_1_1AdditionalData.html">CUDAWrappers::MatrixFree::AdditionalData</a></div><div class="ttdef"><b>Definition:</b> <a href="cuda__matrix__free_8h_source.html#l00104">cuda_matrix_free.h:105</a></div></div>
<div class="ttc" id="astructCUDAWrappers_1_1MatrixFree_1_1AdditionalData_html_a4fc9f434f93f40a8c1dff4ed6b9fd509"><div class="ttname"><a href="structCUDAWrappers_1_1MatrixFree_1_1AdditionalData.html#a4fc9f434f93f40a8c1dff4ed6b9fd509">CUDAWrappers::MatrixFree::AdditionalData::mapping_update_flags</a></div><div class="ttdeci">UpdateFlags mapping_update_flags</div><div class="ttdef"><b>Definition:</b> <a href="cuda__matrix__free_8h_source.html#l00147">cuda_matrix_free.h:147</a></div></div>
</div><!-- fragment --><p>然后，关键的一步是使用前面所有的类来循环所有的单元格来执行矩阵-向量乘积。我们在下一个函数中实现这一点。 <br  />
</p>
<p>在应用亥姆霍兹算子时，我们必须注意正确处理边界条件。因为本地算子不知道约束条件，所以我们必须在事后将正确的值从源头复制到目的向量上。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line"><span class="keywordtype">void</span> HelmholtzOperator&lt;dim, fe_degree&gt;::vmult(</div>
<div class="line">  <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double, MemorySpace::CUDA&gt;</a> &amp;      dst,</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double, MemorySpace::CUDA&gt;</a> &amp;src)<span class="keyword"></span></div>
<div class="line"><span class="keyword">  const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  dst = 0.;</div>
<div class="line">  LocalHelmholtzOperator&lt;dim, fe_degree&gt; helmholtz_operator(</div>
<div class="line">    coef.get_values());</div>
<div class="line">  mf_data.cell_loop(helmholtz_operator, src, dst);</div>
<div class="line">  mf_data.copy_constrained_values(src, dst);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line"><span class="keywordtype">void</span> HelmholtzOperator&lt;dim, fe_degree&gt;::initialize_dof_vector(</div>
<div class="line">  <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double, MemorySpace::CUDA&gt;</a> &amp;vec)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  mf_data.initialize_dof_vector(vec);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="ClasscodeHelmholtzProblemcode"></a></p><h3>Class <code>HelmholtzProblem</code></h3>
<p>这是本程序的主类。它定义了我们用于教程程序的通常框架。唯一值得评论的一点是<code>solve()</code>函数和向量类型的选择。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line"><span class="keyword">class </span>HelmholtzProblem</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  HelmholtzProblem();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span> setup_system();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> assemble_rhs();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> solve();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> output_results(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  MPI_Comm mpi_communicator;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>       fe;</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a> dof_handler;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classIndexSet.html">IndexSet</a> locally_owned_dofs;</div>
<div class="line">  <a class="code" href="classIndexSet.html">IndexSet</a> locally_relevant_dofs;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a>                          constraints;</div>
<div class="line">  std::unique_ptr&lt;HelmholtzOperator&lt;dim, fe_degree&gt;&gt; system_matrix_dev;</div>
<div class="ttc" id="aclassFE__Q_html"><div class="ttname"><a href="classFE__Q.html">FE_Q</a></div><div class="ttdef"><b>Definition:</b> <a href="fe__q_8h_source.html#l00548">fe_q.h:549</a></div></div>
<div class="ttc" id="aclassparallel_1_1distributed_1_1Triangulation_html"><div class="ttname"><a href="classparallel_1_1distributed_1_1Triangulation.html">parallel::distributed::Triangulation</a></div><div class="ttdef"><b>Definition:</b> <a href="distributed_2tria_8h_source.html#l00252">tria.h:254</a></div></div>
<div class="ttc" id="anamespaceWorkStream_1_1internal_1_1tbb__no__coloring_html_a8673698a405bf47aa24002aeb6d76d70"><div class="ttname"><a href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">WorkStream::internal::tbb_no_coloring::run</a></div><div class="ttdeci">void run(const Iterator &amp;begin, const typename identity&lt; Iterator &gt;::type &amp;end, Worker worker, Copier copier, const ScratchData &amp;sample_scratch_data, const CopyData &amp;sample_copy_data, const unsigned int queue_length, const unsigned int chunk_size)</div><div class="ttdef"><b>Definition:</b> <a href="work__stream_8h_source.html#l00691">work_stream.h:691</a></div></div>
<div class="ttc" id="ap4est__wrappers_8cc_html_ace00f2f80d9780ef9aa1007e1c22c6a4"><div class="ttname"><a href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a></div><div class="ttdeci">const ::parallel::distributed::Triangulation&lt; dim, spacedim &gt; * triangulation</div><div class="ttdef"><b>Definition:</b> <a href="p4est__wrappers_8cc_source.html#l00069">p4est_wrappers.cc:69</a></div></div>
</div><!-- fragment --><p>由于<code>solve()</code>函数中的所有操作都是在显卡上执行的，因此所使用的向量也有必要在GPU上存储其值。 <a class="el" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector</a> 可以被告知要使用哪个内存空间。还有 <a class="el" href="classLinearAlgebra_1_1CUDAWrappers_1_1Vector.html">LinearAlgebra::CUDAWrappers::Vector</a> ，总是使用GPU内存存储，但不与MPI一起工作。值得注意的是，如果MPI实现是CUDA感知的，并且配置标志<code>DEAL_II_MPI_WITH_CUDA_SUPPORT</code>被启用，不同MPI进程之间的通信可以得到改善。(这个标志的值需要在安装deal.II时调用&lt;tt&gt;cmake时设置)。 <br  />
</p>
<p>此外，我们还保留了一个带有CPU存储的解决方案向量，这样我们就可以像往常一样查看和显示解决方案。</p>
<div class="fragment"><div class="line">  <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double, MemorySpace::Host&gt;</a></div>
<div class="line">                                                                ghost_solution_host;</div>
<div class="line">  <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double, MemorySpace::CUDA&gt;</a> solution_dev;</div>
<div class="line">  <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double, MemorySpace::CUDA&gt;</a></div>
<div class="line">    system_rhs_dev;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classConditionalOStream.html">ConditionalOStream</a> pcout;</div>
<div class="line">};</div>
<div class="ttc" id="aclassConditionalOStream_html"><div class="ttname"><a href="classConditionalOStream.html">ConditionalOStream</a></div><div class="ttdef"><b>Definition:</b> <a href="conditional__ostream_8h_source.html#l00080">conditional_ostream.h:81</a></div></div>
</div><!-- fragment --><p>除了 <code>Helmholtzproblem::solve()</code> 之外，这个类的所有其余函数的实现并不包含任何新的内容，我们不会对整体方法进一步发表过多的评论。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line">HelmholtzProblem&lt;dim, fe_degree&gt;::HelmholtzProblem()</div>
<div class="line">  : mpi_communicator(MPI_COMM_WORLD)</div>
<div class="line">  , <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>(mpi_communicator)</div>
<div class="line">  , fe(fe_degree)</div>
<div class="line">  , dof_handler(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>)</div>
<div class="line">  , pcout(std::cout, <a class="code" href="namespaceUtilities.html">Utilities</a>::MPI::<a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">this_mpi_process</a>(mpi_communicator) == 0)</div>
<div class="line">{}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line"><span class="keywordtype">void</span> HelmholtzProblem&lt;dim, fe_degree&gt;::setup_system()</div>
<div class="line">{</div>
<div class="line">  dof_handler.<a class="code" href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">distribute_dofs</a>(fe);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  locally_owned_dofs = dof_handler.<a class="code" href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">locally_owned_dofs</a>();</div>
<div class="line">  <a class="code" href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a>(dof_handler, locally_relevant_dofs);</div>
<div class="line">  system_rhs_dev.reinit(locally_owned_dofs, mpi_communicator);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  constraints.<a class="code" href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">clear</a>();</div>
<div class="line">  constraints.<a class="code" href="classAffineConstraints.html#a2c9d71b5b7e8851c25a411ccf34de986">reinit</a>(locally_relevant_dofs);</div>
<div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                           0,</div>
<div class="line">                                           <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a>(),</div>
<div class="line">                                           constraints);</div>
<div class="line">  constraints.<a class="code" href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">close</a>();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  system_matrix_dev.reset(</div>
<div class="line">    <span class="keyword">new</span> HelmholtzOperator&lt;dim, fe_degree&gt;(dof_handler, constraints));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  ghost_solution_host.reinit(locally_owned_dofs,</div>
<div class="line">                             locally_relevant_dofs,</div>
<div class="line">                             mpi_communicator);</div>
<div class="line">  system_matrix_dev-&gt;initialize_dof_vector(solution_dev);</div>
<div class="line">  system_rhs_dev.reinit(solution_dev);</div>
<div class="line">}</div>
<div class="ttc" id="aclassAffineConstraints_html_a1611aa37f754086388ca76bcd421cce5"><div class="ttname"><a href="classAffineConstraints.html#a1611aa37f754086388ca76bcd421cce5">AffineConstraints::close</a></div><div class="ttdeci">void close()</div></div>
<div class="ttc" id="aclassAffineConstraints_html_a2c9d71b5b7e8851c25a411ccf34de986"><div class="ttname"><a href="classAffineConstraints.html#a2c9d71b5b7e8851c25a411ccf34de986">AffineConstraints::reinit</a></div><div class="ttdeci">void reinit(const IndexSet &amp;local_constraints=IndexSet())</div></div>
<div class="ttc" id="aclassAffineConstraints_html_addd15bc409c61d6f795f0132c574335b"><div class="ttname"><a href="classAffineConstraints.html#addd15bc409c61d6f795f0132c574335b">AffineConstraints::clear</a></div><div class="ttdeci">void clear()</div></div>
<div class="ttc" id="aclassDoFHandler_html_a553ca864aaf70330d9be86bc78f36d1e"><div class="ttname"><a href="classDoFHandler.html#a553ca864aaf70330d9be86bc78f36d1e">DoFHandler::distribute_dofs</a></div><div class="ttdeci">void distribute_dofs(const FiniteElement&lt; dim, spacedim &gt; &amp;fe)</div></div>
<div class="ttc" id="aclassDoFHandler_html_ad39fd2189568f2f6b7d557237e3372e3"><div class="ttname"><a href="classDoFHandler.html#ad39fd2189568f2f6b7d557237e3372e3">DoFHandler::locally_owned_dofs</a></div><div class="ttdeci">const IndexSet &amp; locally_owned_dofs() const</div></div>
<div class="ttc" id="aclassFunctions_1_1ZeroFunction_html"><div class="ttname"><a href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction</a></div><div class="ttdef"><b>Definition:</b> <a href="function_8h_source.html#l00510">function.h:511</a></div></div>
<div class="ttc" id="agroup__constraints_html_ga3b4ea7dfd313e388d868c4e4aa685799"><div class="ttname"><a href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a></div><div class="ttdeci">void make_hanging_node_constraints(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, AffineConstraints&lt; number &gt; &amp;constraints)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__constraints_8cc_source.html#l01787">dof_tools_constraints.cc:1787</a></div></div>
<div class="ttc" id="anamespaceDoFTools_html_acad7e0841b9046eaafddc4c617ab1d9d"><div class="ttname"><a href="namespaceDoFTools.html#acad7e0841b9046eaafddc4c617ab1d9d">DoFTools::extract_locally_relevant_dofs</a></div><div class="ttdeci">void extract_locally_relevant_dofs(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, IndexSet &amp;dof_set)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools_8cc_source.html#l01210">dof_tools.cc:1210</a></div></div>
<div class="ttc" id="anamespaceUtilities_1_1MPI_html_a895dcd8223a0ee6f0e6a80b80e2d5982"><div class="ttname"><a href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a></div><div class="ttdeci">unsigned int this_mpi_process(const MPI_Comm &amp;mpi_communicator)</div><div class="ttdef"><b>Definition:</b> <a href="mpi_8cc_source.html#l00128">mpi.cc:128</a></div></div>
<div class="ttc" id="anamespaceUtilities_html"><div class="ttname"><a href="namespaceUtilities.html">Utilities</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2communication__pattern__base_8h_source.html#l00030">communication_pattern_base.h:31</a></div></div>
<div class="ttc" id="anamespaceVectorTools_html_ab2562d41bb26f362043f9719a8cd9b87"><div class="ttname"><a href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a></div><div class="ttdeci">void interpolate_boundary_values(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const std::map&lt; types::boundary_id, const Function&lt; spacedim, number &gt; * &gt; &amp;function_map, std::map&lt; types::global_dof_index, number &gt; &amp;boundary_values, const ComponentMask &amp;component_mask=ComponentMask())</div></div>
</div><!-- fragment --><p>与 <a class="el" href="step_4.html">step-4</a> 或 <a class="el" href="step_6.html">step-6</a> 等程序不同，我们不必组装整个线性系统，只需组装右手边的向量。这在本质上与我们在 <a class="el" href="step_4.html">step-4</a> 中所做的一样，例如，但我们必须注意在将局部贡献复制到全局矢量时使用正确的约束对象。特别是，我们需要确保对应于边界节点的条目被正确地清零了。这对于CG的收敛是必要的。 另一个解决方案是修改上面的<code>vmult()</code>函数，我们假装源向量的条目为零，在矩阵-向量乘积中不考虑它们。但这里使用的方法更简单）。) <br  />
</p>
<p>在函数的最后，我们不能直接将数值从主机复制到设备上，而是需要使用一个类型为 <a class="el" href="classLinearAlgebra_1_1ReadWriteVector.html">LinearAlgebra::ReadWriteVector</a> 的中间对象来构建必要的正确通信模式。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line"><span class="keywordtype">void</span> HelmholtzProblem&lt;dim, fe_degree&gt;::assemble_rhs()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classLinearAlgebra_1_1distributed_1_1Vector.html">LinearAlgebra::distributed::Vector&lt;double, MemorySpace::Host&gt;</a></div>
<div class="line">                    system_rhs_host(locally_owned_dofs,</div>
<div class="line">                    locally_relevant_dofs,</div>
<div class="line">                    mpi_communicator);</div>
<div class="line">  <span class="keyword">const</span> <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a> quadrature_formula(fe_degree + 1);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classFEValues.html">FEValues&lt;dim&gt;</a> fe_values(fe,</div>
<div class="line">                          quadrature_formula,</div>
<div class="line">                          <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa4057ca2f127aa619c65886a9d3ad4aea">update_values</a> | <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fad5c9ff886b9615349a5d04a6c782df4a">update_quadrature_points</a> |</div>
<div class="line">                            <a class="code" href="fe__update__flags_8h.html#aa94b67d2fdcc390690c523f28019e52fa714204722e9eeb43aadbd0d5ddc48c85">update_JxW_values</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dofs_per_cell = fe.n_dofs_per_cell();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_q_points    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> cell_rhs(dofs_per_cell);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell : dof_handler.<a class="code" href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">active_cell_iterators</a>())</div>
<div class="line">    <span class="keywordflow">if</span> (cell-&gt;is_locally_owned())</div>
<div class="line">      {</div>
<div class="line">        cell_rhs = 0;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        fe_values.reinit(cell);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q_index = 0; q_index &lt; n_q_points; ++q_index)</div>
<div class="line">          {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; dofs_per_cell; ++i)</div>
<div class="line">              cell_rhs(i) += (fe_values.shape_value(i, q_index) * 1.0 *</div>
<div class="line">                              fe_values.JxW(q_index));</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        cell-&gt;get_dof_indices(local_dof_indices);</div>
<div class="line">        constraints.<a class="code" href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">distribute_local_to_global</a>(cell_rhs,</div>
<div class="line">                                               local_dof_indices,</div>
<div class="line">                                               system_rhs_host);</div>
<div class="line">      }</div>
<div class="line">  system_rhs_host.compress(<a class="code" href="group__Vectors.html#gga40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classLinearAlgebra_1_1ReadWriteVector.html">LinearAlgebra::ReadWriteVector&lt;double&gt;</a> rw_vector(locally_owned_dofs);</div>
<div class="line">  rw_vector.import(system_rhs_host, <a class="code" href="group__Vectors.html#gga40c50779cd14ba89bbf0bd9b4561964cae5042eefddc828c7c31e1e8e26da8b09">VectorOperation::insert</a>);</div>
<div class="line">  system_rhs_dev.import(rw_vector, <a class="code" href="group__Vectors.html#gga40c50779cd14ba89bbf0bd9b4561964cae5042eefddc828c7c31e1e8e26da8b09">VectorOperation::insert</a>);</div>
<div class="line">}</div>
<div class="ttc" id="aclassAffineConstraints_html_a373fbdacd8c486e675b8d2bff8943192"><div class="ttname"><a href="classAffineConstraints.html#a373fbdacd8c486e675b8d2bff8943192">AffineConstraints::distribute_local_to_global</a></div><div class="ttdeci">void distribute_local_to_global(const InVector &amp;local_vector, const std::vector&lt; size_type &gt; &amp;local_dof_indices, OutVector &amp;global_vector) const</div><div class="ttdef"><b>Definition:</b> <a href="affine__constraints_8h_source.html#l02259">affine_constraints.h:2259</a></div></div>
<div class="ttc" id="aclassFEValues_html"><div class="ttname"><a href="classFEValues.html">FEValues</a></div><div class="ttdef"><b>Definition:</b> <a href="fe_2fe__values_8h_source.html#l03905">fe_values.h:3906</a></div></div>
<div class="ttc" id="aclassVector_html"><div class="ttname"><a href="classVector.html">Vector&lt; double &gt;</a></div></div>
<div class="ttc" id="agroup__CPP11_html_gaace8c98aca00e7e48a619bb5e08084aa"><div class="ttname"><a href="group__CPP11.html#gaace8c98aca00e7e48a619bb5e08084aa">DoFHandler::active_cell_iterators</a></div><div class="ttdeci">IteratorRange&lt; active_cell_iterator &gt; active_cell_iterators() const</div></div>
<div class="ttc" id="agroup__Vectors_html_gga40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708"><div class="ttname"><a href="group__Vectors.html#gga40c50779cd14ba89bbf0bd9b4561964cae1077e8dbf4afea5d2df8c8b723c0708">VectorOperation::add</a></div><div class="ttdeci">@ add</div><div class="ttdef"><b>Definition:</b> <a href="vector__operation_8h_source.html#l00053">vector_operation.h:53</a></div></div>
<div class="ttc" id="agroup__Vectors_html_gga40c50779cd14ba89bbf0bd9b4561964cae5042eefddc828c7c31e1e8e26da8b09"><div class="ttname"><a href="group__Vectors.html#gga40c50779cd14ba89bbf0bd9b4561964cae5042eefddc828c7c31e1e8e26da8b09">VectorOperation::insert</a></div><div class="ttdeci">@ insert</div><div class="ttdef"><b>Definition:</b> <a href="vector__operation_8h_source.html#l00049">vector_operation.h:49</a></div></div>
</div><!-- fragment --><p>这个solve()函数最后包含了对之前讨论的新类的调用。这里我们不使用任何预处理程序，即通过身份矩阵进行预处理，以只关注 <a class="el" href="classCUDAWrappers_1_1MatrixFree.html">CUDAWrappers::MatrixFree</a> 框架的特殊性。当然，在实际应用中，选择一个合适的预处理程序是至关重要的，但我们至少有与 <a class="el" href="step_37.html">step-37</a> 中相同的限制，因为矩阵条目是即时计算而不是存储的。 <br  />
</p>
<p>在函数的第一部分解出线性系统后，我们将解决方案从设备上复制到主机上，以便能够查看其值并在<code>output_results()</code>中显示。这种转移的工作方式与前一个函数的结尾相同。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line"><span class="keywordtype">void</span> HelmholtzProblem&lt;dim, fe_degree&gt;::solve()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classPreconditionIdentity.html">PreconditionIdentity</a> preconditioner;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a> solver_control(system_rhs_dev.size(),</div>
<div class="line">                               1<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">e</a>-12 * system_rhs_dev.l2_norm());</div>
<div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;LinearAlgebra::distributed::Vector&lt;double, MemorySpace::CUDA&gt;</a>&gt; cg(</div>
<div class="line">    solver_control);</div>
<div class="line">  cg.solve(*system_matrix_dev, solution_dev, system_rhs_dev, preconditioner);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  pcout &lt;&lt; <span class="stringliteral">&quot;  Solved in &quot;</span> &lt;&lt; solver_control.last_step() &lt;&lt; <span class="stringliteral">&quot; iterations.&quot;</span></div>
<div class="line">        &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classLinearAlgebra_1_1ReadWriteVector.html">LinearAlgebra::ReadWriteVector&lt;double&gt;</a> rw_vector(locally_owned_dofs);</div>
<div class="line">  rw_vector.import(solution_dev, <a class="code" href="group__Vectors.html#gga40c50779cd14ba89bbf0bd9b4561964cae5042eefddc828c7c31e1e8e26da8b09">VectorOperation::insert</a>);</div>
<div class="line">  ghost_solution_host.import(rw_vector, <a class="code" href="group__Vectors.html#gga40c50779cd14ba89bbf0bd9b4561964cae5042eefddc828c7c31e1e8e26da8b09">VectorOperation::insert</a>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  constraints.<a class="code" href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">distribute</a>(ghost_solution_host);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  ghost_solution_host.update_ghost_values();</div>
<div class="line">}</div>
<div class="ttc" id="aclassAffineConstraints_html_a7b3d3f295bb56d6cd6856bdc6cbe8a01"><div class="ttname"><a href="classAffineConstraints.html#a7b3d3f295bb56d6cd6856bdc6cbe8a01">AffineConstraints::distribute</a></div><div class="ttdeci">void distribute(VectorType &amp;vec) const</div></div>
<div class="ttc" id="aclassPreconditionIdentity_html"><div class="ttname"><a href="classPreconditionIdentity.html">PreconditionIdentity</a></div><div class="ttdef"><b>Definition:</b> <a href="precondition_8h_source.html#l00079">precondition.h:80</a></div></div>
<div class="ttc" id="aclassSolverCG_html"><div class="ttname"><a href="classSolverCG.html">SolverCG</a></div><div class="ttdef"><b>Definition:</b> <a href="solver__cg_8h_source.html#l00095">solver_cg.h:96</a></div></div>
<div class="ttc" id="aclassSolverControl_html"><div class="ttname"><a href="classSolverControl.html">SolverControl</a></div><div class="ttdef"><b>Definition:</b> <a href="solver__control_8h_source.html#l00065">solver_control.h:66</a></div></div>
<div class="ttc" id="anamespacePhysics_1_1Elasticity_1_1Kinematics_html_a9587d5229555daa5b1fa1ba2f8a40adb"><div class="ttname"><a href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">Physics::Elasticity::Kinematics::e</a></div><div class="ttdeci">SymmetricTensor&lt; 2, dim, Number &gt; e(const Tensor&lt; 2, dim, Number &gt; &amp;F)</div></div>
</div><!-- fragment --><p>输出结果函数和平时一样，因为我们已经将数值从GPU复制回CPU。 <br  />
</p>
<p>既然我们已经在用这个函数做事情了，我们不妨计算一下解决方案的 \(L_2\) 规范。我们通过调用 <a class="el" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference()</a>. 来做到这一点，该函数旨在通过评估数值解（由自由度值的向量给出）和代表精确解的对象之间的差异来计算误差。但是我们可以通过传入一个零函数来轻松地计算解决方案的 \(L_2\) 准则。也就是说，我们不是在评估误差 \(\|u_h-u\|_{L_2(\Omega)}\) ，而是在评估 \(\|u_h-0\|_{L_2(\Omega)}=\|u_h\|_{L_2(\Omega)}\) 。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line"><span class="keywordtype">void</span> HelmholtzProblem&lt;dim, fe_degree&gt;::output_results(</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#ac1eb26168177faa30ffbcf9cbb9c3cd5">attach_dof_handler</a>(dof_handler);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">add_data_vector</a>(ghost_solution_host, <span class="stringliteral">&quot;solution&quot;</span>);</div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#a5eb51872b8736849bb7e8d2007fae086">build_patches</a>();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="structDataOutBase_1_1VtkFlags.html">DataOutBase::VtkFlags</a> flags;</div>
<div class="line">  flags.<a class="code" href="group__Exceptions.html#ga3be0d6de1c92b770e8664bce2fc7c107">compression_level</a> = <a class="code" href="group__Exceptions.html#gga7ad65742b9dbfb7eeb04b511b5a08d63a3b747f53b680a2f1dd1c8e345a1e7261">DataOutBase::VtkFlags::best_speed</a>;</div>
<div class="line">  data_out.<a class="code" href="group__Exceptions.html#gac7280a24690b117454acfb0fa058299c">set_flags</a>(flags);</div>
<div class="line">  data_out.<a class="code" href="group__Exceptions.html#ga0864e51eb173c87e2a3edc9391ea8009">write_vtu_with_pvtu_record</a>(</div>
<div class="line">    <span class="stringliteral">&quot;./&quot;</span>, <span class="stringliteral">&quot;solution&quot;</span>, cycle, mpi_communicator, 2);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> cellwise_norm(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells());</div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a>(dof_handler,</div>
<div class="line">                                    ghost_solution_host,</div>
<div class="line">                                    <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a>(),</div>
<div class="line">                                    cellwise_norm,</div>
<div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 2),</div>
<div class="line">                                    <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> global_norm =</div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a>(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>,</div>
<div class="line">                                      cellwise_norm,</div>
<div class="line">                                      <a class="code" href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a>);</div>
<div class="line">  pcout &lt;&lt; <span class="stringliteral">&quot;  solution norm: &quot;</span> &lt;&lt; global_norm &lt;&lt; std::endl;</div>
<div class="line">}</div>
<div class="ttc" id="aclassDataOut__DoFData_html_ac1eb26168177faa30ffbcf9cbb9c3cd5"><div class="ttname"><a href="classDataOut__DoFData.html#ac1eb26168177faa30ffbcf9cbb9c3cd5">DataOut_DoFData::attach_dof_handler</a></div><div class="ttdeci">void attach_dof_handler(const DoFHandlerType &amp;)</div></div>
<div class="ttc" id="aclassDataOut__DoFData_html_ace4b76e565ba0701c4d32c26075ed3b9"><div class="ttname"><a href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">DataOut_DoFData::add_data_vector</a></div><div class="ttdeci">void add_data_vector(const VectorType &amp;data, const std::vector&lt; std::string &gt; &amp;names, const DataVectorType type=type_automatic, const std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt; &amp;data_component_interpretation=std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="data__out__dof__data_8h_source.html#l01087">data_out_dof_data.h:1087</a></div></div>
<div class="ttc" id="aclassDataOut_html"><div class="ttname"><a href="classDataOut.html">DataOut</a></div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out_8h_source.html#l00147">data_out.h:150</a></div></div>
<div class="ttc" id="aclassDataOut_html_a5eb51872b8736849bb7e8d2007fae086"><div class="ttname"><a href="classDataOut.html#a5eb51872b8736849bb7e8d2007fae086">DataOut::build_patches</a></div><div class="ttdeci">virtual void build_patches(const unsigned int n_subdivisions=0)</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out_8cc_source.html#l01085">data_out.cc:1085</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga0864e51eb173c87e2a3edc9391ea8009"><div class="ttname"><a href="group__Exceptions.html#ga0864e51eb173c87e2a3edc9391ea8009">DataOutInterface::write_vtu_with_pvtu_record</a></div><div class="ttdeci">std::string write_vtu_with_pvtu_record(const std::string &amp;directory, const std::string &amp;filename_without_extension, const unsigned int counter, const MPI_Comm &amp;mpi_communicator, const unsigned int n_digits_for_counter=numbers::invalid_unsigned_int, const unsigned int n_groups=0) const</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8cc_source.html#l07326">data_out_base.cc:7326</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga3be0d6de1c92b770e8664bce2fc7c107"><div class="ttname"><a href="group__Exceptions.html#ga3be0d6de1c92b770e8664bce2fc7c107">DataOutBase::VtkFlags::compression_level</a></div><div class="ttdeci">ZlibCompressionLevel compression_level</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8h_source.html#l01151">data_out_base.h:1151</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_gac7280a24690b117454acfb0fa058299c"><div class="ttname"><a href="group__Exceptions.html#gac7280a24690b117454acfb0fa058299c">DataOutInterface::set_flags</a></div><div class="ttdeci">void set_flags(const FlagType &amp;flags)</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8cc_source.html#l08166">data_out_base.cc:8166</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_gga7ad65742b9dbfb7eeb04b511b5a08d63a3b747f53b680a2f1dd1c8e345a1e7261"><div class="ttname"><a href="group__Exceptions.html#gga7ad65742b9dbfb7eeb04b511b5a08d63a3b747f53b680a2f1dd1c8e345a1e7261">DataOutBase::VtkFlags::best_speed</a></div><div class="ttdeci">@ best_speed</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8h_source.html#l01134">data_out_base.h:1134</a></div></div>
<div class="ttc" id="anamespaceVectorTools_html_a21eb62d70953182dcc2b15c4e14dd533"><div class="ttname"><a href="namespaceVectorTools.html#a21eb62d70953182dcc2b15c4e14dd533">VectorTools::compute_global_error</a></div><div class="ttdeci">double compute_global_error(const Triangulation&lt; dim, spacedim &gt; &amp;tria, const InVector &amp;cellwise_error, const NormType &amp;norm, const double exponent=2.)</div></div>
<div class="ttc" id="anamespaceVectorTools_html_a676190d2c897ac5da68a9c460fa95832"><div class="ttname"><a href="namespaceVectorTools.html#a676190d2c897ac5da68a9c460fa95832">VectorTools::integrate_difference</a></div><div class="ttdeci">void integrate_difference(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const InVector &amp;fe_function, const Function&lt; spacedim, typename InVector::value_type &gt; &amp;exact_solution, OutVector &amp;difference, const Quadrature&lt; dim &gt; &amp;q, const NormType &amp;norm, const Function&lt; spacedim, double &gt; *weight=nullptr, const double exponent=2.)</div></div>
<div class="ttc" id="anamespaceVectorTools_html_a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e"><div class="ttname"><a href="namespaceVectorTools.html#a69967cb7a148a7169963126249213db1aa3903caf348e2d5dc54d1b49e15c1e8e">VectorTools::L2_norm</a></div><div class="ttdeci">@ L2_norm</div><div class="ttdef"><b>Definition:</b> <a href="vector__tools__common_8h_source.html#l00113">vector_tools_common.h:113</a></div></div>
<div class="ttc" id="astructDataOutBase_1_1VtkFlags_html"><div class="ttname"><a href="structDataOutBase_1_1VtkFlags.html">DataOutBase::VtkFlags</a></div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8h_source.html#l01087">data_out_base.h:1088</a></div></div>
</div><!-- fragment --><p><code><a class="el" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run()</a></code>函数中也没有什么令人惊讶的地方。我们只是在一系列（全局）细化的网格上计算解决方案。</p>
<div class="fragment"><div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> fe_degree&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">HelmholtzProblem&lt;dim, fe_degree&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cycle = 0; cycle &lt; 7 - dim; ++cycle)</div>
<div class="line">      {</div>
<div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;Cycle &quot;</span> &lt;&lt; cycle &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (cycle == 0)</div>
<div class="line">          <a class="code" href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a>(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>, 0., 1.);</div>
<div class="line">        <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.refine_global(1);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        setup_system();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        pcout &lt;&lt; <span class="stringliteral">&quot;   Number of active cells:       &quot;</span></div>
<div class="line">              &lt;&lt; <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_global_active_cells() &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;   Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.<a class="code" href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">n_dofs</a>()</div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        assemble_rhs();</div>
<div class="line">        solve();</div>
<div class="line">        output_results(cycle);</div>
<div class="line">        pcout &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step64</span></div>
<div class="ttc" id="aclassDoFHandler_html_aa5b8d3c4b9deb0774dde5c2851e07e1e"><div class="ttname"><a href="classDoFHandler.html#aa5b8d3c4b9deb0774dde5c2851e07e1e">DoFHandler::n_dofs</a></div><div class="ttdeci">types::global_dof_index n_dofs() const</div></div>
<div class="ttc" id="anamespaceGridGenerator_html_acea0cbcd68e52ce8113d1134b87de403"><div class="ttname"><a href="namespaceGridGenerator.html#acea0cbcd68e52ce8113d1134b87de403">GridGenerator::hyper_cube</a></div><div class="ttdeci">void hyper_cube(Triangulation&lt; dim, spacedim &gt; &amp;tria, const double left=0., const double right=1., const bool colorize=false)</div></div>
</div><!-- fragment --><p><a class="anchor" id="Thecodemaincodefunction"></a></p><h3>The <code>main()</code> function</h3>
<p>最后为<code>main()</code>函数。 默认情况下，所有的MPI等级将尝试访问编号为0的设备，我们假设它是与某一MPI等级运行的CPU相关的GPU设备。这是可行的，但是如果我们在运行MPI支持时，可能会有多个MPI进程在同一台机器上运行（例如，每个CPU核心一个），然后它们都想访问该机器上的同一个GPU。如果机器上只有一个GPU，我们对此无能为力。该机器上的所有MPI行列都需要共享它。但是如果有不止一个GPU，那么最好为不同的进程解决不同的显卡。下面的选择是基于MPI进程的ID，通过将GPU轮流分配给GPU行列。(为了正确地工作，这个方案假定一台机器上的MPI等级是连续的。如果不是这样的话，那么等级与GPU的关联可能就不是最佳的了）。) 为了使其正常工作，在使用这个函数之前，需要对MPI进行初始化。</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span>Step64;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <a class="code" href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a> mpi_init(argc, argv, 1);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keywordtype">int</span>         n_devices       = 0;</div>
<div class="line">      cudaError_t cuda_error_code = cudaGetDeviceCount(&amp;n_devices);</div>
<div class="line">      <a class="code" href="group__Exceptions.html#gac1b7e8a4a8d5d910cd9fbd8814e9955e">AssertCuda</a>(cuda_error_code);</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> my_mpi_id =</div>
<div class="line">        <a class="code" href="namespaceUtilities_1_1MPI.html#a895dcd8223a0ee6f0e6a80b80e2d5982">Utilities::MPI::this_mpi_process</a>(MPI_COMM_WORLD);</div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">int</span> device_id = my_mpi_id % n_devices;</div>
<div class="line">      cuda_error_code     = cudaSetDevice(device_id);</div>
<div class="line">      <a class="code" href="group__Exceptions.html#gac1b7e8a4a8d5d910cd9fbd8814e9955e">AssertCuda</a>(cuda_error_code);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      HelmholtzProblem&lt;3, 3&gt; helmholtz_problem;</div>
<div class="line">      helmholtz_problem.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aclassUtilities_1_1MPI_1_1MPI__InitFinalize_html"><div class="ttname"><a href="classUtilities_1_1MPI_1_1MPI__InitFinalize.html">Utilities::MPI::MPI_InitFinalize</a></div><div class="ttdef"><b>Definition:</b> <a href="mpi_8h_source.html#l00902">mpi.h:903</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_gac1b7e8a4a8d5d910cd9fbd8814e9955e"><div class="ttname"><a href="group__Exceptions.html#gac1b7e8a4a8d5d910cd9fbd8814e9955e">AssertCuda</a></div><div class="ttdeci">#define AssertCuda(error_code)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01780">exceptions.h:1780</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>由于本教程的主要目的是演示如何使用 <a class="el" href="classCUDAWrappers_1_1MatrixFree.html">CUDAWrappers::MatrixFree</a> 接口，而不是计算任何有用的东西本身，我们只是在这里显示预期的输出。</p>
<div class="fragment"><div class="line">Cycle 0</div>
<div class="line">   Number of active cells:       8</div>
<div class="line">   Number of degrees of freedom: 343</div>
<div class="line">  Solved in 27 iterations.</div>
<div class="line">  solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>: 0.0205439</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Cycle 1</div>
<div class="line">   Number of active cells:       64</div>
<div class="line">   Number of degrees of freedom: 2197</div>
<div class="line">  Solved in 60 iterations.</div>
<div class="line">  solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>: 0.0205269</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Cycle 2</div>
<div class="line">   Number of active cells:       512</div>
<div class="line">   Number of degrees of freedom: 15625</div>
<div class="line">  Solved in 114 iterations.</div>
<div class="line">  solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>: 0.0205261</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Cycle 3</div>
<div class="line">   Number of active cells:       4096</div>
<div class="line">   Number of degrees of freedom: 117649</div>
<div class="line">  Solved in 227 iterations.</div>
<div class="line">  solution <a class="code" href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">norm</a>: 0.0205261</div>
<div class="ttc" id="anamespaceLocalIntegrators_1_1Divergence_html_a8bcfc37d2a2be8faa18628a601ecf112"><div class="ttname"><a href="namespaceLocalIntegrators_1_1Divergence.html#a8bcfc37d2a2be8faa18628a601ecf112">LocalIntegrators::Divergence::norm</a></div><div class="ttdeci">double norm(const FEValuesBase&lt; dim &gt; &amp;fe, const ArrayView&lt; const std::vector&lt; Tensor&lt; 1, dim &gt;&gt;&gt; &amp;Du)</div><div class="ttdef"><b>Definition:</b> <a href="divergence_8h_source.html#l00472">divergence.h:472</a></div></div>
</div><!-- fragment --><p>在这里，人们可以提出两个看法。首先，数值解的规范收敛了，大概是收敛到精确（但未知）解的规范。其次，每次细化网格时，迭代次数大约增加一倍。这与CG迭代次数随矩阵条件数的平方根增长的预期一致；而且我们知道二阶微分运算的矩阵条件数的增长方式为 \({\cal O}(h^{-2})\) 。这当然是相当低效的，因为一个最佳解算器的迭代次数与问题的大小无关。但是要有这样一个求解器，就需要使用比我们在这里使用的身份矩阵更好的预处理程序。</p>
<p><a class="anchor" id="extensions"></a> <a class="anchor" id="Possibilitiesforextensions"></a></p><h3>Possibilities for extensions </h3>
<p>目前，这个程序完全没有使用预处理程序。这主要是因为构造一个高效的无矩阵预处理程序是不容易的。 然而，只需要相应矩阵的对角线的简单选择是很好的选择，这些也可以用无矩阵的方式计算。另外，也许更好的是，我们可以扩展教程，使用类似于 step-37 的切比雪夫平滑器的多网格。<a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line">/* ---------------------------------------------------------------------</div>
<div class="line"> *</div>
<div class="line"> * Copyright (C) 2019 - 2020 by the deal.II authors</div>
<div class="line"> *</div>
<div class="line"> * This file is part of the deal.II library.</div>
<div class="line"> *</div>
<div class="line"> * The deal.II library is free software; you can use it, redistribute</div>
<div class="line"> * it, and/or modify it under the terms of the GNU Lesser General</div>
<div class="line"> * Public License as published by the Free Software Foundation; either</div>
<div class="line"> * version 2.1 of the License, or (at your option) any later version.</div>
<div class="line"> * The full text of the license can be found in the file LICENSE.md at</div>
<div class="line"> * the top level directory of deal.II.</div>
<div class="line"> *</div>
<div class="line"> * ---------------------------------------------------------------------</div>
<div class="line"> </div>
<div class="line"> *</div>
<div class="line"> * Authors: Bruno Turcksin, Daniel Arndt, Oak Ridge National Laboratory, 2019</div>
<div class="line"> */</div>
<div class="line"> </div>
<div class="line">#include &lt;deal.II/base/conditional_ostream.h&gt;</div>
<div class="line">#include &lt;deal.II/base/quadrature_lib.h&gt;</div>
<div class="line"> </div>
<div class="line">#include &lt;deal.II/dofs/dof_tools.h&gt;</div>
<div class="line"> </div>
<div class="line">#include &lt;deal.II/fe/fe_q.h&gt;</div>
<div class="line"> </div>
<div class="line">#include &lt;deal.II/grid/grid_generator.h&gt;</div>
<div class="line">#include &lt;deal.II/grid/tria.h&gt;</div>
<div class="line"> </div>
<div class="line">#include &lt;deal.II/lac/affine_constraints.h&gt;</div>
<div class="line">#include &lt;deal.II/lac/la_parallel_vector.h&gt;</div>
<div class="line">#include &lt;deal.II/lac/precondition.h&gt;</div>
<div class="line">#include &lt;deal.II/lac/solver_cg.h&gt;</div>
<div class="line"> </div>
<div class="line">#include &lt;deal.II/numerics/data_out.h&gt;</div>
<div class="line">#include &lt;deal.II/numerics/vector_tools.h&gt;</div>
<div class="line"> </div>
<div class="line">#include &lt;deal.II/base/cuda.h&gt;</div>
<div class="line"> </div>
<div class="line">#include &lt;deal.II/matrix_free/cuda_fe_evaluation.h&gt;</div>
<div class="line">#include &lt;deal.II/matrix_free/cuda_matrix_free.h&gt;</div>
<div class="line">#include &lt;deal.II/matrix_free/operators.h&gt;</div>
<div class="line"> </div>
<div class="line">#include &lt;fstream&gt;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">namespace Step64</div>
<div class="line">{</div>
<div class="line">  using namespace dealii;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  template &lt;int dim, int fe_degree&gt;</div>
<div class="line">  class VaryingCoefficientFunctor</div>
<div class="line">  {</div>
<div class="line">  public:</div>
<div class="line">    VaryingCoefficientFunctor(double *coefficient)</div>
<div class="line">      : coef(coefficient)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    __device__ void operator()(</div>
<div class="line">      const unsigned int                                          cell,</div>
<div class="line">      const typename CUDAWrappers::MatrixFree&lt;dim, double&gt;::Data *gpu_data);</div>
<div class="line"> </div>
<div class="line">    static const unsigned int n_dofs_1d = fe_degree + 1;</div>
<div class="line">    static const unsigned int n_local_dofs =</div>
<div class="line">      ::Utilities::pow(n_dofs_1d, dim);</div>
<div class="line">    static const unsigned int n_q_points =</div>
<div class="line">      ::Utilities::pow(n_dofs_1d, dim);</div>
<div class="line"> </div>
<div class="line">  private:</div>
<div class="line">    double *coef;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  template &lt;int dim, int fe_degree&gt;</div>
<div class="line">  __device__ void VaryingCoefficientFunctor&lt;dim, fe_degree&gt;::operator()(</div>
<div class="line">    const unsigned int                                          cell,</div>
<div class="line">    const typename CUDAWrappers::MatrixFree&lt;dim, double&gt;::Data *gpu_data)</div>
<div class="line">  {</div>
<div class="line">    const unsigned int pos = CUDAWrappers::local_q_point_id&lt;dim, double&gt;(</div>
<div class="line">      cell, gpu_data, n_dofs_1d, n_q_points);</div>
<div class="line">    const Point&lt;dim&gt; q_point =</div>
<div class="line">      CUDAWrappers::get_quadrature_point&lt;dim, double&gt;(cell,</div>
<div class="line">                                                      gpu_data,</div>
<div class="line">                                                      n_dofs_1d);</div>
<div class="line"> </div>
<div class="line">    double p_square = 0.;</div>
<div class="line">    for (unsigned int i = 0; i &lt; dim; ++i)</div>
<div class="line">      {</div>
<div class="line">        const double coord = q_point[i];</div>
<div class="line">        p_square += coord * coord;</div>
<div class="line">      }</div>
<div class="line">    coef[pos] = 10. / (0.05 + 2. * p_square);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  template &lt;int dim, int fe_degree&gt;</div>
<div class="line">  class HelmholtzOperatorQuad</div>
<div class="line">  {</div>
<div class="line">  public:</div>
<div class="line">    __device__ HelmholtzOperatorQuad(double coef)</div>
<div class="line">      : coef(coef)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    __device__ void</div>
<div class="line">    operator()(CUDAWrappers::FEEvaluation&lt;dim, fe_degree&gt; *fe_eval) const;</div>
<div class="line"> </div>
<div class="line">  private:</div>
<div class="line">    double coef;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  template &lt;int dim, int fe_degree&gt;</div>
<div class="line">  __device__ void HelmholtzOperatorQuad&lt;dim, fe_degree&gt;::</div>
<div class="line">                  operator()(CUDAWrappers::FEEvaluation&lt;dim, fe_degree&gt; *fe_eval) const</div>
<div class="line">  {</div>
<div class="line">    fe_eval-&gt;submit_value(coef * fe_eval-&gt;get_value());</div>
<div class="line">    fe_eval-&gt;submit_gradient(fe_eval-&gt;get_gradient());</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  template &lt;int dim, int fe_degree&gt;</div>
<div class="line">  class LocalHelmholtzOperator</div>
<div class="line">  {</div>
<div class="line">  public:</div>
<div class="line">    LocalHelmholtzOperator(double *coefficient)</div>
<div class="line">      : coef(coefficient)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    __device__ void operator()(</div>
<div class="line">      const unsigned int                                          cell,</div>
<div class="line">      const typename CUDAWrappers::MatrixFree&lt;dim, double&gt;::Data *gpu_data,</div>
<div class="line">      CUDAWrappers::SharedData&lt;dim, double&gt; *                     shared_data,</div>
<div class="line">      const double *                                              src,</div>
<div class="line">      double *                                                    dst) const;</div>
<div class="line"> </div>
<div class="line">    static const unsigned int n_dofs_1d    = fe_degree + 1;</div>
<div class="line">    static const unsigned int n_local_dofs = Utilities::pow(fe_degree + 1, dim);</div>
<div class="line">    static const unsigned int n_q_points   = Utilities::pow(fe_degree + 1, dim);</div>
<div class="line"> </div>
<div class="line">  private:</div>
<div class="line">    double *coef;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  template &lt;int dim, int fe_degree&gt;</div>
<div class="line">  __device__ void LocalHelmholtzOperator&lt;dim, fe_degree&gt;::operator()(</div>
<div class="line">    const unsigned int                                          cell,</div>
<div class="line">    const typename CUDAWrappers::MatrixFree&lt;dim, double&gt;::Data *gpu_data,</div>
<div class="line">    CUDAWrappers::SharedData&lt;dim, double&gt; *                     shared_data,</div>
<div class="line">    const double *                                              src,</div>
<div class="line">    double *                                                    dst) const</div>
<div class="line">  {</div>
<div class="line">    const unsigned int pos = CUDAWrappers::local_q_point_id&lt;dim, double&gt;(</div>
<div class="line">      cell, gpu_data, n_dofs_1d, n_q_points);</div>
<div class="line"> </div>
<div class="line">    CUDAWrappers::FEEvaluation&lt;dim, fe_degree, fe_degree + 1, 1, double&gt;</div>
<div class="line">      fe_eval(cell, gpu_data, shared_data);</div>
<div class="line">    fe_eval.read_dof_values(src);</div>
<div class="line">    fe_eval.evaluate(true, true);</div>
<div class="line">    fe_eval.apply_for_each_quad_point(</div>
<div class="line">      HelmholtzOperatorQuad&lt;dim, fe_degree&gt;(coef[pos]));</div>
<div class="line">    fe_eval.integrate(true, true);</div>
<div class="line">    fe_eval.distribute_local_to_global(dst);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  template &lt;int dim, int fe_degree&gt;</div>
<div class="line">  class HelmholtzOperator</div>
<div class="line">  {</div>
<div class="line">  public:</div>
<div class="line">    HelmholtzOperator(const DoFHandler&lt;dim&gt; &amp;          dof_handler,</div>
<div class="line">                      const AffineConstraints&lt;double&gt; &amp;constraints);</div>
<div class="line"> </div>
<div class="line">    void</div>
<div class="line">    vmult(LinearAlgebra::distributed::Vector&lt;double, MemorySpace::CUDA&gt; &amp;dst,</div>
<div class="line">          const LinearAlgebra::distributed::Vector&lt;double, MemorySpace::CUDA&gt;</div>
<div class="line">            &amp;src) const;</div>
<div class="line"> </div>
<div class="line">    void initialize_dof_vector(</div>
<div class="line">      LinearAlgebra::distributed::Vector&lt;double, MemorySpace::CUDA&gt; &amp;vec) const;</div>
<div class="line"> </div>
<div class="line">  private:</div>
<div class="line">    CUDAWrappers::MatrixFree&lt;dim, double&gt;       mf_data;</div>
<div class="line">    LinearAlgebra::CUDAWrappers::Vector&lt;double&gt; coef;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  template &lt;int dim, int fe_degree&gt;</div>
<div class="line">  HelmholtzOperator&lt;dim, fe_degree&gt;::HelmholtzOperator(</div>
<div class="line">    const DoFHandler&lt;dim&gt; &amp;          dof_handler,</div>
<div class="line">    const AffineConstraints&lt;double&gt; &amp;constraints)</div>
<div class="line">  {</div>
<div class="line">    MappingQGeneric&lt;dim&gt; mapping(fe_degree);</div>
<div class="line">    typename CUDAWrappers::MatrixFree&lt;dim, double&gt;::AdditionalData</div>
<div class="line">      additional_data;</div>
<div class="line">    additional_data.mapping_update_flags = update_values | update_gradients |</div>
<div class="line">                                           update_JxW_values |</div>
<div class="line">                                           update_quadrature_points;</div>
<div class="line">    const QGauss&lt;1&gt; quad(fe_degree + 1);</div>
<div class="line">    mf_data.reinit(mapping, dof_handler, constraints, quad, additional_data);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    const unsigned int n_owned_cells =</div>
<div class="line">      dynamic_cast&lt;const parallel::TriangulationBase&lt;dim&gt; *&gt;(</div>
<div class="line">        &amp;dof_handler.get_triangulation())</div>
<div class="line">        -&gt;n_locally_owned_active_cells();</div>
<div class="line">    coef.reinit(Utilities::pow(fe_degree + 1, dim) * n_owned_cells);</div>
<div class="line"> </div>
<div class="line">    const VaryingCoefficientFunctor&lt;dim, fe_degree&gt; functor(coef.get_values());</div>
<div class="line">    mf_data.evaluate_coefficients(functor);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  template &lt;int dim, int fe_degree&gt;</div>
<div class="line">  void HelmholtzOperator&lt;dim, fe_degree&gt;::vmult(</div>
<div class="line">    LinearAlgebra::distributed::Vector&lt;double, MemorySpace::CUDA&gt; &amp;      dst,</div>
<div class="line">    const LinearAlgebra::distributed::Vector&lt;double, MemorySpace::CUDA&gt; &amp;src)</div>
<div class="line">    const</div>
<div class="line">  {</div>
<div class="line">    dst = 0.;</div>
<div class="line">    LocalHelmholtzOperator&lt;dim, fe_degree&gt; helmholtz_operator(</div>
<div class="line">      coef.get_values());</div>
<div class="line">    mf_data.cell_loop(helmholtz_operator, src, dst);</div>
<div class="line">    mf_data.copy_constrained_values(src, dst);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  template &lt;int dim, int fe_degree&gt;</div>
<div class="line">  void HelmholtzOperator&lt;dim, fe_degree&gt;::initialize_dof_vector(</div>
<div class="line">    LinearAlgebra::distributed::Vector&lt;double, MemorySpace::CUDA&gt; &amp;vec) const</div>
<div class="line">  {</div>
<div class="line">    mf_data.initialize_dof_vector(vec);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  template &lt;int dim, int fe_degree&gt;</div>
<div class="line">  class HelmholtzProblem</div>
<div class="line">  {</div>
<div class="line">  public:</div>
<div class="line">    HelmholtzProblem();</div>
<div class="line"> </div>
<div class="line">    void run();</div>
<div class="line"> </div>
<div class="line">  private:</div>
<div class="line">    void setup_system();</div>
<div class="line"> </div>
<div class="line">    void assemble_rhs();</div>
<div class="line"> </div>
<div class="line">    void solve();</div>
<div class="line"> </div>
<div class="line">    void output_results(const unsigned int cycle) const;</div>
<div class="line"> </div>
<div class="line">    MPI_Comm mpi_communicator;</div>
<div class="line"> </div>
<div class="line">    parallel::distributed::Triangulation&lt;dim&gt; triangulation;</div>
<div class="line"> </div>
<div class="line">    FE_Q&lt;dim&gt;       fe;</div>
<div class="line">    DoFHandler&lt;dim&gt; dof_handler;</div>
<div class="line"> </div>
<div class="line">    IndexSet locally_owned_dofs;</div>
<div class="line">    IndexSet locally_relevant_dofs;</div>
<div class="line"> </div>
<div class="line">    AffineConstraints&lt;double&gt;                          constraints;</div>
<div class="line">    std::unique_ptr&lt;HelmholtzOperator&lt;dim, fe_degree&gt;&gt; system_matrix_dev;</div>
<div class="line"> </div>
<div class="line">    LinearAlgebra::distributed::Vector&lt;double, MemorySpace::Host&gt;</div>
<div class="line">                                                                  ghost_solution_host;</div>
<div class="line">    LinearAlgebra::distributed::Vector&lt;double, MemorySpace::CUDA&gt; solution_dev;</div>
<div class="line">    LinearAlgebra::distributed::Vector&lt;double, MemorySpace::CUDA&gt;</div>
<div class="line">      system_rhs_dev;</div>
<div class="line"> </div>
<div class="line">    ConditionalOStream pcout;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  template &lt;int dim, int fe_degree&gt;</div>
<div class="line">  HelmholtzProblem&lt;dim, fe_degree&gt;::HelmholtzProblem()</div>
<div class="line">    : mpi_communicator(MPI_COMM_WORLD)</div>
<div class="line">    , triangulation(mpi_communicator)</div>
<div class="line">    , fe(fe_degree)</div>
<div class="line">    , dof_handler(triangulation)</div>
<div class="line">    , pcout(std::cout, Utilities::MPI::this_mpi_process(mpi_communicator) == 0)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  template &lt;int dim, int fe_degree&gt;</div>
<div class="line">  void HelmholtzProblem&lt;dim, fe_degree&gt;::setup_system()</div>
<div class="line">  {</div>
<div class="line">    dof_handler.distribute_dofs(fe);</div>
<div class="line"> </div>
<div class="line">    locally_owned_dofs = dof_handler.locally_owned_dofs();</div>
<div class="line">    DoFTools::extract_locally_relevant_dofs(dof_handler, locally_relevant_dofs);</div>
<div class="line">    system_rhs_dev.reinit(locally_owned_dofs, mpi_communicator);</div>
<div class="line"> </div>
<div class="line">    constraints.clear();</div>
<div class="line">    constraints.reinit(locally_relevant_dofs);</div>
<div class="line">    DoFTools::make_hanging_node_constraints(dof_handler, constraints);</div>
<div class="line">    VectorTools::interpolate_boundary_values(dof_handler,</div>
<div class="line">                                             0,</div>
<div class="line">                                             Functions::ZeroFunction&lt;dim&gt;(),</div>
<div class="line">                                             constraints);</div>
<div class="line">    constraints.close();</div>
<div class="line"> </div>
<div class="line">    system_matrix_dev.reset(</div>
<div class="line">      new HelmholtzOperator&lt;dim, fe_degree&gt;(dof_handler, constraints));</div>
<div class="line"> </div>
<div class="line">    ghost_solution_host.reinit(locally_owned_dofs,</div>
<div class="line">                               locally_relevant_dofs,</div>
<div class="line">                               mpi_communicator);</div>
<div class="line">    system_matrix_dev-&gt;initialize_dof_vector(solution_dev);</div>
<div class="line">    system_rhs_dev.reinit(solution_dev);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  template &lt;int dim, int fe_degree&gt;</div>
<div class="line">  void HelmholtzProblem&lt;dim, fe_degree&gt;::assemble_rhs()</div>
<div class="line">  {</div>
<div class="line">    LinearAlgebra::distributed::Vector&lt;double, MemorySpace::Host&gt;</div>
<div class="line">                      system_rhs_host(locally_owned_dofs,</div>
<div class="line">                      locally_relevant_dofs,</div>
<div class="line">                      mpi_communicator);</div>
<div class="line">    const QGauss&lt;dim&gt; quadrature_formula(fe_degree + 1);</div>
<div class="line"> </div>
<div class="line">    FEValues&lt;dim&gt; fe_values(fe,</div>
<div class="line">                            quadrature_formula,</div>
<div class="line">                            update_values | update_quadrature_points |</div>
<div class="line">                              update_JxW_values);</div>
<div class="line"> </div>
<div class="line">    const unsigned int dofs_per_cell = fe.n_dofs_per_cell();</div>
<div class="line">    const unsigned int n_q_points    = quadrature_formula.size();</div>
<div class="line"> </div>
<div class="line">    Vector&lt;double&gt; cell_rhs(dofs_per_cell);</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;types::global_dof_index&gt; local_dof_indices(dofs_per_cell);</div>
<div class="line"> </div>
<div class="line">    for (const auto &amp;cell : dof_handler.active_cell_iterators())</div>
<div class="line">      if (cell-&gt;is_locally_owned())</div>
<div class="line">        {</div>
<div class="line">          cell_rhs = 0;</div>
<div class="line"> </div>
<div class="line">          fe_values.reinit(cell);</div>
<div class="line"> </div>
<div class="line">          for (unsigned int q_index = 0; q_index &lt; n_q_points; ++q_index)</div>
<div class="line">            {</div>
<div class="line">              for (unsigned int i = 0; i &lt; dofs_per_cell; ++i)</div>
<div class="line">                cell_rhs(i) += (fe_values.shape_value(i, q_index) * 1.0 *</div>
<div class="line">                                fe_values.JxW(q_index));</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">          cell-&gt;get_dof_indices(local_dof_indices);</div>
<div class="line">          constraints.distribute_local_to_global(cell_rhs,</div>
<div class="line">                                                 local_dof_indices,</div>
<div class="line">                                                 system_rhs_host);</div>
<div class="line">        }</div>
<div class="line">    system_rhs_host.compress(VectorOperation::add);</div>
<div class="line"> </div>
<div class="line">    LinearAlgebra::ReadWriteVector&lt;double&gt; rw_vector(locally_owned_dofs);</div>
<div class="line">    rw_vector.import(system_rhs_host, VectorOperation::insert);</div>
<div class="line">    system_rhs_dev.import(rw_vector, VectorOperation::insert);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  template &lt;int dim, int fe_degree&gt;</div>
<div class="line">  void HelmholtzProblem&lt;dim, fe_degree&gt;::solve()</div>
<div class="line">  {</div>
<div class="line">    PreconditionIdentity preconditioner;</div>
<div class="line"> </div>
<div class="line">    SolverControl solver_control(system_rhs_dev.size(),</div>
<div class="line">                                 1e-12 * system_rhs_dev.l2_norm());</div>
<div class="line">    SolverCG&lt;LinearAlgebra::distributed::Vector&lt;double, MemorySpace::CUDA&gt;&gt; cg(</div>
<div class="line">      solver_control);</div>
<div class="line">    cg.solve(*system_matrix_dev, solution_dev, system_rhs_dev, preconditioner);</div>
<div class="line"> </div>
<div class="line">    pcout &lt;&lt; &quot;  Solved in &quot; &lt;&lt; solver_control.last_step() &lt;&lt; &quot; iterations.&quot;</div>
<div class="line">          &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    LinearAlgebra::ReadWriteVector&lt;double&gt; rw_vector(locally_owned_dofs);</div>
<div class="line">    rw_vector.import(solution_dev, VectorOperation::insert);</div>
<div class="line">    ghost_solution_host.import(rw_vector, VectorOperation::insert);</div>
<div class="line"> </div>
<div class="line">    constraints.distribute(ghost_solution_host);</div>
<div class="line"> </div>
<div class="line">    ghost_solution_host.update_ghost_values();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  template &lt;int dim, int fe_degree&gt;</div>
<div class="line">  void HelmholtzProblem&lt;dim, fe_degree&gt;::output_results(</div>
<div class="line">    const unsigned int cycle) const</div>
<div class="line">  {</div>
<div class="line">    DataOut&lt;dim&gt; data_out;</div>
<div class="line"> </div>
<div class="line">    data_out.attach_dof_handler(dof_handler);</div>
<div class="line">    data_out.add_data_vector(ghost_solution_host, &quot;solution&quot;);</div>
<div class="line">    data_out.build_patches();</div>
<div class="line"> </div>
<div class="line">    DataOutBase::VtkFlags flags;</div>
<div class="line">    flags.compression_level = DataOutBase::VtkFlags::best_speed;</div>
<div class="line">    data_out.set_flags(flags);</div>
<div class="line">    data_out.write_vtu_with_pvtu_record(</div>
<div class="line">      &quot;./&quot;, &quot;solution&quot;, cycle, mpi_communicator, 2);</div>
<div class="line"> </div>
<div class="line">    Vector&lt;float&gt; cellwise_norm(triangulation.n_active_cells());</div>
<div class="line">    VectorTools::integrate_difference(dof_handler,</div>
<div class="line">                                      ghost_solution_host,</div>
<div class="line">                                      Functions::ZeroFunction&lt;dim&gt;(),</div>
<div class="line">                                      cellwise_norm,</div>
<div class="line">                                      QGauss&lt;dim&gt;(fe.degree + 2),</div>
<div class="line">                                      VectorTools::L2_norm);</div>
<div class="line">    const double global_norm =</div>
<div class="line">      VectorTools::compute_global_error(triangulation,</div>
<div class="line">                                        cellwise_norm,</div>
<div class="line">                                        VectorTools::L2_norm);</div>
<div class="line">    pcout &lt;&lt; &quot;  solution norm: &quot; &lt;&lt; global_norm &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  template &lt;int dim, int fe_degree&gt;</div>
<div class="line">  void HelmholtzProblem&lt;dim, fe_degree&gt;::run()</div>
<div class="line">  {</div>
<div class="line">    for (unsigned int cycle = 0; cycle &lt; 7 - dim; ++cycle)</div>
<div class="line">      {</div>
<div class="line">        pcout &lt;&lt; &quot;Cycle &quot; &lt;&lt; cycle &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        if (cycle == 0)</div>
<div class="line">          GridGenerator::hyper_cube(triangulation, 0., 1.);</div>
<div class="line">        triangulation.refine_global(1);</div>
<div class="line"> </div>
<div class="line">        setup_system();</div>
<div class="line"> </div>
<div class="line">        pcout &lt;&lt; &quot;   Number of active cells:       &quot;</div>
<div class="line">              &lt;&lt; triangulation.n_global_active_cells() &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; &quot;   Number of degrees of freedom: &quot; &lt;&lt; dof_handler.n_dofs()</div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        assemble_rhs();</div>
<div class="line">        solve();</div>
<div class="line">        output_results(cycle);</div>
<div class="line">        pcout &lt;&lt; std::endl;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">} // namespace Step64</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">int main(int argc, char *argv[])</div>
<div class="line">{</div>
<div class="line">  try</div>
<div class="line">    {</div>
<div class="line">      using namespace Step64;</div>
<div class="line"> </div>
<div class="line">      Utilities::MPI::MPI_InitFinalize mpi_init(argc, argv, 1);</div>
<div class="line"> </div>
<div class="line">      int         n_devices       = 0;</div>
<div class="line">      cudaError_t cuda_error_code = cudaGetDeviceCount(&amp;n_devices);</div>
<div class="line">      AssertCuda(cuda_error_code);</div>
<div class="line">      const unsigned int my_mpi_id =</div>
<div class="line">        Utilities::MPI::this_mpi_process(MPI_COMM_WORLD);</div>
<div class="line">      const int device_id = my_mpi_id % n_devices;</div>
<div class="line">      cuda_error_code     = cudaSetDevice(device_id);</div>
<div class="line">      AssertCuda(cuda_error_code);</div>
<div class="line"> </div>
<div class="line">      HelmholtzProblem&lt;3, 3&gt; helmholtz_problem;</div>
<div class="line">      helmholtz_problem.run();</div>
<div class="line">    }</div>
<div class="line">  catch (std::exception &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; &quot;----------------------------------------------------&quot;</div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; &quot;Exception on processing: &quot; &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; &quot;Aborting!&quot; &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; &quot;----------------------------------------------------&quot;</div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      return 1;</div>
<div class="line">    }</div>
<div class="line">  catch (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; &quot;----------------------------------------------------&quot;</div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; &quot;Unknown exception!&quot; &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; &quot;Aborting!&quot; &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; &quot;----------------------------------------------------&quot;</div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      return 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  return 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> 。 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
