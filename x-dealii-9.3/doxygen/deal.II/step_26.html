<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="canonical" href="https://www.dealii.org/current/doxygen/deal.II/step_26.html" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The deal.II Library: The step-26 tutorial program  。</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link rel="SHORTCUT ICON" href="deal.ico"></link>
<script type="text/javascript" src="custom.js"></script>
<meta name="author" content="The deal.II Authors <authors@dealii.org>"></meta>
<meta name="copyright" content="Copyright (C) 1998 - 2021 by the deal.II authors"></meta>
<meta name="deal.II-version" content="9.3.0-pre"></meta>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo200.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">
   &#160;<span id="projectnumber">Reference documentation for deal.II version 9.3.0-pre</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!--Extra macros for MathJax:-->
<div style="display:none">
\(\newcommand{\dealvcentcolon}{\mathrel{\mathop{:}}}\)
\(\newcommand{\dealcoloneq}{\dealvcentcolon\mathrel{\mkern-1.2mu}=}\)
\(\newcommand{\jump}[1]{\left[\!\left[ #1 \right]\!\right]}\)
\(\newcommand{\average}[1]{\left\{\!\left\{ #1 \right\}\!\right\}}\)
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">The step-26 tutorial program 。 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>本教程取决于 <a class="el" href="step_6.html">step-6</a> 。</p>
<p> 
<table class="tutorial" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a><a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Adaptingmeshesfortimedependentproblems"> Adapting meshes for time dependent problems </a><a href="#Adaptingmeshesfortimedependentproblems"> Adapting meshes for time dependent problems </a>
        <li><a href="#WhatcouldpossiblygowrongVerifyingwhetherthecodeiscorrect"> What could possibly go wrong? Verifying whether the code is correct </a><a href="#WhatcouldpossiblygowrongVerifyingwhetherthecodeiscorrect"> What could possibly go wrong? Verifying whether the code is correct </a>
        <li><a href="#Thetestcase"> The testcase </a><a href="#Thetestcase"> The testcase </a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a><a href="#CommProg" class=bold>The commented program</a>
    <ul>
        <li><a href="#ThecodeHeatEquationcodeclass">The <code>HeatEquation</code> class</a><a href="#ThecodeHeatEquationcodeclass">The <code>HeatEquation</code> class</a>
        <li><a href="#Equationdata">Equation data</a><a href="#Equationdata">Equation data</a>
        <li><a href="#ThecodeHeatEquationcodeimplementation">The <code>HeatEquation</code> implementation</a><a href="#ThecodeHeatEquationcodeimplementation">The <code>HeatEquation</code> implementation</a>
      <ul>
        <li><a href="#codeHeatEquationsetup_systemcode"><code>HeatEquation::setup_system</code></a><a href="#codeHeatEquationsetup_systemcode"><code>HeatEquation::setup_system</code></a>
        <li><a href="#codeHeatEquationsolve_time_stepcode"><code>HeatEquation::solve_time_step</code></a><a href="#codeHeatEquationsolve_time_stepcode"><code>HeatEquation::solve_time_step</code></a>
        <li><a href="#codeHeatEquationoutput_resultscode"><code>HeatEquation::output_results</code></a><a href="#codeHeatEquationoutput_resultscode"><code>HeatEquation::output_results</code></a>
        <li><a href="#codeHeatEquationrefine_meshcode"><code>HeatEquation::refine_mesh</code></a><a href="#codeHeatEquationrefine_meshcode"><code>HeatEquation::refine_mesh</code></a>
        <li><a href="#codeHeatEquationruncode"><code>HeatEquation::run</code></a><a href="#codeHeatEquationruncode"><code>HeatEquation::run</code></a>
      </ul>
        <li><a href="#Thecodemaincodefunction">The <code>main</code> function</a><a href="#Thecodemaincodefunction">The <code>main</code> function</a>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a><a href="#Results" class=bold>Results</a>
    <ul>
        <li><a href="#Possibilitiesforextensions">Possibilities for extensions</a><a href="#Possibilitiesforextensions">Possibilities for extensions</a>
      <ul>
        <li><a href="#Adaptivetimestepping">Adaptive time stepping</a><a href="#Adaptivetimestepping">Adaptive time stepping</a>
        <li><a href="#Bettertimesteppingmethods">Better time stepping methods</a><a href="#Bettertimesteppingmethods">Better time stepping methods</a>
        <li><a href="#Betterrefinementcriteria">Better refinement criteria</a><a href="#Betterrefinementcriteria">Better refinement criteria</a>
        <li><a href="#Positivitypreservation">Positivity preservation</a><a href="#Positivitypreservation">Positivity preservation</a>
    </ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a><a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
</p>
<p><a class="anchor" id="Intro"></a> <a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<dl class="section note"><dt>Note</dt><dd>The material presented here is also discussed in <a href="http://www.math.colostate.edu/~bangerth/videos.676.29.html">video lecture 29</a>, <a href="http://www.math.colostate.edu/~bangerth/videos.676.30.html">video lecture 30</a>. (All video lectures are also available <a href="http://www.math.colostate.edu/~bangerth/videos.html">here</a>.) ( See also <a href="http://www.math.colostate.edu/~bangerth/videos.676.31.7.html">video lecture 31.7</a>.) ) <br  />
</dd></dl>
<p>这个程序实现了热力方程</p>
<p class="formulaDsp">
\begin{align*} \frac{\partial u(\mathbf x, t)}{\partial t} - \Delta u(\mathbf x, t) &amp;= f(\mathbf x, t), \qquad\qquad &amp;&amp; \forall \mathbf x \in \Omega, t\in (0,T), \\ u(\mathbf x, 0) &amp;= u_0(\mathbf x) &amp;&amp; \forall \mathbf x \in \Omega, \\ \\ u(\mathbf x, t) &amp;= g(\mathbf x,t) &amp;&amp; \forall \mathbf x \in \partial\Omega, t \in (0,T). \end{align*}
</p>
<p>在某种意义上，这个方程比我们在前面的程序 <a class="el" href="step_23.html">step-23</a> 、 <a class="el" href="step_24.html">step-24</a> 、 <a class="el" href="step_25.html">step-25</a> 中讨论的方程，即波浪方程要简单。这是由于热方程随着时间的推移使解变得平滑，因此在许多方面更宽容。例如，当使用隐式时间步长方法时，我们实际上可以采取大的时间步长，我们对通过每隔几步调整网格而引入的小干扰的麻烦较小，等等。</p>
<p>我们在这里的目标将是使用θ-scheme解决上述方程，该方程在时间上离散，使用以下方法，我们希望 \(u^n(\mathbf x)\) 在某个时间 \(t_n\) 近似 \(u(\mathbf x, t_n)\) 。</p>
<p class="formulaDsp">
\begin{align*} \frac{u^n(\mathbf x)-u^{n-1}(\mathbf x)}{k_n} - \left[ (1-\theta)\Delta u^{n-1}(\mathbf x) + \theta\Delta u^n(\mathbf x) \right] &amp;= \left[ (1-\theta)f(\mathbf x, t_{n-1}) + \theta f(\mathbf x, t_n) \right]. \end{align*}
</p>
<p>这里， \(k_n=t_n-t_{n-1}\) 是时间步长。Theta-scheme概括了显式欧拉（ \(\theta=0\) ）、隐式欧拉（ \(\theta=1\) ）和Crank-Nicolson（ \(\theta=\frac 12\) ）的时间离散。由于后者具有最高的收敛顺序，我们将在下面的程序中选择 \(\theta=\frac 12\) ，但要使这个参数的玩法保持简单。如果你对玩更高阶的方法感兴趣，可以看一下 <a class="el" href="step_52.html">step-52</a> 。</p>
<p>鉴于这种时间离散化，空间离散化会像往常一样发生，通过与测试函数相乘，通过部分积分，然后将一切限制在一个有限维的子空间。在与 \(k_n\) 相乘之后，这就产生了以下一组完全离散的方程。</p>
<p class="formulaDsp">
\begin{align*} M U^n-MU^{n-1} + k_n \left[ (1-\theta)A U^{n-1} + \theta A U^n \right] &amp;= k_n \left[ (1-\theta)F^{n-1} + \theta F^n \right], \end{align*}
</p>
<p>其中 \(M\) 是质量矩阵， \(A\) 是刚度矩阵，由拉普拉斯离散化产生。将所有已知的量带到右手边，得到我们必须在每一步解决的线性系统。</p>
<p class="formulaDsp">
\begin{align*} (M + k_n \theta A) U^n &amp;= MU^{n-1} - k_n (1-\theta)A U^{n-1} + k_n \left[ (1-\theta)F^{n-1} + \theta F^n \right]. \end{align*}
</p>
<p>左手边的线性系统是对称的和正定的，所以我们用共轭梯度法来解决它应该没有问题。</p>
<p>如果我们在初始时间有一组节点系数 \(U^0\) ，我们可以开始上面的迭代。在这里，我们采取将初始值 \(u_0(\mathbf x)\) 插值到第一个时间步骤所用的网格上得到的。我们还需要选择一个时间步长；在这里我们只选择固定的时间步长，但显然先进的仿真器会希望自适应地选择它。我们将在<a href="#Results">results section below</a>中简要地回过头来讨论这个问题。</p>
<p><a class="anchor" id="Adaptingmeshesfortimedependentproblems"></a></p><h3>Adapting meshes for time dependent problems </h3>
<p>在前面几个程序中求解波浪方程及其变体时，我们保持网格的固定。就像静止方程一样，我们可以很好地说明这不是最聪明的方法，通过调整网格可以节省大量资金。然而，与静止的情况相比，还有很大的困难。让我们依次来看看这些困难。</p>
<ul>
<li>
<p class="startli"><em>Time step size and minimal mesh size</em> 。对于静止的问题，一般的方法是 "将网格做得越细越好"。对于有奇点的问题，这往往会导致我们在角落或界面上得到许多细化层次的情况。第一个使用自适应网格的教程， <a class="el" href="step_6.html">step-6</a> ，已经是一个案例了。</p>
<p class="interli">然而，对于时间相关问题，我们通常需要选择与网格大小相关的时间步长。对于显性时间离散，这是显而易见的，因为我们需要尊重CFL条件，将时间步长与最小的网格尺寸联系起来。对于隐式时间离散，不存在这样的硬性限制，但在实践中，如果我们使网格尺寸变小，我们仍然希望使时间步长变小，因为我们通常有 \(\|e\| \le {\cal O}(k^p + h^q)\) 形式的误差估计，其中 \(p,q\) 分别是时间和空间离散的收敛阶。我们只有减少这两个项，才能使误差变小。理想情况下，像这样的估计会建议选择 \(k \propto h^{q/p}\) 。因为，至少对于非光滑解的问题，误差通常集中在最小的网格尺寸的单元中，我们必须确实选择 \(k \propto h_{\text{min}}^{q/p}\) ，使用<em>smallest</em> 的网格尺寸。</p>
<p class="interli">其结果是，在一个地方进一步细化网格，不仅意味着稍微增加自由度的适度额外努力，而且由于时间步长较小，必须更频繁地解决<em>global</em>线性系统的问题。</p>
<p class="interli">在实践中，人们通常通过承认我们不能使时间步长任意地小，因此也不能使局部网格大小任意地小来处理这个问题。相反，我们设置了一个最大的细化水平，当我们标记单元进行细化时，我们只是不细化那些子单元会超过这个最大的细化水平。</p>
<p class="interli">还有一个类似的问题是，我们将选择一个在不同时间在域的不同部分开启的右手边。为了避免在我们突然需要更细的网格的地方被太粗的网格抓个正着，我们也将在程序中强制执行<em>minimal</em>的网格细化水平。</p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><em>Test functions from different meshes</em>。让我们再次考虑我们上面写下的半离散方程。 </p><p class="formulaDsp">
\begin{align*} \frac{u^n(\mathbf x)-u^{n-1}(\mathbf x)}{k_n} - \left[ (1-\theta)\Delta u^{n-1}(\mathbf x) + \theta\Delta u^n(\mathbf x) \right] &amp;= \left[ (1-\theta)f(\mathbf x, t_{n-1}) + \theta f(\mathbf x, t_n) \right]. \end{align*}
</p>
<p class="interli">在这里我们可以将 \(u^{n-1}\) 视为数据，因为它可能已经被计算过了。现在，让我们把 </p><p class="formulaDsp">
\begin{align*} u^n(\mathbf x)\approx u_h^n(\mathbf x) = \sum_j U^n \varphi_j(\mathbf x), \end{align*}
</p>
<p>改为</p>
<p class="interli">乘以测试函数 \(\varphi_i(\mathbf x)\) ，并在必要时进行部分积分。在上述过程中，这将产生 </p><p class="formulaDsp">
\begin{align*} \sum_j (M + k_n \theta A)_{ij} U^n_j &amp;= (\varphi_i, u_h^{n-1}) - k_n (1-\theta)(\nabla \varphi_i, \nabla u_h^{n-1}) + k_n \left[ (1-\theta)F^{n-1} + \theta F^n \right]. \end{align*}
</p>
<p class="interli">现在想象一下，我们在时间步骤 \(n-1\) 和 \(n\) 之间改变了网格。那么问题来了，我们在 \(u_h^n\) 和 \(u^{n-1}\) 中使用的基函数是不同的！这与 \(u_h^n\) 中的项有关。这与右手边的项有关，其中第一个项我们可以更清楚地写成（第二个项遵循同样的模式） </p><p class="formulaDsp">
\begin{align*} (\varphi_i, u_h^{n-1}) = (\varphi_i^n, u_h^{n-1}) = \sum_{j=1}^{N_{n-1}} (\varphi_i^n, \varphi_j^{n-1}) U^{n-1}_j, \qquad\qquad i=1\ldots N_n. \end{align*}
</p>
<p class="interli">如果这两个时间步骤中使用的网格是相同的，那么 \((\varphi_i^n, \varphi_j^{n-1})\) 就会形成一个方形质量矩阵 \(M_{ij}\) 。然而，如果网格不一样，那么一般来说，矩阵是矩形的。更糟的是，甚至很难计算这些积分，因为如果我们在时间步长 \(n\) 的网格单元上循环，那么我们需要在这些单元的正交点上评估 \(\varphi_j^{n-1}\) ，但它们不一定对应于时间步长 \(n-1\) 的网格单元，而且 \(\varphi_j^{n-1}\) 不是通过这些单元定义的；当然，如果我们想通过在网格 \(n-1\) 的单元上的积分计算积分，这也是一样的。</p>
<p class="interli">在任何情况下，我们必须面对的情况是，我们需要整合定义在两个不同网格上的形状函数。这是可以做到的，事实上在 <a class="el" href="step_28.html">step-28</a> 中也有演示，但这个过程最多只能用 "笨拙 "一词来形容。</p>
<p class="interli">在实践中，人们通常并不希望这样做。相反，我们在每次调整网格时，通过从旧的网格插值到新的网格来避免整个情况。换句话说，我们不是求解上面的方程，而是求解 </p><p class="formulaDsp">
\begin{align*} \sum_j (M + k_n \theta A)_{ij} U^n_j &amp;= (\varphi_i, I_h^n u_h^{n-1}) - k_n (1-\theta)(\nabla \varphi_i, \nabla I_h^n u_h^{n-1}) + k_n \left[ (1-\theta)F^{n-1} + \theta F^n \right], \end{align*}
</p>
<p>这个问题</p>
<p class="endli">其中 \(I_h^n\) 是对时间步骤 \(n\) 中使用的有限元空间的插值运算。这不是最佳的方法，因为它除了时间和空间离散化之外，还引入了一个额外的误差，但这是一个务实的方法，使得做时间适应网格是可行的。 </p>
</li>
</ul>
<p><br  />
</p>
<p><a class="anchor" id="WhatcouldpossiblygowrongVerifyingwhetherthecodeiscorrect"></a></p><h3>What could possibly go wrong? Verifying whether the code is correct </h3>
<p>在实现有限元代码时，通常会有很多事情会出错。特别是，对于时间相关问题，以下是常见的错误来源。</p>
<ul>
<li>时间积分，例如，把涉及当前和之前时间步数的条款前面的系数弄错了（例如，把 \(\theta\) 的系数混为 \(1-\theta\) ）。</li>
<li>处理右手边，例如忘记了 \(k_n\) 或 \(\theta\) 的系数。</li>
<li>边界值处理不当，例如忘记了 \(k_n\) 或 \(\theta\) 的系数，或者忘记了不仅对右手边而且对系统矩阵应用非零边界值。</li>
</ul>
<p>一个不太常见的问题是把初始条件弄错了，因为通常只要输出第一个时间步长就能看出它是错的。在任何情况下，为了验证代码的正确性，有一个测试协议是很有帮助的，它允许我们分别验证这些组件中的每一个。这意味着。</p>
<ul>
<li>用非零初始条件但零右手边和边界值测试代码，并验证时间演化的正确性。</li>
<li>然后用零初始条件和边界值但非零右手边进行测试，并再次确保正确性。</li>
<li>最后，用零初始条件和右手边但非零边界值进行测试。</li>
</ul>
<p>这听起来很复杂，但幸运的是，对于像这里这样没有系数（或恒定系数）的线性偏微分方程，有一个相当标准的协议，它建立在以下观察之上：如果你选择一个正方形 \([0,1]^2\) 作为你的领域（或者稍加修改，一个矩形），那么精确解可以被写成</p>
<p class="formulaDsp">
\begin{align*} u(x,y,t) = a(t) \sin(n_x \pi x) \sin(n_y \pi y) \end{align*}
</p>
<p>整数常数 \(n_x,n_y\) ），只要初始条件、右手边和边界值也都是 \(\sin(n_x \pi x) \sin(n_y \pi y)\) 的形式。这是由于函数 \(\sin(n_x \pi x) \sin(n_y \pi y)\) 是拉普拉斯算子的特征函数，允许我们以分析的方式计算像时间因子 \(a(t)\) 这样的东西，从而与我们得到的数字进行比较。</p>
<p>作为一个例子，让我们考虑我们有 \(u_0(x,y)=\sin(n_x \pi x) \sin(n_x \pi y)\) 和 \(f(x,y,t)=0\) 的情况。通过上面对 \(u(x,y,t)\) 的形式的主张（ansatz），我们可以得到</p>
<p class="formulaDsp">
\begin{align*} \left(\frac{\partial}{\partial t} -\Delta\right) u(x,y,t) &amp;= \left(\frac{\partial}{\partial t} -\Delta\right) a(t) \sin(n_x \pi x) \sin(n_y \pi y) \\ &amp;= \left(a&#39;(t) + (n_x^2+n_y^2)\pi^2 a(t) \right) \sin(n_x \pi x) \sin(n_y \pi y). \end{align*}
</p>
<p>为了使其等于 \(f(x,y,t)=0\) ，我们需要</p>
<p class="formulaDsp">
\begin{align*} a&#39;(t) + (n_x^2+n_y^2)\pi^2 a(t) = 0 \end{align*}
</p>
<p>并且由于初始条件， \(a(0)=1\) 。这个微分方程可以被整合，得到</p>
<p class="formulaDsp">
\begin{align*} a(t) = - e^{-(n_x^2+n_y^2)\pi^2 t}. \end{align*}
</p>
<p>换句话说，如果初始条件是正弦的乘积，那么解的形状与正弦的乘积完全一样，它以已知的时间依赖性衰减到零。如果你有足够细的网格和足够小的时间步长，这一点是很容易测试的。</p>
<p>如果你把时间积分方案弄错了（例如，在各种项前面有错误的 \(\theta\) 或 \(k\) 的因子），通常会发生的情况是你没有得到正确的解的时间行为。仔细检查各种因子，直到你得到正确的行为。你可能还想验证一下时间衰减率（例如，通过绘制固定点上的解的值来确定）是否在你将时间步长或网格大小加倍或减半时都不会加倍或减半。你知道这不是对边界条件或右手边的处理，因为这些都是零。</p>
<p>如果你已经这样验证了时间积分器是正确的，那么就拿右手边非零但初始条件为零的情况来说吧。 \(u_0(x,y)=0\) 和 \(f(x,y,t)=\sin(n_x \pi x) \sin(n_x \pi y)\) 。再来看看。</p>
<p class="formulaDsp">
\begin{align*} \left(\frac{\partial}{\partial t} -\Delta\right) u(x,y,t) &amp;= \left(\frac{\partial}{\partial t} -\Delta\right) a(t) \sin(n_x \pi x) \sin(n_y \pi y) \\ &amp;= \left(a&#39;(t) + (n_x^2+n_y^2)\pi^2 a(t) \right) \sin(n_x \pi x) \sin(n_y \pi y), \end{align*}
</p>
<p>并使之等于 \(f(x,y,t)\) ，我们需要</p>
<p class="formulaDsp">
\begin{align*} a&#39;(t) + (n_x^2+n_y^2)\pi^2 a(t) = 1 \end{align*}
</p>
<p>并且由于初始条件， \(a(0)=0\) 。对这个方程进行时间积分，可以得到</p>
<p class="formulaDsp">
\begin{align*} a(t) = \frac{1}{(n_x^2+n_y^2)\pi^2} \left[ 1 - e^{-(n_x^2+n_y^2)\pi^2 t} \right]. \end{align*}
</p>
<p>同样，如果你在右手边条款前面有错误的 \(\theta\) 或 \(k\) 的因素，你将不会得到正确的解的时间行为，或者它将收敛到 \(\frac{1}{(n_x^2+n_y^2)\pi^2}\) 以外的一个最大值。</p>
<p>一旦我们用这个方案验证了时间积分和右手边的处理是正确的，我们就可以继续验证我们的边界值是否正确，用一个非常类似的方法来验证。</p>
<p><a class="anchor" id="Thetestcase"></a></p><h3>The testcase </h3>
<p>在一个具有简单右手边的简单域上求解热方程，几乎总是导致解非常无聊，因为它们很快就变得非常光滑，然后就不再有什么变化。相反，我们在这里用零迪里希特边界值和零初始条件在L形域上求解方程，但作为右手边我们选择</p>
<p class="formulaDsp">
\begin{align*} f(\mathbf x, t) = \left\{ \begin{array}{ll} \chi_1(\mathbf x) &amp; \text{if \(0\le t \le 0.2\tau\) or \(\tau\le t \le 1.2\tau\) or \(2\tau\le t \le 2.2\tau\), etc} \\ \chi_2(\mathbf x) &amp; \text{if \(0.5\le t \le 0.7\tau\) or \(1.5\tau\le t \le 1.7\tau\) or \(2.5\tau\le t \le 2.7\tau\), etc} \\ 0 &amp; \text{otherwise} \end{array} \right. \end{align*}
</p>
<p>这里。</p>
<p class="formulaDsp">
\begin{align*} \chi_1(\mathbf x) &amp;= \left\{ \begin{array}{ll} 1 &amp; \text{if \(x&gt;0.5\) and \(y&gt;-0.5\)} \\ 0 &amp; \text{otherwise} \end{array} \right. \\ \chi_2(\mathbf x) &amp;= \left\{ \begin{array}{ll} 1 &amp; \text{if \(x&gt;-0.5\) and \(y&gt;0.5\)} \\ 0 &amp; \text{otherwise} \end{array} \right. \end{align*}
</p>
<p>换句话说，在每一个长度为 \(\tau\) 的周期中，右手边首先在域1中闪烁，然后完全关闭，然后在域2中打开，然后再次完全关闭。通过<a href="#Results">results section</a>中显示的解的小动画，这种模式可能是最好的观察。</p>
<p>如果你把热方程解释为寻找导电固体的空间和时间可变的温度分布，那么上面的测试案例对应于一个L形体，我们把边界保持在零温度，并在域的两个部分交替加热。在加热的同时，这些地方的温度会上升，之后温度会扩散并再次减弱。这些初始条件的意义在于，它们为我们提供了一个在时间上（当源打开和关闭时）以及时间上（在再入角以及源作用的区域的边缘和角落）都有奇点的解决方案。<a class="anchor" id="CommProg"></a></p><h1>The commented program</h1>
<p>程序以通常的包含文件开始，所有这些文件你现在应该都见过了。</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparse__matrix_8h.html">deal.II/lac/sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__out_8h.html">deal.II/grid/grid_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="ttc" id="aaffine__constraints_8h_html"><div class="ttname"><a href="affine__constraints_8h.html">affine_constraints.h</a></div></div>
<div class="ttc" id="adof__tools_8h_html"><div class="ttname"><a href="dof__tools_8h.html">dof_tools.h</a></div></div>
<div class="ttc" id="adofs_2dof__handler_8h_html"><div class="ttname"><a href="dofs_2dof__handler_8h.html">dof_handler.h</a></div></div>
<div class="ttc" id="adynamic__sparsity__pattern_8h_html"><div class="ttname"><a href="dynamic__sparsity__pattern_8h.html">dynamic_sparsity_pattern.h</a></div></div>
<div class="ttc" id="aerror__estimator_8h_html"><div class="ttname"><a href="error__estimator_8h.html">error_estimator.h</a></div></div>
<div class="ttc" id="afe_2fe__values_8h_html"><div class="ttname"><a href="fe_2fe__values_8h.html">fe_values.h</a></div></div>
<div class="ttc" id="afe__q_8h_html"><div class="ttname"><a href="fe__q_8h.html">fe_q.h</a></div></div>
<div class="ttc" id="afull__matrix_8h_html"><div class="ttname"><a href="full__matrix_8h.html">full_matrix.h</a></div></div>
<div class="ttc" id="afunction_8h_html"><div class="ttname"><a href="function_8h.html">function.h</a></div></div>
<div class="ttc" id="agrid_2grid__refinement_8h_html"><div class="ttname"><a href="grid_2grid__refinement_8h.html">grid_refinement.h</a></div></div>
<div class="ttc" id="agrid_2tria_8h_html"><div class="ttname"><a href="grid_2tria_8h.html">tria.h</a></div></div>
<div class="ttc" id="agrid__generator_8h_html"><div class="ttname"><a href="grid__generator_8h.html">grid_generator.h</a></div></div>
<div class="ttc" id="agrid__out_8h_html"><div class="ttname"><a href="grid__out_8h.html">grid_out.h</a></div></div>
<div class="ttc" id="ainclude_2deal_8II_2base_2utilities_8h_html"><div class="ttname"><a href="include_2deal_8II_2base_2utilities_8h.html">utilities.h</a></div></div>
<div class="ttc" id="alogstream_8h_html"><div class="ttname"><a href="logstream_8h.html">logstream.h</a></div></div>
<div class="ttc" id="amatrix__tools_8h_html"><div class="ttname"><a href="matrix__tools_8h.html">matrix_tools.h</a></div></div>
<div class="ttc" id="anumerics_2data__out_8h_html"><div class="ttname"><a href="numerics_2data__out_8h.html">data_out.h</a></div></div>
<div class="ttc" id="anumerics_2solution__transfer_8h_html"><div class="ttname"><a href="numerics_2solution__transfer_8h.html">solution_transfer.h</a></div></div>
<div class="ttc" id="aprecondition_8h_html"><div class="ttname"><a href="precondition_8h.html">precondition.h</a></div></div>
<div class="ttc" id="aquadrature__lib_8h_html"><div class="ttname"><a href="quadrature__lib_8h.html">quadrature_lib.h</a></div></div>
<div class="ttc" id="asolver__cg_8h_html"><div class="ttname"><a href="solver__cg_8h.html">solver_cg.h</a></div></div>
<div class="ttc" id="asparse__matrix_8h_html"><div class="ttname"><a href="sparse__matrix_8h.html">sparse_matrix.h</a></div></div>
<div class="ttc" id="avector_8h_html"><div class="ttname"><a href="vector_8h.html">vector.h</a></div></div>
<div class="ttc" id="avector__tools_8h_html"><div class="ttname"><a href="vector__tools_8h.html">vector_tools.h</a></div></div>
</div><!-- fragment --><p>然后照例将本程序的所有内容放入一个命名空间，并将deal.II命名空间导入到我们将要工作的空间。</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>Step26</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="ttc" id="anamespacedealii_html"><div class="ttname"><a href="namespacedealii.html">dealii</a></div><div class="ttdef"><b>Definition:</b> <a href="namespace__dealii_8h_source.html#l00025">namespace_dealii.h:26</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeHeatEquationcodeclass"></a> </p><h3>The <code>HeatEquation</code> class</h3>
<p><br  />
</p>
<p>下一个部分是这个程序的主类的声明。它沿用了以前的例子中公认的路径。如果你看过 <a class="el" href="step_6.html">step-6</a> ，例如，这里唯一值得注意的是，我们需要建立两个矩阵（质量和拉普拉斯矩阵），并保存当前和前一个时间步长的解。然后，我们还需要存储当前时间、时间步长和当前时间步长的编号。最后一个成员变量表示引言中讨论的theta参数，它允许我们在一个程序中处理显式和隐式欧拉方法，以及Crank-Nicolson方法和其他通用方法。 <br  />
</p>
<p>就成员函数而言，唯一可能的惊喜是 <code>refine_mesh</code> 函数需要最小和最大的网格细化水平的参数。这样做的目的在介绍中已经讨论过了。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>HeatEquation</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  HeatEquation();</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keywordtype">void</span> setup_system();</div>
<div class="line">  <span class="keywordtype">void</span> solve_time_step();</div>
<div class="line">  <span class="keywordtype">void</span> output_results() <span class="keyword">const</span>;</div>
<div class="line">  <span class="keywordtype">void</span> refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> min_grid_level,</div>
<div class="line">                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div>
<div class="line">  <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>          fe;</div>
<div class="line">  <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>    dof_handler;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      sparsity_pattern;</div>
<div class="line">  <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>;</div>
<div class="line">  <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> laplace_matrix;</div>
<div class="line">  <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> solution;</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> old_solution;</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> system_rhs;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">double</span>       time;</div>
<div class="line">  <span class="keywordtype">double</span>       time_step;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> theta;</div>
<div class="line">};</div>
<div class="ttc" id="aclassAffineConstraints_html"><div class="ttname"><a href="classAffineConstraints.html">AffineConstraints&lt; double &gt;</a></div></div>
<div class="ttc" id="aclassDoFHandler_html"><div class="ttname"><a href="classDoFHandler.html">DoFHandler</a></div><div class="ttdef"><b>Definition:</b> <a href="dofs_2dof__handler_8h_source.html#l00314">dof_handler.h:315</a></div></div>
<div class="ttc" id="aclassFE__Q_html"><div class="ttname"><a href="classFE__Q.html">FE_Q</a></div><div class="ttdef"><b>Definition:</b> <a href="fe__q_8h_source.html#l00548">fe_q.h:549</a></div></div>
<div class="ttc" id="aclassSparseMatrix_html"><div class="ttname"><a href="classSparseMatrix.html">SparseMatrix&lt; double &gt;</a></div></div>
<div class="ttc" id="aclassSparsityPattern_html"><div class="ttname"><a href="classSparsityPattern.html">SparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="sparsity__pattern_8h_source.html#l00868">sparsity_pattern.h:869</a></div></div>
<div class="ttc" id="aclassTriangulation_html"><div class="ttname"><a href="classTriangulation.html">Triangulation</a></div><div class="ttdef"><b>Definition:</b> <a href="grid_2tria_8h_source.html#l01127">tria.h:1128</a></div></div>
<div class="ttc" id="aclassVector_html"><div class="ttname"><a href="classVector.html">Vector&lt; double &gt;</a></div></div>
<div class="ttc" id="anamespaceLocalIntegrators_1_1L2_html_a1c15243765304a803037988b5561627d"><div class="ttname"><a href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">LocalIntegrators::L2::mass_matrix</a></div><div class="ttdeci">void mass_matrix(FullMatrix&lt; double &gt; &amp;M, const FEValuesBase&lt; dim &gt; &amp;fe, const double factor=1.)</div><div class="ttdef"><b>Definition:</b> <a href="l2_8h_source.html#l00058">l2.h:58</a></div></div>
<div class="ttc" id="anamespaceWorkStream_1_1internal_1_1tbb__no__coloring_html_a8673698a405bf47aa24002aeb6d76d70"><div class="ttname"><a href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">WorkStream::internal::tbb_no_coloring::run</a></div><div class="ttdeci">void run(const Iterator &amp;begin, const typename identity&lt; Iterator &gt;::type &amp;end, Worker worker, Copier copier, const ScratchData &amp;sample_scratch_data, const CopyData &amp;sample_copy_data, const unsigned int queue_length, const unsigned int chunk_size)</div><div class="ttdef"><b>Definition:</b> <a href="work__stream_8h_source.html#l00691">work_stream.h:691</a></div></div>
<div class="ttc" id="ap4est__wrappers_8cc_html_ace00f2f80d9780ef9aa1007e1c22c6a4"><div class="ttname"><a href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a></div><div class="ttdeci">const ::parallel::distributed::Triangulation&lt; dim, spacedim &gt; * triangulation</div><div class="ttdef"><b>Definition:</b> <a href="p4est__wrappers_8cc_source.html#l00069">p4est_wrappers.cc:69</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="Equationdata"></a> </p><h3>Equation data</h3>
<p>.</p>
<p>在下面的类和函数中，我们实现了定义这个问题的各种数据（右手边和边界值），这些数据在这个程序中使用，我们需要函数对象。右手边的选择是在介绍的最后讨论的。对于边界值，我们选择零值，但这很容易在下面改变。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  RightHandSide()</div>
<div class="line">    : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;()</div>
<div class="line">    , period(0.2)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div>
<div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> period;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> RightHandSide&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div>
<div class="line">                                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  (void)component;</div>
<div class="line">  <a class="code" href="group__Exceptions.html#gaafbb69cc2a791ae55880fd8d57d0c1b0">AssertIndexRange</a>(component, 1);</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dim == 2, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> time = this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">double</span> point_within_period =</div>
<div class="line">    (time / period - <a class="code" href="namespaceDifferentiation_1_1SD.html#a860b730b2531e8c9adafc3e7bd7343fa">std::floor</a>(time / period));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> ((point_within_period &gt;= 0.0) &amp;&amp; (point_within_period &lt;= 0.2))</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> ((p[0] &gt; 0.5) &amp;&amp; (p[1] &gt; -0.5))</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((point_within_period &gt;= 0.5) &amp;&amp; (point_within_period &lt;= 0.7))</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">if</span> ((p[0] &gt; -0.5) &amp;&amp; (p[1] &gt; 0.5))</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>BoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div>
<div class="line">                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">double</span> BoundaryValues&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div>
<div class="line">                                  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  (void)component;</div>
<div class="line">  <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(component == 0, <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(component, 0, 1));</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aclassFunction_html"><div class="ttname"><a href="classFunction.html">Function</a></div><div class="ttdef"><b>Definition:</b> <a href="function_8h_source.html#l00150">function.h:153</a></div></div>
<div class="ttc" id="aclassFunction_html_acbfcab66b2fc63bfea59268f40772bb4"><div class="ttname"><a href="classFunction.html#acbfcab66b2fc63bfea59268f40772bb4">Function::value</a></div><div class="ttdeci">virtual RangeNumberType value(const Point&lt; dim &gt; &amp;p, const unsigned int component=0) const</div></div>
<div class="ttc" id="aclassPoint_html"><div class="ttname"><a href="classPoint.html">Point</a></div><div class="ttdef"><b>Definition:</b> <a href="base_2point_8h_source.html#l00110">point.h:111</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga0d685aad996180f9851183ae3e29019a"><div class="ttname"><a href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">StandardExceptions::ExcIndexRange</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcIndexRange(int arg1, int arg2, int arg3)</div></div>
<div class="ttc" id="agroup__Exceptions_html_ga70a0bb353656e704acf927945277bbc6"><div class="ttname"><a href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a></div><div class="ttdeci">#define Assert(cond, exc)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01473">exceptions.h:1473</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_ga7b52b286796c23ef9ff178faf7a4b68f"><div class="ttname"><a href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">StandardExceptions::ExcNotImplemented</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcNotImplemented()</div></div>
<div class="ttc" id="agroup__Exceptions_html_gaafbb69cc2a791ae55880fd8d57d0c1b0"><div class="ttname"><a href="group__Exceptions.html#gaafbb69cc2a791ae55880fd8d57d0c1b0">AssertIndexRange</a></div><div class="ttdeci">#define AssertIndexRange(index, range)</div><div class="ttdef"><b>Definition:</b> <a href="include_2deal_8II_2base_2exceptions_8h_source.html#l01698">exceptions.h:1698</a></div></div>
<div class="ttc" id="anamespaceDifferentiation_1_1SD_html_a860b730b2531e8c9adafc3e7bd7343fa"><div class="ttname"><a href="namespaceDifferentiation_1_1SD.html#a860b730b2531e8c9adafc3e7bd7343fa">Differentiation::SD::floor</a></div><div class="ttdeci">Expression floor(const Expression &amp;x)</div><div class="ttdef"><b>Definition:</b> <a href="symengine__math_8cc_source.html#l00294">symengine_math.cc:294</a></div></div>
<div class="ttc" id="anamespaceUtilities_1_1System_html_a76bc1cc7649cc416723f450d24fdd91d"><div class="ttname"><a href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">Utilities::System::get_time</a></div><div class="ttdeci">std::string get_time()</div><div class="ttdef"><b>Definition:</b> <a href="base_2utilities_8cc_source.html#l01019">utilities.cc:1019</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="ThecodeHeatEquationcodeimplementation"></a></p><h3>The <code>HeatEquation</code> implementation</h3>
<p><br  />
</p>
<p>现在是实现主类的时候了。让我们从构造函数开始，它选择了一个线性元素，一个时间步长为1/500的常数（记得上面右边的源的一个周期被设置为0.2，所以我们用100个时间步长来解决每个周期），并通过设置 \(\theta=1/2\) 选择了Crank Nicolson方法 。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">HeatEquation&lt;dim&gt;::HeatEquation()</div>
<div class="line">  : fe(1)</div>
<div class="line">  , dof_handler(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>)</div>
<div class="line">  , time_step(1. / 500)</div>
<div class="line">  , theta(0.5)</div>
<div class="line">{}</div>
</div><!-- fragment --><p><a class="anchor" id="codeHeatEquationsetup_systemcode"></a> </p><h4><code>HeatEquation::setup_system</code></h4>
<p><br  />
</p>
<p>下一个函数是设置DoFHandler对象，计算约束条件，并将线性代数对象设置为其正确的大小。我们还在这里通过简单地调用库中的两个函数来计算质量和拉普拉斯矩阵。 <br  />
</p>
<p>注意，在组装矩阵时，我们不考虑悬挂节点的约束（两个函数都有一个AffineConstraints参数，默认为空对象）。这是因为我们要在结合当前时间步长的矩阵后，在run()中浓缩约束。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> HeatEquation&lt;dim&gt;::setup_system()</div>
<div class="line">{</div>
<div class="line">  dof_handler.distribute_dofs(fe);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; std::endl</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot;===========================================&quot;</span> &lt;&lt; std::endl</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells()</div>
<div class="line">            &lt;&lt; std::endl</div>
<div class="line">            &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.n_dofs()</div>
<div class="line">            &lt;&lt; std::endl</div>
<div class="line">            &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  constraints.clear();</div>
<div class="line">  <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div>
<div class="line">  constraints.close();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.n_dofs());</div>
<div class="line">  <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div>
<div class="line">                                  dsp,</div>
<div class="line">                                  constraints,</div>
<div class="line">                                  <span class="comment">/*keep_constrained_dofs = */</span> <span class="keyword">true</span>);</div>
<div class="line">  sparsity_pattern.copy_from(dsp);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>.reinit(sparsity_pattern);</div>
<div class="line">  laplace_matrix.reinit(sparsity_pattern);</div>
<div class="line">  system_matrix.reinit(sparsity_pattern);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceMatrixCreator.html#aab6397f114af66efd781f7f4daba22be">MatrixCreator::create_mass_matrix</a>(dof_handler,</div>
<div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div>
<div class="line">                                    <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>);</div>
<div class="line">  <a class="code" href="namespaceMatrixCreator.html#a7b8157122064151d414dc34a22a3ca9c">MatrixCreator::create_laplace_matrix</a>(dof_handler,</div>
<div class="line">                                       <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div>
<div class="line">                                       laplace_matrix);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  solution.reinit(dof_handler.n_dofs());</div>
<div class="line">  old_solution.reinit(dof_handler.n_dofs());</div>
<div class="line">  system_rhs.reinit(dof_handler.n_dofs());</div>
<div class="line">}</div>
<div class="ttc" id="aclassDynamicSparsityPattern_html"><div class="ttname"><a href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a></div><div class="ttdef"><b>Definition:</b> <a href="dynamic__sparsity__pattern_8h_source.html#l00318">dynamic_sparsity_pattern.h:319</a></div></div>
<div class="ttc" id="aclassQGauss_html"><div class="ttname"><a href="classQGauss.html">QGauss</a></div><div class="ttdef"><b>Definition:</b> <a href="quadrature__lib_8h_source.html#l00038">quadrature_lib.h:39</a></div></div>
<div class="ttc" id="agroup__constraints_html_ga3b4ea7dfd313e388d868c4e4aa685799"><div class="ttname"><a href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a></div><div class="ttdeci">void make_hanging_node_constraints(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, AffineConstraints&lt; number &gt; &amp;constraints)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__constraints_8cc_source.html#l01787">dof_tools_constraints.cc:1787</a></div></div>
<div class="ttc" id="agroup__constraints_html_gaf78e864edbfba7e0a7477457bfb96b26"><div class="ttname"><a href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a></div><div class="ttdeci">void make_sparsity_pattern(const DoFHandler&lt; dim, spacedim &gt; &amp;dof_handler, SparsityPatternType &amp;sparsity_pattern, const AffineConstraints&lt; number &gt; &amp;constraints=AffineConstraints&lt; number &gt;(), const bool keep_constrained_dofs=true, const types::subdomain_id subdomain_id=numbers::invalid_subdomain_id)</div><div class="ttdef"><b>Definition:</b> <a href="dof__tools__sparsity_8cc_source.html#l00064">dof_tools_sparsity.cc:64</a></div></div>
<div class="ttc" id="anamespaceMatrixCreator_html_a7b8157122064151d414dc34a22a3ca9c"><div class="ttname"><a href="namespaceMatrixCreator.html#a7b8157122064151d414dc34a22a3ca9c">MatrixCreator::create_laplace_matrix</a></div><div class="ttdeci">void create_laplace_matrix(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const Quadrature&lt; dim &gt; &amp;q, SparseMatrix&lt; double &gt; &amp;matrix, const Function&lt; spacedim &gt; *const a=nullptr, const AffineConstraints&lt; double &gt; &amp;constraints=AffineConstraints&lt; double &gt;())</div></div>
<div class="ttc" id="anamespaceMatrixCreator_html_aab6397f114af66efd781f7f4daba22be"><div class="ttname"><a href="namespaceMatrixCreator.html#aab6397f114af66efd781f7f4daba22be">MatrixCreator::create_mass_matrix</a></div><div class="ttdeci">void create_mass_matrix(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const Quadrature&lt; dim &gt; &amp;q, SparseMatrix&lt; number &gt; &amp;matrix, const Function&lt; spacedim, number &gt; *const a=nullptr, const AffineConstraints&lt; number &gt; &amp;constraints=AffineConstraints&lt; number &gt;())</div></div>
</div><!-- fragment --><p><a class="anchor" id="codeHeatEquationsolve_time_stepcode"></a> </p><h4><code>HeatEquation::solve_time_step</code></h4>
<p><br  />
</p>
<p>下一个函数是解决单个时间步长的实际线性系统的函数。这里没有什么值得惊讶的。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> HeatEquation&lt;dim&gt;::solve_time_step()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classSolverControl.html">SolverControl</a>            solver_control(1000, 1<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">e</a>-8 * system_rhs.l2_norm());</div>
<div class="line">  <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt; cg(solver_control);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;SparseMatrix&lt;double&gt;</a>&gt; preconditioner;</div>
<div class="line">  preconditioner.<a class="code" href="group__Preconditioners.html#ga7a3d66b17bb0ea1b16606e222474c2ea">initialize</a>(system_matrix, 1.0);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  cg.solve(system_matrix, solution, system_rhs, preconditioner);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  constraints.distribute(solution);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;     &quot;</span> &lt;&lt; solver_control.last_step() &lt;&lt; <span class="stringliteral">&quot; CG iterations.&quot;</span></div>
<div class="line">            &lt;&lt; std::endl;</div>
<div class="line">}</div>
<div class="ttc" id="aclassPreconditionSSOR_html"><div class="ttname"><a href="classPreconditionSSOR.html">PreconditionSSOR</a></div><div class="ttdef"><b>Definition:</b> <a href="precondition_8h_source.html#l00650">precondition.h:651</a></div></div>
<div class="ttc" id="aclassSolverCG_html"><div class="ttname"><a href="classSolverCG.html">SolverCG</a></div><div class="ttdef"><b>Definition:</b> <a href="solver__cg_8h_source.html#l00095">solver_cg.h:96</a></div></div>
<div class="ttc" id="aclassSolverControl_html"><div class="ttname"><a href="classSolverControl.html">SolverControl</a></div><div class="ttdef"><b>Definition:</b> <a href="solver__control_8h_source.html#l00065">solver_control.h:66</a></div></div>
<div class="ttc" id="agroup__Preconditioners_html_ga7a3d66b17bb0ea1b16606e222474c2ea"><div class="ttname"><a href="group__Preconditioners.html#ga7a3d66b17bb0ea1b16606e222474c2ea">PreconditionSSOR::initialize</a></div><div class="ttdeci">void initialize(const MatrixType &amp;A, const typename BaseClass::AdditionalData &amp;parameters=typename BaseClass::AdditionalData())</div></div>
<div class="ttc" id="anamespacePhysics_1_1Elasticity_1_1Kinematics_html_a9587d5229555daa5b1fa1ba2f8a40adb"><div class="ttname"><a href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">Physics::Elasticity::Kinematics::e</a></div><div class="ttdeci">SymmetricTensor&lt; 2, dim, Number &gt; e(const Tensor&lt; 2, dim, Number &gt; &amp;F)</div></div>
</div><!-- fragment --><p><a class="anchor" id="codeHeatEquationoutput_resultscode"></a></p><h4><code>HeatEquation::output_results</code></h4>
<p><br  />
</p>
<p>除了我们告诉DataOut对象当前的时间和时间步长是什么之外，在生成图形输出方面也没有什么新东西，这样就可以把它写进输出文件。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> HeatEquation&lt;dim&gt;::output_results()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">  <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#ac1eb26168177faa30ffbcf9cbb9c3cd5">attach_dof_handler</a>(dof_handler);</div>
<div class="line">  data_out.<a class="code" href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">add_data_vector</a>(solution, <span class="stringliteral">&quot;U&quot;</span>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  data_out.<a class="code" href="classDataOut.html#a5eb51872b8736849bb7e8d2007fae086">build_patches</a>();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  data_out.<a class="code" href="group__Exceptions.html#gac7280a24690b117454acfb0fa058299c">set_flags</a>(<a class="code" href="structDataOutBase_1_1VtkFlags.html">DataOutBase::VtkFlags</a>(time, timestep_number));</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> std::string filename =</div>
<div class="line">    <span class="stringliteral">&quot;solution-&quot;</span> + <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(timestep_number, 3) + <span class="stringliteral">&quot;.vtk&quot;</span>;</div>
<div class="line">  std::ofstream output(filename);</div>
<div class="line">  data_out.<a class="code" href="group__Exceptions.html#gacad99726038e4fca7f605fdffb3317e4">write_vtk</a>(output);</div>
<div class="line">}</div>
<div class="ttc" id="aclassDataOut__DoFData_html_ac1eb26168177faa30ffbcf9cbb9c3cd5"><div class="ttname"><a href="classDataOut__DoFData.html#ac1eb26168177faa30ffbcf9cbb9c3cd5">DataOut_DoFData::attach_dof_handler</a></div><div class="ttdeci">void attach_dof_handler(const DoFHandlerType &amp;)</div></div>
<div class="ttc" id="aclassDataOut__DoFData_html_ace4b76e565ba0701c4d32c26075ed3b9"><div class="ttname"><a href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">DataOut_DoFData::add_data_vector</a></div><div class="ttdeci">void add_data_vector(const VectorType &amp;data, const std::vector&lt; std::string &gt; &amp;names, const DataVectorType type=type_automatic, const std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt; &amp;data_component_interpretation=std::vector&lt; DataComponentInterpretation::DataComponentInterpretation &gt;())</div><div class="ttdef"><b>Definition:</b> <a href="data__out__dof__data_8h_source.html#l01087">data_out_dof_data.h:1087</a></div></div>
<div class="ttc" id="aclassDataOut_html"><div class="ttname"><a href="classDataOut.html">DataOut</a></div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out_8h_source.html#l00147">data_out.h:150</a></div></div>
<div class="ttc" id="aclassDataOut_html_a5eb51872b8736849bb7e8d2007fae086"><div class="ttname"><a href="classDataOut.html#a5eb51872b8736849bb7e8d2007fae086">DataOut::build_patches</a></div><div class="ttdeci">virtual void build_patches(const unsigned int n_subdivisions=0)</div><div class="ttdef"><b>Definition:</b> <a href="numerics_2data__out_8cc_source.html#l01085">data_out.cc:1085</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_gac7280a24690b117454acfb0fa058299c"><div class="ttname"><a href="group__Exceptions.html#gac7280a24690b117454acfb0fa058299c">DataOutInterface::set_flags</a></div><div class="ttdeci">void set_flags(const FlagType &amp;flags)</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8cc_source.html#l08166">data_out_base.cc:8166</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_gacad99726038e4fca7f605fdffb3317e4"><div class="ttname"><a href="group__Exceptions.html#gacad99726038e4fca7f605fdffb3317e4">DataOutInterface::write_vtk</a></div><div class="ttdeci">void write_vtk(std::ostream &amp;out) const</div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8cc_source.html#l07177">data_out_base.cc:7177</a></div></div>
<div class="ttc" id="anamespaceUtilities_html_a6195c5f009ea8c7c536c6ffdf108c32f"><div class="ttname"><a href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a></div><div class="ttdeci">std::string int_to_string(const unsigned int value, const unsigned int digits=numbers::invalid_unsigned_int)</div><div class="ttdef"><b>Definition:</b> <a href="base_2utilities_8cc_source.html#l00473">utilities.cc:473</a></div></div>
<div class="ttc" id="astructDataOutBase_1_1VtkFlags_html"><div class="ttname"><a href="structDataOutBase_1_1VtkFlags.html">DataOutBase::VtkFlags</a></div><div class="ttdef"><b>Definition:</b> <a href="data__out__base_8h_source.html#l01087">data_out_base.h:1088</a></div></div>
</div><!-- fragment --><p><a class="anchor" id="codeHeatEquationrefine_meshcode"></a> </p><h4><code>HeatEquation::refine_mesh</code></h4>
<p><br  />
</p>
<p>这个函数是程序中最有趣的部分。它负责自适应网格细化的工作。这个函数执行的三个任务是：首先找出需要细化/粗化的单元，然后实际进行细化，最终在两个不同的网格之间传输解向量。第一个任务是通过对解决方案使用成熟的凯利误差估计器来实现的。第二项任务是实际进行再细化。这也只涉及到基本的函数，例如 <code>refine_and_coarsen_fixed_fraction</code> ，它可以细化那些具有最大估计误差的单元，这些误差合计占60，并粗化那些具有最小误差的单元，这些误差合计占40。请注意，对于像目前这样的问题，即有事发生的区域正在四处移动，我们希望积极地进行粗化，以便我们能够将单元格移动到有必要的地方。 <br  />
</p>
<p>正如在介绍中已经讨论过的，太小的网格会导致太小的时间步长，而太大的网格会导致太小的分辨率。因此，在前两个步骤之后，我们有两个循环，将细化和粗化限制在一个允许的单元范围内。</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> HeatEquation&lt;dim&gt;::refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> min_grid_level,</div>
<div class="line">                                    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div>
<div class="line">    dof_handler,</div>
<div class="line">    <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(fe.degree + 1),</div>
<div class="line">    std::map&lt;<a class="code" href="namespacetypes.html#aed8813fee8c8a2edcc6005e6a48c321a">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(),</div>
<div class="line">    solution,</div>
<div class="line">    estimated_error_per_cell);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceGridRefinement.html#ae90dc87c4db158b8d01f6d564ac614e5">GridRefinement::refine_and_coarsen_fixed_fraction</a>(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>,</div>
<div class="line">                                                    estimated_error_per_cell,</div>
<div class="line">                                                    0.6,</div>
<div class="line">                                                    0.4);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_levels() &gt; max_grid_level)</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell :</div>
<div class="line">         <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.active_cell_iterators_on_level(max_grid_level))</div>
<div class="line">      cell-&gt;clear_refine_flag();</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell :</div>
<div class="line">       <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.active_cell_iterators_on_level(min_grid_level))</div>
<div class="line">    cell-&gt;clear_coarsen_flag();</div>
<div class="ttc" id="aclassKellyErrorEstimator_html_aa0917e696d4f8ddb983223a68c512357"><div class="ttname"><a href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator::estimate</a></div><div class="ttdeci">static void estimate(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const Quadrature&lt; dim - 1 &gt; &amp;quadrature, const std::map&lt; types::boundary_id, const Function&lt; spacedim, typename InputVector::value_type &gt; * &gt; &amp;neumann_bc, const InputVector &amp;solution, Vector&lt; float &gt; &amp;error, const ComponentMask &amp;component_mask=ComponentMask(), const Function&lt; spacedim &gt; *coefficients=nullptr, const unsigned int n_threads=numbers::invalid_unsigned_int, const types::subdomain_id subdomain_id=numbers::invalid_subdomain_id, const types::material_id material_id=numbers::invalid_material_id, const Strategy strategy=cell_diameter_over_24)</div></div>
<div class="ttc" id="anamespaceGridRefinement_html_ae90dc87c4db158b8d01f6d564ac614e5"><div class="ttname"><a href="namespaceGridRefinement.html#ae90dc87c4db158b8d01f6d564ac614e5">GridRefinement::refine_and_coarsen_fixed_fraction</a></div><div class="ttdeci">void refine_and_coarsen_fixed_fraction(Triangulation&lt; dim, spacedim &gt; &amp;tria, const Vector&lt; Number &gt; &amp;criteria, const double top_fraction, const double bottom_fraction, const unsigned int max_n_cells=std::numeric_limits&lt; unsigned int &gt;::max(), const VectorTools::NormType norm_type=VectorTools::NormType::L1_norm)</div><div class="ttdef"><b>Definition:</b> <a href="grid_2grid__refinement_8cc_source.html#l00390">grid_refinement.cc:390</a></div></div>
<div class="ttc" id="anamespacetypes_html_aed8813fee8c8a2edcc6005e6a48c321a"><div class="ttname"><a href="namespacetypes.html#aed8813fee8c8a2edcc6005e6a48c321a">types::boundary_id</a></div><div class="ttdeci">unsigned int boundary_id</div><div class="ttdef"><b>Definition:</b> <a href="types_8h_source.html#l00129">types.h:129</a></div></div>
</div><!-- fragment --><p>上面这两个循环略有不同，但这很容易解释。在第一个循环中，我们没有调用 <code><a class="el" href="namespaceTrilinosWrappers_1_1internal.html#aee42c8e3004e2e81eac3c3356d3ec46b">triangulation.end()</a></code> ，而是调用了 <code>triangulation.end_active(max_grid_level)</code> 。这两个调用应该产生相同的迭代器，因为迭代器是按级别排序的，不应该有任何级别高于 <code>max_grid_level</code> 的单元格。事实上，这段代码确保了这种情况的发生。</p>
<p>作为网格细化的一部分，我们需要将旧网格中的解向量转移到新网格中。为此，我们使用了SolutionTransfer类，我们必须准备好需要转移到新网格的解向量（一旦我们完成细化，我们将失去旧的网格，所以转移必须与细化同时发生）。在我们调用这个函数的时候，我们将刚刚计算出解决方案，所以我们不再需要old_solution变量（它将在网格被细化后被解决方案覆盖，也就是在时间步长结束时；见下文）。换句话说，我们只需要一个求解向量，并将其复制到一个临时对象中，当我们在下面进一步调用 <code>setup_system()</code> 时，它就不会被重置。 <br  />
</p>
<p>因此，我们初始化一个SolutionTransfer对象，将其附加到旧的DoF处理程序中。然后，我们准备好三角形和数据向量以进行细化（按照这个顺序）。</p>
<div class="fragment"><div class="line"><a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim&gt;</a> solution_trans(dof_handler);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><a class="code" href="classVector.html">Vector&lt;double&gt;</a> previous_solution;</div>
<div class="line">previous_solution = solution;</div>
<div class="line"><a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.prepare_coarsening_and_refinement();</div>
<div class="line">solution_trans.prepare_for_coarsening_and_refinement(previous_solution);</div>
<div class="ttc" id="aclassSolutionTransfer_html"><div class="ttname"><a href="classSolutionTransfer.html">SolutionTransfer</a></div><div class="ttdef"><b>Definition:</b> <a href="numerics_2solution__transfer_8h_source.html#l00338">solution_transfer.h:339</a></div></div>
</div><!-- fragment --><p>现在一切都准备好了，所以进行细化并在新网格上重新创建DoF结构，最后在 <code>setup_system</code> 函数中初始化矩阵结构和新向量。接下来，我们实际执行从旧网格到新网格的插值解。最后一步是对解向量应用悬空节点约束，即确保位于悬空节点上的自由度值，使解是连续的。这是必要的，因为SolutionTransfer只对单元格进行局部操作，而不考虑邻域的情况。</p>
<div class="fragment"><div class="line">  <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">  setup_system();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  solution_trans.interpolate(previous_solution, solution);</div>
<div class="line">  constraints.distribute(solution);</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="codeHeatEquationruncode"></a></p><h4><code>HeatEquation::run</code></h4>
<p><br  />
</p>
<p>这是程序的主要驱动力，我们在这里循环计算所有的时间步骤。在函数的顶部，我们通过重复第一个时间步长来设置初始全局网格细化的数量和自适应网格细化的初始周期数量。然后，我们创建一个网格，初始化我们要处理的各种对象，设置一个标签，说明我们在重新运行第一个时间步长时应该从哪里开始，并将初始解插值到网格上（我们在这里选择了零函数，当然，我们可以用更简单的方法，直接将解向量设置为零）。我们还输出一次初始时间步长。 <br  />
</p>
<dl class="section note"><dt>Note</dt><dd>如果你是一个有经验的程序员，你可能会对我们在这段代码中使用 <code>goto</code> 语句感到吃惊 <code>goto</code> 语句现在已经不是特别受人欢迎了，因为计算机科学界的伟人之一Edsgar Dijkstra在1968年写了一封信，名为 "Go To Statement considered harmful"（见<a href="http://en.wikipedia.org/wiki/Considered_harmful">here</a>）。这段代码的作者全心全意地赞同这一观念。 <code>goto</code> 是难以理解的。事实上，deal.II几乎不包含任何出现的情况：不包括基本上是从书本上转录的代码，也不计算重复的代码片断，在写这篇笔记时，在大约60万行代码中有3个位置；我们还在4个教程程序中使用它，与这里的背景完全相同。与其在这里试图证明这种情况的发生，不如先看看代码，我们会在函数的最后再来讨论这个问题。</dd></dl>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">HeatEquation&lt;dim&gt;::run</a>()</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> initial_global_refinement       = 2;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_adaptive_pre_refinement_steps = 4;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceGridGenerator.html#a3b2a4ad8296c2b72a11d23b5969e8cc0">GridGenerator::hyper_L</a>(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>);</div>
<div class="line">  <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.refine_global(initial_global_refinement);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  setup_system();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pre_refinement_step = 0;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> tmp;</div>
<div class="line">  <a class="code" href="classVector.html">Vector&lt;double&gt;</a> forcing_terms;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">start_time_iteration:</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  time            = 0.0;</div>
<div class="line">  timestep_number = 0;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  tmp.<a class="code" href="group__Vectors.html#gac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(solution.size());</div>
<div class="line">  forcing_terms.<a class="code" href="group__Vectors.html#gac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(solution.size());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a>(dof_handler,</div>
<div class="line">                           <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a>(),</div>
<div class="line">                           old_solution);</div>
<div class="line">  solution = old_solution;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  output_results();</div>
<div class="ttc" id="aclassFunctions_1_1ZeroFunction_html"><div class="ttname"><a href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction</a></div><div class="ttdef"><b>Definition:</b> <a href="function_8h_source.html#l00510">function.h:511</a></div></div>
<div class="ttc" id="agroup__Vectors_html_gac4a4dbef7dd65ef8ad35ae56b57d7c05"><div class="ttname"><a href="group__Vectors.html#gac4a4dbef7dd65ef8ad35ae56b57d7c05">Vector::reinit</a></div><div class="ttdeci">virtual void reinit(const size_type N, const bool omit_zeroing_entries=false)</div></div>
<div class="ttc" id="anamespaceGridGenerator_html_a3b2a4ad8296c2b72a11d23b5969e8cc0"><div class="ttname"><a href="namespaceGridGenerator.html#a3b2a4ad8296c2b72a11d23b5969e8cc0">GridGenerator::hyper_L</a></div><div class="ttdeci">void hyper_L(Triangulation&lt; dim &gt; &amp;tria, const double left=-1., const double right=1., const bool colorize=false)</div></div>
<div class="ttc" id="anamespaceVectorTools_html_a761f008bdeb7d94a69205ae824deefad"><div class="ttname"><a href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a></div><div class="ttdeci">void interpolate(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const Function&lt; spacedim, typename VectorType::value_type &gt; &amp;function, VectorType &amp;vec, const ComponentMask &amp;component_mask=ComponentMask())</div></div>
</div><!-- fragment --><p>然后我们开始主循环，直到计算的时间超过我们的结束时间0.5。第一个任务是建立我们在每个时间步骤中需要解决的线性系统的右手边。回顾一下，它包含项 \(MU^{n-1}-(1-\theta)k_n AU^{n-1}\) 。我们把这些项放到变量system_rhs中，借助于一个临时矢量。</p>
<div class="fragment"><div class="line"><span class="keywordflow">while</span> (time &lt;= 0.5)</div>
<div class="line">  {</div>
<div class="line">    time += time_step;</div>
<div class="line">    ++timestep_number;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Time step &quot;</span> &lt;&lt; timestep_number &lt;&lt; <span class="stringliteral">&quot; at t=&quot;</span> &lt;&lt; time</div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>.vmult(system_rhs, old_solution);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    laplace_matrix.vmult(tmp, old_solution);</div>
<div class="line">    system_rhs.add(-(1 - theta) * time_step, tmp);</div>
</div><!-- fragment --><p>第二件事是计算源项的贡献。这与术语 \(k_n \left[ (1-\theta)F^{n-1} + \theta F^n \right]\) 相对应。下面的代码调用 <a class="el" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a> 来计算向量 \(F\) ，在这里我们在评估之前设置了右侧（源）函数的时间。这一切的结果最终都在forcing_terms变量中。</p>
<div class="fragment"><div class="line">RightHandSide&lt;dim&gt; rhs_function;</div>
<div class="line">rhs_function.set_time(time);</div>
<div class="line"><a class="code" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a>(dof_handler,</div>
<div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div>
<div class="line">                                    rhs_function,</div>
<div class="line">                                    tmp);</div>
<div class="line">forcing_terms = tmp;</div>
<div class="line">forcing_terms *= time_step * theta;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">rhs_function.set_time(time - time_step);</div>
<div class="line"><a class="code" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a>(dof_handler,</div>
<div class="line">                                    <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div>
<div class="line">                                    rhs_function,</div>
<div class="line">                                    tmp);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">forcing_terms.<a class="code" href="group__Vectors.html#ga10b0336c485e36c7b4b105dd2a926002">add</a>(time_step * (1 - theta), tmp);</div>
<div class="ttc" id="agroup__Vectors_html_ga10b0336c485e36c7b4b105dd2a926002"><div class="ttname"><a href="group__Vectors.html#ga10b0336c485e36c7b4b105dd2a926002">Vector::add</a></div><div class="ttdeci">void add(const std::vector&lt; size_type &gt; &amp;indices, const std::vector&lt; OtherNumber &gt; &amp;values)</div></div>
<div class="ttc" id="anamespaceVectorTools_html_a6e325333a138893e181da47f29ac680a"><div class="ttname"><a href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a></div><div class="ttdeci">void create_right_hand_side(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const Quadrature&lt; dim &gt; &amp;q, const Function&lt; spacedim, typename VectorType::value_type &gt; &amp;rhs, VectorType &amp;rhs_vector, const AffineConstraints&lt; typename VectorType::value_type &gt; &amp;constraints=AffineConstraints&lt; typename VectorType::value_type &gt;())</div></div>
</div><!-- fragment --><p>接下来，我们将强迫项添加到来自时间步长的强迫项中，同时建立矩阵 \(M+k_n\theta A\) ，我们必须在每个时间步长中进行反转。这些操作的最后一块是消除线性系统中悬挂的节点约束自由度。</p>
<div class="fragment"><div class="line">system_rhs += forcing_terms;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">system_matrix.copy_from(<a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>);</div>
<div class="line">system_matrix.<a class="code" href="group__Vectors.html#ga10b0336c485e36c7b4b105dd2a926002">add</a>(theta * time_step, laplace_matrix);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">constraints.condense(system_matrix, system_rhs);</div>
</div><!-- fragment --><p>在求解之前，我们还需要做一个操作：边界值。为此，我们创建一个边界值对象，将适当的时间设置为当前时间步长的时间，并像我们之前多次做的那样对其进行评估。其结果也被用来在线性系统中设置正确的边界值。</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  BoundaryValues&lt;dim&gt; boundary_values_function;</div>
<div class="line">  boundary_values_function.set_time(time);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  std::map&lt;types::global_dof_index, double&gt; boundary_values;</div>
<div class="line">  <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                           0,</div>
<div class="line">                                           boundary_values_function,</div>
<div class="line">                                           boundary_values);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="namespaceMatrixTools.html#a9ad0eb7a8662628534586716748d62fb">MatrixTools::apply_boundary_values</a>(boundary_values,</div>
<div class="line">                                     system_matrix,</div>
<div class="line">                                     solution,</div>
<div class="line">                                     system_rhs);</div>
<div class="line">}</div>
<div class="ttc" id="anamespaceMatrixTools_html_a9ad0eb7a8662628534586716748d62fb"><div class="ttname"><a href="namespaceMatrixTools.html#a9ad0eb7a8662628534586716748d62fb">MatrixTools::apply_boundary_values</a></div><div class="ttdeci">void apply_boundary_values(const std::map&lt; types::global_dof_index, number &gt; &amp;boundary_values, SparseMatrix&lt; number &gt; &amp;matrix, Vector&lt; number &gt; &amp;solution, Vector&lt; number &gt; &amp;right_hand_side, const bool eliminate_columns=true)</div><div class="ttdef"><b>Definition:</b> <a href="matrix__tools_8cc_source.html#l00081">matrix_tools.cc:81</a></div></div>
<div class="ttc" id="anamespaceVectorTools_html_ab2562d41bb26f362043f9719a8cd9b87"><div class="ttname"><a href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a></div><div class="ttdeci">void interpolate_boundary_values(const Mapping&lt; dim, spacedim &gt; &amp;mapping, const DoFHandler&lt; dim, spacedim &gt; &amp;dof, const std::map&lt; types::boundary_id, const Function&lt; spacedim, number &gt; * &gt; &amp;function_map, std::map&lt; types::global_dof_index, number &gt; &amp;boundary_values, const ComponentMask &amp;component_mask=ComponentMask())</div></div>
</div><!-- fragment --><p>解决了这个问题，我们要做的就是解决这个系统，生成图形数据，然后...</p>
<div class="fragment"><div class="line">solve_time_step();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">output_results();</div>
</div><!-- fragment --><p>...处理网格细化问题。在这里，我们要做的是(i)在求解过程一开始就细化所要求的次数，之后我们跳到顶部重新开始时间迭代，(ii)之后每五步细化一次。 <br  />
</p>
<p>时间循环，事实上，程序的主要部分以开始进入下一个时间步骤而结束，将old_solution设置为我们刚刚计算的解决方案。</p>
<div class="fragment"><div class="line">        <span class="keywordflow">if</span> ((timestep_number == 1) &amp;&amp;</div>
<div class="line">            (pre_refinement_step &lt; n_adaptive_pre_refinement_steps))</div>
<div class="line">          {</div>
<div class="line">            refine_mesh(initial_global_refinement,</div>
<div class="line">                        initial_global_refinement +</div>
<div class="line">                          n_adaptive_pre_refinement_steps);</div>
<div class="line">            ++pre_refinement_step;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">            tmp.<a class="code" href="group__Vectors.html#gac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(solution.size());</div>
<div class="line">            forcing_terms.<a class="code" href="group__Vectors.html#gac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(solution.size());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">            std::cout &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">goto</span> start_time_iteration;</div>
<div class="line">          }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((timestep_number &gt; 0) &amp;&amp; (timestep_number % 5 == 0))</div>
<div class="line">          {</div>
<div class="line">            refine_mesh(initial_global_refinement,</div>
<div class="line">                        initial_global_refinement +</div>
<div class="line">                          n_adaptive_pre_refinement_steps);</div>
<div class="line">            tmp.<a class="code" href="group__Vectors.html#gac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(solution.size());</div>
<div class="line">            forcing_terms.<a class="code" href="group__Vectors.html#gac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(solution.size());</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        old_solution = solution;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step26</span></div>
</div><!-- fragment --><p>现在你已经看到了这个函数的作用，让我们回到 <code>goto</code> 的问题上来。从本质上讲，代码所做的事情是这样的。 </p><div class="CodeFragmentInTutorialComment"></div><div class="CodeFragmentInTutorialComment">[1.x.94]</div><div class="CodeFragmentInTutorialComment"></div><p> 这里，"对结果满意 "的条件是，我们是想保留当前的网格，还是宁愿细化网格，在新的网格上重新开始。我们当然可以用下面的方法来取代 <code>goto</code> 的使用。 </p><div class="CodeFragmentInTutorialComment"></div><div class="CodeFragmentInTutorialComment">[1.x.95]</div><div class="CodeFragmentInTutorialComment"></div><p> 这样做的好处是摆脱了 <code>goto</code> ，但缺点是必须在两个不同的地方重复实现 "solve timestep "和 "postprocess "操作的代码。这可以通过将这些部分的代码（在上面的实际实现中是相当大的块）放到他们自己的函数中来解决，但是一个带有 <code>break</code> 语句的 <code>while(true)</code> 循环并不真的比 <code>goto</code> 容易阅读或理解。</p>
<p>最后，人们可能只是同意<em>in general</em> <code>goto</code> 语句是个坏主意，但要务实地指出，在某些场合，它们可能有助于避免代码重复和尴尬的控制流。这可能是其中的一个地方，它与Steve McConnell在他关于良好编程实践的优秀书籍 "Code Complete" <b>[CodeComplete]</b> 中的立场相吻合（见 <a class="el" href="step_1.html">step-1</a> 的介绍中提到的这本书），该书花了惊人的10页来讨论 <code>goto</code> 的一般问题。</p>
<p><a class="anchor" id="Thecodemaincodefunction"></a> </p><h3>The <code>main</code> function</h3>
<p>走到这一步，对于这个程序的主要功能，又没有什么可讨论的了：它看起来像自 <a class="el" href="step_6.html">step-6</a> 以来的所有此类功能。</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span>Step26;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      HeatEquation&lt;2&gt; heat_equation_solver;</div>
<div class="line">      heat_equation_solver.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="Results"></a></p><h1>Results</h1>
<p>如同许多教程一样，程序的实际输出比我们如何到达那里更重要。尽管如此，它还是在这里。</p>
<div class="fragment"><div class="line">===========================================</div>
<div class="line">Number of active cells: 48</div>
<div class="line">Number of degrees of freedom: 65</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Time step 1 at t=0.002</div>
<div class="line">     7 CG iterations.</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">===========================================</div>
<div class="line">Number of active cells: 60</div>
<div class="line">Number of degrees of freedom: 81</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Time step 1 at t=0.002</div>
<div class="line">     7 CG iterations.</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">===========================================</div>
<div class="line">Number of active cells: 105</div>
<div class="line">Number of degrees of freedom: 136</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Time step 1 at t=0.002</div>
<div class="line">     7 CG iterations.</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">[...]</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">Time step 249 at t=0.498</div>
<div class="line">     13 CG iterations.</div>
<div class="line">Time step 250 at t=0.5</div>
<div class="line">     14 CG iterations.</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">===========================================</div>
<div class="line">Number of active cells: 1803</div>
<div class="line">Number of degrees of freedom: 2109</div>
</div><!-- fragment --><p>也许更有意义的是解决方案的可视化和计算的网格。</p>
<p><img src="https://www.dealii.org/images/steps/developer/step-26.movie.gif" alt="Animation of the solution of step 26." class="inline"/> <br  />
</p>
<p>影片显示了两个源的开关以及网格对此的反应。很明显，现在的网格可能不是我们能想出的最好的。我们将在下一节再讨论这个问题。</p>
<p><a class="anchor" id="extensions"></a> <a class="anchor" id="Possibilitiesforextensions"></a></p><h3>Possibilities for extensions</h3>
<p>至少有两个方面可以大大改进这个程序：自适应时间步进和更好地选择网格。</p>
<p><a class="anchor" id="Adaptivetimestepping"></a></p><h4>Adaptive time stepping</h4>
<p>在选择了隐式时间步进方案后，我们不受任何类似CFL的时间步进条件的约束。此外，由于在热力方程中发生变化的时间尺度不受细胞直径的约束（与波浪方程的情况不同，在波浪方程中，我们有一个固定的信息传输速度，将时间尺度和空间尺度联系起来），我们可以随心所欲地选择时间步骤。或者，最好是按照我们认为必要的准确性来选择。</p>
<p>看一下这个解决方案，很明显，行动并不是随时间均匀发生的：在我们打开一个源的时候，很多东西都在发生变化，一旦一个源开启了一段时间，事情就变得不那么戏剧化了，而当两个源都关闭的时候，我们进入了一个漫长的下降阶段。在这些时候，我们肯定可以使用比以前更大的时间步长而不牺牲太多的准确性。</p>
<p>关于如何自适应地选择时间步长，文献中有许多建议。例如，可以从ODE求解器选择其时间步长的方式中学到很多。我们也可以从后验误差估计器中得到启发，理想情况下，后验误差估计器可以写成由时间和空间对整体误差的贡献组成的方式。如果时间上的贡献太大，我们应该选择一个较小的时间步长。例如，这个方向的想法可以在deal.II的前主要开发者Ralf Hartmann的博士论文中找到，该论文由德国海德堡大学在2002年出版。</p>
<p><a class="anchor" id="Bettertimesteppingmethods"></a></p><h4>Better time stepping methods</h4>
<p>我们在这里使用较简单的时间步进方法之一，即二阶时间的Crank-Nicolson方法。然而，更精确的方法如Runge-Kutta方法是可用的，并且应该使用，因为它们并不代表很多额外的努力。对于目前的程序来说，实现这一点并不困难，但在 <a class="el" href="step_52.html">step-52</a> 中也给出了一个更系统的处理。</p>
<p><a class="anchor" id="Betterrefinementcriteria"></a></p><h4>Better refinement criteria</h4>
<p>如果你看一下上面电影中的网格，很明显它们不是特别适合手头的任务。事实上，它们看起来相当随意。</p>
<p>有两个因素在起作用。首先，有一些细胞已经被细化的岛屿，但它们被非细化的细胞所包围（可能也有一些偶尔被粗化的岛屿）。这些并不可怕，因为它们大多数时候并不影响网格的近似质量，但是它们也无济于事，因为它们的许多额外自由度事实上受到悬挂节点的约束。也就是说，这很容易解决：Triangulation类在其构造函数中接受一个参数，表示 "网格平滑 "的程度。传递许多可能的标志之一，这将指示三角剖分细化一些额外的单元，或者不细化一些单元，这样得到的网格就不会有这些假象。</p>
<p>第二个问题更为严重：网格出现了滞后的解决方案。其根本原因是我们每隔五步才调整一次网格，而且在这些情况下只允许进行一次细化。每当一个源打开时，之前的解在这个区域是非常平滑的，因此网格也是相当粗糙的。这意味着在下一个时间步骤中，当我们细化网格时，我们会在这个区域多得到一个细化级别，五个时间步骤后再多一个级别，等等。但这还不够：首先，我们应该在一个源打开时立即进行细化（毕竟在当前情况下，我们至少知道右手边是什么），而且我们应该允许超过一个细化级别。当然，所有这些都可以用deal.II来完成，只是需要在如何使之工作方面有一些算法上的思考!</p>
<p><a class="anchor" id="Positivitypreservation"></a></p><h4>Positivity preservation</h4>
<p>为了提高你的模拟在时间上的准确性和分辨率，通常要减少时间步长 \(k_n\) 。如果你在这个特定的例子中开始玩弄时间步长，你会注意到，如果 \(k_n\) 低于某个阈值，解决方案会变成部分负值。这不是我们所期望发生的（在自然界）。</p>
<p>为了从数学上了解这种行为，让我们考虑一个一般的、完全离散的问题。</p>
<p class="formulaDsp">
\begin{align*} A u^{n} = B u^{n-1}. \end{align*}
</p>
<p>然后， \(i\) th方程的一般形式为。</p>
<p class="formulaDsp">
\begin{align*} a_{ii} u^{n}_i &amp;= b_{ii} u^{n-1}_i + \sum\limits_{j \in S_i} \left( b_{ij} u^{n-1}_j - a_{ij} u^{n}_j \right), \end{align*}
</p>
<p>其中 \(S_i\) 是自由度 \(i\) 耦合的自由度集合（即矩阵 \(A\) 或矩阵 \(B\) 在位置 \((i,j)\) 有一个非零条目）。如果所有系数都满足以下条件。</p>
<p class="formulaDsp">
\begin{align*} a_{ii} &amp;&gt; 0, &amp; b_{ii} &amp;\geq 0, &amp; a_{ij} &amp;\leq 0, &amp; b_{ij} &amp;\geq 0, &amp; \forall j &amp;\in S_i, \end{align*}
</p>
<p>所有解 \(u^{n}\) 的符号都与之前的解 \(u^{n-1}\) 保持一致，因此也与初始值 \(u^0\) 保持一致。关于正性保留的更多信息，请参见 <a href="http://bookstore.siam.org/cs14/">Kuzmin, H&auml;m&auml;l&auml;inen</a> 。</p>
<p>根据要解决的PDE和使用的时间积分方案，人们能够推导出时间步长的条件 \(k_n\) 。对于采用Crank-Nicolson方案的热方程，<a href="https://doi.org/10.2478/cmam-2010-0025">Schatz et. al.</a>已将其转化为下列方案。</p>
<p class="formulaDsp">
\begin{align*} (1 - \theta) k a_{ii} &amp;\leq m_{ii},\qquad \forall i, &amp; \theta k \left| a_{ij} \right| &amp;\geq m_{ij},\qquad j \neq i, \end{align*}
</p>
<p>其中 \(M = m_{ij}\) 表示质量矩阵， \(A = a_{ij}\) 表示刚度矩阵， \(a_{ij} \leq 0\) 表示 \(j \neq i\) 。有了 \(a_{ij} \leq 0\) ，我们可以制定全局时间步长 \(k\) 的界限如下。</p>
<p class="formulaDsp">
\begin{align*} k_{\text{max}} &amp;= \frac{ 1 }{ 1 - \theta } \min\left( \frac{ m_{ii} }{ a_{ii} } \right),~ \forall i, &amp; k_{\text{min}} &amp;= \frac{ 1 }{ \theta } \max\left( \frac{ m_{ij} }{ \left|a_{ij}\right| } \right),~ j \neq i. \end{align*}
</p>
<p>换句话说，在Crank-Nicolson方案的情况下，时间步长受到<em>both a lower and upper bound</em>的约束。这些约束应与CFL条件一起考虑，以确保所进行的模拟的重要性。</p>
<p>无法使时间步长达到我们所希望的那样小，以获得更多的精度而又不失去正数特性是令人讨厌的。这就提出了一个问题：在这个特定的教程中，我们是否可以至少<em>compute</em>选择最小的时间步长来确保正性的保存。事实上，我们可以使用通过MatrixCreator函数创建的质量和刚度的SparseMatrix对象。通过SparseMatrixIterators遍历每个条目，我们可以检查对角线和非对角线条目，从而动态地设置一个合适的时间步长。对于二次元矩阵，对角线元素被存储为一行的第一个成员（见SparseMatrix文档）。下面是一个关于如何从 <code>mass_matrix</code> 中抓取感兴趣的条目的示范性代码片断。</p>
<div class="fragment"><div class="line"><a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a> (<a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>.m() == <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>.n(), <a class="code" href="group__Exceptions.html#gaedbba1448cb1d1c4a34ab973974ec960">ExcNotQuadratic</a>());</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_rows = <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>.m();</div>
<div class="line"><span class="keywordtype">double</span> mass_matrix_min_diag    = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">std::numeric_limits&lt;double&gt;::max</a>(),</div>
<div class="line">       mass_matrix_max_offdiag = 0.;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><a class="code" href="classSparseMatrixIterators_1_1Iterator.html">SparseMatrixIterators::Iterator&lt;double,true&gt;</a> row_it (&amp;<a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>, 0);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> m = 0; m&lt;num_rows; ++m)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// check the diagonal element</span></div>
<div class="line">  row_it = <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>.begin(m);</div>
<div class="line">  mass_matrix_min_diag = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeb244a97c0c9e9e7ca4765e096f0badc">std::min</a>(row_it-&gt;value(), mass_matrix_min_diag);</div>
<div class="line">  ++row_it;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="comment">// check the off-diagonal elements</span></div>
<div class="line">  <span class="keywordflow">for</span>(; row_it != <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>.end(m); ++row_it)</div>
<div class="line">    mass_matrix_max_offdiag = <a class="code" href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">std::max</a>(row_it-&gt;value(), mass_matrix_max_offdiag);</div>
<div class="line">}</div>
<div class="ttc" id="aclassSparseMatrixIterators_1_1Iterator_html"><div class="ttname"><a href="classSparseMatrixIterators_1_1Iterator.html">SparseMatrixIterators::Iterator</a></div><div class="ttdef"><b>Definition:</b> <a href="sparse__matrix_8h_source.html#l00349">sparse_matrix.h:350</a></div></div>
<div class="ttc" id="agroup__Exceptions_html_gaedbba1448cb1d1c4a34ab973974ec960"><div class="ttname"><a href="group__Exceptions.html#gaedbba1448cb1d1c4a34ab973974ec960">LACExceptions::ExcNotQuadratic</a></div><div class="ttdeci">static ::ExceptionBase &amp; ExcNotQuadratic()</div></div>
<div class="ttc" id="anamespaceVectorTools_1_1EvaluationFlags_html_ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420"><div class="ttname"><a href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffda8e7f5b8545162dccd5ed717792bdf420">VectorTools::EvaluationFlags::max</a></div><div class="ttdeci">@ max</div><div class="ttdef"><b>Definition:</b> <a href="vector__tools__evaluate_8h_source.html#l00053">vector_tools_evaluate.h:53</a></div></div>
<div class="ttc" id="anamespaceVectorTools_1_1EvaluationFlags_html_ac6721740e24732d6afabcf28ddfc1ffdaeb244a97c0c9e9e7ca4765e096f0badc"><div class="ttname"><a href="namespaceVectorTools_1_1EvaluationFlags.html#ac6721740e24732d6afabcf28ddfc1ffdaeb244a97c0c9e9e7ca4765e096f0badc">VectorTools::EvaluationFlags::min</a></div><div class="ttdeci">@ min</div><div class="ttdef"><b>Definition:</b> <a href="vector__tools__evaluate_8h_source.html#l00059">vector_tools_evaluate.h:59</a></div></div>
</div><!-- fragment --><p>使用这样计算出来的信息，我们可以通过上面的公式约束时间步长。<a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"><div class="line"><span class="comment">/* ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (C) 2013 - 2020 by the deal.II authors</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of the deal.II library.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The deal.II library is free software; you can use it, redistribute</span></div>
<div class="line"><span class="comment"> * it, and/or modify it under the terms of the GNU Lesser General</span></div>
<div class="line"><span class="comment"> * Public License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment"> * The full text of the license can be found in the file LICENSE.md at</span></div>
<div class="line"><span class="comment"> * the top level directory of deal.II.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * ---------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Author: Wolfgang Bangerth, Texas A&amp;M University, 2013</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="include_2deal_8II_2base_2utilities_8h.html">deal.II/base/utilities.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="quadrature__lib_8h.html">deal.II/base/quadrature_lib.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="function_8h.html">deal.II/base/function.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="logstream_8h.html">deal.II/base/logstream.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector_8h.html">deal.II/lac/vector.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="full__matrix_8h.html">deal.II/lac/full_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dynamic__sparsity__pattern_8h.html">deal.II/lac/dynamic_sparsity_pattern.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sparse__matrix_8h.html">deal.II/lac/sparse_matrix.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="solver__cg_8h.html">deal.II/lac/solver_cg.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="precondition_8h.html">deal.II/lac/precondition.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="affine__constraints_8h.html">deal.II/lac/affine_constraints.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2tria_8h.html">deal.II/grid/tria.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__generator_8h.html">deal.II/grid/grid_generator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid_2grid__refinement_8h.html">deal.II/grid/grid_refinement.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="grid__out_8h.html">deal.II/grid/grid_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dofs_2dof__handler_8h.html">deal.II/dofs/dof_handler.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="dof__tools_8h.html">deal.II/dofs/dof_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe__q_8h.html">deal.II/fe/fe_q.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fe_2fe__values_8h.html">deal.II/fe/fe_values.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2data__out_8h.html">deal.II/numerics/data_out.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="vector__tools_8h.html">deal.II/numerics/vector_tools.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="error__estimator_8h.html">deal.II/numerics/error_estimator.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="numerics_2solution__transfer_8h.html">deal.II/numerics/solution_transfer.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="matrix__tools_8h.html">deal.II/numerics/matrix_tools.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>Step26</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">using namespace </span><a class="code" href="namespacedealii.html">dealii</a>;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>HeatEquation</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    HeatEquation();</div>
<div class="line">    <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">run</a>();</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keywordtype">void</span> setup_system();</div>
<div class="line">    <span class="keywordtype">void</span> solve_time_step();</div>
<div class="line">    <span class="keywordtype">void</span> output_results() <span class="keyword">const</span>;</div>
<div class="line">    <span class="keywordtype">void</span> refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> min_grid_level,</div>
<div class="line">                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classTriangulation.html">Triangulation&lt;dim&gt;</a> <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>;</div>
<div class="line">    <a class="code" href="classFE__Q.html">FE_Q&lt;dim&gt;</a>          fe;</div>
<div class="line">    <a class="code" href="classDoFHandler.html">DoFHandler&lt;dim&gt;</a>    dof_handler;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classAffineConstraints.html">AffineConstraints&lt;double&gt;</a> constraints;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSparsityPattern.html">SparsityPattern</a>      sparsity_pattern;</div>
<div class="line">    <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>;</div>
<div class="line">    <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> laplace_matrix;</div>
<div class="line">    <a class="code" href="classSparseMatrix.html">SparseMatrix&lt;double&gt;</a> system_matrix;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> solution;</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> old_solution;</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> system_rhs;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span>       time;</div>
<div class="line">    <span class="keywordtype">double</span>       time_step;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestep_number;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> theta;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>RightHandSide : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    RightHandSide()</div>
<div class="line">      : <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;()</div>
<div class="line">      , period(0.2)</div>
<div class="line">    {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="namespaceinternal.html#aa5bef221c94bc6b9c5441c306a72cdbaa2063c1608d6e0baf80249c42e2be5804">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">private</span>:</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> period;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> RightHandSide&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div>
<div class="line">                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    (void)component;</div>
<div class="line">    <a class="code" href="group__Exceptions.html#gaafbb69cc2a791ae55880fd8d57d0c1b0">AssertIndexRange</a>(component, 1);</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(dim == 2, <a class="code" href="group__Exceptions.html#ga7b52b286796c23ef9ff178faf7a4b68f">ExcNotImplemented</a>());</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> time = this-&gt;<a class="code" href="namespaceUtilities_1_1System.html#a76bc1cc7649cc416723f450d24fdd91d">get_time</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> point_within_period =</div>
<div class="line">      (time / period - <a class="code" href="namespaceDifferentiation_1_1SD.html#a860b730b2531e8c9adafc3e7bd7343fa">std::floor</a>(time / period));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((point_within_period &gt;= 0.0) &amp;&amp; (point_within_period &lt;= 0.2))</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">if</span> ((p[0] &gt; 0.5) &amp;&amp; (p[1] &gt; -0.5))</div>
<div class="line">          <span class="keywordflow">return</span> 1;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          <span class="keywordflow">return</span> 0;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((point_within_period &gt;= 0.5) &amp;&amp; (point_within_period &lt;= 0.7))</div>
<div class="line">      {</div>
<div class="line">        <span class="keywordflow">if</span> ((p[0] &gt; -0.5) &amp;&amp; (p[1] &gt; 0.5))</div>
<div class="line">          <span class="keywordflow">return</span> 1;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">          <span class="keywordflow">return</span> 0;</div>
<div class="line">      }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keyword">class </span>BoundaryValues : <span class="keyword">public</span> <a class="code" href="classFunction.html">Function</a>&lt;dim&gt;</div>
<div class="line">  {</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> <a class="code" href="namespaceinternal.html#aa5bef221c94bc6b9c5441c306a72cdbaa2063c1608d6e0baf80249c42e2be5804">value</a>(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; p,</div>
<div class="line">                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component = 0) <span class="keyword">const override</span>;</div>
<div class="line">  };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">double</span> BoundaryValues&lt;dim&gt;::value(<span class="keyword">const</span> <a class="code" href="classPoint.html">Point&lt;dim&gt;</a> &amp; <span class="comment">/*p*/</span>,</div>
<div class="line">                                    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> component)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    (void)component;</div>
<div class="line">    <a class="code" href="group__Exceptions.html#ga70a0bb353656e704acf927945277bbc6">Assert</a>(component == 0, <a class="code" href="group__Exceptions.html#ga0d685aad996180f9851183ae3e29019a">ExcIndexRange</a>(component, 0, 1));</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  HeatEquation&lt;dim&gt;::HeatEquation()</div>
<div class="line">    : fe(1)</div>
<div class="line">    , dof_handler(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>)</div>
<div class="line">    , time_step(1. / 500)</div>
<div class="line">    , theta(0.5)</div>
<div class="line">  {}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> HeatEquation&lt;dim&gt;::setup_system()</div>
<div class="line">  {</div>
<div class="line">    dof_handler.distribute_dofs(fe);</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;===========================================&quot;</span> &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;Number of active cells: &quot;</span> &lt;&lt; <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells()</div>
<div class="line">              &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;Number of degrees of freedom: &quot;</span> &lt;&lt; dof_handler.n_dofs()</div>
<div class="line">              &lt;&lt; std::endl</div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    constraints.clear();</div>
<div class="line">    <a class="code" href="group__constraints.html#ga3b4ea7dfd313e388d868c4e4aa685799">DoFTools::make_hanging_node_constraints</a>(dof_handler, constraints);</div>
<div class="line">    constraints.close();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classDynamicSparsityPattern.html">DynamicSparsityPattern</a> dsp(dof_handler.n_dofs());</div>
<div class="line">    <a class="code" href="group__constraints.html#gaf78e864edbfba7e0a7477457bfb96b26">DoFTools::make_sparsity_pattern</a>(dof_handler,</div>
<div class="line">                                    dsp,</div>
<div class="line">                                    constraints,</div>
<div class="line">                                    <span class="comment">/*keep_constrained_dofs = */</span> <span class="keyword">true</span>);</div>
<div class="line">    sparsity_pattern.copy_from(dsp);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>.reinit(sparsity_pattern);</div>
<div class="line">    laplace_matrix.reinit(sparsity_pattern);</div>
<div class="line">    system_matrix.reinit(sparsity_pattern);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceMatrixCreator.html#aab6397f114af66efd781f7f4daba22be">MatrixCreator::create_mass_matrix</a>(dof_handler,</div>
<div class="line">                                      <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div>
<div class="line">                                      <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>);</div>
<div class="line">    <a class="code" href="namespaceMatrixCreator.html#a7b8157122064151d414dc34a22a3ca9c">MatrixCreator::create_laplace_matrix</a>(dof_handler,</div>
<div class="line">                                         <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div>
<div class="line">                                         laplace_matrix);</div>
<div class="line"> </div>
<div class="line">    solution.reinit(dof_handler.n_dofs());</div>
<div class="line">    old_solution.reinit(dof_handler.n_dofs());</div>
<div class="line">    system_rhs.reinit(dof_handler.n_dofs());</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> HeatEquation&lt;dim&gt;::solve_time_step()</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classSolverControl.html">SolverControl</a>            solver_control(1000, 1<a class="code" href="namespacePhysics_1_1Elasticity_1_1Kinematics.html#a9587d5229555daa5b1fa1ba2f8a40adb">e</a>-8 * system_rhs.l2_norm());</div>
<div class="line">    <a class="code" href="classSolverCG.html">SolverCG&lt;Vector&lt;double&gt;</a>&gt; cg(solver_control);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classPreconditionSSOR.html">PreconditionSSOR&lt;SparseMatrix&lt;double&gt;</a>&gt; preconditioner;</div>
<div class="line">    preconditioner.<a class="code" href="group__Preconditioners.html#ga7a3d66b17bb0ea1b16606e222474c2ea">initialize</a>(system_matrix, 1.0);</div>
<div class="line"> </div>
<div class="line">    cg.solve(system_matrix, solution, system_rhs, preconditioner);</div>
<div class="line"> </div>
<div class="line">    constraints.distribute(solution);</div>
<div class="line"> </div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;     &quot;</span> &lt;&lt; solver_control.last_step() &lt;&lt; <span class="stringliteral">&quot; CG iterations.&quot;</span></div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> HeatEquation&lt;dim&gt;::output_results()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">  </span>{</div>
<div class="line">    <a class="code" href="classDataOut.html">DataOut&lt;dim&gt;</a> data_out;</div>
<div class="line"> </div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#ac1eb26168177faa30ffbcf9cbb9c3cd5">attach_dof_handler</a>(dof_handler);</div>
<div class="line">    data_out.<a class="code" href="classDataOut__DoFData.html#ace4b76e565ba0701c4d32c26075ed3b9">add_data_vector</a>(solution, <span class="stringliteral">&quot;U&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    data_out.<a class="code" href="classDataOut.html#a5eb51872b8736849bb7e8d2007fae086">build_patches</a>();</div>
<div class="line"> </div>
<div class="line">    data_out.<a class="code" href="group__Exceptions.html#gac7280a24690b117454acfb0fa058299c">set_flags</a>(<a class="code" href="structDataOutBase_1_1VtkFlags.html">DataOutBase::VtkFlags</a>(time, timestep_number));</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> std::string filename =</div>
<div class="line">      <span class="stringliteral">&quot;solution-&quot;</span> + <a class="code" href="namespaceUtilities.html#a6195c5f009ea8c7c536c6ffdf108c32f">Utilities::int_to_string</a>(timestep_number, 3) + <span class="stringliteral">&quot;.vtk&quot;</span>;</div>
<div class="line">    std::ofstream output(filename);</div>
<div class="line">    data_out.<a class="code" href="group__Exceptions.html#gacad99726038e4fca7f605fdffb3317e4">write_vtk</a>(output);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> HeatEquation&lt;dim&gt;::refine_mesh(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> min_grid_level,</div>
<div class="line">                                      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_grid_level)</div>
<div class="line">  {</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;float&gt;</a> estimated_error_per_cell(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_active_cells());</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classKellyErrorEstimator.html#aa0917e696d4f8ddb983223a68c512357">KellyErrorEstimator&lt;dim&gt;::estimate</a>(</div>
<div class="line">      dof_handler,</div>
<div class="line">      <a class="code" href="classQGauss.html">QGauss&lt;dim - 1&gt;</a>(fe.degree + 1),</div>
<div class="line">      std::map&lt;<a class="code" href="namespacetypes.html#aed8813fee8c8a2edcc6005e6a48c321a">types::boundary_id</a>, <span class="keyword">const</span> <a class="code" href="classFunction.html">Function&lt;dim&gt;</a> *&gt;(),</div>
<div class="line">      solution,</div>
<div class="line">      estimated_error_per_cell);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceGridRefinement.html#ae90dc87c4db158b8d01f6d564ac614e5">GridRefinement::refine_and_coarsen_fixed_fraction</a>(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>,</div>
<div class="line">                                                      estimated_error_per_cell,</div>
<div class="line">                                                      0.6,</div>
<div class="line">                                                      0.4);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.n_levels() &gt; max_grid_level)</div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell :</div>
<div class="line">           <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.active_cell_iterators_on_level(max_grid_level))</div>
<div class="line">        cell-&gt;clear_refine_flag();</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;cell :</div>
<div class="line">         <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.active_cell_iterators_on_level(min_grid_level))</div>
<div class="line">      cell-&gt;clear_coarsen_flag();</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classSolutionTransfer.html">SolutionTransfer&lt;dim&gt;</a> solution_trans(dof_handler);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> previous_solution;</div>
<div class="line">    previous_solution = solution;</div>
<div class="line">    <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.prepare_coarsening_and_refinement();</div>
<div class="line">    solution_trans.prepare_for_coarsening_and_refinement(previous_solution);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.execute_coarsening_and_refinement();</div>
<div class="line">    setup_system();</div>
<div class="line"> </div>
<div class="line">    solution_trans.interpolate(previous_solution, solution);</div>
<div class="line">    constraints.distribute(solution);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="namespaceWorkStream_1_1internal_1_1tbb__no__coloring.html#a8673698a405bf47aa24002aeb6d76d70">HeatEquation&lt;dim&gt;::run</a>()</div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> initial_global_refinement       = 2;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_adaptive_pre_refinement_steps = 4;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceGridGenerator.html#a3b2a4ad8296c2b72a11d23b5969e8cc0">GridGenerator::hyper_L</a>(<a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>);</div>
<div class="line">    <a class="code" href="p4est__wrappers_8cc.html#ace00f2f80d9780ef9aa1007e1c22c6a4">triangulation</a>.refine_global(initial_global_refinement);</div>
<div class="line"> </div>
<div class="line">    setup_system();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pre_refinement_step = 0;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> tmp;</div>
<div class="line">    <a class="code" href="classVector.html">Vector&lt;double&gt;</a> forcing_terms;</div>
<div class="line"> </div>
<div class="line">  start_time_iteration:</div>
<div class="line"> </div>
<div class="line">    time            = 0.0;</div>
<div class="line">    timestep_number = 0;</div>
<div class="line"> </div>
<div class="line">    tmp.<a class="code" href="group__Vectors.html#gac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(solution.size());</div>
<div class="line">    forcing_terms.<a class="code" href="group__Vectors.html#gac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(solution.size());</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <a class="code" href="namespaceVectorTools.html#a761f008bdeb7d94a69205ae824deefad">VectorTools::interpolate</a>(dof_handler,</div>
<div class="line">                             <a class="code" href="classFunctions_1_1ZeroFunction.html">Functions::ZeroFunction&lt;dim&gt;</a>(),</div>
<div class="line">                             old_solution);</div>
<div class="line">    solution = old_solution;</div>
<div class="line"> </div>
<div class="line">    output_results();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (time &lt;= 0.5)</div>
<div class="line">      {</div>
<div class="line">        time += time_step;</div>
<div class="line">        ++timestep_number;</div>
<div class="line"> </div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;Time step &quot;</span> &lt;&lt; timestep_number &lt;&lt; <span class="stringliteral">&quot; at t=&quot;</span> &lt;&lt; time</div>
<div class="line">                  &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>.vmult(system_rhs, old_solution);</div>
<div class="line"> </div>
<div class="line">        laplace_matrix.vmult(tmp, old_solution);</div>
<div class="line">        system_rhs.add(-(1 - theta) * time_step, tmp);</div>
<div class="line"> </div>
<div class="line">        RightHandSide&lt;dim&gt; rhs_function;</div>
<div class="line">        rhs_function.set_time(time);</div>
<div class="line">        <a class="code" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a>(dof_handler,</div>
<div class="line">                                            <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div>
<div class="line">                                            rhs_function,</div>
<div class="line">                                            tmp);</div>
<div class="line">        forcing_terms = tmp;</div>
<div class="line">        forcing_terms *= time_step * theta;</div>
<div class="line"> </div>
<div class="line">        rhs_function.set_time(time - time_step);</div>
<div class="line">        <a class="code" href="namespaceVectorTools.html#a6e325333a138893e181da47f29ac680a">VectorTools::create_right_hand_side</a>(dof_handler,</div>
<div class="line">                                            <a class="code" href="classQGauss.html">QGauss&lt;dim&gt;</a>(fe.degree + 1),</div>
<div class="line">                                            rhs_function,</div>
<div class="line">                                            tmp);</div>
<div class="line"> </div>
<div class="line">        forcing_terms.<a class="code" href="group__Vectors.html#ga10b0336c485e36c7b4b105dd2a926002">add</a>(time_step * (1 - theta), tmp);</div>
<div class="line"> </div>
<div class="line">        system_rhs += forcing_terms;</div>
<div class="line"> </div>
<div class="line">        system_matrix.copy_from(<a class="code" href="namespaceLocalIntegrators_1_1L2.html#a1c15243765304a803037988b5561627d">mass_matrix</a>);</div>
<div class="line">        system_matrix.<a class="code" href="group__Vectors.html#ga10b0336c485e36c7b4b105dd2a926002">add</a>(theta * time_step, laplace_matrix);</div>
<div class="line"> </div>
<div class="line">        constraints.condense(system_matrix, system_rhs);</div>
<div class="line"> </div>
<div class="line">        {</div>
<div class="line">          BoundaryValues&lt;dim&gt; boundary_values_function;</div>
<div class="line">          boundary_values_function.set_time(time);</div>
<div class="line"> </div>
<div class="line">          std::map&lt;types::global_dof_index, double&gt; boundary_values;</div>
<div class="line">          <a class="code" href="namespaceVectorTools.html#ab2562d41bb26f362043f9719a8cd9b87">VectorTools::interpolate_boundary_values</a>(dof_handler,</div>
<div class="line">                                                   0,</div>
<div class="line">                                                   boundary_values_function,</div>
<div class="line">                                                   boundary_values);</div>
<div class="line"> </div>
<div class="line">          <a class="code" href="namespaceMatrixTools.html#a9ad0eb7a8662628534586716748d62fb">MatrixTools::apply_boundary_values</a>(boundary_values,</div>
<div class="line">                                             system_matrix,</div>
<div class="line">                                             solution,</div>
<div class="line">                                             system_rhs);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        solve_time_step();</div>
<div class="line"> </div>
<div class="line">        output_results();</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> ((timestep_number == 1) &amp;&amp;</div>
<div class="line">            (pre_refinement_step &lt; n_adaptive_pre_refinement_steps))</div>
<div class="line">          {</div>
<div class="line">            refine_mesh(initial_global_refinement,</div>
<div class="line">                        initial_global_refinement +</div>
<div class="line">                          n_adaptive_pre_refinement_steps);</div>
<div class="line">            ++pre_refinement_step;</div>
<div class="line"> </div>
<div class="line">            tmp.<a class="code" href="group__Vectors.html#gac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(solution.size());</div>
<div class="line">            forcing_terms.<a class="code" href="group__Vectors.html#gac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(solution.size());</div>
<div class="line"> </div>
<div class="line">            std::cout &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">goto</span> start_time_iteration;</div>
<div class="line">          }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((timestep_number &gt; 0) &amp;&amp; (timestep_number % 5 == 0))</div>
<div class="line">          {</div>
<div class="line">            refine_mesh(initial_global_refinement,</div>
<div class="line">                        initial_global_refinement +</div>
<div class="line">                          n_adaptive_pre_refinement_steps);</div>
<div class="line">            tmp.<a class="code" href="group__Vectors.html#gac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(solution.size());</div>
<div class="line">            forcing_terms.<a class="code" href="group__Vectors.html#gac4a4dbef7dd65ef8ad35ae56b57d7c05">reinit</a>(solution.size());</div>
<div class="line">          }</div>
<div class="line"> </div>
<div class="line">        old_solution = solution;</div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">} <span class="comment">// namespace Step26</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using namespace </span>Step26;</div>
<div class="line"> </div>
<div class="line">      HeatEquation&lt;2&gt; heat_equation_solver;</div>
<div class="line">      heat_equation_solver.run();</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (std::exception &amp;exc)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Exception on processing: &quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; exc.what() &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">  <span class="keywordflow">catch</span> (...)</div>
<div class="line">    {</div>
<div class="line">      std::cerr &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      std::cerr &lt;&lt; <span class="stringliteral">&quot;Unknown exception!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;Aborting!&quot;</span> &lt;&lt; std::endl</div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;----------------------------------------------------&quot;</span></div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line">      <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="anamespaceinternal_html_aa5bef221c94bc6b9c5441c306a72cdbaa2063c1608d6e0baf80249c42e2be5804"><div class="ttname"><a href="namespaceinternal.html#aa5bef221c94bc6b9c5441c306a72cdbaa2063c1608d6e0baf80249c42e2be5804">internal::EvaluatorQuantity::value</a></div><div class="ttdeci">@ value</div></div>
</div><!-- fragment --><p> 。 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
